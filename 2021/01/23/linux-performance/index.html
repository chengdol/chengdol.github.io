<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="最近一周在on-call，这里整理一下Linkedin Learn: Linux performance的内容. 这里主要关注4个方面: CPU, Memory, Disk and FileSystem IO, Network. 其实很多时候，alerts or incidents are derived from performance issues, of course we have ins">
<meta name="keywords" content="linux,performance">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux Performance Tuning">
<meta property="og:url" content="http://yoursite.com/2021/01/23/linux-performance/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="最近一周在on-call，这里整理一下Linkedin Learn: Linux performance的内容. 这里主要关注4个方面: CPU, Memory, Disk and FileSystem IO, Network. 其实很多时候，alerts or incidents are derived from performance issues, of course we have ins">
<meta property="og:locale" content="中文|English">
<meta property="og:updated_time" content="2021-12-27T06:42:53.469Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux Performance Tuning">
<meta name="twitter:description" content="最近一周在on-call，这里整理一下Linkedin Learn: Linux performance的内容. 这里主要关注4个方面: CPU, Memory, Disk and FileSystem IO, Network. 其实很多时候，alerts or incidents are derived from performance issues, of course we have ins">






  <link rel="canonical" href="http://yoursite.com/2021/01/23/linux-performance/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Linux Performance Tuning | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">146</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">42</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">260</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/23/linux-performance/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Linux Performance Tuning

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-01-23 20:26:48" itemprop="dateCreated datePublished" datetime="2021-01-23T20:26:48-08:00">2021-01-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-12-26 22:42:53" itemprop="dateModified" datetime="2021-12-26T22:42:53-08:00">2021-12-26</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">50k</span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>最近一周在on-call，这里整理一下Linkedin Learn: Linux performance的内容. 这里主要关注4个方面: CPU, Memory, Disk and FileSystem IO, Network. 其实很多时候，alerts or incidents are derived from performance issues, of course we have insight checks for services themselves. 建议阅读 <code>&lt;&lt;How linux works&gt;&gt;</code>这本书，里面都讲到了。</p>
<p>此外，极客时间的课程<code>&lt;&lt;Linux性能优化实战&gt;&gt;</code>非常好，受益匪浅。我还阅读了书籍<code>&lt;&lt;Systems Performance&gt;&gt;</code>.</p>
<h1 id="From-极客时间"><a href="#From-极客时间" class="headerlink" title="From 极客时间"></a>From 极客时间</h1><p><a href="http://www.brendangregg.com/" target="_blank" rel="noopener">性能领域大师布伦丹·格雷格 personal website</a></p>
<p>For more comprehensive cheat sheet, please switch to <code>&lt;&lt;On-Call System Performance&gt;&gt;</code>.</p>
<h2 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h2><p>Understand the meaning of <code>uptime</code> command(check man). Load average is <strong>not</strong> CPU usage. 平均负载是指单位时间内，系统处于可运行状态(R)和不可中断状态(D)的平均进程数，也就是平均活跃进程数(可以这么理解，但源码它实际上是活跃进程数的指数衰减平均值)，它和 CPU 使用率并<strong>没有</strong>直接关系. (有时需要对比系统的运行时间，有的故障可能是系统重启导致的)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check CPU number</span></span><br><span class="line">lscpu</span><br><span class="line"><span class="comment"># check load average</span></span><br><span class="line">uptime</span><br><span class="line">w</span><br><span class="line"><span class="comment"># or using top with 1 to show each cpu</span></span><br><span class="line"><span class="comment"># and load average</span></span><br><span class="line">top -b -n 1 | head</span><br></pre></td></tr></table></figure></p>
<p>关于不可中断状态，当一个进程向磁盘读写数据时，为了保证数据的一致性，在得到磁盘回复前，它是不能被其他进程或者中断打断的，这个时候的进程就处于不可中断状态。如果此时的进程被打断了，就容易出现磁盘数据与进程数据不一致的问题. 不可中断状态实际上是系统对进程和硬件设备的一种保护机制.</p>
<p>综合<code>top</code>, <code>ps</code> 中查看进程 status code, such as <code>SLsl</code>，很有意义，可以了解进程的组成等，比如多线程.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">man ps</span><br><span class="line"><span class="comment"># PROCESS STATE CODES</span></span><br><span class="line">D    uninterruptible sleep (usually IO)</span><br><span class="line">R    running or runnable (on run queue)</span><br><span class="line">S    interruptible sleep (waiting <span class="keyword">for</span> an event to complete)</span><br><span class="line">T    stopped by job control signal</span><br><span class="line">t    stopped by debugger during the tracing</span><br><span class="line">W    paging (not valid since the 2.6.xx kernel)</span><br><span class="line">X    dead (should never be seen)</span><br><span class="line">Z    defunct (<span class="string">"zombie"</span>) process, terminated but not reaped by its parent</span><br><span class="line">I    idle</span><br><span class="line"><span class="comment"># For BSD formats and when the stat keyword is used, additional characters may be displayed:</span></span><br><span class="line">&lt;    high-priority (not nice to other users)</span><br><span class="line">N    low-priority (nice to other users)</span><br><span class="line">L    has pages locked into memory (<span class="keyword">for</span> real-time and custom IO)</span><br><span class="line">s    is a session leader (会话是指共享同一个控制终端的一个或多个进程组)</span><br><span class="line">l    is multi-threaded (using CLONE_THREAD, like NPTL pthreads <span class="keyword">do</span>)</span><br><span class="line">+    is <span class="keyword">in</span> the foreground process group (进程组表示一组相互关联的进程，比如每个子进程都是父进程所在组的成员)</span><br></pre></td></tr></table></figure></p>
<p>比如当平均负载为2时, 意味着什么呢? When number of CPU is larger, equal or less then 2. Check <code>lscpu</code> or <code>grep &#39;model name&#39; /proc/cpuinfo | wc -l</code> to see the logical CPU size.</p>
<p>三个不同时间间隔的平均值，其实给我们提供了，分析系统负载趋势的数据来源，让我们能更全面、更立体地理解目前的负载状况. 当平均负载高于 CPU 数量 70% 的时候，你就应该分析排查负载高的问题了。一旦负载过高，就可能导致进程响应变慢，进而影响服务的正常功能. 最推荐的方法，还是把系统的平均负载监控起来(prometheus + grafana)，然后根据更多的历史数据，判断负载的变化趋势。当发现负载有明显升高趋势时，比如说负载翻倍了，你再去做分析和调查。</p>
<p>当发现负载高的时候，你可以使用 <code>iostat</code>, <code>mpstat</code>, <code>pidstat</code> 等工具，辅助分析负载的来源.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stress cpu with 1 process</span></span><br><span class="line">stress --cpu 1 --timeout 600</span><br><span class="line"><span class="comment"># stress io</span></span><br><span class="line"><span class="comment"># stress -i 1 --timeout 600 does not work well</span></span><br><span class="line"><span class="comment"># because VM sync buffer is small</span></span><br><span class="line">stress-ng --io 1 --hdd 1 --timeout 600</span><br><span class="line"><span class="comment"># stress cpu with 8 processes</span></span><br><span class="line">stress -c 8 --timeout 600</span><br><span class="line"></span><br><span class="line"><span class="comment"># check uptime updates</span></span><br><span class="line"><span class="comment"># -d: highlight the successive difference</span></span><br><span class="line">watch -d <span class="string">"uptime"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check all cpus status</span></span><br><span class="line"><span class="comment"># 判断cpu usage 升高是由于iowait 还是 computing</span></span><br><span class="line">mpstat -P ALL 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># check which process cause cpu usage high</span></span><br><span class="line"><span class="comment"># -u: cpu status</span></span><br><span class="line">pidstat -u 5 2</span><br><span class="line"><span class="comment"># -d: io status</span></span><br><span class="line"><span class="comment"># -p: pid</span></span><br><span class="line">pidstat -d -p 12345 5 2</span><br></pre></td></tr></table></figure></p>
<p>在查看pidstat 时，可能没有%wait column，则需要升级版本到11.5.5 (centos 8)，见<a href="https://github.com/sysstat/sysstat" target="_blank" rel="noopener">sysstat git repo</a>. 或者如果在prod VM上无安装，直接把编译好的文件丢到系统上就可以运行。</p>
<p>理解 CPU 上下文切换: 分为进程上下文切换、线程上下文切换和中断上下文切换。</p>
<p>注意，<code>系统调用</code>过程中，并不会涉及到虚拟内存等进程用户态的资源，也不会切换进程。这跟我们通常所说的进程上下文切换是不一样的。进程上下文切换，是指从一个进程切换到另一个进程运行。而系统调用过程中一直是同一个进程在运行。所以，系统调用过程通常称为特权模式切换，而不是上下文切换。但实际上，系统调用过程中，CPU 的上下文切换还是无法避免的。</p>
<p>线程与进程最大的区别在于，线程是调度的基本单位，而进程则是资源拥有的基本单位。说白了，所谓内核中的任务调度，实际上的调度对象是线程；而进程只是给线程提供了虚拟内存、全局变量等资源。</p>
<p>跟进程上下文不同，中断上下文切换并不涉及到进程的用户态。所以，即便中断过程打断了一个正处在用户态的进程，也不需要保存和恢复这个进程的虚拟内存、全局变量等用户态资源。中断上下文，其实只包括内核态中断服务程序执行所必需的状态，包括 CPU 寄存器、内核堆栈、硬件中断参数等。</p>
<p><code>vmstat</code> 是一个常用的系统性能分析工具，主要用来分析系统的内存使用情况，也常用来分析 CPU 上下文切换和中断的次数。<br><code>sysbench</code> 是一个多线程的基准测试工具，一般用来评估不同系统参数下的数据库负载情况。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># benchmark tool</span></span><br><span class="line">sysbench --threads=10 --max-time=300 threads run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统整体的性能</span></span><br><span class="line"><span class="comment"># focus on in, cs, r, b, check man for description</span></span><br><span class="line"><span class="comment"># 注意r 的个数是否远超CPU 个数</span></span><br><span class="line"><span class="comment"># in 太多也是个问题</span></span><br><span class="line"><span class="comment"># us sy 看cpu 主要是被用户 还是 内核 占据</span></span><br><span class="line"><span class="comment"># -w: wide display</span></span><br><span class="line"><span class="comment"># -S: unit m(mb)</span></span><br><span class="line"><span class="comment"># 2: profile interval</span></span><br><span class="line">vmstat -w -S m 2</span><br><span class="line"></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line"> 2  0      0 230548     24 4068628    0    0     0    33 16436 29165 25  2 73  0  0</span><br><span class="line"> 1  0      0 226888     24 4069028    0    0     0    43 15443 27179 39  2 59  0  0</span><br><span class="line"> 3  0      0 225588     24 4070544    0    0     0   523 20873 38865 36  2 61  0  0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看process 的性能</span></span><br><span class="line"><span class="comment"># only show at least one column non-zero item </span></span><br><span class="line"><span class="comment"># -w: show context switch</span></span><br><span class="line"><span class="comment"># -u: show cpu stat</span></span><br><span class="line">pidstat -w -u 2</span><br><span class="line"><span class="comment"># -t: thread level, helpful!</span></span><br><span class="line"><span class="comment"># -p: pid</span></span><br><span class="line"><span class="comment"># check both process and its thread context switch status</span></span><br><span class="line">pidstat -wt -p 14233 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># analyze interrupt, good point to check proc file</span></span><br><span class="line"><span class="comment"># focus on the most frequently changing part, 然后查看指代什么行为</span></span><br><span class="line">watch -d <span class="string">'cat /proc/interrupts'</span></span><br><span class="line"><span class="comment"># RES 重调度中断</span></span><br></pre></td></tr></table></figure></p>
<p>如果系统的上下文切换次数比较稳定，那么从数百到一万以内，都应该算是正常的。但当上下文切换次数超过一万次，或者切换次数出现数量级的增长时，就很可能已经出现了性能问题。</p>
<p>这里比较一下2个测压工具:<br><code>stress</code> 基于多进程的，会fork多个进程，导致进程上下文切换，导致cpu %us开销很高；<br><code>sysbench</code> 基于多线程的，会创建多个线程，单一进程基于内核线程切换，导致cpu %sy的内核开销很高。</p>
<p>一些思路:<br>登录到服务器，现在系统负载怎么样。高的话有三种情况，首先是cpu使用率，其次是io使用率，之后就是两者都高。<br>cpu 使用率高，可能确实是使用率高，也的可能实际处理不高而是进程太多切换上下文频繁，也可能是进程内线程的上下文切换频繁。<br>io 使用率高，说明 io 请求比较大，可能是文件io，网络io.</p>
<p>这里你一定要记得，当碰到无法解释的 CPU 使用率问题时，先要检查一下是不是短时应用在捣鬼。短时应用的运行时间比较短，很难在 top 或者 ps 这类展示系统概要和进程快照的工具中发现，你需要使用记录事件的工具来配合诊断，比如 <code>execsnoop</code> 或者 <code>perf top</code>.</p>
<p>当 iowait 升高时，进程很可能因为得不到硬件的响应，而长时间处于不可中断状态。从 ps 或者 top 命令的输出中，你可以发现它们都处于 D 状态，也就是不可中断状态. D 状态的进程会导致平均负载升高， I 状态的进程却不会.</p>
<p>正常情况下，不可中断状态在很短时间内就会结束。所以，短时的不可中断状态进程，我们一般可以忽略. 如果系统或硬件发生了故障，进程可能会在不可中断状态D 保持很久，甚至导致系统中出现大量不可中断进程。这时，你就得注意下，系统是不是出现了 I/O 等性能问题。看僵尸进程，当一个进程创建了子进程后，它应该通过系统调用 wait() 或者 waitpid() 等待子进程结束，回收子进程的资源；而子进程在结束时，会向它的父进程发送 SIGCHLD 信号，所以，父进程还可以注册 <code>SIGCHLD</code> 信号的处理函数，异步回收资源。如果父进程没有处理子进程的终止，那么子进程就会一直处于僵尸状态。大量的僵尸进程会用尽 PID 进程号，导致新进程不能创建，所以这种情况一定要避免。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># versatile tool for generating system resource statistics</span></span><br><span class="line">dstat</span><br></pre></td></tr></table></figure>
<p>strace 正是最常用的跟踪进程系统调用的工具, 但僵尸进程都是已经退出的进程，所以就没法儿继续分析它的系统调用:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -f: trace threads generated</span></span><br><span class="line">strace -p &lt;pid&gt; [-f]</span><br></pre></td></tr></table></figure></p>
<p><a href="https://meenakshi02.wordpress.com/2011/02/02/strace-hanging-at-futex/" target="_blank" rel="noopener">strace hanging at futex, FUTEX_WAIT</a>: The process is multi-threaded, you are tracing the original parent thread, and it’s doing nothing but waiting for some other threads to finish.</p>
<p>If top, pidstat 这类工具已经不能给出更多的信息了。这时，我们就应该求助那些基于事件记录的动态追踪工具了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wait for 15 seconds</span></span><br><span class="line"><span class="comment"># crtl+c quit</span></span><br><span class="line">perf record -g</span><br><span class="line"><span class="comment"># check</span></span><br><span class="line">pert report</span><br></pre></td></tr></table></figure></p>
<p>iowait 高不一定代表 I/O 有性能瓶颈。当系统中只有 I/O 类型的进程在运行时，iowait 也会很高，但实际上，磁盘的读写远没有达到性能瓶颈的程度。碰到 iowait 升高时，需要先用 dstat, pidstat 等工具，确认是不是磁盘 I/O 的问题，然后再找是哪些进程导致了 I/O。</p>
<p>其实除了 iowait，<code>软中断(softirq)</code>导致 CPU 使用率升高也是最常见的一种性能问题。</p>
<p>为了解决中断处理程序执行过长和中断丢失的问题，Linux 将中断处理过程分成了两个阶段，也就是上半部和下半部：<br>上半部用来快速处理中断，它在中断禁止模式下运行，主要处理跟硬件紧密相关的或时间敏感的工作。<br>下半部用来延迟处理上半部未完成的工作，通常以内核线程的方式运行。</p>
<p>上半部直接处理硬件请求，也就是我们常说的硬中断，特点是快速执行；而下半部则是由内核触发，也就是我们常说的软中断，特点是延迟执行。</p>
<p>上半部会打断 CPU 正在执行的任务，然后立即执行中断处理程序。而下半部以内核线程的方式执行，并且每个 CPU 都对应一个软中断内核线程，名字为 “ksoftirqd/CPU编号”，比如说， 0 号 CPU 对应的软中断内核线程的名字就是 <code>ksoftirqd/0</code>。</p>
<p>经常听同事说大量的网络小包会导致性能问题，一直不太理解，从今天的课程来看，大量的小网络包会导致频繁的硬中断和软中断呢.软中断问题在大流量网络中最为常见. </p>
<p>注意cpu 使用率 和 load average 没有直接关系，这个在最开始提到过了，它们各自定义不一样。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test tool</span></span><br><span class="line"><span class="comment"># -S参数表示设置TCP协议的SYN（同步序列号），-p表示目的端口为80</span></span><br><span class="line"><span class="comment"># -i u100表示每隔100微秒发送一个网络帧</span></span><br><span class="line">hping3 -S -p 80 -i u100 192.168.0.30</span><br><span class="line"></span><br><span class="line"><span class="comment"># check cpu %si and %hi</span></span><br><span class="line"><span class="comment"># load average may be low</span></span><br><span class="line">top</span><br><span class="line"></span><br><span class="line"><span class="comment"># check softirq frequencies and category</span></span><br><span class="line"><span class="comment"># usually NET_RX ratio change a lot</span></span><br><span class="line">watch -d cat /proc/softirqs</span><br><span class="line"></span><br><span class="line"><span class="comment"># check network rx/tx packet vs KBS per second</span></span><br><span class="line"><span class="comment"># -n DEV 表示显示网络收发的报告，间隔1秒输出一组数据</span></span><br><span class="line"><span class="comment"># can calculate bytes/packet</span></span><br><span class="line">sar -n DEV 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># -i eth0 只抓取eth0网卡</span></span><br><span class="line"><span class="comment"># -n不解析协议名和主机名</span></span><br><span class="line"><span class="comment"># tcp port 80表示只抓取tcp协议并且端口号为80的网络帧</span></span><br><span class="line">tcpdump -i eth0 -n tcp port 80</span><br></pre></td></tr></table></figure></p>
<p>在tcpdump的输出中，观察<code>Flag[x]</code> 类型, 比如<code>Flag[S]</code> 表示SYN 包。可以找到source IP 并且通过防火墙隔离。</p>
<p>[ ] cassandra perf analysis find cause?<br>[x] why cassandra Sleep with high CPU usage? -&gt; multi-threads are running<br>[x] why process is <code>S</code> but some threads are <code>R</code>, parent is doing nothing but waiting children threads.</p>
<p>倪老师您好，我在网上看到一个关于iowait指标的解释，非常形象，但不确定是否准确，帮忙鉴别一下，谢谢，<br>链接 <a href="http://linuxperf.com/?p=33" target="_blank" rel="noopener">http://linuxperf.com/?p=33</a></p>
<p>sar -w 或者 sar -w 1 也能直观的看到每秒生成线程或者进程的数量。Brendan Gregg 确实是这个领域的大师，贡献了很多的技术理念和实践经验。他的《性能之巅》可以和本课对比着看，会有更多的理解.</p>
<h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><p>Understanding concepts:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Virtual_memory#Usage" target="_blank" rel="noopener">virtual memory</a></li>
<li><a href="https://en.wikipedia.org/wiki/Memory_management_unit" target="_blank" rel="noopener">MMU and page table</a></li>
<li><a href="https://unix.stackexchange.com/questions/472223/whats-the-use-of-having-a-kernel-part-in-the-virtual-memory-space-of-linux-proc" target="_blank" rel="noopener">kernal part in process virtual memory</a></li>
<li><a href="https://en.wikipedia.org/wiki/Page_(computer_memory" target="_blank" rel="noopener">page</a>)</li>
<li><a href="https://en.wikipedia.org/wiki/Page_fault" target="_blank" rel="noopener">paging fault</a></li>
</ul>
<p>这里查了一下tmpfs的解释和作用:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Tmpfs" target="_blank" rel="noopener">what is tmpfs</a></li>
<li><a href="https://segmentfault.com/a/1190000014737366" target="_blank" rel="noopener">tmpfs 详解</a><br>It is intended to appear as a mounted file system, but data is stored in volatile memory instead of a persistent storage device. A similar construction is a RAM disk, which appears as a virtual disk drive and hosts a disk file system. tmpfs is meant only for ephemeral files<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># resize mounted tmpfs size</span></span><br><span class="line"><span class="comment"># only temporary</span></span><br><span class="line">mount -o remount,size=300M tmpfs /dev/shm</span><br><span class="line"><span class="comment"># -T: see file system type</span></span><br><span class="line">df -hT</span><br><span class="line"></span><br><span class="line"><span class="comment"># create new tmpfs mounted</span></span><br><span class="line">mkdir /data</span><br><span class="line"><span class="comment"># -t: type</span></span><br><span class="line"><span class="comment"># -o: options</span></span><br><span class="line"><span class="comment"># second tmpfs: device name</span></span><br><span class="line">mount -t tmpfs -o size=100M tmpfs /data</span><br><span class="line">umount /data</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>tmpfs用途还是较广的，Linux中可以把一些程序的临时文件放置在tmpfs中，利用tmpfs比硬盘速度快的特点来提升系统性能.</p>
<p>需要理解<code>free</code>, <code>top</code>, <code>ps</code> 中关于memory 部分的含义, for example: buffers, cached, shared.</p>
<p><code>/proc</code> 是 Linux 内核提供的一种特殊文件系统，是用户跟内核交互的接口。比方说，用户可以从 /proc 中查询内核的运行状态和配置选项，查询进程的运行状态、统计数据等，当然，你也可以通过 /proc 来修改内核的配置.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># generate files</span></span><br><span class="line">dd <span class="keyword">if</span>=/dev/urandom of=/tmp/file bs=1M count=500</span><br><span class="line"><span class="comment"># check bi/bo and mem</span></span><br><span class="line">vmstat 1 20</span><br></pre></td></tr></table></figure></p>
<p>在读写普通文件时，会经过文件系统，由文件系统负责与磁盘交互；而读写磁盘或者分区时，就会跳过文件系统，也就是所谓的“裸I/O“。这两种读写方式所使用的缓存是不同的，也就是文中所讲的 Cache 和 Buffer 区别。</p>
<p>我的分析步骤：使用<code>top</code> 和 <code>ps</code> 查询系统中大量占用内存的进程，使用<code>cat /proc/[pid]/status</code>和<code>pmap -x &lt;pid&gt;</code>查看某个进程使用内存的情况和动态变化。</p>
<p>查看缓存的实际效果使用<code>缓存命中率</code>: 是指直接通过缓存获取数据的请求次数，占所有数据请求次数的百分比。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># read file</span></span><br><span class="line">dd <span class="keyword">if</span>=/tmp/file of=/dev/null bs=1M count=500</span><br><span class="line"></span><br><span class="line">yum install -y bcc-tools</span><br><span class="line"><span class="comment"># need to manually export</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/share/bcc/tools</span><br><span class="line"><span class="comment"># check overall cache hit rate</span></span><br><span class="line">cachestat 1 3</span><br><span class="line"><span class="comment"># check process cache hit rate</span></span><br><span class="line"><span class="comment"># similar to top command mechanism</span></span><br><span class="line"><span class="comment"># 3: 3 seconds update</span></span><br><span class="line">cachetop 3</span><br></pre></td></tr></table></figure></p>
<p>Investigate file cache size by <a href="https://github.com/tobert/pcstat" target="_blank" rel="noopener">pcstat</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install go first</span></span><br><span class="line"><span class="comment"># use go to fetch and install pcstat, see github page</span></span><br><span class="line">pcstat /bin/ls</span><br></pre></td></tr></table></figure></p>
<p>但同时也要注意，如果我们把 dd 当成测试文件系统性能的工具，由于缓存的存在，就会导致测试结果严重失真。所以测试前要查看文件在缓存中的大小，先清理一下缓存:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></table></figure></p>
<p>不过要注意，Buffers 和 Cache 都是操作系统来管理的，应用程序并不能直接控制这些缓存的内容和生命周期。所以，在应用程序开发中，一般要用专门的缓存组件，来进一步提升性能。比如，程序内部可以使用堆或者栈明确声明内存空间，来存储需要缓存的数据。再或者，使用 Redis 这类外部缓存服务，优化数据的访问效率。</p>
<p><code>dd</code>命令也支持直接IO的 有选项oflag和iflag 所以dd也可以用来绕过cache buff做测试, 注意直接IO和裸IO 不一样，直接IO是跳过Buffer，裸IO是跳过文件系统(还是有buffer的)。</p>
<p>还要注意的是，就算是第一次读，也会有缓存命中，因为系统会预读一部分到内存中，直接IO虽然跳过了buffer, 但cache hit rate is 100%，根据缓存命中次数(每次命中就是one page 4K size)，计算出在当时时间间隔中的命中大小: HITS <em> 1024 </em> 4K, 在除以时间间隔，就可知速率K/s.</p>
<p><code>dd</code> command <code>bs(block size)</code> option <a href="https://unix.stackexchange.com/questions/9432/is-there-a-way-to-determine-the-optimal-value-for-the-bs-parameter-to-dd" target="_blank" rel="noopener">value</a>, 4K is fine, for large storage hard drive, 1M is good to go, <code>bs</code> vaule deponds on your RAM size, it is the size that processed of each operation.</p>
<p>Memory leak, 理解内存的分配与回收，哪些虚拟内存段容易发生泄漏问题: heap and 内存映射段(包括动态链接库和共享内存，其中共享内存由程序动态分配和管理)。所以，如果程序在分配后忘了回收，就会导致跟堆内存类似的泄漏问题。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -r: mem statistic</span></span><br><span class="line"><span class="comment"># -S: swap statistic</span></span><br><span class="line"><span class="comment"># 3: refresh rate second</span></span><br><span class="line">sar -r -S 3</span><br><span class="line"><span class="comment"># in bcc-tools with cachestat and cachetop</span></span><br><span class="line">memleak -a -p $(pidof app_name)</span><br></pre></td></tr></table></figure></p>
<p>memleak的输出结果中addr 表示分配的地址，然后后面会给出哪个stack请求的分配，列出了相关调用。<br>还有一个常见的内存debug tool: <code>valgrind</code>.</p>
<p>文件页(file-backed page) 和 匿名页(anonymous page)的区别和回收.</p>
<p>了解swap的机制。<code>watermark</code> 也就是阈值。<br>事实上不仅 hadoop，包括 ES 在内绝大部分 Java 的应用都建议关 swap，这个和 JVM 的 gc 有关，它在 gc 的时候会遍历所有用到的堆的内存，如果这部分内存是被 swap 出去了，遍历的时候就会有磁盘IO。</p>
<p><a href="https://jvns.ca/blog/2017/02/17/mystery-swap/" target="_blank" rel="noopener">Swapping, memory limits, and cgroups</a>.<br>开启swapping 会使cgroup memory limit失效。</p>
<p>用<code>smem --sort swap</code>命令可以直接将进程按照swap使用量排序显示.</p>
<p>记录被OOM杀掉的进程:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dmesg | grep -E <span class="string">"kill|oom|out of memory"</span></span><br></pre></td></tr></table></figure></p>
<p>[ ] cgroup mem vs proc mem data? <a href="https://www.cnblogs.com/muahao/p/9593869.html" target="_blank" rel="noopener">https://www.cnblogs.com/muahao/p/9593869.html</a></p>
<h2 id="I-O"><a href="#I-O" class="headerlink" title="I/O"></a>I/O</h2><p>在 Linux 中一切皆文件。不仅普通的文件和目录，就连块设备、套接字、管道等，也都要通过统一的文件系统来管理。<br>为了方便管理，Linux 文件系统为每个文件都分配两个数据结构，索引节点（index node）和目录项（directory entry）.</p>
<p>索引节点，简称为 inode，用来记录文件的元数据，比如 inode 编号、文件大小、访问权限、修改日期、数据的位置等。索引节点和文件一一对应，它跟文件内容一样，都会被持久化存储到磁盘中。所以记住，索引节点同样占用磁盘空间(<code>df -i &lt;dir&gt;</code>)。</p>
<p>目录项，简称为 dentry，用来记录文件的名字、索引节点指针以及与其他目录项的关联关系。多个关联的目录项，就构成了文件系统的目录结构。不过，不同于索引节点，目录项是由内核维护的一个内存数据结构，所以通常也被叫做目录项缓存。</p>
<p>实际上，磁盘读写的最小单位是扇区，然而扇区只有 512B 大小，如果每次都读写这么小的单位，效率一定很低。所以，文件系统又把连续的扇区组成了逻辑块，然后每次都以逻辑块为最小单元，来管理数据。常见的逻辑块大小为 4KB，也就是由连续的 8 个扇区组成。</p>
<p>目录项、索引节点、逻辑块以及超级块，构成了 Linux 文件系统的四大基本要素。不过，为了支持各种不同的文件系统，Linux 内核在用户进程和文件系统的中间，又引入了一个抽象层，也就是虚拟文件系统 <code>VFS(Virtual File System)</code>。</p>
<p>VFS 定义了一组所有文件系统都支持的数据结构和标准接口。这样，用户进程和内核中的其他子系统，只需要跟 VFS 提供的统一接口进行交互就可以了，而不需要再关心底层各种文件系统的实现细节。</p>
<p>文件读写方式的各种差异，导致 I/O 的分类多种多样。最常见的有，缓冲与非缓冲 I/O、直接与非直接 I/O、阻塞与非阻塞 I/O、同步与异步 I/O 等。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check dentry and inode cache</span></span><br><span class="line">cat /proc/slabinfo | grep -E <span class="string">'^#|dentry|inode'</span></span><br><span class="line"><span class="comment"># dispaly kernel slab cache real time</span></span><br><span class="line">slabtop</span><br></pre></td></tr></table></figure></p>
<p>衡量磁盘IO性能, 须要提到五个常见指标，也就是我们经常用到的，使用率、饱和度、IOPS、吞吐量以及响应时间.<br>在数据库、大量小文件等这类随机读写比较多的场景中，IOPS 更能反映系统的整体性能；而在多媒体等顺序读写较多的场景中，吞吐量才更能反映系统的整体性能。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -d: Display the device utilization report</span></span><br><span class="line"><span class="comment"># -x: Display extended statistics</span></span><br><span class="line">iostat -d -x 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># process io statistic</span></span><br><span class="line">pidstat -d 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># sort by io</span></span><br><span class="line">iotop</span><br><span class="line"></span><br><span class="line"><span class="comment"># trace system calls</span></span><br><span class="line">strace -p &lt;pid&gt;</span><br><span class="line"><span class="comment"># -f: show threads system calls</span></span><br><span class="line">strace -f -p &lt;pid&gt;</span><br><span class="line"><span class="comment"># -T: 显示系统调用的时长</span></span><br><span class="line"><span class="comment"># -tt: 显示跟踪时间</span></span><br><span class="line">strace -f -T -tt -p &lt;pid&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># -t: show threads</span></span><br><span class="line"><span class="comment"># -a: show command</span></span><br><span class="line">pstree -t -a -p &lt;pid&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># check open files</span></span><br><span class="line"><span class="comment"># note use pid not tid(please use its parent pid)</span></span><br><span class="line">lsof -p &lt;pid&gt;</span><br></pre></td></tr></table></figure></p>
<p>你可以用 iostat 获得磁盘的 I/O 情况，也可以用 pidstat、iotop 等观察进程的 I/O 情况。<br>使用率是从时间角度衡量I/O，但是磁盘还可以支持并行写，所以即使使用率100%，有可能还可以接收新的I/O（不饱和）</p>
<p>很有意思的思路:<br>一般来说，生产系统的应用程序，应该有动态调整日志级别的功能。继续查看源码，你会发现，这个程序也可以调整日志级别。如果你给它发送 SIGUSR1 信号，就可以把日志调整为 INFO 级；发送 SIGUSR2 信号，则会调整为 WARNING 级</p>
<p>在排查应用程序问题时，我们可能需要，在线上环境临时开启应用程序的调试日志。有时候，事后一不小心就忘了调回去。没把线上的日志调高到警告级别，可能会导致 CPU 使用率、磁盘 I/O 等一系列的性能问题，严重时，甚至会影响到同一台服务器上运行的其他应用程序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File reads and writes by filename and process. Top for files</span></span><br><span class="line">filetop</span><br><span class="line"></span><br><span class="line"><span class="comment"># Trace open() syscalls. Uses Linux eBPF/bcc</span></span><br><span class="line">opensnoop</span><br></pre></td></tr></table></figure>
<p>MySQL 的 MyISAM 引擎，主要依赖系统缓存加速磁盘 I/O 的访问。可如果系统中还有其他应用同时运行， MyISAM 引擎很难充分利用系统缓存。缓存可能会被其他应用程序占用，甚至被清理掉。所以，不建议把应用程序的性能优化完全建立在系统缓存上。最好能在应用程序的内部分配内存，构建完全自主控制的缓存；或者使用第三方的缓存应用，比如 Memcached、Redis 等。</p>
<p>学习了redis的一些特性和配置。</p>
<p>为了更客观合理地评估优化效果，我们首先应该对磁盘和文件系统进行基准测试，得到文件系统或者磁盘 I/O 的极限性能。fio 文件系统和磁盘 I/O 性能基准测试工具, fio  is  a tool that will spawn a number of threads or processes doing a particular type of I/O action as specified by the user.  The typical use of fio is to write a job file matching the I/O load one wants to simulate:</p>
<blockquote>
<p>Note that 用磁盘路径测试写，会破坏这个磁盘中的文件系统，所以在使用前，你一定要事先做好数据备份。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 随机读</span></span><br><span class="line">fio -name=randread -direct=1 -iodepth=64 -rw=randread -ioengine=libaio -bs=4k -size=1G -numjobs=1 -runtime=1000 -group_reporting -filename=/dev/sdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机写</span></span><br><span class="line">fio -name=randwrite -direct=1 -iodepth=64 -rw=randwrite -ioengine=libaio -bs=4k -size=1G -numjobs=1 -runtime=1000 -group_reporting -filename=/dev/sdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 顺序读</span></span><br><span class="line">fio -name=<span class="built_in">read</span> -direct=1 -iodepth=64 -rw=<span class="built_in">read</span> -ioengine=libaio -bs=4k -size=1G -numjobs=1 -runtime=1000 -group_reporting -filename=/dev/sdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 顺序写</span></span><br><span class="line">fio -name=write -direct=1 -iodepth=64 -rw=write -ioengine=libaio -bs=4k -size=1G -numjobs=1 -runtime=1000 -group_reporting -filename=/dev/sdb</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>fio 支持 I/O 的重放。借助前面提到过的 blktrace，再配合上 fio，就可以实现对应用程序 I/O 模式的基准测试。你需要先用 blktrace ，记录磁盘设备的 I/O 访问情况；然后使用 fio ，重放 blktrace 的记录。我们就通过 blktrace+fio 的组合使用，得到了应用程序 I/O 模式的基准测试报告.</p>
<p>还谈到了磁盘优化的几个方面，比较深入了，不太理解.<br>平常没机会从系统层面优化磁盘性能参数。<br>能做的就是减少磁盘写入，以及错峰操作磁盘。<br>比如在凌晨或业务低谷时，压缩备份日志，减少对正常业务的影响。</p>
<p>[ ] <a href="https://stackoverflow.com/questions/9305992/if-threads-share-the-same-pid-how-can-they-be-identified" target="_blank" rel="noopener">If threads share the same PID, how can they be identified?</a><br>[ ] <a href="https://github.com/feiskyer/linux-perf-examples/blob/master/mysql-slow/Makefile" target="_blank" rel="noopener">Makefile launches docker container</a><br>[ ] <a href="https://github.com/jpetazzo/nsenter" target="_blank" rel="noopener">nsenter</a> 这个和docker exec 有关系，和我之前提到的理解错误的docker login 问题有联系. 可以看一下readme. 认真研究一下这个工具.</p>
<h2 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h2><p>本质上是一种进程间通信方式，特别是跨系统的进程间通信，必须要通过网络才能进行。随着高并发、分布式、云计算、微服务等技术的普及，网络的性能也变得越来越重要。</p>
<p>网络接口配置的最大传输单元（MTU），就规定了最大的 IP 包大小。在我们最常用的以太网中，MTU 默认值是 1500（这也是 Linux 的默认值).<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check virtual NI</span></span><br><span class="line">ls -l /sys/class/net</span><br></pre></td></tr></table></figure></p>
<p>实际上，我们通常用带宽、吞吐量、延时、PPS（Packet Per Second）等指标衡量网络的性能。除了这些指标，网络的可用性（网络能否正常通信）、并发连接数（TCP 连接数量）、丢包率（丢包百分比）、重传率（重新传输的网络包比例）等也是常用的性能指标。</p>
<p>而对 TCP 或者 Web 服务来说，更多会用并发连接数和每秒请求数（QPS，Query per Second）等指标，</p>
<p>查看网络配置:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -s: statistic, show RX and TX</span></span><br><span class="line">ip -s a s</span><br><span class="line"><span class="comment"># multiple -s, show more info</span></span><br><span class="line">ip -s -s a s</span><br></pre></td></tr></table></figure></p>
<p>查看套接字socket:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -l 表示只显示监听套接字</span></span><br><span class="line"><span class="comment"># -t 表示只显示 TCP 套接字</span></span><br><span class="line"><span class="comment"># -n 表示显示数字地址和端口(而不是名字)</span></span><br><span class="line"><span class="comment"># -p 表示显示进程信息</span></span><br><span class="line">netstat -nlp | head</span><br><span class="line">ss -ltnp | head</span><br><span class="line"></span><br><span class="line"><span class="comment"># 协议栈protocol stack statistic</span></span><br><span class="line">netstat -s</span><br><span class="line">ss -s</span><br></pre></td></tr></table></figure></p>
<p>查看throughput and PPS<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check bandwidth</span></span><br><span class="line">ethtool eth0 | grep -i speed</span><br><span class="line"><span class="comment"># -n: network</span></span><br><span class="line"><span class="comment"># DEV EDEV TCP UDP ICMP, etc</span></span><br><span class="line">sar -n DEV 1</span><br></pre></td></tr></table></figure></p>
<p>查看delay:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping</span><br></pre></td></tr></table></figure></p>
<p>Linux 内核自带的高性能网络测试工具 <code>pktgen</code>, 需要加载内核模块. 用来测试PPS.<br>TCP/UDP 性能测试: <code>iperf3</code>.<br>HTTP 性能: <code>ab</code>, <code>webbench</code>, 如果需要mock 负载，使用<code>wrk</code>.</p>
<p>DNS 不仅方便了人们访问不同的互联网服务，更为很多应用提供了，动态服务发现和全局负载均衡（Global Server Load Balance，GSLB）的机制。这样，DNS 就可以选择离用户最近的 IP 来提供服务。</p>
<p>注意查询IP指定的name server不同，得到的IP也可能不同。</p>
<p><code>dig</code> can show the recurring query steps:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># +trace: enable trace</span></span><br><span class="line"><span class="comment"># +nodnssec: 表示禁止DNS安全扩展</span></span><br><span class="line">dig +trace +nodnssec time.geekbang.org</span><br><span class="line"><span class="comment"># check time use Queryrime field</span></span><br><span class="line">dig time.geekbang.org</span><br></pre></td></tr></table></figure></p>
<p>nslookup debug mode, used when lookup failed:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nslookup -debug &lt;hostname&gt;</span><br><span class="line">time nslookup xxx</span><br></pre></td></tr></table></figure></p>
<p>在应用程序的开发过程中，我们必须考虑到 DNS 解析可能带来的性能问题，掌握常见的优化方法.<br>碰到dns问题最多的就是劫持，现在公网都是强制https，内部用powerdns(open source).</p>
<p>在实际分析网络性能时，先用 tcpdump 抓包，后用 Wireshark 分析，也是一种常用的方法。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁止接收从DNS服务器发送过来并包含googleusercontent的包</span></span><br><span class="line">iptables -I INPUT -p udp --sport 53 -m string --string googleusercontent --algo bm -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># packet catch</span></span><br><span class="line">tcpdump -nn udp port 53 or host 35.190.27.188</span><br><span class="line"></span><br><span class="line"><span class="comment"># -n: forbid ptr</span></span><br><span class="line">ping -n -c2 google.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># ptr 查询35.190.27.188的域名</span></span><br><span class="line">nslookup -<span class="built_in">type</span>=PTR 35.190.27.188 8.8.8.8</span><br></pre></td></tr></table></figure></p>
<p>实际上，根据 IP 地址反查域名、根据端口号反查协议名称，是很多网络工具默认的行为，而这往往会导致性能工具的工作缓慢.</p>
<p>[ ] <a href="https://www.computerhope.com/unix/dmesg.htm" target="_blank" rel="noopener">Linux ring buffer with dmesg</a><br>[ ] <a href="https://stackoverflow.com/questions/47450231/what-is-the-relationship-of-dma-ring-buffer-and-tx-rx-ring-for-a-network-card" target="_blank" rel="noopener">DMA ring</a><br>[ ] <a href="https://blog.cloudflare.com/conntrack-tales-one-thousand-and-one-flows/" target="_blank" rel="noopener">conntrack module</a><br>[ ] <a href="https://mp.weixin.qq.com/s/VYBs8iqf0HsNg9WAxktzYQ" target="_blank" rel="noopener">Diagnose NAT issue</a><br>[ ] <a href="https://coolshell.cn/about" target="_blank" rel="noopener">酷壳</a><br>[ ] <a href="https://www.tcpdump.org/manpages/tcpdump.1.html" target="_blank" rel="noopener">tcpdump man</a><br>[ ] <a href="https://www.wireshark.org/docs/" target="_blank" rel="noopener">wireshark doc</a><br>[ ] <a href="https://www.quora.com/What-is-the-difference-between-the-edge-trigger-and-the-level-trigger-in-epoll" target="_blank" rel="noopener">level-triggered vs edge-triggered</a><br>[ ] <a href="https://www.zhihu.com/question/22756773" target="_blank" rel="noopener">thundering herd 惊群</a><br>[ ] 不懂的很多。。可以从go network programming开始学习? 网络学习吃力的同学，先去把林沛满老师两本Wireshark分析网络看完<br>[ ] hping3 a network penetration test tool, security auditiing, fw test</p>
<p>[ ] blog <a href="https://blog.openresty.com.cn/cn/dynamic-tracing/#%E4%BB%80%E4%B9%88%E6%98%AF%E5%8A%A8%E6%80%81%E8%BF%BD%E8%B8%AA" target="_blank" rel="noopener">动态追踪技术漫谈</a></p>
<h1 id="From-LinkedIn-Learning"><a href="#From-LinkedIn-Learning" class="headerlink" title="From LinkedIn Learning"></a>From LinkedIn Learning</h1><p><code>time</code> in shell is a keyword, it is also a command, they have different output.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum install -y time</span><br><span class="line"></span><br><span class="line"><span class="comment"># use time yum installed</span></span><br><span class="line"><span class="comment"># also show major and minor page faults</span></span><br><span class="line">$(<span class="built_in">which</span> time) sleep 1</span><br><span class="line">0.00user 0.00system 0:01.00elapsed 0%CPU (0avgtext+0avgdata 644maxresident)k</span><br><span class="line">0inputs+0outputs (0major+205minor)pagefaults 0swaps</span><br><span class="line"></span><br><span class="line"><span class="comment"># use shell keyword time</span></span><br><span class="line">time sleep 1</span><br><span class="line"><span class="comment"># user and sys is cpu time on user and system space</span></span><br><span class="line"><span class="comment"># user + sys could be larger than real time if your program</span></span><br><span class="line"><span class="comment"># uses multi-cores</span></span><br><span class="line">real	0m1.002s</span><br><span class="line">user	0m0.000s</span><br><span class="line">sys	0m0.001s</span><br></pre></td></tr></table></figure></p>
<p>If you want to test performance of 2 similar commands, put each in a loop and <code>time</code> it as a whole to see the differences, or using <code>strace -c -o /tmp/result.out ./script</code> and <code>head</code> the first several lines of the result to see what system calls cost much.</p>
<p><code>/proc</code> is mounted at boot time, see mount detail by <code>mount | grep proc</code> command. proc files provide kernel info, printing the contents of the proc file causes the corresponding function in the kernel to be called to produce fresh value. we can also write to proc file to change kernal parameters. <code>/proc</code> is a pseudo filesystem, so <code>ls -l</code> the length may be 0.</p>
<p><code>/proc</code> files under <code>/proc/sys</code> represent kernel variables.</p>
<h2 id="CPU-1"><a href="#CPU-1" class="headerlink" title="CPU"></a>CPU</h2><p>Packages for performance tools, yum install them and <code>rpm -ql</code> to see utilities contained:</p>
<ul>
<li>sysstat: iostat, mpstat, nfsiostat-sysstat, pidstat, <strong>sar</strong></li>
<li>procps-ng: free, pmap, ps, since, tload, <strong>top</strong>, uptime, vmstat, watch</li>
<li>perf: <code>sudo perf record find / -xdev -name core &gt;/dev/null 2&gt;&amp;1; sudo perf report</code></li>
</ul>
<p>主要说了sar, top, cpuinfo 以及scheduling priority and nice value. (具体记录在其他blog中，搜一下关键字)</p>
<p><code>Throughput</code>, important for server, fewer context switch and longer time silces. throughput 和 responsiveness 需要权衡，好的throughput 意味着尽可能run 单一的任务，这样context switch就少. <code>Responsiveness</code>, important for interactive or control system, requires quick context switch and shorter time slices and less page faults.</p>
<p>Can configure the kernel to preemptible or not, preemption means context switch.</p>
<p>Linux kernel has 3 choices for the kind of <code>preemption</code> it employs.</p>
<ul>
<li>None: no preemption</li>
<li>Voluntary: kernel checks frequently for placement (the most commonly choice)</li>
<li>Preempt: schedule preempts unless kernel is in a critical section.</li>
</ul>
<h2 id="Memory-1"><a href="#Memory-1" class="headerlink" title="Memory"></a>Memory</h2><p><code>/proc/meminfo</code> file, the <code>MemAvailable</code> value is space for program without swapping (includes reclaimable cache and buffer), important.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">MemTotal:</span>       <span class="number">32779460</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">MemFree:</span>          <span class="number">239788</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">MemAvailable:</span>    <span class="number">3996032</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Buffers:</span>              <span class="number">20</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Cached:</span>          <span class="number">5797312</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">SwapCached:</span>            <span class="number">0</span> <span class="string">kB</span></span><br><span class="line"><span class="attr">Active:</span>          <span class="number">4435144</span> <span class="string">kB</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure></p>
<p><code>htop</code> command is similar to <code>top</code> but with colorful display. From the options you will sort by different categories, e.g. %CPU, $MEM, etc.</p>
<p><code>Translation lookaside buffer</code>(TLB), use for virtual address mapped to physical addresses. Linux supportss having huge pages, can use <code>sysctl</code> config at runtime or during bootstrap (/etc/sysctl.d).</p>
<p><code>Page faults</code>, a process uses an address that is not mapped or even not RAM resident. minor or major page faults, minor is not a big deal, major has disk I/O involved, much slower. Linux is on-demand page system. (how linux works 这本书也提到了)</p>
<h2 id="Disk"><a href="#Disk" class="headerlink" title="Disk"></a>Disk</h2><p><code>atop</code> command is also helpful.</p>
<p>后面谈到了如何测试不同filesystem 的performance, 可以用dd 生成大文件用作loop device, 格式化为不用的filesystem，然后mount，随后进行大量的文件或文件夹创建，记录时间，在对文件和文件夹进行操作，记录时间.</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag"># linux</a>
          
            <a href="/tags/performance/" rel="tag"># performance</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/01/04/infra-terraform-deep/" rel="next" title="Terraform Deep Dive">
                <i class="fa fa-chevron-left"></i> Terraform Deep Dive
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/02/12/k8s-rebind-pv/" rel="prev" title="Rebinding Release PV with PVC">
                Rebinding Release PV with PVC <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">260</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">42</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">146</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#From-极客时间"><span class="nav-number">1.</span> <span class="nav-text">From 极客时间</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU"><span class="nav-number">1.1.</span> <span class="nav-text">CPU</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory"><span class="nav-number">1.2.</span> <span class="nav-text">Memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#I-O"><span class="nav-number">1.3.</span> <span class="nav-text">I/O</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Network"><span class="nav-number">1.4.</span> <span class="nav-text">Network</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#From-LinkedIn-Learning"><span class="nav-number">2.</span> <span class="nav-text">From LinkedIn Learning</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU-1"><span class="nav-number">2.1.</span> <span class="nav-text">CPU</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory-1"><span class="nav-number">2.2.</span> <span class="nav-text">Memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Disk"><span class="nav-number">2.3.</span> <span class="nav-text">Disk</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="Symbols count total">1.2m</span>
  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
