<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="//TODO: [ ] see reading section [ ] series https://blog.freshtracks.io/a-deep-dive-into-kubernetes-metrics-b190cc97f0f6 [ ] prom config with service discovry, for example consul Docker Compose Demo Gi">
<meta name="keywords" content="prometheus">
<meta property="og:type" content="article">
<meta property="og:title" content="Prometheus Quick Start">
<meta property="og:url" content="http://yoursite.com/2021/09/19/monitor-prometheus/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="//TODO: [ ] see reading section [ ] series https://blog.freshtracks.io/a-deep-dive-into-kubernetes-metrics-b190cc97f0f6 [ ] prom config with service discovry, for example consul Docker Compose Demo Gi">
<meta property="og:locale" content="中文|English">
<meta property="og:image" content="https://drive.google.com/uc?id=1WrobLras0BsfiVB_RphmprnA6-6Dm83U">
<meta property="og:updated_time" content="2023-09-17T23:04:12.764Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Prometheus Quick Start">
<meta name="twitter:description" content="//TODO: [ ] see reading section [ ] series https://blog.freshtracks.io/a-deep-dive-into-kubernetes-metrics-b190cc97f0f6 [ ] prom config with service discovry, for example consul Docker Compose Demo Gi">
<meta name="twitter:image" content="https://drive.google.com/uc?id=1WrobLras0BsfiVB_RphmprnA6-6Dm83U">






  <link rel="canonical" href="http://yoursite.com/2021/09/19/monitor-prometheus/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Prometheus Quick Start | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">159</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">48</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">295</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/19/monitor-prometheus/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Prometheus Quick Start

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-09-19 14:01:32" itemprop="dateCreated datePublished" datetime="2021-09-19T14:01:32-07:00">2021-09-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2023-09-17 16:04:12" itemprop="dateModified" datetime="2023-09-17T16:04:12-07:00">2023-09-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Monitor/" itemprop="url" rel="index"><span itemprop="name">Monitor</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>//TODO:
[ ] see reading section
[ ] series <a href="https://blog.freshtracks.io/a-deep-dive-into-kubernetes-metrics-b190cc97f0f6" target="_blank" rel="noopener">https://blog.freshtracks.io/a-deep-dive-into-kubernetes-metrics-b190cc97f0f6</a>
[ ] prom config with service discovry, for example consul</p>
<h1>Docker Compose Demo</h1>
<p>Github repo:
<a href="https://github.com/chengdol/InfraTree/tree/master/docker-monitoring" target="_blank" rel="noopener">https://github.com/chengdol/InfraTree/tree/master/docker-monitoring</a></p>
<p>The steps are in README.</p>
<h1>Prometheus</h1>
<p>Open-source monitoring and alerting system:
<a href="https://prometheus.io/" target="_blank" rel="noopener">https://prometheus.io/</a>
Prometheus collects and stores its metrics as <code>time-series</code> data, i.e. metrics
information is stored with the timestamp at which it was recorded, alongside
optional <code>key-value</code> pairs called labels.</p>
<p>Architecture
<img src="https://drive.google.com/uc?id=1WrobLras0BsfiVB_RphmprnA6-6Dm83U" alt=""></p>
<p>Learning targets:</p>
<ul>
<li>Know how to set up prometheus cluster for testing purpose</li>
<li>Know how to <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/" target="_blank" rel="noopener">configure</a> prometheus/alertmanager/grafana</li>
<li>Know how to export different kind of metrics</li>
<li>Know how to <code>PromQL</code></li>
<li>Know how to integrate with Grafana</li>
</ul>
<h2 id="Metric-type">Metric type</h2>
<p>Explanation (counter, gauge, histogram, summary):
<a href="https://www.youtube.com/watch?v=nJMRmhbY5hY" target="_blank" rel="noopener">https://www.youtube.com/watch?v=nJMRmhbY5hY</a></p>
<p><strong>Conuter</strong>: request count, task completed, error count, etc.
Query how fast the value is increasing, <code>rate()</code> only applies for <code>counter</code> as
it is monotonic increasing.</p>
<p><strong>Guage</strong>: memory usage, queue size, kafka lag, etc.
For example, <code>avg_over_time()</code> on gauge type.</p>
<p><strong>Histogram</strong>: duration of http request, response size, etc.
To late calculate average and percentile, happy with approximation.
You can use default bucket or customizing your own.
The vaule in bucket is accumulated, add to all buckets that greater than current value.</p>
<p><strong>Summary</strong>: duration of http request, response size, etc.
complex than Histogram, no idea the value range so cannot histogram.</p>
<h2 id="PromQL">PromQL</h2>
<p>First, understand <a href="https://prometheus.io/docs/concepts/metric_types/" target="_blank" rel="noopener">metric type</a> in prometheus
<a href="https://www.youtube.com/watch?v=nJMRmhbY5hY" target="_blank" rel="noopener">https://www.youtube.com/watch?v=nJMRmhbY5hY</a></p>
<p>Helpful promQL visualizing tool, cheat sheet:
<a href="https://promlabs.com/promql-cheat-sheet" target="_blank" rel="noopener">https://promlabs.com/promql-cheat-sheet</a></p>
<p>How to know <a href="https://prometheus.io/docs/concepts/data_model/#metric-names-and-labels" target="_blank" rel="noopener"><strong>labels</strong></a>
of a specific metric? Using prometheus query browser run metric name and see the
console output, it will contains all labels of that metric.</p>
<h2 id="Alert-Expr">Alert Expr</h2>
<h3 id="Excluding-Time-Slot-from-Alert-Expr"><a href="https://stackoverflow.com/questions/59157537/how-to-snooze-prometheus-alert-for-specific-time" target="_blank" rel="noopener">Excluding Time Slot from Alert Expr</a></h3>
<p>This is helpful as we know it is no-ops. Now Prometheus supports
<a href="https://github.com/prometheus/alertmanager/pull/2393" target="_blank" rel="noopener">time-based muting</a>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># excluding specific time slot</span></span><br><span class="line">some_metrics_vector and ON() absent(day_of_week() == 0 AND hour() &gt;=3 &lt; 4 AND minute() &gt;= 10 &lt; 50)</span><br></pre></td></tr></table></figure>
<p>The explanation please see
<a href="https://www.robustperception.io/combining-alert-conditions" target="_blank" rel="noopener">here</a>, so for
logical operators they are case-insensitive, <code>and</code> or <code>AND</code>, either is fine.</p>
<p>You can verify in prometheus expression browser first then writing to alert expr.</p>
<p><strong>Tips:</strong>:
In alert debug, to see label instance or job value in description, for example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">'<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> is not responding for 10 minutes.'</span></span><br><span class="line"><span class="string">```</span> </span><br><span class="line"><span class="string">Just</span> <span class="string">run</span> <span class="string">that</span> <span class="string">alert</span> <span class="string">expression</span> <span class="string">manually</span> <span class="string">in</span> <span class="string">expression</span> <span class="string">browser,</span> <span class="string">modify</span> <span class="string">the</span> <span class="string">alert</span></span><br><span class="line"><span class="string">expression</span> <span class="string">to</span> <span class="string">see</span> <span class="string">the</span> <span class="string">output</span> <span class="string">labels.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### [Capture the Counter First Event](https://stackoverflow.com/questions/66532785/prometheus-alerting-rule-not-detecting-first-time-metric-increase)</span></span><br><span class="line"><span class="string">There</span> <span class="string">is</span> <span class="string">case</span> <span class="string">the</span> <span class="string">we</span> <span class="string">want</span> <span class="string">to</span> <span class="string">capture</span> <span class="string">the</span> <span class="string">first</span> <span class="number">0</span><span class="string">(non-existence)</span> <span class="bullet">-&gt;</span> <span class="number">1</span> <span class="string">counter</span></span><br><span class="line"><span class="string">event</span> <span class="string">and</span> <span class="string">fire</span> <span class="string">alert,</span> <span class="string">this</span> <span class="string">can</span> <span class="string">be</span> <span class="string">captured</span> <span class="string">by</span> <span class="string">`unless`</span> <span class="string">+</span> <span class="string">`offset`,</span> <span class="string">and</span> <span class="string">after</span> <span class="number">1</span></span><br><span class="line"><span class="string">we</span> <span class="string">can</span> <span class="string">use</span> <span class="string">increase</span> <span class="string">to</span> <span class="attr">catch:</span></span><br><span class="line"></span><br><span class="line"><span class="string">```bash</span></span><br><span class="line"><span class="comment"># ((0 -&gt; 1 case capture) or (1 -&gt; 1+ case capture))</span></span><br><span class="line"><span class="string">((_metric_counter_</span> <span class="string">unless</span> <span class="string">_metric_counter_</span> <span class="string">offset</span> <span class="number">15</span><span class="string">m)</span> <span class="string">or</span> <span class="string">(increase(_metric_counter_[15m])))</span> <span class="string">&gt; 0</span></span><br></pre></td></tr></table></figure>
<h1>Query Example</h1>
<p>Here I list some examples to explain and practice common PromQL. Part of them
are from Grafana dashboard as they have embedded variables, but the syntax and
usage is the same in prometheus expression browser and Grafana.</p>
<p>Understand <code>instant</code> and <code>range</code> vector and how <code>rate</code> and <code>irate</code> works:
<a href="https://www.metricfire.com/blog/understanding-the-prometheus-rate-function/" target="_blank" rel="noopener">https://www.metricfire.com/blog/understanding-the-prometheus-rate-function/</a></p>
<p><code>rate</code>(average rate!) or <code>irate</code>(instant rate, last 2 data points only)
calculates the per-second average rate of how fast a value is increasing over a
period of time, they automatically adjusts for counter resets. If you want to
use any other aggregation(such as <code>sum</code>) together with <code>rate</code> then you must
apply <code>rate</code> first, otherwise the counter resets will not be caught and you will
get weird results.</p>
<p><code>irate</code>(spike) should only be used when graphing volatile, fast-moving counters.</p>
<p>Use <code>rate</code>(trend) for alerts and slow-moving counters, as brief changes in the
<code>rate</code> can reset the FOR clause and graphs consisting entirely of rare spikes
are hard to read.</p>
<p>Also remember <code>rate</code> first then aggregation rather than inversely
<a href="https://www.robustperception.io/rate-then-sum-never-sum-then-rate" target="_blank" rel="noopener">https://www.robustperception.io/rate-then-sum-never-sum-then-rate</a></p>
<p>For <code>group_left</code>(many to one!) and <code>group_right</code>(one to many!), here is the
<a href="https://www.robustperception.io/using-group_left-to-calculate-label-proportions" target="_blank" rel="noopener">example</a>.</p>
<p>One query example for system load average dashboard:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $&#123;interval&#125;, $&#123;load&#125;, $&#123;service&#125;, $env: </span></span><br><span class="line"><span class="comment"># these variables are defined from by dashboard config variables</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># explain on label_replace</span></span><br><span class="line"><span class="comment"># 在avg_over_time()得到的向量中，对于instance这个label，看是否match $env-(.+) 这个正则表达式</span></span><br><span class="line"><span class="comment"># 如果有match，则$1 就是对应正则中的第一个(.+)的真实值，然后在label_replace返回的新向量中，增加一个</span></span><br><span class="line"><span class="comment"># label name=$1，如果没有match，则返回原来的向量</span></span><br><span class="line">avg(</span><br><span class="line">label_replace(avg_over_time(node_load<span class="variable">$&#123;load&#125;</span>&#123;instance=~<span class="string">"^.+-<span class="variable">$&#123;service:regex&#125;</span>-[0-9]+$"</span>&#125;[<span class="variable">$&#123;interval&#125;</span>]),</span><br><span class="line"><span class="string">"instance_group"</span>,</span><br><span class="line"><span class="string">"<span class="variable">$1</span>"</span>,</span><br><span class="line"><span class="string">"instance"</span>,</span><br><span class="line"><span class="string">"<span class="variable">$env</span>-(.+)"</span>)</span><br><span class="line">) by (instance_group) &gt; 6</span><br><span class="line"><span class="comment"># then average the new vector, group it by instance_group label and check if the average group level LA &gt; 6</span></span><br></pre></td></tr></table></figure>
<p>Above varaibles are Query type:
<a href="https://grafana.com/docs/grafana/latest/variables/variable-types/add-query-variable/" target="_blank" rel="noopener">https://grafana.com/docs/grafana/latest/variables/variable-types/add-query-variable/</a></p>
<h1>Grafana</h1>
<p>As the key visual component of monitoring system, please see the separate post
<code>&lt;&lt;Grafana Quick Start&gt;&gt;</code></p>
<h1>AlertManager</h1>
<p>How to connect alertmaneger to prometheus:
<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#alertmanager_config" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#alertmanager_config</a></p>
<p>How to config alertmanager itself:
<a href="https://prometheus.io/docs/alerting/latest/configuration/" target="_blank" rel="noopener">https://prometheus.io/docs/alerting/latest/configuration/</a></p>
<p>Config example to start:
<a href="https://github.com/prometheus/alertmanager/blob/main/doc/examples/simple.yml" target="_blank" rel="noopener">https://github.com/prometheus/alertmanager/blob/main/doc/examples/simple.yml</a>
Tool to generate routing tree:
<a href="https://prometheus.io/docs/alerting/latest/configuration/" target="_blank" rel="noopener">https://prometheus.io/docs/alerting/latest/configuration/</a></p>
<p>Alertmanager repo and docker:
<a href="https://github.com/prometheus/alertmanager" target="_blank" rel="noopener">https://github.com/prometheus/alertmanager</a></p>
<p>The example alertmanager start command:</p>
<pre><code class="language-bash">/bin/alertmanager --config.file=/etc/config/alertmanager.yml --storage.path=/data --web.route-prefix=/ --web.external-url=https://xxx.xxx/alertmanager
</code></pre>
<p>Run identical Prometheus servers on two or more separate machines. Identical
alerts will be deduplicated by the Alertmanager.</p>
<p>For high availability of the Alertmanager, you can run multiple instances in a
Mesh cluster and configure the Prometheus servers to send notifications to each
of them.</p>
<p>To silence one alert, using <strong>New Silence</strong> and in matcher use <code>alertname</code> as
key and alertname vaule as value(can add more key-value to filter more). If
silence multiple alerts, using regex. Preview silence can show you how many
current active alerts are affected, or you can just silence it so no new alert
will come.</p>
<h1>Integrated with K8s</h1>
<p><a href="https://www.youtube.com/watch?v=bErGEHf6GCc&amp;list=PLpbcUe4chE7-HuslXKj1MB10ncorfzEGa" target="_blank" rel="noopener">https://www.youtube.com/watch?v=bErGEHf6GCc&amp;list=PLpbcUe4chE7-HuslXKj1MB10ncorfzEGa</a>
<a href="https://www.youtube.com/watch?v=CmPdyvgmw-A" target="_blank" rel="noopener">https://www.youtube.com/watch?v=CmPdyvgmw-A</a>
<a href="https://www.youtube.com/watch?v=h4Sl21AKiDg" target="_blank" rel="noopener">https://www.youtube.com/watch?v=h4Sl21AKiDg</a></p>
<p><a href="https://www.youtube.com/watch?v=5o37CGlNLr8" target="_blank" rel="noopener">https://www.youtube.com/watch?v=5o37CGlNLr8</a>
<a href="https://www.youtube.com/watch?v=LQpmeb7idt8" target="_blank" rel="noopener">https://www.youtube.com/watch?v=LQpmeb7idt8</a></p>
<h1>Readings</h1>
<ul>
<li><a href="https://www.metricfire.com/blog/prometheus-vs-elk" target="_blank" rel="noopener">Prometheus vs ELK</a></li>
<li><a href="https://prometheus.io/docs/introduction/faq/#how-to-feed-logs-into-prometheus" target="_blank" rel="noopener">Metrics vs Logs</a></li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/prometheus/" rel="tag"># prometheus</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/09/13/oncall-kafka/" rel="next" title="On-Call Kafka Quick Check">
                <i class="fa fa-chevron-left"></i> On-Call Kafka Quick Check
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/09/19/k8s-container-mem-cpu/" rel="prev" title="Pod/Container Memory/CPU Usage">
                Pod/Container Memory/CPU Usage <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">295</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">48</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">159</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Docker Compose Demo</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Prometheus</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Metric-type"><span class="nav-number">2.1.</span> <span class="nav-text">Metric type</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PromQL"><span class="nav-number">2.2.</span> <span class="nav-text">PromQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Alert-Expr"><span class="nav-number">2.3.</span> <span class="nav-text">Alert Expr</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Excluding-Time-Slot-from-Alert-Expr"><span class="nav-number">2.3.1.</span> <span class="nav-text">Excluding Time Slot from Alert Expr</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Query Example</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">Grafana</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">AlertManager</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">Integrated with K8s</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">7.</span> <span class="nav-text">Readings</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>





  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
