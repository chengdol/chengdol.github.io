<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="List some common Elasticsearch APIs to check different objects: Elastic Stack Compatibility The table shows the stack components’ version compatibility. Some Strategies   If the cluster is unhealthy,">
<meta name="keywords" content="oncall">
<meta property="og:type" content="article">
<meta property="og:title" content="On-Call Elasticsearch Quick Check">
<meta property="og:url" content="http://yoursite.com/2021/09/06/oncall-elasticsearch/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="List some common Elasticsearch APIs to check different objects: Elastic Stack Compatibility The table shows the stack components’ version compatibility. Some Strategies   If the cluster is unhealthy,">
<meta property="og:locale" content="中文|English">
<meta property="og:updated_time" content="2023-09-17T23:04:12.765Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="On-Call Elasticsearch Quick Check">
<meta name="twitter:description" content="List some common Elasticsearch APIs to check different objects: Elastic Stack Compatibility The table shows the stack components’ version compatibility. Some Strategies   If the cluster is unhealthy,">






  <link rel="canonical" href="http://yoursite.com/2021/09/06/oncall-elasticsearch/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>On-Call Elasticsearch Quick Check | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">161</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">49</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">301</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/06/oncall-elasticsearch/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">On-Call Elasticsearch Quick Check

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-09-06 22:15:03" itemprop="dateCreated datePublished" datetime="2021-09-06T22:15:03-07:00">2021-09-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2023-09-17 16:04:12" itemprop="dateModified" datetime="2023-09-17T16:04:12-07:00">2023-09-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Oncall/" itemprop="url" rel="index"><span itemprop="name">Oncall</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>List some common Elasticsearch APIs to check different objects:</p>
<h1>Elastic Stack Compatibility</h1>
<p>The <a href="https://www.elastic.co/support/matrix#matrix_compatibility" target="_blank" rel="noopener">table</a> shows the stack components’ version compatibility.</p>
<h1>Some Strategies</h1>
<ol>
<li>
<p>If the cluster is unhealthy, check health API the shard status, as well as check node API for node status, are all nodes in good roles? Also check path.data in date node. Check this <a href="https://www.datadoghq.com/blog/elasticsearch-performance-scaling-problems/" target="_blank" rel="noopener">post</a></p>
</li>
<li>
<p>If remove and rejoin node intentionally in a short time, e.g: upgrade, OS maintenance, etc, can <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/delayed-allocation.html" target="_blank" rel="noopener">delay the unassigned replica shards re-allocation</a>. This setting goes into every index so it may take some time, you can revert setting back after node rejoins.</p>
</li>
</ol>
<h1>Cluster Check</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cluster health, examine:</span></span><br><span class="line"><span class="comment"># total shard number, primary shard number, etc</span></span><br><span class="line"><span class="comment"># 1. yellow or red (relocating or unassigned shards?)</span></span><br><span class="line"><span class="comment"># 2. node number: master and data (any lost?)</span></span><br><span class="line"><span class="comment"># 3. huge number of pending tasks (may get stuck the whole cluster, then</span></span><br><span class="line"><span class="comment"># need to check what kind of pending tasks)</span></span><br><span class="line">GET _cluster/health</span><br><span class="line">curl -s <span class="string">"http://localhost:9200/_cluster/health?pretty"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># total index number in cluster</span></span><br><span class="line">GET _cluster/stats?filter_path=indices.count</span><br><span class="line"><span class="comment"># total shard number in cluster</span></span><br><span class="line">GET _cluster/stats?filter_path=indices.shards.total</span><br><span class="line"></span><br><span class="line"><span class="comment"># explain shard’s current allocation.</span></span><br><span class="line"><span class="comment"># can see on going allocation explanation</span></span><br><span class="line">GET _cluster/allocation/explain</span><br><span class="line"></span><br><span class="line"><span class="comment"># current settings</span></span><br><span class="line"><span class="comment"># defaults, transient and persistent(usually made by dynamic APIs)</span></span><br><span class="line">GET _cluster/settings?flat_settings&amp;include_defaults</span><br><span class="line"></span><br><span class="line"><span class="comment"># set persistent/transient setting</span></span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"&lt;transient or persistent&gt;"</span> : &#123;</span><br><span class="line">        <span class="string">"cluster.routing.allocation.disk.watermark.flood_stage"</span>: <span class="string">"90%"</span>,</span><br><span class="line">        <span class="string">"cluster.routing.allocation.disk.watermark.high"</span>: <span class="string">"75%"</span>,</span><br><span class="line">        <span class="string">"cluster.routing.allocation.disk.watermark.low"</span>: <span class="string">"70%"</span>,</span><br><span class="line">        <span class="string">"cluster.routing.allocation.cluster_concurrent_rebalance"</span> : <span class="string">"6"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># set cluster_concurrent_rebalance and node_concurrent_recoveries bigger can</span></span><br><span class="line"><span class="comment"># speed up rebalancing</span></span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"transient"</span> : &#123;</span><br><span class="line">        <span class="string">"cluster.routing.allocation.cluster_concurrent_rebalance"</span> : <span class="string">"10"</span>,</span><br><span class="line">        <span class="string">"indices.recovery.max_bytes_per_sec"</span> : <span class="string">"250mb"</span>,</span><br><span class="line">        <span class="string">"cluster.routing.allocation.node_concurrent_recoveries"</span>: <span class="string">"10"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove persistent/transient setting</span></span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"&lt;transient or persistent&gt;"</span> : &#123;</span><br><span class="line">        <span class="string">"cluster.routing.allocation.disk.watermark.low"</span>: null</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># super helpful!</span></span><br><span class="line"><span class="comment"># show allocation details on each node</span></span><br><span class="line"><span class="comment"># shards, disk.percent columns can help observe the rebalancing</span></span><br><span class="line">GET _cat/allocation?v&amp;s=shards:desc</span><br><span class="line">GET _cat/allocation?v&amp;s=disk.percent:desc</span><br></pre></td></tr></table></figure>
<h1>Pending Task</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pending tasks list</span></span><br><span class="line"><span class="comment"># usually when cluster is yellow or heavy load</span></span><br><span class="line">GET _cluster/pending_tasks?pretty</span><br><span class="line">curl -s <span class="string">"http://localhost:9200/_cluster/pending_tasks?pretty"</span> &gt; pending_tasks</span><br><span class="line"></span><br><span class="line"><span class="comment"># then analyze the "source" to examine what kind of pending tasks is occupied</span></span><br></pre></td></tr></table></figure>
<h1>Node Check</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">"http://localhost:9200/_cat/nodes?pretty"</span></span><br><span class="line"><span class="comment"># list all header parameters</span></span><br><span class="line">GET _cat/nodes?v</span><br><span class="line"></span><br><span class="line"><span class="comment"># check master and data role are properly set</span></span><br><span class="line">GET _cat/nodes?<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check node ES version, useful in upgrade</span></span><br><span class="line">GET _cat/nodes?v&amp;h=ip,v</span><br><span class="line"></span><br><span class="line"><span class="comment"># check node heap used, ram.percent</span></span><br><span class="line"><span class="comment"># ram.percent: used + cached!!</span></span><br><span class="line">GET _cat/nodes?v&amp;h=ip,heap.current,heap.percent,ram.percent,ram.current,node,role,master</span><br><span class="line"></span><br><span class="line"><span class="comment"># node metrics</span></span><br><span class="line"><span class="comment"># desc sort used disk space percent</span></span><br><span class="line"><span class="comment"># as well as show index number in each node</span></span><br><span class="line">GET _cat/nodes?h=ip,disk.total,disk.used_percent,indexing.index_total&amp;s=disk.used_percent:desc</span><br><span class="line"></span><br><span class="line"><span class="comment"># list custom node attributes</span></span><br><span class="line">GET _cat/nodeattrs?v</span><br></pre></td></tr></table></figure>
<h1>Index Check</h1>
<p>Delete indices can be performed on Kibana Index Management browser.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list all header parameters</span></span><br><span class="line"><span class="comment"># h=xx,xx,xx</span></span><br><span class="line">GET _cat/indices?<span class="built_in">help</span></span><br><span class="line">curl -s <span class="string">"http://localhost:9200/_cat/indices?help"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check index mapping and setting</span></span><br><span class="line">GET &lt;index name&gt;?pretty</span><br><span class="line"></span><br><span class="line"><span class="comment"># view 2 doc in this index</span></span><br><span class="line"><span class="comment"># so you can have a glapse of doc content</span></span><br><span class="line">GET &lt;index name&gt;/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"size"</span>: 2</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># when you know doc id</span></span><br><span class="line">GET &lt;index name&gt;/_doc/&lt;unique id&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># sort by creation date</span></span><br><span class="line"><span class="comment"># creation.date.string: human-readable</span></span><br><span class="line"><span class="comment"># creation.date: Epoch &amp; Unix Timestamp</span></span><br><span class="line"><span class="comment"># sort to see the creation time window for a specific index pattern</span></span><br><span class="line">GET _cat/indices/[*-index-pattern-2021.11]h=i,creation.date.string&amp;s=creation.date</span><br><span class="line"><span class="comment"># you can use converter here just in case</span></span><br><span class="line"><span class="comment"># https://www.epochconverter.com/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pri.store.size: combined size of all primary shard for an index</span></span><br><span class="line">GET _cat/indices/h=i,pri.store.size</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete index</span></span><br><span class="line">curl -XDELETE <span class="string">'localhost:9200/&lt;index name&gt;/'</span></span><br></pre></td></tr></table></figure>
<h2 id="Index-Template">Index Template</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat</span></span><br><span class="line">GET _cat/templates/&lt;template name&gt;?v</span><br><span class="line">curl -s <span class="string">"http://localhost:9200/_cat/templates/&lt;template name&gt;?v"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># display template definition, for example </span></span><br><span class="line"><span class="comment"># index-patterns field</span></span><br><span class="line"><span class="comment"># alias field</span></span><br><span class="line">GET _template/&lt;template name&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Index-Alias">Index Alias</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get index alias</span></span><br><span class="line">GET &lt;index name&gt;/_alias</span><br><span class="line"></span><br><span class="line"><span class="comment"># get available alias list</span></span><br><span class="line">GET _alias/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># get list of alias for all indexes, empty is showed</span></span><br><span class="line">GET */_alias</span><br></pre></td></tr></table></figure>
<h1>Shard Check</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list primary/replic shards of specific index</span></span><br><span class="line"><span class="comment"># show doc number in each and host node</span></span><br><span class="line">GET _cat/shards/&lt;index name&gt;?v</span><br><span class="line">curl -s <span class="string">"http://localhost:9200/_cat/shards/&lt;index name&gt;?v"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check shard allocation per node, disk usage</span></span><br><span class="line"><span class="comment"># useful for distribution/balance assess</span></span><br><span class="line">GET _cat/allocation?v</span><br><span class="line"></span><br><span class="line"><span class="comment"># unassigned reason</span></span><br><span class="line"><span class="comment"># relocating direction</span></span><br><span class="line">GET _cat/shards?h=index,state,prirep,unassigned.reason</span><br><span class="line"></span><br><span class="line"><span class="comment"># list reallocating shard</span></span><br><span class="line"><span class="comment"># show reallocating shard source -&gt; target node</span></span><br><span class="line">GET _cat/shards?v&amp;h=index,shard,state,node&amp;s=st:desc</span><br><span class="line"></span><br><span class="line"><span class="comment"># sort shards by size</span></span><br><span class="line"><span class="comment"># s=sto:desc, descending order</span></span><br><span class="line">GET _cat/shards?h=i,shard,p,ip,st,sto&amp;s=sto:desc,ip:desc</span><br><span class="line"></span><br><span class="line"><span class="comment"># list all shareds in specified node and sort by shard size desc</span></span><br><span class="line">curl <span class="string">"localhost:9200/_cat/shards?h=i,shard,ip,prirep,st,store&amp;s=store:desc"</span> \</span><br><span class="line">| grep <span class="string">"&lt;node ip or node name&gt;"</span> &gt; shards.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># query hot shards distribution on data nodes</span></span><br><span class="line"><span class="comment"># sort node ip with order: desc or asc</span></span><br><span class="line">curl -s <span class="string">"localhost:9200/_cat/shards/&lt;hot index pattern&gt;?s=node:asc"</span> &gt; shards \</span><br><span class="line">&amp;&amp; cat shards | awk &#123;<span class="string">'print $8'</span>&#125; | uniq -c | sort -rn</span><br><span class="line"><span class="comment"># get hot shard total based on shards per node</span></span><br><span class="line">cat shards | awk &#123;<span class="string">'print $8'</span>&#125; | uniq -c | sort -rn | \</span><br><span class="line">awk <span class="string">'BEGIN &#123; sum = 0 &#125; &#123; sum += $1&#125; END &#123; print sum &#125;'</span></span><br><span class="line"><span class="comment"># get hot shard number average</span></span><br><span class="line">cat shards | awk &#123;<span class="string">'print $8'</span>&#125; | uniq -c | sort -rn | \</span><br><span class="line">awk <span class="string">'BEGIN &#123; sum = 0; count = 0 &#125; &#123; sum += $1; count += 1 &#125; END &#123; print sum / count &#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># reroute shard pri/rep</span></span><br><span class="line"><span class="comment"># try dryrun first, the output can be big</span></span><br><span class="line"><span class="comment"># the dryrun output contains the reasons from success or failure</span></span><br><span class="line">curl -XPOST <span class="string">"localhost:9200/_cluster/reroute?dry_run"</span> \</span><br><span class="line">-H <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">-d \</span><br><span class="line"><span class="string">'&#123;</span></span><br><span class="line"><span class="string">  "commands": [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      "move": &#123;</span></span><br><span class="line"><span class="string">        "index": "&lt;index name&gt;",</span></span><br><span class="line"><span class="string">        "shard": "&lt;shard number&gt;",</span></span><br><span class="line"><span class="string">        "from_node": "&lt;ip or node name&gt;",</span></span><br><span class="line"><span class="string">        "to_node": "&lt;ip or node name&gt;"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># it is sometimes possible there is unassigned shard due to max reties failed</span></span><br><span class="line"><span class="comment"># https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-reroute.html#cluster-reroute-api-request-body</span></span><br><span class="line">curl -XPOST <span class="string">"localhost:9200/_cluster/reroute?retry_failed=true"</span> \</span><br><span class="line">-H <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">-d \</span><br><span class="line"><span class="string">'&#123;</span></span><br><span class="line"><span class="string">  "commands" : [</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    "allocate_replica" : &#123;</span></span><br><span class="line"><span class="string">       "index" : "&lt;index name&gt;",</span></span><br><span class="line"><span class="string">       "shard" : &lt;shard number&gt;,</span></span><br><span class="line"><span class="string">       "node" : "&lt;target node&gt;"</span></span><br><span class="line"><span class="string">     &#125;</span></span><br><span class="line"><span class="string">  &#125;]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># attempt a single retry </span></span><br><span class="line"><span class="comment"># if there are many good(if shards are stale/corrupted, this will not work) </span></span><br><span class="line"><span class="comment"># unassigned shards blocked, retry all without request body</span></span><br><span class="line"><span class="comment"># you may need to run multiple times to clean the backlog</span></span><br><span class="line">curl -XPOST <span class="string">"localhost:9200/_cluster/reroute?retry_failed=true"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># if shard gets stucked in initializing status from recovery</span></span><br><span class="line"><span class="comment"># the reason could be</span></span><br><span class="line"><span class="comment"># 1. the shard is big</span></span><br><span class="line"><span class="comment"># 2. lot of replicas that lingers initial process</span></span><br></pre></td></tr></table></figure>
<h1>Data Stream</h1>
<p>It is easy to examine DS in Kibana index management console.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get specificed ds backing indices, template, ILM</span></span><br><span class="line">GET _data_stream/&lt;data stream name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># rollover a data stream</span></span><br><span class="line">POST &lt;data stream name&gt;/_rollover</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete ds and all its backing indices</span></span><br><span class="line">DELETE _data_stream/&lt;data stream name&gt;</span><br></pre></td></tr></table></figure>
<p>What I care about is the current write index of DS:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list of all non-system, non-hidden data stream</span></span><br><span class="line">curl -s <span class="string">"http://localhost:9200/_data_stream/*?format=json&amp;pretty"</span> \</span><br><span class="line">| jq -r <span class="string">'.data_streams[].name'</span> | sort -r</span><br><span class="line"></span><br><span class="line"><span class="comment"># find current write index(last one), health status, template and policy</span></span><br><span class="line">curl -s <span class="string">"http://localhost:9200/_data_stream/&lt;data-stream-name&gt;?format=json&amp;pretty"</span> \</span><br><span class="line">| jq -r <span class="string">'.data_streams[].indices[-1].index_name'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># data stream stats</span></span><br><span class="line"><span class="comment"># total shards, total backing indices, total storage size</span></span><br><span class="line">curl -s <span class="string">"http://localhost:9200/_data_stream/&lt;data-stream-name&gt;/_stats?pretty&amp;format=json"</span></span><br></pre></td></tr></table></figure>
<p>Another important statistics is the distribution of data stream based hot shard, it is not straightforward and needs some calculation, I have wrote a <a href="https://gist.github.com/chengdol/be9e90efa69fe075d1da6d5c90307178" target="_blank" rel="noopener">script</a> to display it.</p>
<h1>ILM</h1>
<p>The index <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-lifecycle-management-api.html" target="_blank" rel="noopener">lifecycle management APIs</a>.
I have observed the huge number of pending tasks from ILM operations that slow down the cluster holistically (cs, traffic, usage, etc)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># examine shard age and phase state</span></span><br><span class="line"><span class="comment"># and any ILM error</span></span><br><span class="line">GET &lt;index name&gt;/_ilm/explain</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove ILM from ds or alias</span></span><br><span class="line">POST &lt;ds or <span class="built_in">alias</span>&gt;/_ilm/remove</span><br><span class="line"><span class="comment"># need to check if any index is closed by forcemerge, if yes, open it</span></span><br><span class="line">GET &lt;ds or <span class="built_in">alias</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># retry after the ILM gets fixed(updated)</span></span><br><span class="line">POST &lt;index name&gt;/_ilm/retry</span><br></pre></td></tr></table></figure>
<p>Stop and start the ILM system, used when performing schedule maintenance on cluster nodes and cloud impact ILM actions.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check status</span></span><br><span class="line">GET _ilm/status</span><br><span class="line"></span><br><span class="line"><span class="comment"># stop ILM system</span></span><br><span class="line">POST _ilm/stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># start ILM system</span></span><br><span class="line">POST _ilm/start</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/oncall/" rel="tag"># oncall</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/09/06/elastic-python/" rel="next" title="Python Curator for Elasticsearch">
                <i class="fa fa-chevron-left"></i> Python Curator for Elasticsearch
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/09/13/oncall-kafka/" rel="prev" title="On-Call Kafka Quick Check">
                On-Call Kafka Quick Check <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">301</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">49</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">161</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Elastic Stack Compatibility</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Some Strategies</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Cluster Check</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">Pending Task</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">Node Check</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">Index Check</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Index-Template"><span class="nav-number">6.1.</span> <span class="nav-text">Index Template</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Index-Alias"><span class="nav-number">6.2.</span> <span class="nav-text">Index Alias</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">7.</span> <span class="nav-text">Shard Check</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">8.</span> <span class="nav-text">Data Stream</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">9.</span> <span class="nav-text">ILM</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2024</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>





  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
