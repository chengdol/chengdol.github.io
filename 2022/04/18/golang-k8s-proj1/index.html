<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Porj1 description: build a small go docker app to fetch and display service A’s token from specified GKE cluster through port forwarding. The arguments in token request path are from configMap in the">
<meta name="keywords" content="kubernetes,go">
<meta property="og:type" content="article">
<meta property="og:title" content="Golang K8s Proj1">
<meta property="og:url" content="http://yoursite.com/2022/04/18/golang-k8s-proj1/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="Porj1 description: build a small go docker app to fetch and display service A’s token from specified GKE cluster through port forwarding. The arguments in token request path are from configMap in the">
<meta property="og:locale" content="中文|English">
<meta property="og:updated_time" content="2022-05-04T04:02:21.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Golang K8s Proj1">
<meta name="twitter:description" content="Porj1 description: build a small go docker app to fetch and display service A’s token from specified GKE cluster through port forwarding. The arguments in token request path are from configMap in the">






  <link rel="canonical" href="http://yoursite.com/2022/04/18/golang-k8s-proj1/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Golang K8s Proj1 | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">154</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">44</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">274</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/04/18/golang-k8s-proj1/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Golang K8s Proj1

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2022-04-18 19:25:23" itemprop="dateCreated datePublished" datetime="2022-04-18T19:25:23-07:00">2022-04-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-05-03 21:02:21" itemprop="dateModified" datetime="2022-05-03T21:02:21-07:00">2022-05-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>Porj1 description</strong>: build a small go docker app to fetch and display service A’s token from specified GKE cluster through port forwarding. The arguments in token request path are from configMap in the same GKE cluster.</p>
<p>I structure this blog in the order of the problem solving in development process.</p>
<h1>Caveat</h1>
<p>The VSC may have <a href="https://stackoverflow.com/questions/58518588/vscode-could-not-import-golang-package" target="_blank" rel="noopener">hiccups</a> on import of go packages(annoying errors at package import statement which prevents code intelligent suggestions from using), troubleshooting could be:</p>
<ol>
<li>check the package is downloaded/installed, run <code>go get</code></li>
<li>open VSC editor at Go project root directory rather than others</li>
<li>make sure Go tools are up-to-date</li>
<li>try move the Go project out of GOPATH, and set go.mod for it</li>
<li>restart VSC editor</li>
</ol>
<h1>How to get GKE cluster kubeconfig file?</h1>
<p>To talk to GKE cluster, the first thing to do is running the gcloud command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud container clusters get-credentials &lt;cluster&gt; --region &lt;region&gt; --project &lt;project&gt;</span><br></pre></td></tr></table></figure>
<p>I don’t want to install gcloud CLI, alternatively letting golang do this job. The idea is to figure out how does gcloud command generate the kubeconfig, for example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBECONFIG=kubeconfig.yml gcloud container clusters get-credentials &lt;cluster&gt; --region &lt;region&gt; --project &lt;project&gt;</span><br></pre></td></tr></table></figure>
<p>The result would be a single cluster <code>kuebconfig.yml</code> file in the current directory, and export this <code>KUBECONFIG</code> will make subsequent <code>kubectl</code> commands work on the cluster specified in this yaml file.</p>
<p>To understand in depth I use gcloud option <code>--log-http</code> to dump command log:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud container clusters get-credentials &lt;cluster&gt; --region &lt;region&gt; --project &lt;project&gt; --log-http</span><br></pre></td></tr></table></figure>
<p>Displaying redacted log here:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">=======================</span></span><br><span class="line"><span class="string">====</span> <span class="string">request</span> <span class="string">start</span> <span class="string">====</span></span><br><span class="line"><span class="attr">uri:</span> <span class="attr">https://oauth2.googleapis.com/token</span></span><br><span class="line"><span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line"><span class="string">==</span> <span class="string">headers</span> <span class="string">start</span> <span class="string">==</span></span><br><span class="line"><span class="comment"># header info</span></span><br><span class="line"><span class="string">==</span> <span class="string">headers</span> <span class="string">end</span> <span class="string">==</span></span><br><span class="line"><span class="string">==</span> <span class="string">body</span> <span class="string">start</span> <span class="string">==</span></span><br><span class="line"><span class="string">Body</span> <span class="attr">redacted:</span> <span class="string">Contains</span> <span class="string">oauth</span> <span class="string">token.</span> <span class="string">Set</span> <span class="string">log_http_redact_token</span> <span class="string">property</span> <span class="string">to</span> <span class="literal">false</span> <span class="string">to</span> <span class="string">print</span> <span class="string">the</span> <span class="string">body</span> <span class="string">of</span> <span class="string">this</span> <span class="string">request.</span></span><br><span class="line"><span class="string">==</span> <span class="string">body</span> <span class="string">end</span> <span class="string">==</span></span><br><span class="line"><span class="string">====</span> <span class="string">request</span> <span class="string">end</span> <span class="string">====</span></span><br><span class="line"><span class="bullet">-</span><span class="meta">---</span> <span class="string">response</span> <span class="string">start</span> <span class="bullet">----</span></span><br><span class="line"><span class="attr">status:</span> <span class="number">200</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">headers</span> <span class="string">start</span> <span class="bullet">--</span></span><br><span class="line"><span class="comment"># header info</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">headers</span> <span class="string">end</span> <span class="bullet">--</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">body</span> <span class="string">start</span> <span class="bullet">--</span></span><br><span class="line"><span class="string">Body</span> <span class="attr">redacted:</span> <span class="string">Contains</span> <span class="string">oauth</span> <span class="string">token.</span> <span class="string">Set</span> <span class="string">log_http_redact_token</span> <span class="string">property</span> <span class="string">to</span> <span class="literal">false</span> <span class="string">to</span> <span class="string">print</span> <span class="string">the</span> <span class="string">body</span> <span class="string">of</span> <span class="string">this</span> <span class="string">response.</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">body</span> <span class="string">end</span> <span class="bullet">--</span></span><br><span class="line"><span class="string">total</span> <span class="string">round</span> <span class="string">trip</span> <span class="string">time</span> <span class="string">(request+response):</span> <span class="number">0.084</span> <span class="string">secs</span></span><br><span class="line"><span class="bullet">-</span><span class="meta">---</span> <span class="string">response</span> <span class="string">end</span> <span class="bullet">----</span></span><br><span class="line"></span><br><span class="line"><span class="string">Fetching</span> <span class="string">cluster</span> <span class="string">endpoint</span> <span class="string">and</span> <span class="string">auth</span> <span class="string">data.</span></span><br><span class="line"><span class="string">=======================</span></span><br><span class="line"><span class="string">====</span> <span class="string">request</span> <span class="string">start</span> <span class="string">====</span></span><br><span class="line"><span class="attr">uri:</span> <span class="attr">https://container.googleapis.com/v1/projects/&lt;cluster&gt;/locations/us-west1/clusters/&lt;cluster&gt;?alt=json</span></span><br><span class="line"><span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line"><span class="string">==</span> <span class="string">headers</span> <span class="string">start</span> <span class="string">==</span></span><br><span class="line"><span class="comment"># header info</span></span><br><span class="line"><span class="string">==</span> <span class="string">headers</span> <span class="string">end</span> <span class="string">==</span></span><br><span class="line"><span class="string">==</span> <span class="string">body</span> <span class="string">start</span> <span class="string">==</span></span><br><span class="line"> </span><br><span class="line"><span class="string">==</span> <span class="string">body</span> <span class="string">end</span> <span class="string">==</span></span><br><span class="line"><span class="string">====</span> <span class="string">request</span> <span class="string">end</span> <span class="string">====</span></span><br><span class="line"><span class="bullet">-</span><span class="meta">---</span> <span class="string">response</span> <span class="string">start</span> <span class="bullet">----</span></span><br><span class="line"><span class="attr">status:</span> <span class="number">200</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">headers</span> <span class="string">start</span> <span class="bullet">--</span></span><br><span class="line"><span class="comment"># header info</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">headers</span> <span class="string">end</span> <span class="bullet">--</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">body</span> <span class="string">start</span> <span class="bullet">--</span></span><br><span class="line"><span class="comment"># big json file which contains necessary data to generate kubeconfig</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-</span> <span class="string">body</span> <span class="string">end</span> <span class="bullet">--</span></span><br><span class="line"><span class="string">total</span> <span class="string">round</span> <span class="string">trip</span> <span class="string">time</span> <span class="string">(request+response):</span> <span class="number">0.067</span> <span class="string">secs</span></span><br><span class="line"><span class="bullet">-</span><span class="meta">---</span> <span class="string">response</span> <span class="string">end</span> <span class="bullet">----</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">---------------------</span></span><br><span class="line"><span class="string">kubeconfig</span> <span class="string">entry</span> <span class="string">generated</span> <span class="string">for</span> <span class="string">&lt;cluster&gt;.</span></span><br></pre></td></tr></table></figure>
<p>The first http call is about OAuth2.0, used to authorize caller’s request, the gcloud client will do this automatically for you if env variable <code>GOOGLE_APPLICATION_CREDENTIALS</code> is set correctly, for example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GOOGLE_APPLICATION_CREDENTIALS=<span class="string">"path to adc.json or service account key file"</span></span><br></pre></td></tr></table></figure>
<p>I will mount this credential file into docker when I run container.</p>
<p>Note that I use <code>GOOGLE_APPLICATION_CREDENTIALS</code> because the app runs outside of the gcloud environment, if it is inside the attached service account will be used. See demo about <a href="https://cloud.google.com/docs/authentication/production#automatically" target="_blank" rel="noopener">Authenticating as a service account</a>.</p>
<p>Next I go to figure out how to run gcloud K8s go client to get the GKE cluster info, from the log dump above the URL is known as:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">uri:</span> <span class="attr">https://container.googleapis.com/v1/projects/&lt;cluster&gt;/locations/us-west1/clusters/&lt;cluster&gt;?alt=json</span></span><br></pre></td></tr></table></figure>
<p>It is gcloud K8s engine REST API v1, the live experiment can play <a href="https://cloud.google.com/kubernetes-engine/docs/reference/rest/v1beta1/projects.locations.clusters/get" target="_blank" rel="noopener">here</a>. Once you fill the <code>name</code> field and click the EXECUTE button(uncheck the API key), the OAuth2.0 will pop up and let you authorize the request then the call will succeed.</p>
<p>Next find the corresponding go client call for this REST API:
<a href="https://cloud.google.com/go/docs/reference" target="_blank" rel="noopener">Go Cloud Client Libraries </a>
=&gt; search in search bar
<a href="https://cloud.google.com/go/docs/reference/cloud.google.com/go/container/latest/apiv1" target="_blank" rel="noopener">Kubernetes Engine API</a>
=&gt; search related func name
<a href="https://cloud.google.com/go/docs/reference/cloud.google.com/go/container/latest/apiv1#cloud_google_com_go_container_apiv1_ClusterManagerClient_GetCluster" target="_blank" rel="noopener">func (*ClusterManagerClient) GetCluster</a></p>
<blockquote>
<p>Note that gcloud K8s go client is for managing GKE cluster not the K8s resources, it is not the k8s/go-client mentioned later.</p>
</blockquote>
<p>From the sample code, the required field structure is the same as the REST API path:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The name (project, location, cluster) of the cluster to retrieve.</span></span><br><span class="line"><span class="comment">// Specified in the format `projects/*/locations/*/clusters/*`.</span></span><br><span class="line">Name <span class="keyword">string</span> <span class="string">`protobuf:"bytes,5,opt,name=name,proto3" json:"name,omitempty"`</span></span><br></pre></td></tr></table></figure>
<p>Now ready, I have <code>GOOGLE_APPLICATION_CREDENTIALS</code> exported and gcloud K8s go client library, it is easy to get what <code>gcloud container clusters get-credentials</code> does for us and make the kubeconfig yaml file from template.</p>
<h2 id="What-is-OAuth2-0">What is OAuth2.0</h2>
<p>The OAuth(open authorization) 2.0 <a href="https://cloud.google.com/docs/authentication" target="_blank" rel="noopener">google doc and example</a>.</p>
<p>Usage: authorization between services, OAuth access token is JWT.</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=t4-416mg6iU" target="_blank" rel="noopener">Intro OAuth</a>, access delegation, limited access.</li>
<li><a href="https://www.youtube.com/watch?v=3pZ3Nh8tgTE" target="_blank" rel="noopener">OAuth deeper</a>: terms: resource, resource owner, resource server, client, authorization server(issue access token)</li>
<li><a href="https://www.youtube.com/watch?v=soGRyl9ztjI" target="_blank" rel="noopener">JWT explained</a>, vs session token(reference token). The JWT(value token) contains the complete request info, that’s why it uses JSON object. Session token is just a key from a session map on the server side.</li>
<li><a href="https://www.youtube.com/watch?v=_XbXkVdoG_0" target="_blank" rel="noopener">JWT structure explained</a>, encode and decode JWT object</li>
</ul>
<h1>How to use K8s go client to access K8s resource?</h1>
<p>Note that K8s go client(<a href="https://github.com/kubernetes/client-go" target="_blank" rel="noopener">kubernetes/go-client</a>) is a standalone project used to talk to K8s, K8s itself is another go project(<a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener">kubernetes/kubernetes</a>).</p>
<p>I have made the kubeconfig yaml file ready and set <code>KUBECONFIG</code> env variable, then using the client to do API call, for example <a href="https://github.com/eddiezane/hello-client-go/blob/main/main.go" target="_blank" rel="noopener">reference code</a>, can also reference the go client <a href="https://github.com/kubernetes/client-go/blob/master/examples/out-of-cluster-client-configuration/main.go" target="_blank" rel="noopener">example</a> for out-of-k8s cluster.</p>
<p>In my project I need to get date from configMap, use <a href="https://github.com/kubernetes/client-go/blob/master/kubernetes/typed/core/v1/configmap.go" target="_blank" rel="noopener">go client for configmap</a>.</p>
<h2 id="Tutorial">Tutorial</h2>
<p><a href="https://youtu.be/jiKwjnlc7Wk" target="_blank" rel="noopener">Youtube: Getting Started with Kubernetes client-go</a>
<a href="https://www.youtube.com/watch?v=vlw1NYySbmQ&amp;list=PLh4KH3LtJvRTb_J-8T--wZeOBV3l3uQhc" target="_blank" rel="noopener">Youtube: client-go K8s native development</a></p>
<h1>How to port forward in pure golang?</h1>
<p>Next, I need to query a K8s service, to make it easy I need to forward port onto localhost, the kubectl command is:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service port forward</span></span><br><span class="line">kubectl port-forward svc/example 9200:9200 -v=8 &amp;&gt; verbose.txt</span><br></pre></td></tr></table></figure>
<p>I add <code>-v=8</code> flag to dump the log into verbose.txt file.</p>
<p>Then I see there are consecutive API calls, it first gets service detail(GET), then looking for pod(GET) and pod details(GET) managed by that service and uses that pod to do port forwarding(POST). So it actually does:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pod port forward</span></span><br><span class="line">kubectl port-forward example-0 9200:9200</span><br></pre></td></tr></table></figure>
<p>The go client has <a href="https://github.com/kubernetes/client-go/blob/28ccde769f/tools/portforward/portforward.go" target="_blank" rel="noopener">port forward package</a>, to use it, import as <code>k8s.io/client-go/tools/portforward</code>(just follows the dir path layout).</p>
<p>The usage of port forward package is not obvious, I reference below 2 posts to make it work:</p>
<ul>
<li><a href="https://github.com/kubernetes/client-go/issues/51#issuecomment-436200428" target="_blank" rel="noopener">Port forward sample</a></li>
<li><a href="https://gianarb.it/blog/programmatically-kube-port-forward-in-go" target="_blank" rel="noopener">Programmatically Kubernetes port forward in Go</a></li>
</ul>
<p>The go channels(start and stop port forward) and goroutine will be used here, you can check <code>lsof</code> or <code>netstat</code> to see the target localhost port is listening.</p>
<p>Additionally, You can also see how <a href="https://github.com/kubernetes/kubernetes/blob/v1.6.0-alpha.0/pkg/kubectl/cmd/portforward.go#L107" target="_blank" rel="noopener">kubectl implement port-forward</a></p>
<h1>How to convert curl to golang?</h1>
<p>Next, I need to convert <code>curl</code> to golang, it is easy as the underlying is all about http request.</p>
<p>There is a interesting project has exactly what I need:
<a href="https://mholt.github.io/curl-to-go/" target="_blank" rel="noopener">https://mholt.github.io/curl-to-go/</a></p>
<h1>How to unmarshal only small set of fields from HTTP response JSON?</h1>
<p>I find 2 options:</p>
<ol>
<li>Use struct type which has only the target fields, have to construct multiple struct and embed them to reflect the JSON field nesting.</li>
<li>Use <a href="https://gobyexample.com/json" target="_blank" rel="noopener">interface + type assertion</a> to receive and convert the target field, no struct is needed!</li>
</ol>
<p>For single JSON object, <a href="https://ahmet.im/blog/golang-json-decoder-pitfalls/" target="_blank" rel="noopener">don’t use json.Decoder</a>, please use <code>json.Unmarshal</code> instead.</p>
<h1>How to reduce go docker image size?</h1>
<p>Lastly, I want to build a go docker app to simplify use and has minimum image size.</p>
<p>The docker official <a href="https://docs.docker.com/language/golang/build-images/" target="_blank" rel="noopener">doc</a> for building go docker image is not good, end up with a big size image.</p>
<p>The solution is easy: using multi-stage Dockerfile, build go binary in one go docker image and copy the binary to a new base image of the same Linux distro but has much less image size:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># syntax=docker/dockerfile:1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Need to have google-cloud-sdk-gke-gcloud-auth-plugin</span></span><br><span class="line"><span class="comment"># for go-client to access GKE resource</span></span><br><span class="line"><span class="comment"># https://cloud.google.com/blog/products/containers-kubernetes/kubectl-auth-changes-in-gke</span></span><br><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.18</span>-buster AS auth-plugin</span><br><span class="line"><span class="comment"># version &gt; 381.0.0-0 asks to install gcloud cli</span></span><br><span class="line"><span class="comment"># which is not desired and make image size bigger!</span></span><br><span class="line"><span class="keyword">ENV</span> AUTH_VERSION=<span class="string">"381.0.0-0"</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"deb https://packages.cloud.google.com/apt cloud-sdk main"</span> \</span></span><br><span class="line"><span class="bash">    | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; \</span></span><br><span class="line"><span class="bash">    curl https://packages.cloud.google.com/apt/doc/apt-key.gpg \</span></span><br><span class="line"><span class="bash">    | apt-key add -</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install google-cloud-sdk-gke-gcloud-auth-plugin=<span class="variable">$AUTH_VERSION</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># build binary executable base on alpine image</span></span></span><br><span class="line"><span class="bash">FROM golang:1.18-alpine AS binary</span></span><br><span class="line"><span class="bash">WORKDIR /deployment</span></span><br><span class="line"><span class="bash">COPY cmd ./cmd</span></span><br><span class="line"><span class="bash">COPY go.mod ./</span></span><br><span class="line"><span class="bash">COPY go.sum ./</span></span><br><span class="line"><span class="bash">RUN go mod download</span></span><br><span class="line"><span class="bash">RUN go build -o ./cmd/app ./cmd</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># minimum app image creation</span></span></span><br><span class="line"><span class="bash">FROM alpine:3.15</span></span><br><span class="line"><span class="bash">WORKDIR /deployment</span></span><br><span class="line"><span class="bash">COPY --from=binary \</span></span><br><span class="line"><span class="bash">    /deployment/cmd/app \</span></span><br><span class="line"><span class="bash">    ./cmd/app</span></span><br><span class="line"><span class="bash">COPY --from=auth-plugin \</span></span><br><span class="line"><span class="bash">    /usr/lib/google-cloud-sdk/bin/gke-gcloud-auth-plugin \</span></span><br><span class="line"><span class="bash">    /usr/<span class="built_in">local</span>/bin/gke-gcloud-auth-plugin</span></span><br><span class="line"><span class="bash">COPY config ./config</span></span><br><span class="line"><span class="bash">COPY template ./template</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">WORKDIR /deployment/cmd</span></span><br><span class="line"><span class="bash">ENTRYPOINT [ <span class="string">"./app"</span>]</span></span><br><span class="line"><span class="bash">CMD [<span class="string">"--help"</span>]</span></span><br></pre></td></tr></table></figure>
<p>This approach helps me reduce the docker image size from near 2GB to 60MB.</p>
<p>There is a post has similar idea:
<a href="https://dev.to/chseki/build-a-super-minimalistic-docker-image-to-run-your-golang-app-33j0" target="_blank" rel="noopener">Build a super minimalistic Docker Image to run your Golang App</a>.</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
            <a href="/tags/go/" rel="tag"># go</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/03/31/cloud-gcp-cli/" rel="next" title="Google Cloud CLI">
                <i class="fa fa-chevron-left"></i> Google Cloud CLI
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/04/21/message-kafka-learn/" rel="prev" title="Kafka Quick Start">
                Kafka Quick Start <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">274</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">44</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">154</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Caveat</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">How to get GKE cluster kubeconfig file?</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-OAuth2-0"><span class="nav-number">2.1.</span> <span class="nav-text">What is OAuth2.0</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">How to use K8s go client to access K8s resource?</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Tutorial"><span class="nav-number">3.1.</span> <span class="nav-text">Tutorial</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">How to port forward in pure golang?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">How to convert curl to golang?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">How to unmarshal only small set of fields from HTTP response JSON?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">7.</span> <span class="nav-text">How to reduce go docker image size?</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>





  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
