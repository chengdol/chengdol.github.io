<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="后来还用到了Python Terraform package, 结合Python Click 以及其他custom Python package 去构造glue code. Introduction To alter a planet for the purpose of sustaining life. This article from IBM can give you a good over">
<meta name="keywords" content="infra,terraform">
<meta property="og:type" content="article">
<meta property="og:title" content="Terraform Quick Start">
<meta property="og:url" content="http://yoursite.com/2020/05/16/infra-terraform-start/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="后来还用到了Python Terraform package, 结合Python Click 以及其他custom Python package 去构造glue code. Introduction To alter a planet for the purpose of sustaining life. This article from IBM can give you a good over">
<meta property="og:locale" content="中文|English">
<meta property="og:updated_time" content="2022-06-19T18:49:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Terraform Quick Start">
<meta name="twitter:description" content="后来还用到了Python Terraform package, 结合Python Click 以及其他custom Python package 去构造glue code. Introduction To alter a planet for the purpose of sustaining life. This article from IBM can give you a good over">






  <link rel="canonical" href="http://yoursite.com/2020/05/16/infra-terraform-start/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Terraform Quick Start | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">158</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">47</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">288</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/16/infra-terraform-start/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Terraform Quick Start

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-16 21:16:19" itemprop="dateCreated datePublished" datetime="2020-05-16T21:16:19-07:00">2020-05-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-06-19 11:49:28" itemprop="dateModified" datetime="2022-06-19T11:49:28-07:00">2022-06-19</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Infra/" itemprop="url" rel="index"><span itemprop="name">Infra</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>后来还用到了Python <a href="https://github.com/beelit94/python-terraform" target="_blank" rel="noopener">Terraform package</a>, 结合Python Click 以及其他custom Python package 去构造glue code.</p>
<h1>Introduction</h1>
<p>To alter a planet for the purpose of sustaining life.</p>
<p>This <a href="https://www.ibm.com/cloud/learn/terraform" target="_blank" rel="noopener">article</a> from IBM can give you a good overview:</p>
<ul>
<li>Terraform vs Kubernetes</li>
<li>Terraform vs Ansible</li>
</ul>
<p>Removing manual build process, adopting declarative approach to deploy <strong>infrastructure as code</strong>, reusable, idempotent and consistent repeatable deployment.</p>
<p>Use gcloud API or client binary can do the same work as Terraform, so what are the <code>benefits</code>:</p>
<ul>
<li>cloud agnostic, multi-cloud portable.</li>
<li>Unified workflow: If you are already deploying infrastructure to Google Cloud with Terraform, your resources can fit into that workflow.</li>
<li>Full lifecycle management: Terraform doesn’t only create resources, it updates, and deletes tracked resources without requiring you to inspect the API to identify those resources.</li>
<li>Graph of relationships: Terraform understands dependency relationships between resources.</li>
</ul>
<p><a href="https://www.terraform.io/docs/" target="_blank" rel="noopener">Terraform 文档</a>非常informative，结构清晰:
Terraform之于cloud infra on public cloud 就相当于 helm之于application on k8s, 大大简化了操作复杂性，自动快速部署，同时做到了复用，versioning等特性。但得去了解cloud provider中提供的resources 的用途，搭配。</p>
<h2 id="Github-Repo">Github Repo</h2>
<p>resource files in github:
<a href="https://github.com/ned1313/Getting-Started-Terraform" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Terraform</a></p>
<h2 id="Composition">Composition</h2>
<p>Terraform executable: download from web (or build terraform docker image)
Terraform files: using hashicorp configure language DSL
Terraform plugin: interact with provider: AWS, GCP, Azure, etc
Terraform state file: json and don’t touch it but you can view it to get deployment detial</p>
<p>You can have multiple terraform files: <code>.tf</code>, when run terraform it will stitch them together to form a single configuration. 比如把variables, outputs, resources, tfvars分开。</p>
<p>tfvars file by default named as <code>terraform.tfvars</code>, otherwise when run <code>plan</code> you need to specify the file path. This <code>tfvars</code> file is usually generated from some meta-data configuration, then combining with variable declaration file.</p>
<h1>Commands</h1>
<p>To execute terraform command, <strong>build a docker image</strong> and mount cloud auth credentials when start container. BTW, if you run on google compute VM, the SDK will inject the host auth automatucally in container.
If you update the terraform file with different configuration, rerun <code>init</code>, <code>plan</code> and <code>apply</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list all commands</span></span><br><span class="line">terraform --<span class="built_in">help</span></span><br><span class="line">terraform version</span><br><span class="line"></span><br><span class="line"><span class="comment"># create workspace, see below section</span></span><br><span class="line">terraform workspace</span><br><span class="line"></span><br><span class="line"><span class="comment"># linter</span></span><br><span class="line">terraform validate</span><br><span class="line"></span><br><span class="line"><span class="comment"># show a tree of providers in main the sub-modules</span></span><br><span class="line"><span class="comment"># for example, google, kubernetes, random, null, locals they are all providers</span></span><br><span class="line">terraform providers</span><br><span class="line"></span><br><span class="line"><span class="comment"># init will download plugin, for example, aws, gcp or azure..</span></span><br><span class="line">terraform init</span><br><span class="line"></span><br><span class="line"><span class="comment"># will show you the diff if you update your terraform file</span></span><br><span class="line"><span class="comment"># load terraform.tfvars by default, if not, need to specify</span></span><br><span class="line">terraform plan -out plan.tfplan</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># will generate a tfstate file</span></span><br><span class="line"><span class="comment"># perform creation as much parallel as possible</span></span><br><span class="line"><span class="comment"># --auto-approve: for script, no interactive</span></span><br><span class="line">terraform apply <span class="string">"plan.tfplan"</span> [--auto-approve]</span><br><span class="line"></span><br><span class="line"><span class="comment"># -state: output state to specific file</span></span><br><span class="line"><span class="comment"># when run different env with a single definition file</span></span><br><span class="line">terraform apply -state=qa-env.tfstate -var environment=qa <span class="string">"plan.tfplan"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Manually mark a resource as tainted, forcing a destroy and recreate</span></span><br><span class="line"><span class="comment"># on the next plan/apply.</span></span><br><span class="line">terraform taint &lt;google_compute_instance.vm_instance&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># output terraform state or plan file in a human-readable form</span></span><br><span class="line"><span class="comment"># show what has been created</span></span><br><span class="line">terraform show</span><br><span class="line"></span><br><span class="line"><span class="comment"># show output variable value</span></span><br><span class="line"><span class="comment"># useful for scripts to extract outputs from your configuration</span></span><br><span class="line">terraform output [output name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Update variables</span></span><br><span class="line">terraform refresh</span><br><span class="line"></span><br><span class="line"><span class="comment"># show objects being managed by state file</span></span><br><span class="line">terraform state list</span><br><span class="line"></span><br><span class="line"><span class="comment"># destroy Terraform-managed infrastructure</span></span><br><span class="line">terraform destroy [--auto-approve]</span><br></pre></td></tr></table></figure>
<h2 id="Syntax">Syntax</h2>
<p>Hashicorp <a href="https://www.terraform.io/docs/configuration/index.html" target="_blank" rel="noopener">configuration language</a>, basic block syntax:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">block_type label_one [label_two] &#123;</span><br><span class="line">    key = value</span><br><span class="line"></span><br><span class="line">    embedded_block &#123;</span><br><span class="line">        key = value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>怎么知道resource的名称呢? find the provider, then search the resources:
<a href="https://www.terraform.io/docs/configuration/resources.html" target="_blank" rel="noopener">https://www.terraform.io/docs/configuration/resources.html</a>
还有random provider，比如产生随机数.</p>
<h1>Provider</h1>
<p>Support mutliple providers, all written in Go.
<a href="https://www.terraform.io/docs/providers/index.html" target="_blank" rel="noopener">https://www.terraform.io/docs/providers/index.html</a></p>
<h1>Provisioner</h1>
<p>在deploy infrastructure 之后的配置操作，比如使用ansible or shell script as privisioners.</p>
<p>Provisioner can be ran in creation or destruction stage, you can also have multi-provisioner in one resources and they execute in order in resource.</p>
<p>Provisioner can be local or remote:</p>
<ul>
<li>file: copy file from local to remove VM instance.</li>
<li>local-exec: executes a command locally on the machine running Terraform, not the VM instance itself.</li>
<li>remote-exec: executes on remote VM instance.</li>
</ul>
<p>Terraform treats provisioners differently from other arguments. Provisioners only run when a resource is created, adding a provisioner does not force that resource to be destroyed and recreated. Use <code>terraform taint</code> to tell Terraform to recreate the instance.</p>
<h1>Functions</h1>
<p><a href="https://www.terraform.io/docs/configuration/functions.html" target="_blank" rel="noopener">https://www.terraform.io/docs/configuration/functions.html</a></p>
<p>You can experiment with functions in Terraform console, this can help with troubleshooting.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># first run terraform init</span></span><br><span class="line"><span class="comment"># it will auto load tfvars file and variables</span></span><br><span class="line">terraform console</span><br><span class="line">&gt; lower(<span class="string">"HELLO"</span>)</span><br><span class="line">&gt; merge(map1, map2)</span><br><span class="line">&gt; file(path)</span><br><span class="line">&gt; min(2,5,90)</span><br><span class="line">&gt; timestamp()</span><br><span class="line"><span class="comment"># modular</span></span><br><span class="line">&gt; 34 % 2</span><br><span class="line">&gt; cidrsubnet(var.network_address_space, 8, 0)</span><br><span class="line"><span class="comment"># lookup value in a map</span></span><br><span class="line">&gt; lookup(local.common_tags, <span class="string">"Bill"</span>, <span class="string">"Unknown"</span>)</span><br></pre></td></tr></table></figure>
<p>For example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">variable network_info &#123;</span><br><span class="line">    default = <span class="string">"10.1.0.0/16"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># split network range by adding 8 bits, fetch the first one subnet</span></span><br><span class="line"><span class="comment"># 10.1.0.0/24</span></span><br><span class="line">cidr_block = cidrsubnet(var.network_info, 8, 0)</span><br></pre></td></tr></table></figure>
<h1>Resource arguments</h1>
<p><a href="https://www.terraform.io/docs/configuration/resources.html#meta-arguments" target="_blank" rel="noopener">https://www.terraform.io/docs/configuration/resources.html#meta-arguments</a>
common ones:</p>
<ul>
<li>depends_on: make sure terraform creates things in right order</li>
<li>count: create similar resources</li>
<li>for_each: create resources not similar</li>
<li>provider: which provider should create the resource</li>
</ul>
<p>For example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">resource <span class="string">"aws_instance"</span> <span class="string">"web"</span> &#123;</span><br><span class="line">    <span class="comment"># index start from 0</span></span><br><span class="line">    count = 3</span><br><span class="line">    tags &#123;</span><br><span class="line">        Name = <span class="string">"web-<span class="variable">$&#123;count.index + 1&#125;</span>"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    depends_on = [aws_iam_role_policy.custom_name]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource <span class="string">"aws_s3_bucket"</span> <span class="string">"storage"</span> &#123;</span><br><span class="line">    for_each = &#123;</span><br><span class="line">        food = <span class="string">"public-read"</span></span><br><span class="line">        cash = <span class="string">"private"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># access key and value</span></span><br><span class="line">    bucket = <span class="string">"<span class="variable">$&#123;each.key&#125;</span>-<span class="variable">$&#123;var.bucket_suffix&#125;</span>"</span></span><br><span class="line">    acl = each.value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>Variables</h1>
<p>Other way to use variables rather than specifying in single <code>.tf</code> file.</p>
<p>The scenario, we need development, QA(Quality Assurance)/UAT(User Acceptance Testing), production environment, how to implement with one configuration and multiple inputs?</p>
<p>The variable values can be from, precedence from low to high:</p>
<ul>
<li>environment variable: <code>TF_VAR_&lt;var name&gt;</code>.</li>
<li>file: <code>terraform.tfvars</code> or specify by <code>-var-file</code> in terraform command.</li>
<li>terraform command flags <code>-var</code>.</li>
</ul>
<p>You can override variables and precedence, select value based on environment, for example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># specify default value in tf file</span></span><br><span class="line">variable <span class="string">"env_name"</span> &#123;</span><br><span class="line">  <span class="built_in">type</span> = string</span><br><span class="line">  default = <span class="string">"development"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># or specify in tfvars file</span></span><br><span class="line">env_name = <span class="string">"uat"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or specify in command line</span></span><br><span class="line">terraform plan -var <span class="string">'env_name=production'</span></span><br></pre></td></tr></table></figure>
<p>Variable types:</p>
<ul>
<li>string, the default type if no explicitly specified</li>
<li>bool: true, false</li>
<li>number (integer/decimal)</li>
<li>list (index start from 0)</li>
<li>map, value type can be number, string and bool</li>
</ul>
<p>For example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">variable <span class="string">"project"</span> &#123;</span><br><span class="line">  <span class="built_in">type</span> = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable <span class="string">"web_instance_count"</span> &#123;</span><br><span class="line">  <span class="built_in">type</span>    = number</span><br><span class="line">  default = 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># list</span></span><br><span class="line">variable <span class="string">"cidrs"</span> &#123; default = [] &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># map</span></span><br><span class="line">variable <span class="string">"machine_types"</span> &#123;</span><br><span class="line">  <span class="comment"># map type and key is string</span></span><br><span class="line">  <span class="built_in">type</span>    = map(string)</span><br><span class="line">  default = &#123;</span><br><span class="line">    dev  = <span class="string">"f1-micro"</span></span><br><span class="line">    <span class="built_in">test</span> = <span class="string">"n1-highcpu-32"</span></span><br><span class="line">    prod = <span class="string">"n1-highcpu-32"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">machine_resource = lookup(var.machine_types, var.environment_name)</span><br></pre></td></tr></table></figure>
<p>In terraform, the same syntax <code>${}</code> for interpolation as in bash:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># local variable definition</span></span><br><span class="line">locals &#123;</span><br><span class="line">  <span class="comment"># random_integer is a terraform resource</span></span><br><span class="line">  tags = <span class="string">"<span class="variable">$&#123;var.bucket_name_prefix&#125;</span>-<span class="variable">$&#123;var.environment_tag&#125;</span>-<span class="variable">$&#123;random_integer.rand.result&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># use</span></span><br><span class="line">resource <span class="string">"aws_instance"</span> <span class="string">"example"</span> &#123;</span><br><span class="line">  tags = local.tags</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>Workspace</h1>
<p>Workspace is the recommended way to working with multiple environments, for example:</p>
<ul>
<li>state management</li>
<li>variables data</li>
<li>credentials management</li>
</ul>
<p>State file example, we have dev, QA, prod three environments, put them each into separate folder, when run command, specify the input and output:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for dev environment</span></span><br><span class="line"><span class="comment"># -state: where to write state file</span></span><br><span class="line"><span class="comment"># -var-file: load file</span></span><br><span class="line">terraform plan -state=<span class="string">"./dev/dev.state"</span> \</span><br><span class="line">               -var-file=<span class="string">"common.tfvars"</span> \</span><br><span class="line">               -var-file=<span class="string">"./dev/dev.tfvars"</span></span><br></pre></td></tr></table></figure>
<p>Workspace example, there is a <code>terraform.workspace</code> built-in variable can be used to indicate the workspace currently in, then use it in map variable to select right value for different environment. (不用再去分别创建不同的folder for different environment了)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create dev workspace and switch to it</span></span><br><span class="line"><span class="comment"># 类似于git branch</span></span><br><span class="line">terraform workspace new dev</span><br><span class="line"><span class="comment"># show workspace</span></span><br><span class="line">terraform workspace list</span><br><span class="line">terraform plan -out dev.tfplan</span><br><span class="line">terraform apply <span class="string">"dev.tfplan"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># now create QA workspace</span></span><br><span class="line">terraform workspace new QA</span><br><span class="line"></span><br><span class="line"><span class="comment"># switch workspace</span></span><br><span class="line">terraform workspace select dev</span><br></pre></td></tr></table></figure>
<p>Special terraform variable to get workspace name</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  env_name = lower(terraform.workspace)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>Managing secrets</h1>
<p>Hashicorp <strong>Vault</strong> is for this purpose. it can hand over credentials from cloud provider to terraform and set ttl for the secrets.</p>
<p>Or you can use environment variable to specify the credentials, terraform will pick it automatically, but bear in mind to use the right env var name. For example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意这个和前面的TF_VAR_&lt;var name&gt; 不一样，这里是secret</span></span><br><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=xxx</span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=xxx</span><br></pre></td></tr></table></figure>
<h1>Module</h1>
<p>Make code reuse eaiser:
<a href="https://www.terraform.io/docs/configuration/modules.html" target="_blank" rel="noopener">https://www.terraform.io/docs/configuration/modules.html</a></p>
<p>Terraform registry, similar concept with Helm, Docker:
<a href="https://registry.terraform.io/" target="_blank" rel="noopener">https://registry.terraform.io/</a>
Using module block to invoke local or remote modules.</p>
<ol>
<li>root module</li>
<li>support versioning</li>
<li>provider inheritance</li>
</ol>
<p>Module components:</p>
<ul>
<li>variables input</li>
<li>resources</li>
<li>output values (calling part will take this in)</li>
</ul>
<h1>Google Cloud Platform</h1>
<p>Good tutorial:
<a href="https://learn.hashicorp.com/tutorials/terraform/google-cloud-platform-build" target="_blank" rel="noopener">https://learn.hashicorp.com/tutorials/terraform/google-cloud-platform-build</a></p>
<p>If run <code>terraform apply</code> get permission issues, add the service account used to IAM, than grant it roles. Then retry the apply command.</p>
<p>用Terraform 建造的VM instance network 没有ssh allow firewall rule, 要自己添加:
<a href="https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-ssh" target="_blank" rel="noopener">https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-ssh</a></p>
<p>Terrafrom provisions <code>GKE</code> with additional node pool:
<a href="https://learn.hashicorp.com/terraform/kubernetes/provision-gke-cluster" target="_blank" rel="noopener">https://learn.hashicorp.com/terraform/kubernetes/provision-gke-cluster</a></p>
<h2 id="Resources">Resources</h2>
<p>Commonly use reource types for terraform <code>resource</code> block:</p>
<ul>
<li>google_compute_network</li>
<li>google_compute_instance</li>
<li>google_compute_address</li>
<li>google_storage_bucket</li>
<li>google_container_cluster</li>
<li>google_container_node_pool</li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/infra/" rel="tag"># infra</a>
          
            <a href="/tags/terraform/" rel="tag"># terraform</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/12/pipeline-jenkins-learn/" rel="next" title="Jenkins Quick Start">
                <i class="fa fa-chevron-left"></i> Jenkins Quick Start
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/20/elastic-stack/" rel="prev" title="Elastic Stack Quick Start">
                Elastic Stack Quick Start <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">288</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">47</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">158</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Github-Repo"><span class="nav-number">1.1.</span> <span class="nav-text">Github Repo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Composition"><span class="nav-number">1.2.</span> <span class="nav-text">Composition</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Commands</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Syntax"><span class="nav-number">2.1.</span> <span class="nav-text">Syntax</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Provider</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">Provisioner</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">Functions</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">Resource arguments</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">7.</span> <span class="nav-text">Variables</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">8.</span> <span class="nav-text">Workspace</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">9.</span> <span class="nav-text">Managing secrets</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">10.</span> <span class="nav-text">Module</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">11.</span> <span class="nav-text">Google Cloud Platform</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Resources"><span class="nav-number">11.1.</span> <span class="nav-text">Resources</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>





  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
