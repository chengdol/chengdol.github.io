<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="//TODO: [ ] elasticsearch certificate [ ] es ML node for abnormal detect (这个还有点意思，用来分析数据的) [ ] logstash input data for testing, movielens [ ] kibana draw graph, metrics, etc [ ] elk on k8s operator, c">
<meta name="keywords" content="elastic">
<meta property="og:type" content="article">
<meta property="og:title" content="Elastic Stack Quick Start">
<meta property="og:url" content="http://yoursite.com/2020/05/20/elastic-stack/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="//TODO: [ ] elasticsearch certificate [ ] es ML node for abnormal detect (这个还有点意思，用来分析数据的) [ ] logstash input data for testing, movielens [ ] kibana draw graph, metrics, etc [ ] elk on k8s operator, c">
<meta property="og:locale" content="中文|English">
<meta property="og:image" content="https://drive.google.com/uc?id=1ch29tlydlCpFxh2RARV0EVxH_1AWSzRl">
<meta property="og:updated_time" content="2022-06-19T18:49:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Elastic Stack Quick Start">
<meta name="twitter:description" content="//TODO: [ ] elasticsearch certificate [ ] es ML node for abnormal detect (这个还有点意思，用来分析数据的) [ ] logstash input data for testing, movielens [ ] kibana draw graph, metrics, etc [ ] elk on k8s operator, c">
<meta name="twitter:image" content="https://drive.google.com/uc?id=1ch29tlydlCpFxh2RARV0EVxH_1AWSzRl">






  <link rel="canonical" href="http://yoursite.com/2020/05/20/elastic-stack/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Elastic Stack Quick Start | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">152</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">43</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">268</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/20/elastic-stack/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Elastic Stack Quick Start

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-20 17:04:40" itemprop="dateCreated datePublished" datetime="2020-05-20T17:04:40-07:00">2020-05-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-06-19 11:49:28" itemprop="dateModified" datetime="2022-06-19T11:49:28-07:00">2022-06-19</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Elastic/" itemprop="url" rel="index"><span itemprop="name">Elastic</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>//TODO:
[ ] elasticsearch certificate
[ ] es ML node for abnormal detect (这个还有点意思，用来分析数据的)
[ ] logstash input data for testing, <a href="https://grouplens.org/datasets/movielens/" target="_blank" rel="noopener">movielens</a>
[ ] kibana draw graph, metrics, etc
[ ] elk on k8s operator, check source code
[x] <a href="https://www.linkedin.com/learning/learning-the-elastic-stack-2/start-listening-to-your-infrastructure?u=56685617" target="_blank" rel="noopener">linkedin learning</a>:
[x] JKSJ elasticsearch training and <a href="https://github.com/geektime-geekbang/geektime-ELK/tree/master/part-1" target="_blank" rel="noopener">git repo</a>
[x] <a href="https://github.com/lmenezes/cerebro" target="_blank" rel="noopener">cerebro</a>, <a href="https://www.youtube.com/watch?v=ZjVmg9fftUM" target="_blank" rel="noopener">tutorial</a></p>
<h1>Elastic Stack</h1>
<p><a href="https://www.elastic.co/elastic-stack" target="_blank" rel="noopener">https://www.elastic.co/elastic-stack</a>
The Elastic Stack is one of the most effective ways to leverage open source technology to build a central logging, monitoring, and alerting system for servers and applications.</p>
<p><code>Elasticsearch</code>: distributed, fast, highly scalable document <strong>database</strong>.
<code>Logstash</code>: aggregates, filters and supplyments log data, forwards them to Elasticsearch or others.
<code>Kibana</code>: web-based front-end to visualize and analyze log data.
<code>Beats</code>: lightweight utilities for reading logs from a varity of sources, sends data to Logstash or other backends.
<code>Altering</code>: send notifications to email, slack, pagerduty so on and so forth.</p>
<p><img src="https://drive.google.com/uc?id=1ch29tlydlCpFxh2RARV0EVxH_1AWSzRl" alt=""></p>
<p><a href="https://stackoverflow.com/questions/40793901/prometheus-vs-elasticsearch-which-is-better-for-container-and-server-monitoring" target="_blank" rel="noopener">Elastic stack vs Prometheus</a>:
ELK is general-purpose no-sql stack can be used for monitoring, aggregating all the logging and shipping to elastic search for ease of browsing all the logging and similar things. Prometheus is dedicated monitoring system, alongside with service discovery consul and alert-manager.</p>
<p>My <a href="https://github.com/chengdol/InfraTree/tree/master/vagrant-elasticsearch" target="_blank" rel="noopener">Vagrant elasticsearch cluster setup</a>. Java runtime and <code>/bin/bash</code> that supports array are required, also note that elasticserach cannot boot by root user.</p>
<p>Another option is to use docker compose to create testing elasticsearch cluster, see my repo <a href="https://github.com/chengdol/InfraTree/tree/master/docker-elasticsearch" target="_blank" rel="noopener">here</a>.</p>
<h1>Elasticsearch</h1>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rolling-upgrades.html#_upgrading_your_cluster" target="_blank" rel="noopener">Version Rolling Upgrade</a>, some highlights:</p>
<ol>
<li>set <code>index.unassigned.node_left.delayed_timeout</code> to hours</li>
<li>starts from data nodes, then master nodes, one by one, ensure config yaml file is correct for each role</li>
<li>wait for recovery with big retries</li>
<li>revert <code>index.unassigned.node_left.delayed_timeout</code></li>
<li>upgrade kibana version</li>
</ol>
<p>This <a href="https://www.elastic.co/blog/just-enough-kafka-for-the-elastic-stack-part1" target="_blank" rel="noopener">blog series</a> talks about kafka + elastic experience.</p>
<p>This <a href="https://mincong.io/en/prevent-data-loss-in-elasticsearch/#message-queue-integration" target="_blank" rel="noopener">blog</a> shares some ways to enable data high reliability as well as extending resources. As we see the kafka message queue also benefits the data reliability besides throttling.
[x] red status means cluster is losing data due to no primary shard allocated.</p>
<p>There are <a href="https://www.elastic.co/downloads/elasticsearch" target="_blank" rel="noopener">several ways</a> to install: binary, rpm or on kubernetes. The package is Java self-contained, you can also specify <code>ES_JAVA_HOME</code> to use external Java.</p>
<p>Install using <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/targz.html" target="_blank" rel="noopener">archive</a>.
The Elasticsearch <code>.tar.gz</code> package does not include the systemd module (have to create by yourself). To manage Elasticsearch as a service easily, use the Debian or RPM package instead.</p>
<p>It is advisable to change the default locations of the config directory, the data directory, and the logs directory. Usually data directory is mounted on separate disk.</p>
<p>Before launching go to edit <code>$ES_HOME/config/elasticsearch.yml</code>. The configuration files should contain settings which are node-specific (such as <a href="http://node.name" target="_blank" rel="noopener">node.name</a>, node.role and storage paths), or settings which a node requires in order to be able to join a cluster, such as <a href="http://cluster.name" target="_blank" rel="noopener">cluster.name</a> and network.host.</p>
<p>The config path can be changed by <code>ES_PATH_CONF</code> env variable.</p>
<ul>
<li>elasticsearch.yml for configuring Elasticsearch</li>
<li>jvm.options for configuring Elasticsearch JVM settings, can refer to github jvm configuration for different release branch: <code>https://github.com/elastic/elasticsearch/blob/master/distribution/src/config/jvm.options</code></li>
<li>log4j2.properties for configuring Elasticsearch logging, for example the logs path is <code>/var/log/elasticsearch</code></li>
</ul>
<p>Important <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html" target="_blank" rel="noopener">elasticsearch settings</a></p>
<p>For example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cluster name</span></span><br><span class="line"><span class="string">cluster.name:</span> <span class="string">chengdol-es</span></span><br><span class="line"><span class="comment"># node name</span></span><br><span class="line"><span class="string">node.name:</span> <span class="string">master</span></span><br><span class="line"><span class="comment"># ip to access, the host public IP</span></span><br><span class="line"><span class="comment"># or using interface name such as _eth1_</span></span><br><span class="line"><span class="string">network.host:</span> <span class="number">9.30</span><span class="number">.94</span><span class="number">.85</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># a list of master-eligible nodes in the cluster</span></span><br><span class="line"><span class="comment"># Each address can be either an IP address or a hostname </span></span><br><span class="line"><span class="comment"># that resolves to one or more IP addresses via DNS.</span></span><br><span class="line"><span class="string">discovery.seed_hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span><span class="string">:9300</span></span><br><span class="line">  <span class="comment"># port default 9300</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">seeds.mydomain.com</span></span><br><span class="line">  <span class="comment"># ipv6</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">[0:0:0:0:0:ffff:c0a8:10c]:9301</span></span><br></pre></td></tr></table></figure>
<p>To form a production cluster, you need to specify, for node roles, see this <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#node-roles" target="_blank" rel="noopener">document</a> about how to statically specify master and data nodes.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cluster.name</span><br><span class="line">network.host</span><br><span class="line">discovery.seed_hosts</span><br><span class="line">cluster.initial_master_nodes</span><br><span class="line"><span class="comment"># specify dedicated node role</span></span><br><span class="line"><span class="comment"># lower version have different syntax</span></span><br><span class="line">node.roles: [ master ]</span><br><span class="line">node.roles: [ data ]</span><br></pre></td></tr></table></figure>
<p>The master node is responsible for lightweight cluster-wide actions such as creating or deleting an index, tracking which nodes are part of the cluster, and deciding which shards to allocate to which nodes.</p>
<p>High availability (HA) clusters require at least three master-eligible nodes, at least two of which are not voting-only nodes. Such a cluster will be able to elect a master node even if one of the nodes fails.</p>
<p>Data nodes hold the <strong>shards</strong> that contain the documents you have indexed. Data nodes handle data related operations like CRUD, search, and aggregations. These operations are I/O-, memory-, and CPU-intensive. It is important to monitor these resources and to add more data nodes if they are overloaded.</p>
<p>Important <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config.html" target="_blank" rel="noopener">system settings</a>:</p>
<ul>
<li>disable swapping</li>
<li>increase file descriptors</li>
<li>ensure sufficient virtual memory</li>
<li>JVM DNS cache settings</li>
<li>temporary directory not mounted with noexec</li>
<li>TCP retransmission timeout</li>
</ul>
<p>Regarding JVM settings in production environment, see this <a href="https://www.elastic.co/blog/a-heap-of-trouble" target="_blank" rel="noopener">blog</a>:</p>
<ul>
<li>set Xmx and Xms the same</li>
<li>java heap size &lt;= 50% host memory capacity</li>
<li>heap &lt;= 30GB</li>
</ul>
<p>Check elasticsearch version</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 9200 is the defaul port</span></span><br><span class="line"><span class="comment"># on browser or kibana dev console</span></span><br><span class="line">curl -XGET <span class="string">"http://&lt;master/data bind IP&gt;:9200"</span></span><br><span class="line"><span class="comment"># response from Elasticsearch server</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"master"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"chengdol-es"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"XIRbI3QxRq-ZXNuGDRqDFQ"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.11.1"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"tar"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"ff17057114c2199c9c1bbecc727003a907c0db7a"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2021-02-15T13:44:09.394032Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.7.0"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Check cluster health and number of master and data nodes:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET <span class="string">"http://&lt;master/data bind IP&gt;/_cat/health?v=true&amp;format=json&amp;pretty"</span></span><br><span class="line"><span class="comment"># response example</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"chengdol-es"</span>,</span><br><span class="line">  <span class="string">"status"</span> : <span class="string">"green"</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span> : 2,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span> : 1,</span><br><span class="line">  <span class="string">"active_primary_shards"</span> : 0,</span><br><span class="line">  <span class="string">"active_shards"</span> : 0,</span><br><span class="line">  <span class="string">"relocating_shards"</span> : 0,</span><br><span class="line">  <span class="string">"initializing_shards"</span> : 0,</span><br><span class="line">  <span class="string">"unassigned_shards"</span> : 0,</span><br><span class="line">  <span class="string">"delayed_unassigned_shards"</span> : 0,</span><br><span class="line">  <span class="string">"number_of_pending_tasks"</span> : 0,</span><br><span class="line">  <span class="string">"number_of_in_flight_fetch"</span> : 0,</span><br><span class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span> : 0,</span><br><span class="line">  <span class="string">"active_shards_percent_as_number"</span> : 100.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Besides master and data node role, there are ingest node, remote-eligible node, coordinating node(can be dedicated).</p>
<h2 id="Indiex">Indiex</h2>
<p>[x] how to create and config index
[x] how to check index, status, config
[x] how to create actually document data: check document API
[x] how to reroute shards, through cluster APIs</p>
<p>ES <a href="https://logz.io/blog/10-elasticsearch-concepts/" target="_blank" rel="noopener">10 concepts</a>, understand what is <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/glossary.html#index" target="_blank" rel="noopener">indices, document, fields, mapping, shards</a>, primary and replicas shards, document, data node, master node, and so on.</p>
<p>First, an index is some type of data organization mechanism, allowing the user to partition data a certain way. The second concept relates to replicas and shards, the mechanism Elasticsearch uses to distribute data around the cluster.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Schema - MySQL =&gt; Databases =&gt; Tables =&gt; Row =&gt; Columns (事务性, Join)</span><br><span class="line">Mapping - Elasticsearch =&gt; Indices =&gt; Types =&gt; Document =&gt; fields (相关性，高性能全文检索)</span><br></pre></td></tr></table></figure>
<p>So just remember, Indices organize data logically, but they also organize data physically through the underlying shards. When you create an index, you can define how many shards you want. Each shard is an independent Lucene index that can be hosted anywhere in your cluster.</p>
<p><code>Index module</code>: the settings for index and control all aspects related to an index, for example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">index.number_of_shards:</span> <span class="string">The</span> <span class="string">number</span> <span class="string">of</span> <span class="string">primary</span> <span class="string">shards</span> <span class="string">that</span> <span class="string">an</span> <span class="string">index</span> <span class="string">should</span> <span class="string">have</span></span><br><span class="line"><span class="string">index.number_of_replicas:</span> <span class="string">The</span> <span class="string">number</span> <span class="string">of</span> <span class="string">replicas</span> <span class="string">each</span> <span class="string">primary</span> <span class="string">shard</span> <span class="string">has.</span> <span class="string">Defaults</span> <span class="string">to</span> <span class="number">1.</span></span><br></pre></td></tr></table></figure>
<p><code>Index template</code>: tell Elasticsearch how to configure an index when it is created, Elasticsearch applies templates to new indices based on an index pattern that matches the index name. Templates are configured prior to index creation and then when an index is created either manually or through indexing a document, the template settings are used as a basis for creating the index. If a new data stream or index matches more than one index template, the index template with the highest priority is used.</p>
<p>There are two types of templates, <code>index templates</code> and <code>component templates</code>(注意old version只有index template, see this <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates-v1.html#put-index-template-v1-api-prereqs" target="_blank" rel="noopener">legacy index template</a>), template 其实包含了index module的内容.</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-get-template-v1.html" target="_blank" rel="noopener">Get index template</a> details through API.</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html" target="_blank" rel="noopener">Elasticsearch API</a>, for example: cluster status, index, document and shards, and reroute, to examine the node type (master and data nodes), shards distribution and CPU load statistics.</p>
<p>Let’s see an example to display doc content:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat indices</span></span><br><span class="line">curl -X GET <span class="string">"172.20.21.30:9200/_cat/indices?format=json"</span> | jq</span><br><span class="line"><span class="comment"># search index</span></span><br><span class="line"><span class="comment"># get list of docs and its ids</span></span><br><span class="line">curl -X GET <span class="string">"172.20.21.30:9200/&lt;index name&gt;/_search?format=json"</span> | jq</span><br><span class="line"><span class="comment"># get doc via its id</span></span><br><span class="line">curl -X GET <span class="string">"172.20.21.30:9200/&lt;index name&gt;/_doc/&lt;doc id&gt;?format=json"</span> | jq</span><br></pre></td></tr></table></figure>
<p>To upload single or bulk document data to elasticsearch, see <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs.html" target="_blank" rel="noopener">document API</a>. You can download sample here: <a href="https://www.elastic.co/guide/en/kibana/6.8/tutorial-load-dataset.html" target="_blank" rel="noopener">sample data</a>, let’s try accounts data:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># the accounts.json does not have index and type in it, so specify in curl command</span></span><br><span class="line"><span class="comment"># /bank/account is the index and type</span></span><br><span class="line"><span class="comment"># es will create index bank and type account for you automatically</span></span><br><span class="line">curl -s -H <span class="string">"Content-Type: application/x-ndjson"</span> \</span><br><span class="line">  -XPOST 172.20.21.30:9200/bank/account/_bulk?pretty \</span><br><span class="line">  --data-binary <span class="string">"@accounts.json"</span>; <span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># display indices</span></span><br><span class="line">curl -XGET 172.20.21.30:9200/_cat/indices</span><br><span class="line"><span class="comment"># check doc id 1 of index `bank`</span></span><br><span class="line">curl -XGET 172.20.21.30:9200/bank/account/1?pretty</span><br></pre></td></tr></table></figure>
<p>Query data, run on kibana dev console:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># query account from CA</span></span><br><span class="line">curl -XGET 172.20.21.30:9200/bank/account/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match"</span>: &#123;</span><br><span class="line">      <span class="string">"state"</span>: <span class="string">"CA"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In the response message, the match has a <code>_score</code> field, it tells you how relevant is the match.</p>
<h2 id="Plugins">Plugins</h2>
<p>Elasticsearch provides a variety of plugins to extend the system, for example, snapshot plugin, see <a href="https://www.elastic.co/guide/en/elasticsearch/plugins/7.15/index.html" target="_blank" rel="noopener">here</a>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list all installed plug-ins</span></span><br><span class="line">bin/elasticsearch-plugin list</span><br><span class="line"><span class="comment"># example</span></span><br><span class="line">bin/elasticsearch-plugin install analysis-icu</span><br><span class="line"><span class="comment"># api</span></span><br><span class="line">localhost:9200/_cat/plugins</span><br></pre></td></tr></table></figure>
<h1>Kibana</h1>
<p>Kibana <a href="https://www.elastic.co/guide/en/kibana/current/get-started.html" target="_blank" rel="noopener">get startd and download</a>
written in Node.js, no other dependencies needed.</p>
<p>Do a quick configuration, check my vagrant Kibana provision file and start in background:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.port:</span> <span class="number">5601</span></span><br><span class="line"><span class="string">server.host:</span> <span class="string">"172.20.21.30"</span></span><br><span class="line"></span><br><span class="line"><span class="string">server.name:</span> <span class="string">"$&#123;KIBANA_SERVER_NAME&#125;"</span></span><br><span class="line"><span class="comment"># 2 es nodes</span></span><br><span class="line"><span class="string">elasticsearch.hosts:</span> <span class="string">["http://172.20.21.30:9200",</span> <span class="string">"http://172.20.21.31:9200"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="string">pid.file:</span> <span class="string">$&#123;KIBANA_HOME&#125;/kibana.pid</span></span><br><span class="line"><span class="string">kibana.index:</span> <span class="string">".kibana"</span></span><br></pre></td></tr></table></figure>
<p>Access by <code>http://172.20.21.30:5601</code> in firefox browser.</p>
<p>Kibana has built-in <a href="https://www.elastic.co/guide/en/kibana/current/get-started.html#gs-get-data-into-kibana" target="_blank" rel="noopener">sample data</a> that you can play with, Go to add sample data then move to Analytics -&gt; Discover to query and analyze the data. You need to know <a href="https://www.elastic.co/guide/en/kibana/current/kuery-query.html" target="_blank" rel="noopener">KQL</a> to query document, <a href="https://www.elastic.co/guide/en/kibana/current/dashboard.html" target="_blank" rel="noopener">Dashboard</a> is also helpful.</p>
<p>Kibana dev console can issue HTTP request to explore ES APIs, <code>command + enter</code> to run (more shortcut see help menu, helpful!).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo command has a play botton</span></span><br><span class="line">GET /_cat/indices?v</span><br><span class="line">GET /_cat/nodes?v</span><br></pre></td></tr></table></figure>
<p>Or the data can be ingested from Logstash, see below and my Vagrant demo. Need to create Index Pattern to load data and query.</p>
<p>Also you can install plug-ins for Kibana:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/kibana-plugin install &lt;plugin&gt;</span><br><span class="line">bin/kibana-plugin list</span><br><span class="line">bin/kibana-plugin remove &lt;plugin&gt;</span><br></pre></td></tr></table></figure>
<p>I usually use <code>Discover</code> to filter and check log message, and use <code>Dashboard</code> to make graph, such Area, Bar, etc to extract data pattern.</p>
<p>I want to highlight that the <code>Area</code> graph is very useful, it will show you the proportion of each type alone with timeline. For example, in the graph settings, the horizontal axis is <code>@timtstamp</code>, vertical axis is <code>count</code> and break down by the selected field of the message.</p>
<p>There is a <a href="https://www.elastic.co/guide/en/kibana/current/managing-saved-objects.html" target="_blank" rel="noopener"><code>saved object</code></a> management, in <code>Discover</code>, <code>Dasgboard</code> and <code>Index pattern</code> section, you can save items and manage them as well as export/import from other Kibana instance.</p>
<h1>Logstash</h1>
<p>Ingest data to elasticsearch or other downstream consumers, <a href="https://www.elastic.co/guide/en/logstash/current/introduction.html" target="_blank" rel="noopener">introduction</a>. Usually be paired with Beats.</p>
<p>Logstash offers self-contained architecture-specific downloads that include <code>AdoptOpenJDK 11,</code> the latest long term support (LTS) release of JDK. Use the <code>JAVA_HOME</code> environment variable if you want to use a JDK other than the version that is bundled.</p>
<p><a href="https://www.elastic.co/guide/en/logstash/current/config-setting-files.html" target="_blank" rel="noopener">Logstash configuration Files</a>
Two types, pipeline config:</p>
<ul>
<li>/etc/logstash/conf.d</li>
</ul>
<p>and logstash settings:</p>
<ul>
<li>startup.options</li>
<li>logstash.yml</li>
<li>jvm.options</li>
<li>log4j2.properties</li>
<li>pipelines.yml</li>
</ul>
<p>There is a <code>pipeline.workers</code> setting in <code>logstash.yml</code> file and also some input plugin such as UDP has its own <code>workers</code> setting, what’s the difference? Read this post <a href="https://www.elastic.co/blog/a-history-of-logstash-output-workers" target="_blank" rel="noopener">A History of Logstash Output Workers</a>. So the input and (filter + output) are separated pools, they have separated worker thread settings, <code>pipeline.workers</code> is for (filter + output) part, the default value is equal to number of CPU core.</p>
<p><a href="https://www.elastic.co/guide/en/logstash/current/getting-started-with-logstash.html" target="_blank" rel="noopener">Getting started with Logstash</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bin/logstash --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># config file syntax check</span></span><br><span class="line"><span class="comment"># -f: config file</span></span><br><span class="line"><span class="comment"># -t/--config.test_and_exit: </span></span><br><span class="line">bin/logstash -f first-pipeline.conf --config.test_and_exit</span><br><span class="line"><span class="comment"># start logstash</span></span><br><span class="line"><span class="comment"># -r/--config.reload.automatic: used to avoid restart logstash when change conf file</span></span><br><span class="line">bin/logstash -f first-pipeline.conf --config.reload.automatic</span><br></pre></td></tr></table></figure>
<p>Ad-hoc pipeline config:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/share/logstash</span><br><span class="line"><span class="comment">## test running</span></span><br><span class="line">bin/logstash -e <span class="string">'input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;'</span></span><br><span class="line">bin/logstash -e <span class="string">'input &#123; stdin &#123; &#125; &#125; output &#123; elasticsearch &#123; hosts =&gt; ["&lt;master/data node ip&gt;:9200"] &#125; &#125;'</span></span><br><span class="line"><span class="comment">## then type something to send</span></span><br></pre></td></tr></table></figure>
<p>There are 4 important parts to config processing pipeline:</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/logstash/7.17/input-plugins.html" target="_blank" rel="noopener">Logstash input plugin</a></li>
<li><a href="https://www.elastic.co/guide/en/logstash/current/filter-plugins.html" target="_blank" rel="noopener">Logstash filter plugin</a></li>
<li><a href="https://www.elastic.co/guide/en/logstash/current/output-plugins.html" target="_blank" rel="noopener">Logstash output plugin</a></li>
<li><a href="https://www.elastic.co/guide/en/logstash/current/event-dependent-configuration.html" target="_blank" rel="noopener">Condition and reference in filter and output</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this output can be used for testing</span></span><br><span class="line">output &#123;</span><br><span class="line">    <span class="comment"># can have multiple output plugin</span></span><br><span class="line">    elasticsearch &#123;&#125;</span><br><span class="line">    kafka &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"VERBOSE"</span> <span class="keyword">in</span> [message] &#123;</span><br><span class="line">      file &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For <code>stdout</code> plugin, the output can be examined from <code>journalctl -ex -u logstash -f</code>.</p>
<h2 id="Read-Beats-Data">Read Beats Data</h2>
<p>To read data from Beats:</p>
<ol>
<li>Input: where is the data from? logs? beats?</li>
<li>Filter: how should we parse the data? grok filters, geoip filters, etc.</li>
<li>Output: where should we store the logs? backend? Elasticsearch?</li>
</ol>
<p>Go to <code>/etc/logstash/conf.d</code>, create new file for example, <code>beats.conf</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    <span class="comment">## in Beats side, listening on port 5043</span></span><br><span class="line">    beats &#123;</span><br><span class="line">        port =&gt; <span class="string">"5043"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"syslog"</span> &#123;</span><br><span class="line">        <span class="comment">## grok filter</span></span><br><span class="line">        grok &#123;</span><br><span class="line">            match =&gt; &#123; <span class="string">"message"</span> =&gt; <span class="string">"%&#123;SYSLOGTIMESTAMP:syslog_timestamp&#125; %&#123;SYSLOGHOST:syslog_hostname&#125; %&#123;DATA:syslog_program&#125;(?:\[%&#123;POSINT:syslog_pid&#125;\])?: %&#123;GREEDYDATA:syslog_message&#125;"</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        date &#123;</span><br><span class="line">           match =&gt; [ <span class="string">"syslog_timestamp"</span>, <span class="string">"MMM  d HH:mm:ss"</span>, <span class="string">"MMM dd HH:mm:ss"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        <span class="comment">## Elasticsearch address</span></span><br><span class="line">        hosts =&gt; [ <span class="string">"9.30.94.85:9200"</span> ]</span><br><span class="line">        <span class="comment">## write to index</span></span><br><span class="line">        <span class="comment">## %&#123;[@metadata][beat]&#125;: these are field and sub_field in message</span></span><br><span class="line">        index =&gt; <span class="string">"%&#123;[@metadata][beat]&#125;-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">        document_type =&gt; <span class="string">"%&#123;[@metadata][type]&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In above output <code>%{[@metadata][beat]}</code> is field access, please see <a href="https://www.elastic.co/guide/en/logstash/7.15/event-dependent-configuration.html" target="_blank" rel="noopener">Accessing event data and fields in logstash</a>, the logstash <a href="https://www.elastic.co/guide/en/logstash/7.15/configuration-file-structure.html" target="_blank" rel="noopener">data types</a></p>
<p>Then run command to testing file validity:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --config.test_and_exit: parses configuration</span></span><br><span class="line"><span class="comment"># file and reports any errors.</span></span><br><span class="line">bin/logstash -f beats.conf --config.test_and_exit</span><br><span class="line"></span><br><span class="line"><span class="comment"># The --config.reload.automatic: enables automatic </span></span><br><span class="line"><span class="comment"># config reloading so that don’t have to stop and </span></span><br><span class="line"><span class="comment"># restart Logstash every time modify the configuration file.</span></span><br><span class="line">bin/logstash -f beats.conf --config.reload.automatic</span><br></pre></td></tr></table></figure>
<h1>Beats</h1>
<p><a href="https://www.elastic.co/beats/" target="_blank" rel="noopener">https://www.elastic.co/beats/</a>
Beats, written in golang, can output data to Elasticsearch, Logstash and Redis. But usually we send data to Logstash (pre-processing) then forward to Elasticsearch.</p>
<p>Each Beat has configure yaml file with detailed configuration guideline. For example, in the configure yaml file, comment out Elasticsearch output, use Logstash output.</p>
<ul>
<li>Filebeat: text log files</li>
<li>Heartbeat: uptime</li>
<li>Metricbeat: OS and applications</li>
<li>Packetbeat: network monitoring</li>
<li>Winlogbeat: windows event log</li>
<li>Libbeat: write your own</li>
</ul>
<h1>X-Pack</h1>
<p>X-Pack is an Elastic Stack extension that provides security, alerting, monitoring, reporting, machine learning, and many other capabilities. By default, when you install Elasticsearch, X-Pack is installed, it is open-source now.</p>
<p>Check X-pack, you will see the availability and status of each component:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://9.30.94.85:9200/_xpack</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/elastic/" rel="tag"># elastic</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/16/infra-terraform-start/" rel="next" title="Terraform Quick Start">
                <i class="fa fa-chevron-left"></i> Terraform Quick Start
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/21/book-design-dataintensive-app/" rel="prev" title="Design Data-Intensive Applications">
                Design Data-Intensive Applications <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">268</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">43</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">152</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Elastic Stack</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Elasticsearch</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Indiex"><span class="nav-number">2.1.</span> <span class="nav-text">Indiex</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Plugins"><span class="nav-number">2.2.</span> <span class="nav-text">Plugins</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Kibana</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">Logstash</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Read-Beats-Data"><span class="nav-number">4.1.</span> <span class="nav-text">Read Beats Data</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">Beats</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">X-Pack</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
