<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Vagrant Jenkins server git repo for testing purpose: https://github.com/chengdol/vagrant-jenkins Certified Jenkins Enginee Certified Jenkins Engineer (CJE): https://github.com/bmuschko/cje-crash-cours">
<meta name="keywords" content="infra,jenkins,pipeline">
<meta property="og:type" content="article">
<meta property="og:title" content="Jenkins Quick Start">
<meta property="og:url" content="http://yoursite.com/2020/05/12/pipeline-jenkins-learn/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="Vagrant Jenkins server git repo for testing purpose: https://github.com/chengdol/vagrant-jenkins Certified Jenkins Enginee Certified Jenkins Engineer (CJE): https://github.com/bmuschko/cje-crash-cours">
<meta property="og:locale" content="中文|English">
<meta property="og:updated_time" content="2021-03-16T07:37:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jenkins Quick Start">
<meta name="twitter:description" content="Vagrant Jenkins server git repo for testing purpose: https://github.com/chengdol/vagrant-jenkins Certified Jenkins Enginee Certified Jenkins Engineer (CJE): https://github.com/bmuschko/cje-crash-cours">






  <link rel="canonical" href="http://yoursite.com/2020/05/12/pipeline-jenkins-learn/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Jenkins Quick Start | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">159</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">48</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">292</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/12/pipeline-jenkins-learn/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Jenkins Quick Start

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-12 22:28:03" itemprop="dateCreated datePublished" datetime="2020-05-12T22:28:03-07:00">2020-05-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-03-16 00:37:43" itemprop="dateModified" datetime="2021-03-16T00:37:43-07:00">2021-03-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Pipeline/" itemprop="url" rel="index"><span itemprop="name">Pipeline</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Vagrant Jenkins server git repo for testing purpose:
<a href="https://github.com/chengdol/vagrant-jenkins" target="_blank" rel="noopener">https://github.com/chengdol/vagrant-jenkins</a></p>
<h1>Certified Jenkins Enginee</h1>
<p>Certified Jenkins Engineer (CJE):
<a href="https://github.com/bmuschko/cje-crash-course" target="_blank" rel="noopener">https://github.com/bmuschko/cje-crash-course</a></p>
<h1>Jenkins</h1>
<p>Jenkins is not a build system, it is a structured model.
Other interesting project: <code>Tekton</code>, <code>Jenkins X</code> (k8s involved)</p>
<p>Installing Jenkins, must have compatible <code>openjdk</code> installed.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## can use war file:</span></span><br><span class="line">java -jar jenkins.war</span><br></pre></td></tr></table></figure>
<p>or using rpm install for centos/redhat, then using systemctl to start/enable Jenkins
<a href="https://www.jenkins.io/doc/book/installing/#red-hat-centos" target="_blank" rel="noopener">https://www.jenkins.io/doc/book/installing/#red-hat-centos</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## you will see the default jenkins port is 8080</span></span><br><span class="line">ps aux | grep jenkinx</span><br></pre></td></tr></table></figure>
<p>then you can open the web interface by <code>&lt;node ip&gt;:8080</code>. 如果发现是中文版，可能是浏览器的语言设置出了问题，改一下chrome的语言设置为English即可.</p>
<p>If wizard install failed with some plugins, you can fix this later in <code>Manage Plugins</code>.</p>
<p>Jenkins use file system to store everything, if using systemd, the configuration is in <code>/var/lib/jenkins</code>. You can backup this folder, or if you want to wipe it out, then run <code>systemctl restart jenkins</code>, then jenkins goes back to init state.</p>
<p>Even Jenkins UI to create project is not needed, you can mkdir and files in the Jenkins working directory, then go to <code>Manage Jenkins</code> -&gt; <code>Reload Configuration from Disk</code>.</p>
<blockquote>
<p>遇到一件很神奇的事情，有次Jenkins的Credentials配置消失了。。。重启也不见恢复，后来我直接stop daemon, 清空workspace下所有文件，再次重启初始化，就恢复了。后来想想我应该是在配置Credentials时把配置改错了，可以通过<code>Manage Jenkins</code> -&gt; <code>Configure Credentials</code> 改回去。</p>
</blockquote>
<h2 id="Creating-app-build">Creating app build</h2>
<p>freestyle project -&gt; pipeline (series of freestyle project), freestyle project is not recommended.</p>
<p>Jenkins <strong>Workspace</strong>, you can see it in console output or click <code>Workspace</code> icon in your project dashboard. Everything running is in project workspace. Every build will override the previous one. You can use tar command to backup and restore this workspace, or clean workspace.</p>
<blockquote>
<p>注意, 如果在Jenkins configuration中直接使用pipeline script 而不是 SCM, 是不会创建workspace的。</p>
</blockquote>
<p>To store the build artifact, use <code>Post-build Action</code> in configure. for example, you want to archive some jar or zip files. then after build is done, these archives will show in the build page.</p>
<h3 id="Build-trend">Build trend</h3>
<p>Right to <code>Build History</code> list, there is a <code>trend</code> button, click it will see the build time history statistics and distribution.</p>
<h2 id="Testing-and-Continuous-integration">Testing and Continuous integration</h2>
<p>Now start the <code>pipeline</code> job type. After creating a pipeline job, you will see <code>pipeline syntax</code> button in the page bottom, it contains necessary resources to start. You can also use <code>Copy from</code> to copy a pipeline configure from another, for quick start.</p>
<h3 id="Add-slave-nodes">Add slave nodes</h3>
<p><code>Manage Jenkins</code> -&gt; <code>Manage Nodes and Clouds</code>
To add slaves, usually use SSH to launch agent nodes. (如果node没有被发现，会显示错误，根据错误指示排查问题即可)</p>
<p>Before adding a slave node to the Jenkins master we need to prepare the node. We need to install <code>Java</code> on the slave node. Jenkins will install a client program on the slave node.</p>
<p>To run the client program we need to install the same Java version we used to install on Jenkins master. You need to install and configure the necessary tool in the slave node.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y java-1.8.0-openjdk</span><br></pre></td></tr></table></figure>
<p>When configure add node agent,	Host Key Verification Strategy:</p>
<ul>
<li><a href="https://support.cloudbees.com/hc/en-us/articles/115000073552-Host-Key-Verification-for-SSH-Agents" target="_blank" rel="noopener">Host Key Verification for SSH Agents</a></li>
</ul>
<h3 id="Pipeline-steps">Pipeline steps</h3>
<blockquote>
<p>This is scripted pipeline syntax, not recommended! Please use declarative pipeline directives! what are the differences between them: <a href="https://www.jenkins.io/doc/book/pipeline/#pipeline-syntax-overview" target="_blank" rel="noopener">https://www.jenkins.io/doc/book/pipeline/#pipeline-syntax-overview</a></p>
</blockquote>
<p>如果直接在Jenkins configure UI中设置Jenkins file，则常用的Steps (in snippet generator):</p>
<ul>
<li>
<p>node: Allocate node
Jenkins use <code>master &lt;-&gt; agent model</code>, you can configure tasks to be executed in agent node.</p>
</li>
<li>
<p>stage: stage</p>
</li>
<li>
<p>stash: stash some files to be used later in build</p>
</li>
<li>
<p>unstash: restore files previous stashed</p>
</li>
<li>
<p>parallel: execute in parallel (如果注册了多个slave nodes，则parallel会在上面执行并行的任务， 一般用在测试的时候，比如测试不同的环境和配置, see declarative pipeline demo code below)</p>
</li>
<li>
<p>git: Git</p>
</li>
<li>
<p>dir: Change Current Directory</p>
</li>
<li>
<p>sh: Shell Script</p>
</li>
<li>
<p>step: General Build Step</p>
</li>
<li>
<p>emailext: Extended Email</p>
</li>
</ul>
<h3 id="Triggering-auto-build">Triggering auto build</h3>
<p>在pipeline configure中有<code>Builder Triggers</code>可以选择:</p>
<ul>
<li>Build after other projects are built</li>
<li>Build periodically</li>
<li>Poll SCM</li>
<li>Disable this project</li>
<li>Quiet period</li>
<li>Trigger builds remotely</li>
</ul>
<h3 id="Email-Notification">Email Notification</h3>
<p>Using <code>emailext: Extended Email</code>，可以用groovy函数包装，传入email的subject以及内容再调用。</p>
<h2 id="Managing-plugins">Managing plugins</h2>
<p><code>Manage Jenkins</code> -&gt; <code>Manage Plugins</code>, then you can select and install plugin in <code>Available</code> section. For example:</p>
<ul>
<li>
<p>Pipeline (如果这个没安装，则不会在UI中显示pipeline的动态流程图)</p>
</li>
<li>
<p>Html publisher (常用于发布unit test后的html report，这些html文件其实是被相关test生成好的, publisher then renders it)</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">publishHTML([<span class="string">allowMissing:</span> <span class="literal">true</span>,</span><br><span class="line"><span class="symbol">            alwaysLinkToLastBuild:</span> <span class="literal">true</span>,</span><br><span class="line"><span class="symbol">                keepAll:</span> <span class="literal">true</span>,</span><br><span class="line"><span class="symbol">                reportDir:</span> <span class="string">"$WORKSPACE/cognitive-designer-api/DSJsonApiServletJUnitTests/build/reports/tests/payloadtests"</span>,</span><br><span class="line"><span class="symbol">                reportFiles:</span> <span class="string">'index.html'</span>,</span><br><span class="line"><span class="symbol">                reportName:</span> <span class="string">'Payload Test'</span>,</span><br><span class="line"><span class="symbol">                reportTitles:</span> <span class="string">''</span>])</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Green Balls (show green color for success)</p>
</li>
<li>
<p>Blue Ocean (embedded site with new Jenkins UI)</p>
</li>
<li>
<p>Job DSL: Allowing jobs to be defined in a programmatic form in a human readable file.</p>
</li>
</ul>
<blockquote>
<p>Pipeline compatible plugins:
<a href="https://github.com/jenkinsci/pipeline-plugin/blob/master/COMPATIBILITY.md" target="_blank" rel="noopener">https://github.com/jenkinsci/pipeline-plugin/blob/master/COMPATIBILITY.md</a></p>
</blockquote>
<p>在初始化设置Jenkins的时候，有可能有plugins安装失败，可以自己在<code>Manage plugin</code>中安装，然后restart Jenkins (关于restart Jenkins请在没有job运行的情况下进行，不同的安装方式restart的方法不同，或者在安装plugin的时候选择restart jenkins after install), for example: <code>systemctl restart jenkins</code>, 这可以消除控制面板上的plugin failure警告。。</p>
<h2 id="Continuous-delivery">Continuous delivery</h2>
<p>In <code>Blue Ocean</code>, you can run multiple builds in parallel. if more than one builds run in the same agent, the workplace path is distinguished by suffix (@count number). 但是能不能run multiple builds in one agent depends on how you design your pipeline and tasks.</p>
<p><code>Blue Ocean</code>中的UI对parallel的显示也很直观，方便查看。</p>
<h3 id="Trigger-builds-remotely">Trigger builds remotely</h3>
<p>Set pipeline can be triggered remotely by URL, also optionally set pipeline trigger token in pipeline configure UI (can be empty).</p>
<p>You also need to know the user token, set from current user profile menu, you must keep the your user token to somewhere, for example, store it in credential secret text. So you can refer the token for example:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TRIGGER_USER = <span class="string">"chengdol.example.com"</span></span><br><span class="line">TRIGGER_USER_TOEKN = credentials(<span class="string">'&lt;token id&gt;'</span>)</span><br></pre></td></tr></table></figure>
<p>Then in the upstream pipeline script, trigger other pipeline by running curl command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## can be http or https connection</span></span><br><span class="line"><span class="comment">## --user is the jenkin user and its token or password</span></span><br><span class="line"><span class="comment">## token=$&#123;PIPELINE_TRIGGER_TOKEN&#125; can be ignored if it's empty</span></span><br><span class="line">curl --user <span class="variable">$&#123;TRIGGER_USER&#125;</span>:<span class="variable">$&#123;TRIGGER_USER_TOEKN&#125;</span> --request POST http/https://&lt;url&gt;/job/<span class="variable">$&#123;PIPELINE_NAME&#125;</span>/buildWithParameters?token=<span class="variable">$&#123;PIPELINE_TRIGGER_TOKEN&#125;</span>\\&amp;para1=val1\\&amp;&amp;para2=val2</span><br></pre></td></tr></table></figure>
<p>You don’t need to specify all parameters in URL, the parameters default values will be used if they are not specified in the URL.</p>
<p>Notice that <code>para1</code> and <code>para2</code> must exist in parameters section of the triggered pipeline, otherwise you cannot use them. So far, based on testing, I can pass string, bool and file parameter types.</p>
<h3 id="Check-Status-of-Another-pipeline">Check Status of Another pipeline</h3>
<p>reference: <a href="https://gist.github.com/paul-butcher/dc68adc1c05ca970158c18206756dab1" target="_blank" rel="noopener">https://gist.github.com/paul-butcher/dc68adc1c05ca970158c18206756dab1</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --user <span class="variable">$&#123;LOGIN_USER&#125;</span>:<span class="variable">$&#123;LOGIN_USER_TOEKN&#125;</span> --request GET http/https://&lt;url&gt;/job/<span class="variable">$&#123;PIPELINE_NAME&#125;</span>/&lt;build number&gt;/api/json</span><br></pre></td></tr></table></figure>
<p>Then you can parse the json returned:
artifacts -&gt; result: SUCCESS, FAILURE, ABORTED</p>
<h3 id="Flyweight-executor">Flyweight executor</h3>
<p>Flyweight executor reside in Jenkins master, used to execute code outside of node allocation. Others are heavyweight executors. Flyweight executor will not be counted into executor capacity.</p>
<p>For example, we use flyweight executor for pause, in Jenkins script:
<a href="https://stackoverflow.com/questions/44737036/jenkins-pipeline-with-code-pause-for-input" target="_blank" rel="noopener">https://stackoverflow.com/questions/44737036/jenkins-pipeline-with-code-pause-for-input</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## see below declarative pipeline demo code</span></span><br><span class="line">input <span class="string">"waiting for approval, move to staging stage..."</span></span><br></pre></td></tr></table></figure>
<p>The job will be paused, you can go to <code>Paused for Input</code> to decide what to do next: proceed or abort. (In <code>Blue Ocean</code>, the pause interface is more clear)</p>
<h1>Declarative pipeline</h1>
<p>Please use <code>Groovy</code> style to wirte declarative pipeline!</p>
<p>github demo:
<a href="https://github.com/sixeyed/jenkins-pipeline-demos" target="_blank" rel="noopener">https://github.com/sixeyed/jenkins-pipeline-demos</a></p>
<p>Declarative Pipelines:
<a href="https://www.jenkins.io/doc/book/pipeline/syntax/" target="_blank" rel="noopener">https://www.jenkins.io/doc/book/pipeline/syntax/</a></p>
<p>这里有关于declarative pipeline的介绍视频, Jenkins file lives in source control!
<a href="https://www.jenkins.io/solutions/pipeline/" target="_blank" rel="noopener">https://www.jenkins.io/solutions/pipeline/</a>,</p>
<p>Using <code>Blue Ocean</code> to setup pipeline from github need personal access token (must check out repo and user options):
<a href="https://www.youtube.com/watch?v=FhDomw6BaHU" target="_blank" rel="noopener">https://www.youtube.com/watch?v=FhDomw6BaHU</a></p>
<p>In Jenkins UI, go to pipeline syntax then <code>declarative directive generator</code>, it will help you generate pipeline code for declarative pipeline:
<a href="https://www.jenkins.io/doc/book/pipeline/getting-started/#directive-generator" target="_blank" rel="noopener">https://www.jenkins.io/doc/book/pipeline/getting-started/#directive-generator</a></p>
<p>Jenkins parameters variables can be accessed by both <code>params</code> and <code>env</code> prefix, see this <a href="https://stackoverflow.com/questions/28572080/how-to-access-parameters-in-a-parameterized-build" target="_blank" rel="noopener">issue</a>.</p>
<p>This is just a basic structure demo:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  <span class="comment">// default agent specify</span></span><br><span class="line">  agent any</span><br><span class="line">  <span class="comment">// pipeline level env var, global scope</span></span><br><span class="line">  environment &#123;</span><br><span class="line">    <span class="comment">// you can put release number here</span></span><br><span class="line">    <span class="comment">// referred by env.RELEASE</span></span><br><span class="line">    RELEASE = <span class="string">'1.1.3'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// can have multiple stages</span></span><br><span class="line">  stages &#123;</span><br><span class="line">    <span class="comment">// list tool version</span></span><br><span class="line">    stage(<span class="string">'Audit tools'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">          sh <span class="string">'''</span></span><br><span class="line"><span class="string">            git version</span></span><br><span class="line"><span class="string">            docker version</span></span><br><span class="line"><span class="string">          '''</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="comment">// agent specify</span></span><br><span class="line">      agent any</span><br><span class="line">      <span class="comment">// stage level env var, stage scope</span></span><br><span class="line">      environment &#123;</span><br><span class="line">        USER = <span class="string">'root'</span></span><br><span class="line">      &#125;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo <span class="string">"this is Build stage"</span></span><br><span class="line">        <span class="comment">// executable in your repo</span></span><br><span class="line">        sh <span class="string">'chmod +x ./build.sh'</span></span><br><span class="line">        <span class="comment">// 把jenkins中一个名为api-key的密匙的值 放入 API_KEY这个环境变量中</span></span><br><span class="line">        <span class="comment">// 且这个API_KEY仅在block中可见</span></span><br><span class="line">        withCredentials([string(<span class="string">credentialsId:</span> <span class="string">'api-key'</span>, <span class="string">variable:</span> <span class="string">'API_KEY'</span>)]) &#123;</span><br><span class="line">          sh <span class="string">'''</span></span><br><span class="line"><span class="string">              ./build.sh</span></span><br><span class="line"><span class="string">          '''</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// can have different type</span></span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      environment &#123;</span><br><span class="line">        LOG_LEVEL = <span class="string">"INFO"</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// parallel tasks</span></span><br><span class="line">      parallel &#123;</span><br><span class="line">        <span class="comment">// they can be running on different agent</span></span><br><span class="line">        <span class="comment">// depends on you agent setting</span></span><br><span class="line">        stage(<span class="string">'test1'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          steps &#123;</span><br><span class="line">            <span class="comment">// show current stage name test1</span></span><br><span class="line">            echo <span class="string">"parallel $&#123;STAGE_NAME&#125;"</span></span><br><span class="line">            <span class="comment">// switch to ./src directory</span></span><br><span class="line">            dir(<span class="string">'./gradle'</span>) &#123;</span><br><span class="line">              sh <span class="string">'''</span></span><br><span class="line"><span class="string">              ./gradlew -p xxx test1</span></span><br><span class="line"><span class="string">              '''</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'test2'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          steps &#123;</span><br><span class="line">            echo <span class="string">"parallel $&#123;STAGE_NAME&#125;"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'test3'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          steps &#123;</span><br><span class="line">            echo <span class="string">"parallel $&#123;STAGE_NAME&#125;"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">      <span class="comment">// waiting for user input before deploying</span></span><br><span class="line">      input &#123;</span><br><span class="line">        message <span class="string">"Continue Deploy?"</span></span><br><span class="line">        ok <span class="string">"Do it!"</span></span><br><span class="line">        parameters &#123;</span><br><span class="line">          string(<span class="string">name:</span> <span class="string">'TARGET'</span>, <span class="string">defaultValue:</span> <span class="string">'PROD'</span>, <span class="string">description:</span> <span class="string">'target environment'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      steps &#123;</span><br><span class="line">        echo <span class="string">"this is Deploy with $&#123;env.RELEASE&#125;"</span></span><br><span class="line">        <span class="comment">// groovy code block</span></span><br><span class="line">        <span class="comment">// potential security hole, jenkins will not make it easy for you</span></span><br><span class="line">        script &#123;</span><br><span class="line">          <span class="comment">// you need to approve use of these class/method</span></span><br><span class="line">          <span class="keyword">if</span> (Math.random() &gt; <span class="number">0.5</span>) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> Exception()</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// you can use try/catch block for security reason</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// if fail, this wouldn't get executed</span></span><br><span class="line">        <span class="comment">// write 'passed' into file test-results.txt</span></span><br><span class="line">        writeFile <span class="string">file:</span> <span class="string">'test-results.txt'</span>, <span class="string">text:</span> <span class="string">'passed'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  post &#123;</span><br><span class="line">    <span class="comment">// will always be executed</span></span><br><span class="line">    always &#123;</span><br><span class="line">      echo <span class="string">"prints whether deploy happened or not, success or failure."</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// others like: success, failure, cleanup, etc</span></span><br><span class="line">    success &#123;</span><br><span class="line">      <span class="comment">// archive files</span></span><br><span class="line">      archiveArtifacts <span class="string">'test-results.txt'</span></span><br><span class="line">      <span class="comment">// slack notifation</span></span><br><span class="line">      slackSend <span class="string">channel:</span> <span class="string">'#chengdol-private'</span>,</span><br><span class="line"><span class="symbol">                   message:</span> <span class="string">"Release $&#123;env.RELEASE&#125;, success: $&#123;currentBuild.fullDisplayName&#125;."</span></span><br><span class="line">    &#125;</span><br><span class="line">    failure &#123;</span><br><span class="line">         slackSend <span class="string">channel:</span> <span class="string">'#chengdol-private'</span>,</span><br><span class="line"><span class="symbol">                   color:</span> <span class="string">'danger'</span>,</span><br><span class="line"><span class="symbol">                   message:</span> <span class="string">"Release $&#123;env.RELEASE&#125;, FAILED: $&#123;currentBuild.fullDisplayName&#125;."</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>if you don’t want to checkout SCM in stages that run in same agent, you can use this option:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">  skipDefaultCheckout <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Configure-slack">Configure slack</h2>
<p>This is a slightly out-of-date video, 其实在各自pipeline中可以自己单独配置token以及选择channel。
<a href="https://www.youtube.com/watch?v=TWwvxn2-J7E" target="_blank" rel="noopener">https://www.youtube.com/watch?v=TWwvxn2-J7E</a></p>
<p>First install <code>slack notifaction</code> plugin. Then go to <code>Manage Jenkins</code> -&gt; <code>Configure System</code>, scroll down to bottom you will see slack section, see question mark for explanation.</p>
<p>Then go to your target slack channel, select <code>Add an app</code>, search <code>Jenkins CI</code>, then add it to slack, follow the instructions to get the secret token, add this token to Jenkins credentials and use it in above slack configuration.</p>
<p>After all set, try <code>Test connection</code>, you will see message in your slack channel.</p>
<h2 id="Reusable">Reusable</h2>
<p>Reusable functions and libraries are written in <code>Groovy</code>.
<a href="https://www.eficode.com/blog/jenkins-groovy-tutorial" target="_blank" rel="noopener">https://www.eficode.com/blog/jenkins-groovy-tutorial</a></p>
<p>Let’s see some demos:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    <span class="comment">// options</span></span><br><span class="line">    parameters &#123;</span><br><span class="line">        booleanParam(<span class="string">name:</span> <span class="string">'RC'</span>, <span class="string">defaultValue:</span> <span class="literal">false</span>, <span class="string">description:</span> <span class="string">'Is this a Release Candidate?'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    environment &#123;</span><br><span class="line">        VERSION = <span class="string">"0.1.0"</span>        </span><br><span class="line">        VERSION_RC = <span class="string">"rc.2"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'Audit tools'</span>) &#123;                        </span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="comment">// call function</span></span><br><span class="line">                auditTools()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">            environment &#123;</span><br><span class="line">                <span class="comment">// call function</span></span><br><span class="line">                VERSION_SUFFIX = getVersionSuffix()</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">              echo <span class="string">"Building version: $&#123;VERSION&#125; with suffix: $&#123;VERSION_SUFFIX&#125;"</span></span><br><span class="line">              sh <span class="string">'dotnet build -p:VersionPrefix="$&#123;VERSION&#125;" --version-suffix "$&#123;VERSION_SUFFIX&#125;" ./m3/src/Pi.Web/Pi.Web.csproj'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'Unit Test'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">              <span class="comment">// switch directory</span></span><br><span class="line">              dir(<span class="string">'./m3/src'</span>) &#123;</span><br><span class="line">                sh <span class="string">'''</span></span><br><span class="line"><span class="string">                    dotnet test --logger "trx;LogFileName=Pi.Math.trx" Pi.Math.Tests/Pi.Math.Tests.csproj</span></span><br><span class="line"><span class="string">                    dotnet test --logger "trx;LogFileName=Pi.Runtime.trx" Pi.Runtime.Tests/Pi.Runtime.Tests.csproj</span></span><br><span class="line"><span class="string">                '''</span></span><br><span class="line">                mstest <span class="string">testResultsFile:</span><span class="string">"**/*.trx"</span>, <span class="string">keepLongStdio:</span> <span class="literal">true</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'Smoke Test'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">              sh <span class="string">'dotnet ./m3/src/Pi.Web/bin/Debug/netcoreapp3.1/Pi.Web.dll'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'Publish'</span>) &#123;</span><br><span class="line">            <span class="comment">// condition</span></span><br><span class="line">            when &#123;</span><br><span class="line">                expression &#123; <span class="keyword">return</span> params.RC &#125;</span><br><span class="line">            &#125; </span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">'dotnet publish -p:VersionPrefix="$&#123;VERSION&#125;" --version-suffix "$&#123;VERSION_RC&#125;" ./m3/src/Pi.Web/Pi.Web.csproj -o ./out'</span></span><br><span class="line">                archiveArtifacts(<span class="string">'out/'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// groovy methods, can run straight groovy code</span></span><br><span class="line"><span class="keyword">def</span> String getVersionSuffix() &#123;</span><br><span class="line">    <span class="keyword">if</span> (params.RC) &#123;</span><br><span class="line">        <span class="keyword">return</span> env.VERSION_RC</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> env.VERSION_RC + <span class="string">'+ci.'</span> + env.BUILD_NUMBER</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="keyword">void</span> auditTools() &#123;</span><br><span class="line">    sh <span class="string">'''</span></span><br><span class="line"><span class="string">        git version</span></span><br><span class="line"><span class="string">        docker version</span></span><br><span class="line"><span class="string">        dotnet --list-sdks</span></span><br><span class="line"><span class="string">        dotnet --list-runtimes</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Shared-library">Shared library</h2>
<p>Demo structure and code:
<a href="https://github.com/sixeyed/jenkins-pipeline-demo-library" target="_blank" rel="noopener">https://github.com/sixeyed/jenkins-pipeline-demo-library</a>
Invoking shared library at head of jenkins file:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// this is dynamic reference, explicitly specify the library in jenkins file</span></span><br><span class="line">library <span class="string">identifier:</span> <span class="string">'jenkins-pipeline-demo-library@master'</span>, <span class="string">retriever:</span> modernSCM(</span><br><span class="line">        [<span class="string">$class:</span> <span class="string">'GitSCMSource'</span>,</span><br><span class="line"><span class="symbol">        remote:</span> <span class="string">'https://github.com/sixeyed/jenkins-pipeline-demo-library.git'</span>,</span><br><span class="line">        <span class="comment">// if the repo is private, you can have credential here</span></span><br><span class="line"><span class="symbol">        credentialsId:</span> <span class="string">'&lt;credential id&gt;'</span>])</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'Audit tools'</span>) &#123; </span><br><span class="line">            environment &#123;</span><br><span class="line">                <span class="comment">// pass parameters as map</span></span><br><span class="line">                VERSION_SUFFIX = getVersionSuffix <span class="string">rcNumber:</span> env.VERSION_RC, <span class="string">isReleaseCandidate:</span> params.RC</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                auditTools()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can add <code>Global Pipeline Libraries</code> in <code>Configure Jenkins</code> for any pipeline use.
这种情况下，可以设置默认的shared library，然后在jenkins file中直接调用相关函数。</p>
<h3 id="Shared-pipelines">Shared pipelines</h3>
<p>You can put the shared pipeline into a shared library, for example:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">library <span class="string">identifier:</span> <span class="string">'jenkins-pipeline-demo-library@master'</span>, </span><br><span class="line"><span class="symbol">        retriever:</span> modernSCM([<span class="string">$class:</span> <span class="string">'GitSCMSource'</span>, <span class="string">remote:</span> <span class="string">'https://github.com/sixeyed/jenkins-pipeline-demo-library.git'</span>])</span><br><span class="line"></span><br><span class="line">crossPlatformBuild <span class="string">repoName:</span> <span class="string">'sixeyed/pi-psod-pipelines'</span>,</span><br><span class="line"><span class="symbol">                   linuxContext:</span> <span class="string">'m4'</span>, </span><br><span class="line"><span class="symbol">                   windowsContext:</span> <span class="string">'m4'</span></span><br></pre></td></tr></table></figure>
<p>Shared library is under <code>vars</code> folder. In Groovy, we can add a method named call to a class and then invoke the method without using the name <code>call</code>, crossPlatformBuild is actually the file name, inside file there is a call method.</p>
<h2 id="Multi-branch-pipeline">Multi-branch pipeline</h2>
<p><a href="https://www.jenkins.io/doc/book/pipeline/multibranch/" target="_blank" rel="noopener">https://www.jenkins.io/doc/book/pipeline/multibranch/</a>
Jenkins automatically discovers, manages and executes Pipelines for branches which contain a Jenkinsfile in source control.</p>
<p>Orphaned item strategy, for deleted branch, you can discard or reserve it.</p>
<h1>Pipeline development tools</h1>
<h2 id="Validating-pipeline-syntax">Validating pipeline syntax</h2>
<p>First enable <code>anonymous read access</code> in <code>Configure Global Security</code>:
<a href="https://www.jenkins.io/doc/book/pipeline/development/#linter" target="_blank" rel="noopener">https://www.jenkins.io/doc/book/pipeline/development/#linter</a></p>
<p>Issue curl command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## if not success, it will show you the overall problems with your jenkins file</span></span><br><span class="line">curl -X POST -F <span class="string">"jenkinsfile=&lt;[jenkins file path]"</span> http://&lt;IP&gt;:8080/pipeline-model-converter/validate</span><br></pre></td></tr></table></figure>
<p>Visual Studio code has Jenkins linter plugin, you need to configure it with linter url.</p>
<h2 id="Restart-or-replay">Restart or replay</h2>
<p>In every build interface, <code>restart from stage</code>, you can select which stage to restart (sometimes stage may fail due to external reason), <code>replay</code>, you can edit your jenkins file and library then rerun, the changes only live in current build (after succeed, check in your updates to source control).</p>
<h2 id="Unit-test">Unit test</h2>
<blockquote>
<p><a href="https://github.com/jenkinsci/JenkinsPipelineUnit" target="_blank" rel="noopener">https://github.com/jenkinsci/JenkinsPipelineUnit</a></p>
</blockquote>
<ul>
<li>Supports running pipelines and library methods</li>
<li>Can mock steps and validate calls</li>
</ul>
<h1>Jenkins with Docker</h1>
<p>学习步骤:
首先是agent 使用docker，然后master + agent 都使用docker, 最后交由K8s去管理。</p>
<p>这块很有意思，加入容器后就太灵活了，只要有build agent支持docker且已安装，则jenkins就可以把container运行在之上。
<a href="https://www.jenkins.io/doc/book/pipeline/docker/" target="_blank" rel="noopener">https://www.jenkins.io/doc/book/pipeline/docker/</a></p>
<p><a href="https://hub.docker.com/r/jenkins/jenkins" target="_blank" rel="noopener">https://hub.docker.com/r/jenkins/jenkins</a>
you can parallelly run several jenkins version in one machine, for purposes like testing new features, testing upgrade, so on and so forth. But you may need to customize the jenkins docker image and expose to different port.</p>
<ul>
<li>containers as build agents</li>
<li>customizing the build container</li>
<li>using the docker pipeline plugin</li>
</ul>
<p>Jenkins master and slave with docker:
<a href="https://medium.com/@prashant.vats/jenkins-master-and-slave-with-docker-b993dd031cbd" target="_blank" rel="noopener">https://medium.com/@prashant.vats/jenkins-master-and-slave-with-docker-b993dd031cbd</a></p>
<p>From agent syntax:
<a href="https://www.jenkins.io/doc/book/pipeline/syntax/#agent" target="_blank" rel="noopener">https://www.jenkins.io/doc/book/pipeline/syntax/#agent</a></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">agent &#123;</span><br><span class="line">    docker &#123;</span><br><span class="line">        image <span class="string">'myregistry.com/node'</span></span><br><span class="line">        <span class="comment">// can pass argument to docker run</span></span><br><span class="line">        args  <span class="string">'-v /tmp:/tmp'</span></span><br><span class="line">        <span class="comment">// the node must pre-configured to have docker</span></span><br><span class="line">        label <span class="string">'my-defined-label'</span></span><br><span class="line">        <span class="comment">// optional set the registry to pull image</span></span><br><span class="line">        registryUrl <span class="string">'https://myregistry.com/'</span></span><br><span class="line">        registryCredentialsId <span class="string">'myPredefinedCredentialsInJenkins'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If there is no <code>label</code> option, Jenkins will dynamically provisioned on a node and it will fail if no docker installed, you can set docker label to filter:
<a href="https://www.jenkins.io/doc/book/pipeline/docker/#specifying-a-docker-label" target="_blank" rel="noopener">https://www.jenkins.io/doc/book/pipeline/docker/#specifying-a-docker-label</a></p>
<p>I got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock:
<a href="https://stackoverflow.com/questions/47854463/docker-got-permission-denied-while-trying-to-connect-to-the-docker-daemon-socke" target="_blank" rel="noopener">https://stackoverflow.com/questions/47854463/docker-got-permission-denied-while-trying-to-connect-to-the-docker-daemon-socke</a></p>
<p>还解决了一个权限的问题，在实验中container默认用户是<code>jenkins</code>，没有root权限无线运行container内部的程序，解决办法是 <code>args  '-u root'</code>在上面的配置中。</p>
<p>此外jenkins会把workspace注入到container中，通过环境变量查找:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh <span class="string">'printenv'</span></span><br><span class="line">sh <span class="string">'ls -l "$WORKSPACE"</span></span><br></pre></td></tr></table></figure>
<p>Additionally, you can use agent with <code>Dockerfile</code> and install Docker Pipeline plugin.</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/infra/" rel="tag"># infra</a>
          
            <a href="/tags/jenkins/" rel="tag"># jenkins</a>
          
            <a href="/tags/pipeline/" rel="tag"># pipeline</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/30/k8s-helm-quick-start/" rel="next" title="Helm Quick Start">
                <i class="fa fa-chevron-left"></i> Helm Quick Start
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/16/infra-terraform-start/" rel="prev" title="Terraform Quick Start">
                Terraform Quick Start <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">292</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">48</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">159</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Certified Jenkins Enginee</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Jenkins</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-app-build"><span class="nav-number">2.1.</span> <span class="nav-text">Creating app build</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Build-trend"><span class="nav-number">2.1.1.</span> <span class="nav-text">Build trend</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing-and-Continuous-integration"><span class="nav-number">2.2.</span> <span class="nav-text">Testing and Continuous integration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Add-slave-nodes"><span class="nav-number">2.2.1.</span> <span class="nav-text">Add slave nodes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pipeline-steps"><span class="nav-number">2.2.2.</span> <span class="nav-text">Pipeline steps</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Triggering-auto-build"><span class="nav-number">2.2.3.</span> <span class="nav-text">Triggering auto build</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Email-Notification"><span class="nav-number">2.2.4.</span> <span class="nav-text">Email Notification</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Managing-plugins"><span class="nav-number">2.3.</span> <span class="nav-text">Managing plugins</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Continuous-delivery"><span class="nav-number">2.4.</span> <span class="nav-text">Continuous delivery</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Trigger-builds-remotely"><span class="nav-number">2.4.1.</span> <span class="nav-text">Trigger builds remotely</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Check-Status-of-Another-pipeline"><span class="nav-number">2.4.2.</span> <span class="nav-text">Check Status of Another pipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Flyweight-executor"><span class="nav-number">2.4.3.</span> <span class="nav-text">Flyweight executor</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Declarative pipeline</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Configure-slack"><span class="nav-number">3.1.</span> <span class="nav-text">Configure slack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reusable"><span class="nav-number">3.2.</span> <span class="nav-text">Reusable</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Shared-library"><span class="nav-number">3.3.</span> <span class="nav-text">Shared library</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Shared-pipelines"><span class="nav-number">3.3.1.</span> <span class="nav-text">Shared pipelines</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Multi-branch-pipeline"><span class="nav-number">3.4.</span> <span class="nav-text">Multi-branch pipeline</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">Pipeline development tools</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Validating-pipeline-syntax"><span class="nav-number">4.1.</span> <span class="nav-text">Validating pipeline syntax</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Restart-or-replay"><span class="nav-number">4.2.</span> <span class="nav-text">Restart or replay</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unit-test"><span class="nav-number">4.3.</span> <span class="nav-text">Unit test</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">Jenkins with Docker</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>





  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
