<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="From PluralSight Google Cloud path. 下载的配套slides 讲得很详细，可以参考，特别是讲解了如何选择资源组合, 每个课时中有Quick Labs. The best way to learn is to read official document along with operating on glcoud console. Some useful GCP">
<meta name="keywords" content="cloud,gcp">
<meta property="og:type" content="article">
<meta property="og:title" content="Google Cloud">
<meta property="og:url" content="http://yoursite.com/2020/07/10/cloud-gcp/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="From PluralSight Google Cloud path. 下载的配套slides 讲得很详细，可以参考，特别是讲解了如何选择资源组合, 每个课时中有Quick Labs. The best way to learn is to read official document along with operating on glcoud console. Some useful GCP">
<meta property="og:locale" content="中文|English">
<meta property="og:updated_time" content="2022-11-27T00:37:11.483Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Google Cloud">
<meta name="twitter:description" content="From PluralSight Google Cloud path. 下载的配套slides 讲得很详细，可以参考，特别是讲解了如何选择资源组合, 每个课时中有Quick Labs. The best way to learn is to read official document along with operating on glcoud console. Some useful GCP">






  <link rel="canonical" href="http://yoursite.com/2020/07/10/cloud-gcp/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Google Cloud | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">159</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">48</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">293</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/10/cloud-gcp/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Google Cloud

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-07-10 20:43:16" itemprop="dateCreated datePublished" datetime="2020-07-10T20:43:16-07:00">2020-07-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2022-11-26 16:37:11" itemprop="dateModified" datetime="2022-11-26T16:37:11-08:00">2022-11-26</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Cloud/" itemprop="url" rel="index"><span itemprop="name">Cloud</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>From PluralSight Google Cloud path.
下载的配套slides 讲得很详细，可以参考，特别是讲解了如何选择资源组合, 每个课时中有Quick Labs.</p>
<p>The best way to learn is to read official document along with operating on glcoud console.</p>
<p>Some useful GCP projects:</p>
<ul>
<li><a href="https://github.com/jesuispy/networking-101-gcp-sheet" target="_blank" rel="noopener">Networking 101 GCP Sheet</a></li>
<li><a href="https://github.com/priyankavergadia/google-cloud-4-words#the-google-cloud-developers-cheat-sheet" target="_blank" rel="noopener">Google Cloud 4 Words </a></li>
</ul>
<h1>Commands</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## after install gcloud SDK</span></span><br><span class="line"><span class="comment">## init</span></span><br><span class="line">gcloud init --console-only</span><br><span class="line"></span><br><span class="line"><span class="comment">## can login multiple user accounts</span></span><br><span class="line">gcloud auth login</span><br><span class="line"><span class="comment">## it is ADC(application default credential)</span></span><br><span class="line"><span class="comment">## for code to interact with GCP, such as terraform CLI</span></span><br><span class="line">gcloud auth application-default login [--project]</span><br><span class="line"></span><br><span class="line"><span class="comment">## same as gcloud auth login but using SA credential</span></span><br><span class="line"><span class="comment">## and roles</span></span><br><span class="line">gcloud auth activate-service-account [--key-file]</span><br><span class="line"></span><br><span class="line"><span class="comment">## list auth accounts or service account</span></span><br><span class="line">gcloud auth list</span><br><span class="line"><span class="comment">## switch account</span></span><br><span class="line">gcloud config <span class="built_in">set</span> account &lt;account name&gt;</span><br><span class="line"><span class="comment">## revoke account</span></span><br><span class="line">gcloud auth revoke &lt;account name&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## show and install components, i.e alpha, beta, kubectl...</span></span><br><span class="line">gcloud components list</span><br><span class="line">gcloud components install [beta]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## all projects under my account, not the used one</span></span><br><span class="line">gcloud projects list </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## set which project to use</span></span><br><span class="line">gcloud config <span class="built_in">set</span> project &lt;project name&gt;</span><br><span class="line"><span class="comment">## current project in use</span></span><br><span class="line">gcloud config list project</span><br><span class="line"><span class="comment">## get project ID</span></span><br><span class="line">gcloud config get-value project</span><br><span class="line"></span><br><span class="line"><span class="comment">## list service account in project</span></span><br><span class="line">gcloud iam service-accounts list [--project &lt;project ID&gt;]</span><br><span class="line"><span class="comment">## create service-account after auth login and set project</span></span><br><span class="line">gcloud iam service-accounts create &lt;SA name&gt;  [--display-name=&lt;<span class="string">"description"</span>&gt;] [--project &lt;project id&gt;]</span><br><span class="line"><span class="comment">## can update display name and description</span></span><br><span class="line">gcloud iam service-accounts update ...</span><br><span class="line"><span class="comment">## disable service account</span></span><br><span class="line">gcloud iam service-accounts <span class="built_in">enable</span>/<span class="built_in">disable</span> ... </span><br><span class="line"><span class="comment">## delete: When a service account is deleted, its role bindings </span></span><br><span class="line"><span class="comment">## are not immediately removed; they are automatically purged from </span></span><br><span class="line"><span class="comment">## the system after a maximum of 60 days.</span></span><br><span class="line">gcloud iam service-accounts delete ... </span><br><span class="line"><span class="comment">## generate credentials json file for terrform</span></span><br><span class="line"><span class="comment">## can also delete it</span></span><br><span class="line">gcloud iam service-accounts keys create ~/key.json \</span><br><span class="line">  --iam-account &lt;SA name&gt;@&lt;project ID&gt;.iam.gserviceaccount.com</span><br><span class="line"><span class="comment">## see the roles bind to service account</span></span><br><span class="line">gcloud iam service-accounts get-iam-policy &lt;SA&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## see available context</span></span><br><span class="line"><span class="comment">## -o name: show context name</span></span><br><span class="line">kubectl config get-contexts [-o name]</span><br><span class="line"><span class="comment">## switch context</span></span><br><span class="line">kubectl config use-context &lt;context name&gt;</span><br><span class="line"><span class="comment">## rename context to human readable</span></span><br><span class="line">kubectl config rename-context &lt;old&gt; &lt;new&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## export current configuration to yaml file</span></span><br><span class="line">kubectl config view --minify --flatten &gt; cluster.yaml</span><br><span class="line"><span class="comment">## the same as this gcloud command</span></span><br><span class="line"><span class="comment">## KUBECONFIG=clusters.yaml: specify cluster.yaml to store the credentials</span></span><br><span class="line">KUBECONFIG=clusters.yaml gcloud container clusters \</span><br><span class="line">get-credentials &lt;cluster name&gt; --zone=&lt;cluster zone&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## current enabled API list</span></span><br><span class="line">gcloud services list [--porject &lt;project ID&gt;]</span><br><span class="line">gcloud services <span class="built_in">enable</span> &lt;API&gt;</span><br><span class="line">gcloud services <span class="built_in">disable</span> &lt;API&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## create default VPC network</span></span><br><span class="line">gcloud compute networks create default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## create K8s cluster in default network</span></span><br><span class="line">gcloud container clusters create gke-eu --zone europe-west1-c \</span><br><span class="line">  --release-channel stable --<span class="built_in">enable</span>-ip-alias</span><br><span class="line"><span class="comment">## list cluster</span></span><br><span class="line">gcloud container clusters list</span><br><span class="line">gcloud container clusters list \</span><br><span class="line">  --project &lt;project name&gt; \</span><br><span class="line">  --filter <span class="string">"name:cluster-name"</span> \</span><br><span class="line">  --format <span class="string">"get(location)"</span></span><br><span class="line"><span class="comment">## describe</span></span><br><span class="line">gcloud container clusters describe &lt;cluster name&gt; --region &lt;region/zone&gt;</span><br><span class="line"><span class="comment">## delete cluster</span></span><br><span class="line"><span class="comment">## -q: quiet</span></span><br><span class="line">gcloud container clusters delete gke-eu --zone=europe-west1-cd [-q]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## grant IAM roles to end user in project</span></span><br><span class="line"><span class="comment">## member can be serviceAccount:email</span></span><br><span class="line">gcloud projects add-iam-policy-binding &lt;project ID&gt; \</span><br><span class="line"> --member user:&lt;member&gt; \</span><br><span class="line"> --role=roles/gkehub.admin \</span><br><span class="line"> --role=roles/resourcemanager.projectIamAdmin</span><br></pre></td></tr></table></figure>
<h1>Terms</h1>
<p>Cloud SDK commands:</p>
<ul>
<li>gcloud</li>
<li>kubectl</li>
<li>gsutil (google storage)</li>
<li>bq (big query)</li>
</ul>
<p>Cloud shell is acutally running on a ephemeral compute engine instance. 其实command line 操作创建各种资源 比UI 更方便 (这也是Terraform的基础)</p>
<p><code>Zone</code> is under <code>Region</code>, you can think of a zone as data center in a region.</p>
<p><code>Anthos</code> is google’s morden solution for hybird and multi-cloud systems and services management. (下面一章会专门总结一下)</p>
<p><code>GCP cloud functions</code>: serverless execution environment for building and connecting cloud services. With Cloud Functions you write simple, single-purpose functions that are attached to events emitted from your cloud infrastructure and services. Your Cloud Function is triggered when an event being watched is fired. Your code executes in a fully managed environment. There is no need to provision any infrastructure or worry about managing any servers.</p>
<p><code>GCP deployment manager</code>: like <code>Terraform</code>, infrastructure as code.</p>
<p><code>GCP Dataproc</code> for running Apache Spark and Apache Hadoop clusters.
<code>GCP Dataflows</code> offers managed data pipelines, serverless fully managed data processing.
<code>GCP Dataprep</code> visually explore, clean and prepare data for analysis and machine learning.</p>
<p><code>BigQuery</code> is fully managed data warehouse.
<code>Pub/Sub</code> (publisher/subscriber) is scalable, reliable messaging.
<code>DataLab</code> offers interactive data exploration. Build on Jupyter.</p>
<h1>Kubernetes Architecting</h1>
<p>Build on top of compute engine.
Container is isolated in user space to running application code, lightweight, represent as a process:</p>
<ul>
<li>process</li>
<li>linux namespace</li>
<li>cgroups</li>
<li>nuion file systems</li>
</ul>
<p>GKE abstracts away the master, only show the worker nodes on dashboard.
Use <code>Node Pool</code> to manage different kinds of nodes.
Google maintains a container registry: <code>gcr.io</code>
<code>Cloud Run</code>: build on <code>Knative</code>, for serverless workloads.</p>
<p><code>Cloud Build</code>: Build, test, and deploy on serverless CI/CD platform.</p>
<p><code>Private Cluster</code>, google products and authorized networks can access.</p>
<h1>Fundations</h1>
<p><code>Compute Engine</code> let you run virtual machine. In GCP, K8s nodes are actually virtual machine running in Compute Engine, just like IBM Fyre, you can see them in Compute Engine dashboard.</p>
<ul>
<li>Fully customized virtual machines</li>
<li>Persistent disk/SSD or optional local SSDs</li>
<li>Global load balancing and autoscaling</li>
<li>Per-second billing</li>
</ul>
<p>VM has built-in SDK commands.
A <code>vCPU</code> is equal to 1 hardware hyper-thread.</p>
<p><code>Preemptible VM</code>: can be terminated by GCP if the resources is needed in other places.
Cloud storage is binary large-object storage. 不同的storage针对不同的对象.</p>
<p><code>VPC</code>: virtual private cloud, VPC is global scope, subnet is regional, can have different zone on the same subnet. Each VPC network is contained in a GCP project. VPC make componets connect to each other or isolated from each other.</p>
<p>You control the VPC network, use its <code>route table</code> to forward traffic within network, even across subnets.</p>
<p><code>VPC</code>: 3 types:</p>
<ul>
<li>default mode</li>
<li>auto mode</li>
<li>custom mode (for production)</li>
</ul>
<p><code>VPN</code> can connect the on-premises network to GCP network.</p>
<p>VMs can be on the same subnet but different zones. Every subnet has four reserved IP addresses in its primary IP range: <code>.0</code> for subnet network itself, <code>.1</code> for subnet gateway, second-to-last address in the range and the last address.</p>
<p>The external IP is transparent to VM, managed by VPC. You will not see it by <code>ip a s</code> command.
In <code>/etc/hosts</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.128.0.2 instance-1.us-central1-a.c.terraform-k8s-282804.internal instance-1  <span class="comment"># Added by Google</span></span><br><span class="line"><span class="comment">## internal DNS reslover</span></span><br><span class="line">169.254.169.254 metadata.google.internal  <span class="comment"># Added by Google</span></span><br></pre></td></tr></table></figure>
<p>For example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nslookup instance-1</span><br><span class="line"></span><br><span class="line">Server:         169.254.169.254</span><br><span class="line">Address:        169.254.169.254<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:   instance-1.us-central1-a.c.terraform-k8s-282804.internal</span><br><span class="line">Address: 10.128.0.2</span><br></pre></td></tr></table></figure>
<p>Setup VPC peering or VPN to allow internal network connection between VPCs.</p>
<p>You can delete the whole default network setting, and create your own, for example, auto or custom mode network.</p>
<p><code>Private google access</code> (for example to access cloud storage) and <code>Cloud NAT</code> (only outbound is allowed) help VM without external IP to access internet.</p>
<p><code>RAM Disk</code>: tmpfs, fast scratch disk or cache, faster then disk but slower then memory.</p>
<p>VM comes with a single root persistent disk, can attach additional disk to VM, it is network storage! The extended disk needs to be formated and mounted by yourself, for example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs.ext4 -F -E lazy_itable_init=0 \</span><br><span class="line">                     lazy_journal_init=0,discard \</span><br><span class="line">                     /dev/disk/by_id/&lt;disk name&gt;</span><br><span class="line"></span><br><span class="line">sudo mount -o discard,defaults /dev/disk/by_id/&lt;disk name&gt; /home/&lt;target directory&gt;</span><br></pre></td></tr></table></figure>
<p><code>App engine</code> is not like Compute engine, it does not comprise of virtual machines, instead get access a family of services that application needs. Container(K8s, hybird) is in the middle of Compute engine (IssA) and App engine (PaaS). You don’t want to focus on the infrastructure at all, just want to focus on your application code. Especially suited for for building scalable web application/web site and mobile backends, RESTful API.</p>
<p>App engine flexible environment is rely on container running in virtual machine in compute engine.</p>
<h1>Core Services</h1>
<h2 id="IAM">IAM</h2>
<p>除了GCP, 其他public cloud也采取同样的RBAC策略。</p>
<p>忘了就多看几遍: <a href="https://app.pluralsight.com/library/courses/google-cloud-platform-iam-regulating-resource/table-of-contents" target="_blank" rel="noopener">Regulating Resource Usage Using Google Cloud IAM</a></p>
<p>首先理解<code>RBAC</code>，在很多场合都有应用: 分为3个部分: identity, roles and resources. Identity 可以是google account, google group and service account(not human). Role 有几种分类，比如primitive role, predefined role, custom role.</p>
<p><code>IAM</code>: identity and access management, who can do what on which resources. user of IAM can be person, group and application. Always select the least privilege to reduce the exposure to risk.</p>
<p>IAM add new member中 GCP 和 G suite  是共享用户(human)信息的。</p>
<p>Identities:</p>
<ul>
<li>google accounts</li>
<li>service accounts, belongs to your applications</li>
<li>google groups (collection of google accounts and service accounts)</li>
<li>G suite domains</li>
<li>Cloud identity domains</li>
</ul>
<p><code>Service Account</code>: used by application or virtual machine running code on your behalf, can have IAM policies attach to it:</p>
<ul>
<li>user-managed SA: for example <code>service-account-name@project-id.iam.gserviceaccount.com</code>, you choose the service account name.</li>
<li>default SA: 常见的比如使用App engine, compute engine时自动创建的service account.</li>
<li>google-managed SA: GCP 内部使用，不用管。</li>
</ul>
<p>IAM roles:</p>
<ul>
<li>primitive role: Owner, Editor, Viewer.</li>
<li>predefined role: 针对不同资源的roles，比如compite, gke, network等等.</li>
<li>custom role: 自定义的, user maintain, for more granular access.</li>
</ul>
<p>Bindings 就是把Identity 和 roles结合起来，形成一个<code>policy</code>. IAM把policy 赋予不同的对象, 比如: IAM hierarchy: Organization -&gt; folder -&gt; project -&gt; resource.</p>
<p>Project level policy operations (or organiation level)，意思是在project level上，这些member可以做规定的事情。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## add and revoke</span></span><br><span class="line"><span class="comment">## member can be user:xx or serviceAccount:xx</span></span><br><span class="line">gcloud projects add-iam-policy-binding &lt;project ID&gt; \</span><br><span class="line">  --member=member \</span><br><span class="line">  --role=&lt;role ID&gt;</span><br><span class="line">gcloud projects remove-iam-policy-binding &lt;project ID&gt; \</span><br><span class="line">  --member=member \</span><br><span class="line">  --role=&lt;role ID&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## batch operation, role bindings 都在yaml file中</span></span><br><span class="line">gcloud projects <span class="built_in">set</span>-iam-policy &lt;project id&gt; &lt;file path&gt;</span><br><span class="line">gcloud projects get-iam-policy &lt;project id&gt; [--format=json/yaml] &gt; [file path]</span><br></pre></td></tr></table></figure>
<p>注意这2个命令，这里service account被当做了resource而不是identity, 所以这里设置了其他identity去操作这个service account:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud iam service-accounts <span class="built_in">set</span>/get-iam-policy &lt;service account&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Storage-and-Database">Storage and Database</h2>
<p>Storage access control has many options, IAM is one of them and usually is enough. others like ACLs, signed URL and Signed policy document.</p>
<p><code>Cloud Storage</code>: fully managed object store. In the demo, <code>gsutil</code> command can do versioning, acl, set restrictions, etc.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if want to skip heep_proxy setting</span></span><br><span class="line">gs=<span class="string">'env -u http_proxy gsutil'</span></span><br></pre></td></tr></table></figure>
<p>The slide has info about how to choose which service: SQL, NoSQL …?</p>
<p><code>Cloud SQL</code>: a fully managed database service (MySQL or PostgreSQL), If the Cloud SQL located in the same VPC and the same region, connect it with private IP, otherwise using cloud SQL proxy connection (setup via a script).</p>
<p><code>Cloud Spanner</code>: Cloud Spanner combines the benefits of relational database structure with non-relational horizontal scale. Used for financial and inventory applications.</p>
<p><code>Cloud Firestore</code>: the next generation of Cloud Datastore. Cloud Firestore is a NoSQL document database</p>
<p><code>Cloud Bigtable</code>: a fully managed, wide-column NoSQL database that offers low latency and replication for high availability.</p>
<p><code>Cloud Memorystore</code>: creates and manages Redis instances on the Google Cloud Platform.</p>
<h2 id="Resource-Management">Resource Management</h2>
<p>Resource manager, quotas, labels and billing.</p>
<h2 id="Resource-Monitor">Resource Monitor</h2>
<p>From stackdriver collection.</p>
<h1>Scaling and Automation</h1>
<h2 id="Interconnecting-Networks">Interconnecting Networks</h2>
<p>In the demo, Two VMs in differen region and subnet, setup the <code>VPN tunnel</code> they can ping each other via private IP.</p>
<p>理解了这部分，可以自己搭建VPN翻墙了.
<code>Cloud VPN</code>: securely connect your infrastructure to GCP VPC network, useful for low-volume data connections.</p>
<p>Options: IPsec VPN tunnel, dedicated interconnect (for large traffic) and partner interconnect (via other service provider network)</p>
<p>Configure cloud VPN gateway and on-premises VPN gateway, setup VPN tunnel (encrypted traffic), must be paired.</p>
<h2 id="Load-Balancing-and-Auto-Scaling">Load Balancing and Auto Scaling</h2>
<p>Managed instance groups, typically used with autoscaler.</p>
<p>HTTP(s) load balancing: level 7 application layer load balancer.</p>
<p>In the demo, create VM with detached disk, install apach2 then keep the disk to create custom image, use this image to create instance template then creating instance groups.</p>
<h2 id="Infrastructure-Automation">Infrastructure Automation</h2>
<p>Deployment manager and Terraform, can also use Ansible, Chef, Puppet…</p>
<p>Terraform is integrated in Cloud Shell.</p>
<p>GCP marketplace, production-ready solutions.</p>
<h1>External HTTP(S) Load Balancing</h1>
<p><a href="https://cloud.google.com/load-balancing/docs/https" target="_blank" rel="noopener">https://cloud.google.com/load-balancing/docs/https</a></p>
<h1>Anthos</h1>
<p>建议把这个系列的slides下载复习。
Qucik Labs and slides are from <a href="https://app.pluralsight.com/paths/skills/architecting-hybrid-cloud-infrastructure-with-anthos" target="_blank" rel="noopener">PluralSight Anthos special</a></p>
<p>Built on open source technologies pioneered by Google—including Kubernetes, Istio, and Knative—Anthos enables consistency between on-premises and cloud environments.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">      On-premises                           Public Cloud</span><br><span class="line">|----------------------|               |-----------------------|</span><br><span class="line">|                       Config Management                      | Anthos Configuration Management</span><br><span class="line">|      &lt;==============================================&gt;        |</span><br><span class="line">|                       Service Mesh                           | Istio, communications &amp;</span><br><span class="line">|      &lt;==============================================&gt;        |        observability</span><br><span class="line">|-----------|           |              |                       |</span><br><span class="line">| Enterprise| |---------|              |-----------|           |</span><br><span class="line">| workload  | |Containers              |Containers |           | Kubernetes, deployment &amp;</span><br><span class="line">|           | |---------|              |-----------|           |             run-time platform</span><br><span class="line">|           |   K8s     |              |   GKE                 |</span><br><span class="line">|           | on-premise|              |                       |</span><br><span class="line">|-----------|-----------|              |-----------------------|</span><br></pre></td></tr></table></figure>
<p>这个系列先讲了Anthos是什么，组成结构，然后讲了service mesh, 最后讲了anthos config management (ACM).</p>
<p>几个要点:</p>
<ol>
<li>on-premises cluster中安装运行有一个agent pod, 用来主动注册该cluster到anthos control plane.</li>
<li>所有注册过的cluster是统一管理和可视的，在同一个control plane，cluster中的资源也可见.</li>
<li>Anthos中很重要的部分就是service mesh, 使用的是Istio，所以要理解这部分。见我的关于Istio的博客。</li>
<li>config management is the single source of truth, 可以把所有的policies都放在一个git repo中，是为desired state, 使用时会传播到所有被managed的objects中，是否被managed 在object manifest中有annotation标记.</li>
<li>multiple control planes DNS using Istio CoreDNS, not kube-dns (for local).</li>
</ol>
<h2 id="Ingress-of-Anthos">Ingress of Anthos</h2>
<p><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/ingress-for-anthos" target="_blank" rel="noopener">https://cloud.google.com/kubernetes-engine/docs/concepts/ingress-for-anthos</a>
这里将ingress of anthos的概念，组成以及图示都列出来了，很清晰。
Ingress for Anthos is designed to meet the load balancing needs of multi-cluster, multi-regional environments. It’s a controller for the external HTTP(S) load balancer to provide ingress for traffic coming from the internet across one or more clusters.</p>
<p>Ingress for Anthos updates the load balancer, keeping it consistent with the environment and desired state of Kubernetes resources.</p>
<p>Ingress for Anthos uses a centralized Kubernetes API server to deploy Ingress across multiple clusters. This centralized API server is called the <code>config cluster</code>. Any GKE cluster can act as the config cluster. The config cluster uses two custom resource types: <code>MultiClusterIngress</code> and <code>MultiClusterService</code>. By deploying these resources on the config cluster, the Anthos Ingress Controller deploys load balancers across multiple clusters.</p>
<p>There can have multiple <code>mcs</code> and only one <code>mci</code>. <code>mcs</code> can select specific clusters with <code>clusters</code> field. <code>mci</code> can specify default backend and other backends with rules.</p>
<p>Clusters that you register to an <code>environ</code>(An environ is a domain that groups clusters and infrastructure, manages resources, and keeps a consistent policy across them) become visible to Ingress, so they can be used as backends for Ingress.</p>
<p>Environs possess a characteristic known as <code>namespace sameness</code> which assumes that resources with the identical names and same namespace across clusters are considered to be instances of the same resource.</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/cloud/" rel="tag"># cloud</a>
          
            <a href="/tags/gcp/" rel="tag"># gcp</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/07/infra-packer/" rel="next" title="Packer Quick Start">
                <i class="fa fa-chevron-left"></i> Packer Quick Start
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/07/17/cloud-azure/" rel="prev" title="Azure Cloud">
                Azure Cloud <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">293</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">48</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">159</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Commands</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Terms</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Kubernetes Architecting</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">Fundations</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">Core Services</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#IAM"><span class="nav-number">5.1.</span> <span class="nav-text">IAM</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Storage-and-Database"><span class="nav-number">5.2.</span> <span class="nav-text">Storage and Database</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Resource-Management"><span class="nav-number">5.3.</span> <span class="nav-text">Resource Management</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Resource-Monitor"><span class="nav-number">5.4.</span> <span class="nav-text">Resource Monitor</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">Scaling and Automation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Interconnecting-Networks"><span class="nav-number">6.1.</span> <span class="nav-text">Interconnecting Networks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Load-Balancing-and-Auto-Scaling"><span class="nav-number">6.2.</span> <span class="nav-text">Load Balancing and Auto Scaling</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Infrastructure-Automation"><span class="nav-number">6.3.</span> <span class="nav-text">Infrastructure Automation</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">7.</span> <span class="nav-text">External HTTP(S) Load Balancing</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">8.</span> <span class="nav-text">Anthos</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Ingress-of-Anthos"><span class="nav-number">8.1.</span> <span class="nav-text">Ingress of Anthos</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>





  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
