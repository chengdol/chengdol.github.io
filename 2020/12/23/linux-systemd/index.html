<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="VersionDifferent may have different syntax and options in unit file, check it first:1systemctl --version To see systemd service unit configuration:1man 5 systemd.service SystemdHow To Use Systemctl to">
<meta name="keywords" content="systemd">
<meta property="og:type" content="article">
<meta property="og:title" content="Systemd Essential">
<meta property="og:url" content="http://yoursite.com/2020/12/23/linux-systemd/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="VersionDifferent may have different syntax and options in unit file, check it first:1systemctl --version To see systemd service unit configuration:1man 5 systemd.service SystemdHow To Use Systemctl to">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2021-03-16T07:37:43.053Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Systemd Essential">
<meta name="twitter:description" content="VersionDifferent may have different syntax and options in unit file, check it first:1systemctl --version To see systemd service unit configuration:1man 5 systemd.service SystemdHow To Use Systemctl to">






  <link rel="canonical" href="http://yoursite.com/2020/12/23/linux-systemd/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Systemd Essential | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">137</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">41</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">231</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/23/linux-systemd/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Systemd Essential

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-12-23 17:45:30" itemprop="dateCreated datePublished" datetime="2020-12-23T17:45:30-08:00">2020-12-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-03-16 00:37:43" itemprop="dateModified" datetime="2021-03-16T00:37:43-07:00">2021-03-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">28k</span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Version"><a href="#Version" class="headerlink" title="Version"></a>Version</h1><p>Different may have different syntax and options in unit file, check it first:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl --version</span><br></pre></td></tr></table></figure></p>
<p>To see systemd service unit configuration:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man 5 systemd.service</span><br></pre></td></tr></table></figure></p>
<h1 id="Systemd"><a href="#Systemd" class="headerlink" title="Systemd"></a>Systemd</h1><p><a href="https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units" target="_blank" rel="noopener">How To Use Systemctl to Manage Systemd Services and Units</a></p>
<p>History:<br>SysV Init -&gt; Upstart -&gt; Systemd</p>
<p>The <code>systemd</code>, system and service manager, is an init system used to bootstrap the user space and to manage system processes after boot. Use <code>systemctl</code> command to manage the service on a systemd enabled system.</p>
<p>The fundamental purpose of an init system is to initialize the components that must be started after the Linux kernel is booted (traditionally known as “userland” components). The init system is also used to manage services and daemons for the server at any point while the system is running.</p>
<p>main commands, for example using nginx, some commands have to use <code>sudo</code> if you are non-root user, since it will affect te state of the operating system, you can leave off the <code>.service</code> suffix.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># start on boot</span></span><br><span class="line"><span class="comment"># This hooks it up to a certain boot “target”</span></span><br><span class="line"><span class="comment"># causing it to be triggered when that target is started.</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nginx.service</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># start and stop</span></span><br><span class="line">sudo systemctl start nginx.service</span><br><span class="line">sudo systemctl stop nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># To attempt to reload the service without </span></span><br><span class="line"><span class="comment"># interrupting normal functionality</span></span><br><span class="line">sudo systemctl reload nginx.service</span><br><span class="line">sudo systemctl reload-or-restart nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># status overview</span></span><br><span class="line"><span class="comment"># you can see:</span></span><br><span class="line"><span class="comment"># unit file path</span></span><br><span class="line"><span class="comment"># enabled or disabled at vendor and custom</span></span><br><span class="line"><span class="comment"># up time</span></span><br><span class="line"><span class="comment"># Cgroup</span></span><br><span class="line">systemctl status nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># find overriden config files for all units</span></span><br><span class="line"><span class="comment"># 查看哪unit有drop in config snippets</span></span><br><span class="line">sudo systemd-delta</span><br></pre></td></tr></table></figure></p>
<p><code>enable</code> will create a soft link into the location on disk where systemd looks for autostart files (usually <code>/etc/systemd/system/some_target.target.wants</code>).</p>
<p>Some command exit code result used for shell script:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># may need sudo</span></span><br><span class="line">systemctl is-active nginx.service</span><br><span class="line">systemctl is-enabled nginx.service</span><br><span class="line">systemctl is-failed nginx.service</span><br></pre></td></tr></table></figure></p>
<p>Check system states managed by systemd:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list enabled units only</span></span><br><span class="line">systemctl [list-units]</span><br><span class="line"></span><br><span class="line"><span class="comment"># list all of the units that systemd has loaded or attempted to load into memory</span></span><br><span class="line"><span class="comment"># include not currently active</span></span><br><span class="line">systemctl list-units --all [--state=active|inactive] [--<span class="built_in">type</span>=service|target]</span><br><span class="line"></span><br><span class="line"><span class="comment"># show every available units installed on the system</span></span><br><span class="line">systemctl list-unit-files</span><br></pre></td></tr></table></figure></p>
<p><code>list-unit-files</code> state column: The state will usually be <code>enabled</code>, <code>disabled</code>, <code>static</code>, or <code>masked</code>. In this context, <code>static</code> means that the unit file does not contain an <code>[Install]</code> section, which is used to enable a unit. As such, these units cannot be enabled. Usually, this means that the unit performs a one-off action or is used only as a dependency of another unit and should not be run by itself.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># after mask, cannot enable or start service</span></span><br><span class="line">sudo systemctl mask nginx.service</span><br><span class="line">sudo systemctl unmask nginx.service</span><br></pre></td></tr></table></figure></p>
<p>To see full content and path of a unit file, vanilla unit files(don’t touch them, override them if needed in other places, for example <code>/etc/systemd/system</code>) are in <code>/usr/lib/systemd/system</code> and customized are in <code>/etc/systemd/system</code> folder:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># show unit file content and path</span></span><br><span class="line"><span class="comment"># if has overriding snippet, will show them as well</span></span><br><span class="line">systemctl cat nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># list dependencies </span></span><br><span class="line">systemctl list-dependencies nginx.service [--all] [--reverse] [--before] [--after]</span><br><span class="line"></span><br><span class="line"><span class="comment"># low-level detail of unit</span></span><br><span class="line"><span class="comment"># all key=values</span></span><br><span class="line"><span class="comment"># -p: display a single property</span></span><br><span class="line">systemctl show nginx.service [-p ExecStart]</span><br><span class="line"></span><br><span class="line"><span class="comment"># edit unit file</span></span><br><span class="line">sudo systemctl edit --full nginx.service</span><br><span class="line"><span class="comment"># append unit file snippet</span></span><br><span class="line">sudo systemctl edit nginx.service</span><br><span class="line"><span class="comment"># then reload to pick up changes</span></span><br><span class="line">sodu systemctl daemon-reload</span><br></pre></td></tr></table></figure></p>
<p>You can also further override by creating override.conf file in <code>/etc/systemd/system/xxx.service.d</code> folder, there are some principles for overriding, see <a href="https://unix.stackexchange.com/questions/398540/how-to-override-systemd-unit-file-settings" target="_blank" rel="noopener">here</a>.</p>
<p>In systemd, service and other unit files can be tied to a <code>target</code>.</p>
<p>Targets are special unit files that describe a system state or synchronization point. Like other units, the files that define targets can be identified by their suffix, which in this case is <code>.target</code>. Targets do not do much themselves, but are instead used to group other units together.</p>
<p>This can be used in order to bring the system to certain states, much like other init systems use <code>runlevels</code>. (仍然可以显示系统的runlevel的)</p>
<p>For instance, there is a <code>swap.target</code> that is used to indicate that swap is ready for use. Units that are part of this process can sync with this target by indicating in their configuration that they are WantedBy= or RequiredBy= the swap.target. Units that require swap to be available can specify this condition using the Wants=, Requires=, and After= specifications to indicate the nature of their relationship.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># all available targets</span></span><br><span class="line">systemctl list-unit-files --<span class="built_in">type</span>=target</span><br><span class="line"></span><br><span class="line"><span class="comment"># current default target</span></span><br><span class="line">systemctl get-default</span><br><span class="line"></span><br><span class="line"><span class="comment"># set default target</span></span><br><span class="line">sudo systemctl <span class="built_in">set</span>-default multi-user.target</span><br><span class="line">sudo systemctl <span class="built_in">set</span>-default runlevel3.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># see what units are tied to a target</span></span><br><span class="line">systemctl list-dependencies multi-user.target</span><br></pre></td></tr></table></figure>
<p>Unlike runlevels, multiple targets can be active at one time. An active target indicates that systemd has attempted to start all of the units tied to the target and has not tried to tear them down again.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># show all active targets</span></span><br><span class="line">systemctl list-units --<span class="built_in">type</span>=target</span><br></pre></td></tr></table></figure></p>
<p>This is similar to changing the runlevel in other init systems. For instance, if you are operating in a graphical environment with <code>graphical.target</code> active, you can shutdown the graphical system and put the system into a multi-user command line state by isolating the <code>multi-user.target</code>. Since graphical.target depends on multi-user.target but not the other way around, all of the graphical units will be stopped.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check units that will be kept alive</span></span><br><span class="line">systemctl list-dependencies multi-user.target</span><br><span class="line"><span class="comment"># transition</span></span><br><span class="line">sudo systemctl isolate multi-user.target</span><br></pre></td></tr></table></figure></p>
<p>Stopping and rebooting system, note <code>shutdown</code>, <code>reboot</code>, <code>poweroff</code> are actually softlink to systemctl!<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl poweroff</span><br><span class="line">sudo systemctl reboot</span><br><span class="line"><span class="comment"># boot into rescue mode (single-user)</span></span><br><span class="line">sudo systemctl rescue</span><br></pre></td></tr></table></figure></p>
<p>These all alert logged in users that the event is occurring.</p>
<p>有意思的是，这些都是同一个softlink，但是调用却有不同的效果呢? 利用了<code>$0</code> 作为判断, see <a href="https://unix.stackexchange.com/questions/77029/why-are-reboot-shutdown-and-poweroff-symlinks-to-systemctl" target="_blank" rel="noopener">here</a>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lrwxrwxrwx. 1 root root          16 Jun  6  2020 halt -&gt; ../bin/systemctl</span><br><span class="line">lrwxrwxrwx. 1 root root          16 Jun  6  2020 poweroff -&gt; ../bin/systemctl</span><br><span class="line">lrwxrwxrwx. 1 root root          16 Jun  6  2020 reboot -&gt; ../bin/systemctl</span><br><span class="line">lrwxrwxrwx. 1 root root          16 Jun  6  2020 runlevel -&gt; ../bin/systemctl</span><br><span class="line">lrwxrwxrwx. 1 root root          16 Jun  6  2020 shutdown -&gt; ../bin/systemctl</span><br><span class="line">lrwxrwxrwx. 1 root root          16 Jun  6  2020 telinit -&gt; ../bin/systemctl</span><br></pre></td></tr></table></figure></p>
<h1 id="Systemd-Journal"><a href="#Systemd-Journal" class="headerlink" title="Systemd Journal"></a>Systemd Journal</h1><p><a href="https://www.digitalocean.com/community/tutorials/how-to-use-journalctl-to-view-and-manipulate-systemd-logs" target="_blank" rel="noopener">How To Use Journalctl to View and Manipulate Systemd Logs</a></p>
<p>The journal is implemented with the <code>journald</code> daemon, which handles all of the messages produced by the kernel, initrd, services, etc.</p>
<p>这里介绍了关于systemd service journal的使用，更详细的介绍Journal 可以参考我的blog <code>&lt;&lt;Linux System Admin&gt;&gt;</code>.</p>
<p>Set time of the prompt:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># available time zone</span></span><br><span class="line">timedatectl list-timezones</span><br><span class="line"><span class="comment"># set time zone</span></span><br><span class="line">sudo timedatectl <span class="built_in">set</span>-timezone America/Los_Angeles</span><br><span class="line"><span class="comment"># check</span></span><br><span class="line">timedatectl status</span><br><span class="line"></span><br><span class="line"><span class="comment"># or using UTC</span></span><br><span class="line"><span class="comment"># --utc: time zone</span></span><br><span class="line">journalctl --utc</span><br></pre></td></tr></table></figure></p>
<p>To see log of a specific service:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># full log</span></span><br><span class="line">journalctl -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># -u: unit, but some log may be missing in ExecStartPre</span></span><br><span class="line"><span class="comment"># -b: limit to current boot</span></span><br><span class="line"><span class="comment"># -e: show ending logs</span></span><br><span class="line"><span class="comment"># -r: show in reverse order</span></span><br><span class="line"><span class="comment"># -f: tail log</span></span><br><span class="line">journalctl -u nginx.service [--since] [--until] [-e]</span><br><span class="line"></span><br><span class="line"><span class="comment"># combine related units</span></span><br><span class="line"><span class="comment"># good for debug</span></span><br><span class="line">journalctl -u nginx.service -u php-fpm.service --since today</span><br></pre></td></tr></table></figure></p>
<h1 id="Service-Unit-File"><a href="#Service-Unit-File" class="headerlink" title="Service Unit File"></a>Service Unit File</h1><p><a href="https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files" target="_blank" rel="noopener">Understanding Systemd Units and Unit Files</a></p>
<p>Here only focusing on <code>.service</code> unit. Systemd manages a broad range of resources, such as <code>.target</code>. <code>.socket</code>, <code>.device</code>, <code>.mount</code>, <code>.swap</code>, etc. They may or may not have specified section block.</p>
<p>Section block names are case-sensitive. Non-standard section name <code>[X-name]</code> has a <code>X-</code> prefix.<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="comment">#This is generally used for defining metadata for the unit </span></span><br><span class="line"><span class="comment"># and configuring the relationship of the unit to other units</span></span><br><span class="line"><span class="attr">Description</span>=</span><br><span class="line"><span class="attr">Documentation</span>=</span><br><span class="line"></span><br><span class="line"><span class="attr">Requires</span>=</span><br><span class="line"><span class="attr">BindsTo</span>=</span><br><span class="line"></span><br><span class="line"><span class="attr">Wants</span>=</span><br><span class="line"><span class="attr">Before</span>=</span><br><span class="line"><span class="attr">After</span>=</span><br><span class="line"></span><br><span class="line"><span class="attr">Conflicts</span>=</span><br><span class="line"><span class="attr">Conditionxxx</span>=</span><br><span class="line"><span class="attr">Assertxxx</span>=</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="comment"># provide configuration that is only applicable for services</span></span><br><span class="line"><span class="attr">Environment</span>=</span><br><span class="line"><span class="attr">Type</span>=simple(default)|forking|<span class="literal">on</span>eshot|dbus|notify|idle</span><br><span class="line"></span><br><span class="line"><span class="attr">PIDFile</span>=</span><br><span class="line"></span><br><span class="line"><span class="comment"># deprecated syntax</span></span><br><span class="line"><span class="comment"># if true, User and Group only applied to ExecStart</span></span><br><span class="line"><span class="attr">PermissionsStartOnly</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ExecStartPre</span>=</span><br><span class="line"></span><br><span class="line"><span class="attr">ExecStart</span>=</span><br><span class="line"><span class="attr">ExecStartPost</span>=</span><br><span class="line"><span class="attr">ExecReload</span>=</span><br><span class="line"><span class="attr">ExecStop</span>=</span><br><span class="line"><span class="attr">ExecStopPost</span>=</span><br><span class="line"></span><br><span class="line"><span class="attr">User</span>=</span><br><span class="line"><span class="attr">Group</span>=</span><br><span class="line"></span><br><span class="line"><span class="attr">RestartSec</span>=</span><br><span class="line"><span class="attr">Restart</span>=always|<span class="literal">on</span>-success|<span class="literal">on</span>-failure|<span class="literal">on</span>-abnormal|<span class="literal">on</span>-abort|<span class="literal">on</span>-watchdog</span><br><span class="line"><span class="attr">TimeoutSec</span>=</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="comment"># only units that can be enabled will have this section</span></span><br><span class="line"><span class="attr">WantedBy</span>=</span><br><span class="line"><span class="attr">RequiredBy</span>=</span><br><span class="line"></span><br><span class="line"><span class="attr">Alias</span>=</span><br><span class="line"><span class="attr">Also</span>=</span><br><span class="line"><span class="attr">DefaultInstance</span>=</span><br></pre></td></tr></table></figure></p>
<p>key=value pairs 不止这些，遇到新的可以补充。</p>
<p>Systemd does not use a shell to execute commands and does not perform <code>$PATH</code> lookup, so for example in ExecStartPre, must specify shell context to run command:<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ExecStartPre</span>=/bin/sh -c <span class="string">'pgrep process_name &gt; /var/run/process_name.pid'</span></span><br></pre></td></tr></table></figure></p>
<p>And because of no $PATH lookup, must use absolute path to binary or executable.</p>
<p>Setting <code>PermissionsStartOnly=true</code> means that User &amp; Group are only applied to ExecStart. So switching to the new syntax will be :<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ExecStartPre</span>=+/bin/bash -c <span class="string">'/bin/journalctl -b -u ntpdate | /bin/grep -q -e "adjust time server" -e "step time server"'</span></span><br><span class="line"><span class="attr">ExecStartPre</span>=+/bin/mkdir -p /path/to/somedir</span><br><span class="line"><span class="attr">ExecStart</span>=/path/to/myservice</span><br><span class="line"><span class="attr">ExecStop</span>=+/bin/kill -INT <span class="variable">$&#123;MAINPID&#125;</span></span><br><span class="line"><span class="attr">ExecReload</span>=+/bin/kill -INT <span class="variable">$&#123;MAINPID&#125;</span> &amp;&amp; /path/to/myservice</span><br></pre></td></tr></table></figure></p>
<p>Prefix with <code>+</code> will be executed with higher privilege as root. 还需要注意的是每次ExecStartPre的运行环境都是独立的。 </p>
<p>If needs to check the log of latest daemon start process, this will show you all log instead of only unit, I found if use <code>-u</code> to specify unit, some log will miss:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use `b` and `f` to move page</span></span><br><span class="line"><span class="comment"># -e: tail</span></span><br><span class="line"><span class="comment"># -x: more details</span></span><br><span class="line">journalctl -ex</span><br></pre></td></tr></table></figure></p>
<p><a href="https://stackoverflow.com/questions/48195340/systemd-with-multiple-execstart" target="_blank" rel="noopener">Systemd with multiple execStart</a>: serivce type 和 ExecStart 个数有关.</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/systemd/" rel="tag"># systemd</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/12/21/cloud-init/" rel="next" title="Cloud Init Quick Start">
                <i class="fa fa-chevron-left"></i> Cloud Init Quick Start
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/12/25/linux-system-admin/" rel="prev" title="Linux System Admin">
                Linux System Admin <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">231</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">41</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">137</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Version"><span class="nav-number">1.</span> <span class="nav-text">Version</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Systemd"><span class="nav-number">2.</span> <span class="nav-text">Systemd</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Systemd-Journal"><span class="nav-number">3.</span> <span class="nav-text">Systemd Journal</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Service-Unit-File"><span class="nav-number">4.</span> <span class="nav-text">Service Unit File</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="Symbols count total">1.1m</span>
  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
