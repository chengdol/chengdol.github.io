<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Course git repo, this repo has useful Vault commands: https://github.com/ned1313/Getting-Started-Vault My Vault vagrant demo: https://github.com/chengdol/InfraTree/tree/master/vagrant-vault Questions">
<meta name="keywords" content="infra,vault">
<meta property="og:type" content="article">
<meta property="og:title" content="Vault Quick Start">
<meta property="og:url" content="http://yoursite.com/2020/06/21/infra-vault/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="Course git repo, this repo has useful Vault commands: https://github.com/ned1313/Getting-Started-Vault My Vault vagrant demo: https://github.com/chengdol/InfraTree/tree/master/vagrant-vault Questions">
<meta property="og:locale" content="中文|English">
<meta property="og:updated_time" content="2020-11-09T07:49:09.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Vault Quick Start">
<meta name="twitter:description" content="Course git repo, this repo has useful Vault commands: https://github.com/ned1313/Getting-Started-Vault My Vault vagrant demo: https://github.com/chengdol/InfraTree/tree/master/vagrant-vault Questions">






  <link rel="canonical" href="http://yoursite.com/2020/06/21/infra-vault/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Vault Quick Start | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">159</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">48</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">296</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/21/infra-vault/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Vault Quick Start

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-21 18:01:49" itemprop="dateCreated datePublished" datetime="2020-06-21T18:01:49-07:00">2020-06-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-11-08 23:49:09" itemprop="dateModified" datetime="2020-11-08T23:49:09-08:00">2020-11-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Infra/" itemprop="url" rel="index"><span itemprop="name">Infra</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Course git repo, this repo has useful Vault commands:
<a href="https://github.com/ned1313/Getting-Started-Vault" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault</a></p>
<p>My Vault vagrant demo:
<a href="https://github.com/chengdol/InfraTree/tree/master/vagrant-vault" target="_blank" rel="noopener">https://github.com/chengdol/InfraTree/tree/master/vagrant-vault</a></p>
<h1>Questions</h1>
<p><a href="https://www.reddit.com/r/devops/comments/ejfzhl/kubernetes_secrets_vs_hashicorp_vault/" target="_blank" rel="noopener">Vault vs K8s secrets?</a>
Examples of what Vault can do that k8s secrets cannot:
With Vault you can rotate secrets and have secrets with short TTL
With Vault you can access secrets across namespaces (or outside the k8s cluster)
Vault can provide a PKI for signing certs (enabling for example automation of cert generation for mtls)
Vault can use LDAP, oauth, IAM, etc as identity providers</p>
<h1>Introduction</h1>
<p>Vault web site:
<a href="https://www.vaultproject.io/" target="_blank" rel="noopener">https://www.vaultproject.io/</a></p>
<p>Secure, store and tightly control access to tokens, passwords, certificates, encryption keys for protecting secrets and other sensitive data using a UI, CLI, or HTTP API.
注意API的path，并不是和UI上的path一样！</p>
<p>Vault works well with Consul, for example, set Consul as storage backend.</p>
<p>Start a Vault server:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## same as consul in development mode, don't use this in production!</span></span><br><span class="line"><span class="comment">## 0.0.0.0:8200, used for vagrant port fordwarding access from host</span></span><br><span class="line">vault server -dev-listen-address 0.0.0.0:8200 -dev</span><br></pre></td></tr></table></figure>
<p>Output as below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">WARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory</span><br><span class="line">and starts unsealed with a single unseal key. The root token is already</span><br><span class="line">authenticated to the CLI, so you can immediately begin using Vault.</span><br><span class="line"></span><br><span class="line">You may need to set the following environment variable:</span><br><span class="line"></span><br><span class="line">    $ export VAULT_ADDR=&apos;http://0.0.0.0:8200&apos;</span><br><span class="line"></span><br><span class="line">The unseal key and root token are displayed below in case you want to</span><br><span class="line">seal/unseal the Vault or re-authenticate.</span><br><span class="line"></span><br><span class="line">## these two are critical</span><br><span class="line">Unseal Key: pLNBmZQRHvspdy5unZcTjm1jOVQ81Z0pO6ywYHNP1zQ=</span><br><span class="line">Root Token: s.hfnmMkgG7cggWDOmPfHC1jIe</span><br><span class="line"></span><br><span class="line">Development mode should NOT be used in production installations!</span><br></pre></td></tr></table></figure>
<p><code>unseal</code> key在production mode中用来解除对Vault server的封锁，否则无法login as root.</p>
<p>注意，这里VAULT_ADDR是本地的，vault server当然可以在其他地方，设置对应的地址即可.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Vault API access</span></span><br><span class="line"><span class="built_in">export</span> VAULT_ADDR=<span class="string">'http://0.0.0.0:8200'</span></span><br><span class="line"><span class="built_in">export</span> VAULT_TOKEN=s.ttlDcetbJe3uLt0FF5rSidg3</span><br><span class="line"></span><br><span class="line"><span class="comment">## login to vault server need VAULT_TOKEN to login</span></span><br><span class="line">vault login</span><br></pre></td></tr></table></figure>
<p>Vault web UI access: <code>http://localhost:8200</code></p>
<p>So, just like Consul, there are 3 ways to interact with Vault server: UI, API, CLI (actually running API under the hood).</p>
<p><code>secret</code> is a pre-existing secret engine folder in Vault storage path, you can see it in UI:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Write a secret</span></span><br><span class="line">vault kv put secret/hg2g answer=42</span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line"><span class="comment"># marvin.json is a json file</span></span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> --request POST \</span><br><span class="line"> --data @marvin.json <span class="variable">$VAULT_ADDR</span>/v1/secret/data/marvin</span><br></pre></td></tr></table></figure>
<p>marvin.json is as follow:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"paranoid"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="string">"bored"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Get a secret</span></span><br><span class="line">vault kv get secret/hg2g</span><br><span class="line"><span class="comment">#specify format</span></span><br><span class="line">vault kv get -format=json secret/hg2g</span><br><span class="line">vault kv get -format=yaml secret/hg2g</span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line"><span class="comment">#Install jq if necessary</span></span><br><span class="line">sudo yum install jq -y</span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> <span class="variable">$VAULT_ADDR</span>/v1/secret/data/marvin | jq</span><br><span class="line"></span><br><span class="line"><span class="comment">#Put a new secret in and a new value for an existing secret</span></span><br><span class="line">vault kv put secret/hg2g answer=54 ford=prefect</span><br><span class="line">vault kv get secret/hg2g</span><br><span class="line"></span><br><span class="line"><span class="comment">#Delete the secrets</span></span><br><span class="line">vault kv delete secret/hg2g</span><br><span class="line">vault kv get secret/hg2g</span><br><span class="line"></span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> --request DELETE <span class="variable">$VAULT_ADDR</span>/v1/secret/data/marvin</span><br></pre></td></tr></table></figure>
<h1>Working with Secrets</h1>
<p>Secret lifecycle:</p>
<ul>
<li>Create</li>
<li>Read</li>
<li>Update</li>
<li>Delete (soft or hard unrecoverable)</li>
<li>Destroy</li>
</ul>
<p>There is version <code>1</code> and version <code>2</code> of <code>secret engine server</code>, version <code>2</code> is more recoverable and versioning but less performance then version <code>1</code> if you need to scale. <code>secret</code> folder 就是默认创建的secret engine, version <code>2</code>, 可以去UI 查看configuration.</p>
<p>Demo code about secrets lifecycle:
<a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-secretslifecycle.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-secretslifecycle.sh</a></p>
<p>Everytime you update the key, the version increment by 1:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## pick value by version</span></span><br><span class="line">vault kv get -version=3 secret/hg2g</span><br><span class="line"><span class="comment">## from API</span></span><br><span class="line">curl -X GET --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> <span class="variable">$VAULT_ADDR</span>/v1/secret/data/hg2g?version=3 | jq .data.data</span><br></pre></td></tr></table></figure>
<p>If you delete version 3, you still can get version 1 or 2:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vault kv delete secret/hg2g</span><br><span class="line">vault kv get -version=2 secret/hg2g</span><br><span class="line"><span class="comment">## undelete version 3</span></span><br><span class="line"><span class="comment">## -versions not -version, you can undelete multiple: -versions=2,3</span></span><br><span class="line">vault kv undelete -versions=3 secret/hg2g</span><br><span class="line"></span><br><span class="line"><span class="comment">## API</span></span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> --request POST \</span><br><span class="line">  <span class="variable">$VAULT_ADDR</span>/v1/secret/undelete/hg2g  --data <span class="string">'&#123;"versions": [2]&#125;'</span></span><br></pre></td></tr></table></figure>
<p>Destroy, can no longer undelete:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Destroy the secrets</span></span><br><span class="line">vault kv destroy -versions=1,2 secret/hg2g</span><br><span class="line"></span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line"><span class="comment">## metadata is still there</span></span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> --request POST \</span><br><span class="line">  <span class="variable">$VAULT_ADDR</span>/v1/secret/destroy/hg2g --data <span class="string">'&#123;"versions": [1,2]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Remove all data about secrets</span></span><br><span class="line">vault kv metadata delete secret/hg2g</span><br><span class="line">vault kv get secret/hg2g</span><br><span class="line"></span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> --request DELETE \</span><br><span class="line">  <span class="variable">$VAULT_ADDR</span>/v1/secret/metadata/hg2g</span><br></pre></td></tr></table></figure>
<h2 id="Create-New-Secret-Engine">Create New Secret Engine</h2>
<p>Demo about secret engine, 我这里就不贴出来了, 如果用API，还有一些配置用的json文件，见这个的上层目录中的比如<code>dev-b.json</code>:
<a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-secretengine.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-secretengine.sh</a></p>
<h2 id="Create-Mysql-DB-Secret-Engine">Create Mysql DB Secret Engine</h2>
<p>Vault official reference:
<a href="https://www.vaultproject.io/docs/secrets" target="_blank" rel="noopener">https://www.vaultproject.io/docs/secrets</a></p>
<p>Vault在这里类似一个中间层，在user 和 Mysql instance之间，保存和传递credential和请求. 这个demo在AZure上spin up了一个bitnami Mysql instance，和本地的vault mysql secret engine关联，然后通过Vault联系Mysql 产生一个dynamic user，并授予这个临时user权限，我们通过这个临时user就可以操作Mysql 数据库了。</p>
<p>这个dynamic user lifecycle also managed by Vault, as well as the permission the user has.
<a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-mysqlengine.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-mysqlengine.sh</a></p>
<p>Besides Mysql example, Vault secrets can be used for certificates, for SSH credentials, etc.
Secrets engine make Vault extensible, there are different plugin to handle different needs.</p>
<h1>Controlling Access</h1>
<p>Similar to RBAC in K8s, authentication method to control login, policies to control what is able to do, managing client tokens.</p>
<h2 id="Vault-Auth-Method">Vault Auth Method</h2>
<p>Vault has internal authentication (called <code>userpass</code>) and support external, multiple authrntication methods.
<a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-basicauth.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-basicauth.sh</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## list current auth methods</span></span><br><span class="line"><span class="comment">## by default, we only have token auth method</span></span><br><span class="line">vault auth list</span><br><span class="line"><span class="comment">## enable new auth method</span></span><br><span class="line">vault auth <span class="built_in">enable</span> userpass</span><br><span class="line"><span class="comment">## create user</span></span><br><span class="line">vault write auth/userpass/users/arthur password=dent</span><br><span class="line"><span class="comment">## list user</span></span><br><span class="line">vault list auth/userpass/users</span><br></pre></td></tr></table></figure>
<p>You will see the changes in UI <code>Access</code> section.</p>
<p>Once you create a user/password, then you can run for example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 这里使用的是user/password login，不是用token</span></span><br><span class="line">vault login -method=userpass username=arthur</span><br><span class="line"><span class="comment">## then input password</span></span><br><span class="line">Password (will be hidden): </span><br><span class="line"><span class="comment">## 这个warning是因为，做实验的时候之前export了root token</span></span><br><span class="line">WARNING! The VAULT_TOKEN environment variable is <span class="built_in">set</span>! This takes precedence</span><br><span class="line">over the value <span class="built_in">set</span> by this <span class="built_in">command</span>. To use the value <span class="built_in">set</span> by this <span class="built_in">command</span>,</span><br><span class="line"><span class="built_in">unset</span> the VAULT_TOKEN environment variable or <span class="built_in">set</span> it to the token displayed</span><br><span class="line">below.</span><br><span class="line"></span><br><span class="line">Success! You are now authenticated. The token information displayed below</span><br><span class="line">is already stored <span class="keyword">in</span> the token helper. You <span class="keyword">do</span> NOT need to run <span class="string">"vault login"</span></span><br><span class="line">again. Future Vault requests will automatically use this token.</span><br><span class="line"></span><br><span class="line">Key                    Value</span><br><span class="line">---                    -----</span><br><span class="line">token                  s.z52FGzn78XynKlxeS0Akt0t7</span><br><span class="line">token_accessor         90LaRNNtsCUEg6yDd9ldRi3v</span><br><span class="line">token_duration         768h</span><br><span class="line">token_renewable        <span class="literal">true</span></span><br><span class="line">token_policies         [<span class="string">"default"</span>]</span><br><span class="line">identity_policies      []</span><br><span class="line">policies               [<span class="string">"default"</span>]</span><br><span class="line">token_meta_username    arthur</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## will show you where is the token from, not root token any more</span></span><br><span class="line"><span class="comment">## see `path` field where is the token from</span></span><br><span class="line">vault token lookup</span><br></pre></td></tr></table></figure>
<p>Token represents who you are and what you can do, for example, the user itself cannot update its password via its token:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## update password</span></span><br><span class="line">vault write auth/userpass/users/arthur/password password=tricia</span><br><span class="line"><span class="comment">## output</span></span><br><span class="line">Error writing data to auth/userpass/users/arthur/password: Error making API request.</span><br><span class="line"></span><br><span class="line">URL: PUT http://0.0.0.0:8200/v1/auth/userpass/users/arthur/password</span><br><span class="line">Code: 403. Errors:</span><br><span class="line"></span><br><span class="line">* 1 error occurred:</span><br><span class="line">	* permission denied</span><br></pre></td></tr></table></figure>
<p>Can do this after export root token.</p>
<p>Delete auth:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Remove account</span></span><br><span class="line">vault delete auth/userpass/users/arthur</span><br></pre></td></tr></table></figure>
<p>这里介绍了2个新概念: <code>LDAP</code> and <code>Active Directory</code>
<a href="https://stackoverflow.com/questions/663402/what-are-the-differences-between-ldap-and-active-directory" target="_blank" rel="noopener">What are the differences between LDAP and Active Directory?</a>
Active Directory is a database based system that provides authentication, directory, policy, and other services in a Windows environment</p>
<p>LDAP (Lightweight Directory Access Protocol) is an application protocol for querying and modifying items in directory service providers like Active Directory, which supports a form of LDAP.</p>
<p>Short answer: AD is a directory services database, and LDAP is one of the protocols you can use to talk to it.</p>
<p>见下面vault policy章节的例子.
Case: 在外部设置了<code>AD</code> as authentication method, enable <code>LDAP</code> auth in Vault. Then user login Vault with AD credentials against LDAP talk to AD, AD talk to Vault and determine the policy about what the user can do, then user will get the right token from vault to access the store.</p>
<h2 id="Vault-Policy">Vault Policy</h2>
<p>Similar to K8s role.
<a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-activedirectory.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-activedirectory.sh</a></p>
<p>这个例子，远程登录了一个Vault server, login as root, create <code>devkv</code> store with key and value pair, then create policy <code>dev</code> with HCL file for user to access the <code>devkv</code>.</p>
<p>Enable LDAP auth, configure it with Active Directory remotely. Then assign the <code>developers</code> group in LDAP with <code>dev</code> policy.</p>
<p>Then user <code>adent</code> login vault against <code>ldap</code> method. The user is in the <code>developers</code> group so it will get token with permission specified by <code>dev</code> policy.</p>
<h2 id="Client-Token">Client Token</h2>
<p><a href="https://www.vaultproject.io/docs/concepts/tokens" target="_blank" rel="noopener">https://www.vaultproject.io/docs/concepts/tokens</a></p>
<h2 id="Wrapping-Response">Wrapping Response</h2>
<p><a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-tokenwrapping.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-tokenwrapping.sh</a></p>
<h1>Operating Vaule Server</h1>
<p>主要讲了production Vault server setup.</p>
<ul>
<li>Vault server architecture</li>
<li>Storage backend options</li>
<li>Vault server operations</li>
</ul>
<p>这里例子用Consul作为 storage backend(不是说it’s not intended for this吗😂), 在Vault 主机上运行有Consul agent 和 远处的Consul server通信 (gossip tcp: 8301, RPC tcp: 8300) ，Consul server可以有多个以实现HA。Vault通过本地的Consul agent port 8500和其交互，外界访问Vault 用默认的port 8200:
<a href="https://github.com/ned1313/Getting-Started-Vault/tree/master/m5" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/tree/master/m5</a></p>
<p>可以留意一下这里的Consul配置，之前用的一直是dev mode，这里是production mode了, 把Consul 包装成了一个service, run as daemon, in <code>consul</code> folder:</p>
<ul>
<li><a href="http://consul-deploy.sh" target="_blank" rel="noopener">consul-deploy.sh</a></li>
<li>consul.hcl</li>
<li>server.hcl</li>
<li>consul.service</li>
</ul>
<p>注意把 <code>.hcl</code> and <code>.service</code> 文件内容paste到 <code>consul-deploy.sh</code> 创建的文件中。script中的<code>useradd</code> command也值得借鉴。<code>consul keygen</code> 是用来产生encrypt string的，用在server 和 client的 <code>.hcl</code>中。</p>
<p>Consul agent setup:</p>
<ul>
<li><a href="http://consul-deploy-agent.sh" target="_blank" rel="noopener">consul-deploy-agent.sh</a></li>
<li>consul-agent.hcl</li>
</ul>
<p>好了，这里引出一个有意思的东西: <strong>Create Custom Systemd Service</strong>，之前从来没有这么做过，原来systemd是可以自己配置的！
<a href="https://medium.com/@benmorel/creating-a-linux-service-with-systemd-611b5c8b91d6" target="_blank" rel="noopener">https://medium.com/@benmorel/creating-a-linux-service-with-systemd-611b5c8b91d6</a></p>
<p>Vault server Config, also set Vault as systemd service, in <code>vault</code> folder:</p>
<ul>
<li><a href="http://vault-deploy.sh" target="_blank" rel="noopener">vault-deploy.sh</a></li>
<li>vault.hcl</li>
<li>vault.service</li>
</ul>
<p>在 <code>.hcl</code> 中就配置了Consul 为storage backend，看上去本来就有这种特性，所以不需要过多的设置。</p>
<h2 id="Server-Operations">Server Operations</h2>
<p>Operator command:
<a href="https://www.vaultproject.io/docs/commands/operator" target="_blank" rel="noopener">https://www.vaultproject.io/docs/commands/operator</a></p>
<p>Setup production Vault server, sealed and need to unseal:
<a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m5/m5-serveroperations.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m5/m5-serveroperations.sh</a></p>
<h1>Auditing</h1>
<p>Everything is audited, sensitive data is hashed unless you explicitly set false.
<a href="https://github.com/ned1313/Getting-Started-Vault/tree/master/m6" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/tree/master/m6</a></p>
<p>Auditing device type:</p>
<ul>
<li>File, JSON format</li>
<li>Syslog</li>
<li>Socket: TCP/UDP</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## enable auditing device</span></span><br><span class="line">vault audit <span class="built_in">enable</span> [<span class="built_in">type</span>] [-path=valut_path]</span><br><span class="line"><span class="comment">## log_raw=true means no encrypt sensitive data</span></span><br><span class="line">vault audit <span class="built_in">enable</span> file file_path=/var/<span class="built_in">log</span>/vault/vault_audit.log log_raw=<span class="literal">true</span></span><br><span class="line">vault audit <span class="built_in">enable</span> -path=file2 file file_path=/var/<span class="built_in">log</span>/vault/vault_audit2.log</span><br><span class="line">vault audit <span class="built_in">enable</span> syslog tag=<span class="string">"vault"</span> facility=<span class="string">"LOCAL7"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## disable</span></span><br><span class="line">vault audit <span class="built_in">disable</span> [vault_path]</span><br><span class="line"><span class="comment">## disable file2 created above</span></span><br><span class="line">vault audit <span class="built_in">disable</span> file2</span><br><span class="line"><span class="comment">## list</span></span><br><span class="line">vault audit list -detailed</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/infra/" rel="tag"># infra</a>
          
            <a href="/tags/vault/" rel="tag"># vault</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/13/infra-consul/" rel="next" title="Consul Quick Start">
                <i class="fa fa-chevron-left"></i> Consul Quick Start
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/25/pipeline-jenkinsX-learn/" rel="prev" title="Jenkins X Quick Start">
                Jenkins X Quick Start <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">296</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">48</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">159</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Questions</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Working with Secrets</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-New-Secret-Engine"><span class="nav-number">3.1.</span> <span class="nav-text">Create New Secret Engine</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-Mysql-DB-Secret-Engine"><span class="nav-number">3.2.</span> <span class="nav-text">Create Mysql DB Secret Engine</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">Controlling Access</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Vault-Auth-Method"><span class="nav-number">4.1.</span> <span class="nav-text">Vault Auth Method</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vault-Policy"><span class="nav-number">4.2.</span> <span class="nav-text">Vault Policy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Client-Token"><span class="nav-number">4.3.</span> <span class="nav-text">Client Token</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Wrapping-Response"><span class="nav-number">4.4.</span> <span class="nav-text">Wrapping Response</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">Operating Vaule Server</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Server-Operations"><span class="nav-number">5.1.</span> <span class="nav-text">Server Operations</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">Auditing</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>





  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
