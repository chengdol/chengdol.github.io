<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Course git repo, this repo has useful Vault commands:https://github.com/ned1313/Getting-Started-Vault My Vault vagrant demo:https://github.com/chengdol/InfraTree/tree/master/vagrant-vault QuestionsVau">
<meta name="keywords" content="infra,vault">
<meta property="og:type" content="article">
<meta property="og:title" content="Vault Quick Start">
<meta property="og:url" content="http://yoursite.com/2020/06/21/infra-vault/index.html">
<meta property="og:site_name" content="æµ·èƒ†é˜¶æ®µ&#39;s Blog">
<meta property="og:description" content="Course git repo, this repo has useful Vault commands:https://github.com/ned1313/Getting-Started-Vault My Vault vagrant demo:https://github.com/chengdol/InfraTree/tree/master/vagrant-vault QuestionsVau">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-11-09T07:49:09.281Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Vault Quick Start">
<meta name="twitter:description" content="Course git repo, this repo has useful Vault commands:https://github.com/ned1313/Getting-Started-Vault My Vault vagrant demo:https://github.com/chengdol/InfraTree/tree/master/vagrant-vault QuestionsVau">






  <link rel="canonical" href="http://yoursite.com/2020/06/21/infra-vault/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Vault Quick Start | æµ·èƒ†é˜¶æ®µ's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æµ·èƒ†é˜¶æ®µ's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">127</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">38</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">207</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/21/infra-vault/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="æµ·èƒ†é˜¶æ®µ">
      <meta itemprop="description" content="éªéª¥ä¸€è·ƒï¼Œä¸èƒ½åæ­¥ï¼›é©½é©¬åé©¾ï¼ŒåŠŸåœ¨ä¸èˆ">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æµ·èƒ†é˜¶æ®µ's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Vault Quick Start

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-21 18:01:49" itemprop="dateCreated datePublished" datetime="2020-06-21T18:01:49-07:00">2020-06-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-11-08 23:49:09" itemprop="dateModified" datetime="2020-11-08T23:49:09-08:00">2020-11-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Infra/" itemprop="url" rel="index"><span itemprop="name">Infra</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">30k</span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Course git repo, this repo has useful Vault commands:<br><a href="https://github.com/ned1313/Getting-Started-Vault" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault</a></p>
<p>My Vault vagrant demo:<br><a href="https://github.com/chengdol/InfraTree/tree/master/vagrant-vault" target="_blank" rel="noopener">https://github.com/chengdol/InfraTree/tree/master/vagrant-vault</a></p>
<h1 id="Questions"><a href="#Questions" class="headerlink" title="Questions"></a>Questions</h1><p><a href="https://www.reddit.com/r/devops/comments/ejfzhl/kubernetes_secrets_vs_hashicorp_vault/" target="_blank" rel="noopener">Vault vs K8s secrets?</a><br>Examples of what Vault can do that k8s secrets cannot:<br>With Vault you can rotate secrets and have secrets with short TTL<br>With Vault you can access secrets across namespaces (or outside the k8s cluster)<br>Vault can provide a PKI for signing certs (enabling for example automation of cert generation for mtls)<br>Vault can use LDAP, oauth, IAM, etc as identity providers</p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Vault web site:<br><a href="https://www.vaultproject.io/" target="_blank" rel="noopener">https://www.vaultproject.io/</a></p>
<p>Secure, store and tightly control access to tokens, passwords, certificates, encryption keys for protecting secrets and other sensitive data using a UI, CLI, or HTTP API.<br>æ³¨æ„APIçš„pathï¼Œå¹¶ä¸æ˜¯å’ŒUIä¸Šçš„pathä¸€æ ·ï¼</p>
<p>Vault works well with Consul, for example, set Consul as storage backend.</p>
<p>Start a Vault server:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## same as consul in development mode, don't use this in production!</span></span><br><span class="line"><span class="comment">## 0.0.0.0:8200, used for vagrant port fordwarding access from host</span></span><br><span class="line">vault server -dev-listen-address 0.0.0.0:8200 -dev</span><br></pre></td></tr></table></figure></p>
<p>Output as below:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">WARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory</span><br><span class="line">and starts unsealed with a single unseal key. The root token is already</span><br><span class="line">authenticated to the CLI, so you can immediately begin using Vault.</span><br><span class="line"></span><br><span class="line">You may need to set the following environment variable:</span><br><span class="line"></span><br><span class="line">    $ export VAULT_ADDR=&apos;http://0.0.0.0:8200&apos;</span><br><span class="line"></span><br><span class="line">The unseal key and root token are displayed below in case you want to</span><br><span class="line">seal/unseal the Vault or re-authenticate.</span><br><span class="line"></span><br><span class="line">## these two are critical</span><br><span class="line">Unseal Key: pLNBmZQRHvspdy5unZcTjm1jOVQ81Z0pO6ywYHNP1zQ=</span><br><span class="line">Root Token: s.hfnmMkgG7cggWDOmPfHC1jIe</span><br><span class="line"></span><br><span class="line">Development mode should NOT be used in production installations!</span><br></pre></td></tr></table></figure></p>
<p><code>unseal</code> keyåœ¨production modeä¸­ç”¨æ¥è§£é™¤å¯¹Vault serverçš„å°é”ï¼Œå¦åˆ™æ— æ³•login as root.</p>
<p>æ³¨æ„ï¼Œè¿™é‡ŒVAULT_ADDRæ˜¯æœ¬åœ°çš„ï¼Œvault serverå½“ç„¶å¯ä»¥åœ¨å…¶ä»–åœ°æ–¹ï¼Œè®¾ç½®å¯¹åº”çš„åœ°å€å³å¯.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Vault API access</span></span><br><span class="line"><span class="built_in">export</span> VAULT_ADDR=<span class="string">'http://0.0.0.0:8200'</span></span><br><span class="line"><span class="built_in">export</span> VAULT_TOKEN=s.ttlDcetbJe3uLt0FF5rSidg3</span><br><span class="line"></span><br><span class="line"><span class="comment">## login to vault server need VAULT_TOKEN to login</span></span><br><span class="line">vault login</span><br></pre></td></tr></table></figure></p>
<p>Vault web UI access: <code>http://localhost:8200</code></p>
<p>So, just like Consul, there are 3 ways to interact with Vault server: UI, API, CLI (actually running API under the hood). </p>
<p><code>secret</code> is a pre-existing secret engine folder in Vault storage path, you can see it in UI:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Write a secret</span></span><br><span class="line">vault kv put secret/hg2g answer=42</span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line"><span class="comment"># marvin.json is a json file</span></span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> --request POST \</span><br><span class="line"> --data @marvin.json <span class="variable">$VAULT_ADDR</span>/v1/secret/data/marvin</span><br></pre></td></tr></table></figure></p>
<p>marvin.json is as follow:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"paranoid"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="string">"bored"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Get a secret</span></span><br><span class="line">vault kv get secret/hg2g</span><br><span class="line"><span class="comment">#specify format</span></span><br><span class="line">vault kv get -format=json secret/hg2g</span><br><span class="line">vault kv get -format=yaml secret/hg2g</span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line"><span class="comment">#Install jq if necessary</span></span><br><span class="line">sudo yum install jq -y</span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> <span class="variable">$VAULT_ADDR</span>/v1/secret/data/marvin | jq</span><br><span class="line"></span><br><span class="line"><span class="comment">#Put a new secret in and a new value for an existing secret</span></span><br><span class="line">vault kv put secret/hg2g answer=54 ford=prefect</span><br><span class="line">vault kv get secret/hg2g</span><br><span class="line"></span><br><span class="line"><span class="comment">#Delete the secrets</span></span><br><span class="line">vault kv delete secret/hg2g</span><br><span class="line">vault kv get secret/hg2g</span><br><span class="line"></span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> --request DELETE <span class="variable">$VAULT_ADDR</span>/v1/secret/data/marvin</span><br></pre></td></tr></table></figure>
<h1 id="Working-with-Secrets"><a href="#Working-with-Secrets" class="headerlink" title="Working with Secrets"></a>Working with Secrets</h1><p>Secret lifecycle:</p>
<ul>
<li>Create</li>
<li>Read</li>
<li>Update</li>
<li>Delete (soft or hard unrecoverable)</li>
<li>Destroy</li>
</ul>
<p>There is version <code>1</code> and version <code>2</code> of <code>secret engine server</code>, version <code>2</code> is more recoverable and versioning but less performance then version <code>1</code> if you need to scale. <code>secret</code> folder å°±æ˜¯é»˜è®¤åˆ›å»ºçš„secret engine, version <code>2</code>, å¯ä»¥å»UI æŸ¥çœ‹configuration.</p>
<p>Demo code about secrets lifecycle:<br><a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-secretslifecycle.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-secretslifecycle.sh</a></p>
<p>Everytime you update the key, the version increment by 1:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## pick value by version</span></span><br><span class="line">vault kv get -version=3 secret/hg2g</span><br><span class="line"><span class="comment">## from API</span></span><br><span class="line">curl -X GET --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> <span class="variable">$VAULT_ADDR</span>/v1/secret/data/hg2g?version=3 | jq .data.data</span><br></pre></td></tr></table></figure></p>
<p>If you delete version 3, you still can get version 1 or 2:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vault kv delete secret/hg2g</span><br><span class="line">vault kv get -version=2 secret/hg2g</span><br><span class="line"><span class="comment">## undelete version 3</span></span><br><span class="line"><span class="comment">## -versions not -version, you can undelete multiple: -versions=2,3</span></span><br><span class="line">vault kv undelete -versions=3 secret/hg2g</span><br><span class="line"></span><br><span class="line"><span class="comment">## API</span></span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> --request POST \</span><br><span class="line">  <span class="variable">$VAULT_ADDR</span>/v1/secret/undelete/hg2g  --data <span class="string">'&#123;"versions": [2]&#125;'</span></span><br></pre></td></tr></table></figure></p>
<p>Destroy, can no longer undelete:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Destroy the secrets</span></span><br><span class="line">vault kv destroy -versions=1,2 secret/hg2g</span><br><span class="line"></span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line"><span class="comment">## metadata is still there</span></span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> --request POST \</span><br><span class="line">  <span class="variable">$VAULT_ADDR</span>/v1/secret/destroy/hg2g --data <span class="string">'&#123;"versions": [1,2]&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Remove all data about secrets</span></span><br><span class="line">vault kv metadata delete secret/hg2g</span><br><span class="line">vault kv get secret/hg2g</span><br><span class="line"></span><br><span class="line"><span class="comment">#For Linux</span></span><br><span class="line">curl --header <span class="string">"X-Vault-Token: <span class="variable">$VAULT_TOKEN</span>"</span> --request DELETE \</span><br><span class="line">  <span class="variable">$VAULT_ADDR</span>/v1/secret/metadata/hg2g</span><br></pre></td></tr></table></figure></p>
<h2 id="Create-New-Secret-Engine"><a href="#Create-New-Secret-Engine" class="headerlink" title="Create New Secret Engine"></a>Create New Secret Engine</h2><p>Demo about secret engine, æˆ‘è¿™é‡Œå°±ä¸è´´å‡ºæ¥äº†, å¦‚æœç”¨APIï¼Œè¿˜æœ‰ä¸€äº›é…ç½®ç”¨çš„jsonæ–‡ä»¶ï¼Œè§è¿™ä¸ªçš„ä¸Šå±‚ç›®å½•ä¸­çš„æ¯”å¦‚<code>dev-b.json</code>:<br><a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-secretengine.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-secretengine.sh</a></p>
<h2 id="Create-Mysql-DB-Secret-Engine"><a href="#Create-Mysql-DB-Secret-Engine" class="headerlink" title="Create Mysql DB Secret Engine"></a>Create Mysql DB Secret Engine</h2><p>Vault official reference:<br><a href="https://www.vaultproject.io/docs/secrets" target="_blank" rel="noopener">https://www.vaultproject.io/docs/secrets</a></p>
<p>Vaultåœ¨è¿™é‡Œç±»ä¼¼ä¸€ä¸ªä¸­é—´å±‚ï¼Œåœ¨user å’Œ Mysql instanceä¹‹é—´ï¼Œä¿å­˜å’Œä¼ é€’credentialå’Œè¯·æ±‚. è¿™ä¸ªdemoåœ¨AZureä¸Šspin upäº†ä¸€ä¸ªbitnami Mysql instanceï¼Œå’Œæœ¬åœ°çš„vault mysql secret engineå…³è”ï¼Œç„¶åé€šè¿‡Vaultè”ç³»Mysql äº§ç”Ÿä¸€ä¸ªdynamic userï¼Œå¹¶æˆäºˆè¿™ä¸ªä¸´æ—¶useræƒé™ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªä¸´æ—¶userå°±å¯ä»¥æ“ä½œMysql æ•°æ®åº“äº†ã€‚</p>
<p>è¿™ä¸ªdynamic user lifecycle also managed by Vault, as well as the permission the user has.<br><a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-mysqlengine.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m3/m3-mysqlengine.sh</a></p>
<p>Besides Mysql example, Vault secrets can be used for certificates, for SSH credentials, etc.<br>Secrets engine make Vault extensible, there are different plugin to handle different needs.</p>
<h1 id="Controlling-Access"><a href="#Controlling-Access" class="headerlink" title="Controlling Access"></a>Controlling Access</h1><p>Similar to RBAC in K8s, authentication method to control login, policies to control what is able to do, managing client tokens.</p>
<h2 id="Vault-Auth-Method"><a href="#Vault-Auth-Method" class="headerlink" title="Vault Auth Method"></a>Vault Auth Method</h2><p>Vault has internal authentication (called <code>userpass</code>) and support external, multiple authrntication methods.<br><a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-basicauth.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-basicauth.sh</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## list current auth methods</span></span><br><span class="line"><span class="comment">## by default, we only have token auth method</span></span><br><span class="line">vault auth list</span><br><span class="line"><span class="comment">## enable new auth method</span></span><br><span class="line">vault auth <span class="built_in">enable</span> userpass</span><br><span class="line"><span class="comment">## create user</span></span><br><span class="line">vault write auth/userpass/users/arthur password=dent</span><br><span class="line"><span class="comment">## list user</span></span><br><span class="line">vault list auth/userpass/users</span><br></pre></td></tr></table></figure>
<p>You will see the changes in UI <code>Access</code> section.</p>
<p>Once you create a user/password, then you can run for example:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## è¿™é‡Œä½¿ç”¨çš„æ˜¯user/password loginï¼Œä¸æ˜¯ç”¨token</span></span><br><span class="line">vault login -method=userpass username=arthur</span><br><span class="line"><span class="comment">## then input password</span></span><br><span class="line">Password (will be hidden): </span><br><span class="line"><span class="comment">## è¿™ä¸ªwarningæ˜¯å› ä¸ºï¼Œåšå®éªŒçš„æ—¶å€™ä¹‹å‰exportäº†root token</span></span><br><span class="line">WARNING! The VAULT_TOKEN environment variable is <span class="built_in">set</span>! This takes precedence</span><br><span class="line">over the value <span class="built_in">set</span> by this <span class="built_in">command</span>. To use the value <span class="built_in">set</span> by this <span class="built_in">command</span>,</span><br><span class="line"><span class="built_in">unset</span> the VAULT_TOKEN environment variable or <span class="built_in">set</span> it to the token displayed</span><br><span class="line">below.</span><br><span class="line"></span><br><span class="line">Success! You are now authenticated. The token information displayed below</span><br><span class="line">is already stored <span class="keyword">in</span> the token helper. You <span class="keyword">do</span> NOT need to run <span class="string">"vault login"</span></span><br><span class="line">again. Future Vault requests will automatically use this token.</span><br><span class="line"></span><br><span class="line">Key                    Value</span><br><span class="line">---                    -----</span><br><span class="line">token                  s.z52FGzn78XynKlxeS0Akt0t7</span><br><span class="line">token_accessor         90LaRNNtsCUEg6yDd9ldRi3v</span><br><span class="line">token_duration         768h</span><br><span class="line">token_renewable        <span class="literal">true</span></span><br><span class="line">token_policies         [<span class="string">"default"</span>]</span><br><span class="line">identity_policies      []</span><br><span class="line">policies               [<span class="string">"default"</span>]</span><br><span class="line">token_meta_username    arthur</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## will show you where is the token from, not root token any more</span></span><br><span class="line"><span class="comment">## see `path` field where is the token from</span></span><br><span class="line">vault token lookup</span><br></pre></td></tr></table></figure></p>
<p>Token represents who you are and what you can do, for example, the user itself cannot update its password via its token:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## update password</span></span><br><span class="line">vault write auth/userpass/users/arthur/password password=tricia</span><br><span class="line"><span class="comment">## output</span></span><br><span class="line">Error writing data to auth/userpass/users/arthur/password: Error making API request.</span><br><span class="line"></span><br><span class="line">URL: PUT http://0.0.0.0:8200/v1/auth/userpass/users/arthur/password</span><br><span class="line">Code: 403. Errors:</span><br><span class="line"></span><br><span class="line">* 1 error occurred:</span><br><span class="line">	* permission denied</span><br></pre></td></tr></table></figure></p>
<p>Can do this after export root token.</p>
<p>Delete auth:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Remove account</span></span><br><span class="line">vault delete auth/userpass/users/arthur</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œä»‹ç»äº†2ä¸ªæ–°æ¦‚å¿µ: <code>LDAP</code> and <code>Active Directory</code><br><a href="https://stackoverflow.com/questions/663402/what-are-the-differences-between-ldap-and-active-directory" target="_blank" rel="noopener">What are the differences between LDAP and Active Directory?</a><br>Active Directory is a database based system that provides authentication, directory, policy, and other services in a Windows environment</p>
<p>LDAP (Lightweight Directory Access Protocol) is an application protocol for querying and modifying items in directory service providers like Active Directory, which supports a form of LDAP.</p>
<p>Short answer: AD is a directory services database, and LDAP is one of the protocols you can use to talk to it.</p>
<p>è§ä¸‹é¢vault policyç« èŠ‚çš„ä¾‹å­.<br>Case: åœ¨å¤–éƒ¨è®¾ç½®äº†<code>AD</code> as authentication method, enable <code>LDAP</code> auth in Vault. Then user login Vault with AD credentials against LDAP talk to AD, AD talk to Vault and determine the policy about what the user can do, then user will get the right token from vault to access the store.</p>
<h2 id="Vault-Policy"><a href="#Vault-Policy" class="headerlink" title="Vault Policy"></a>Vault Policy</h2><p>Similar to K8s role.<br><a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-activedirectory.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-activedirectory.sh</a></p>
<p>è¿™ä¸ªä¾‹å­ï¼Œè¿œç¨‹ç™»å½•äº†ä¸€ä¸ªVault server, login as root, create <code>devkv</code> store with key and value pair, then create policy <code>dev</code> with HCL file for user to access the <code>devkv</code>. </p>
<p>Enable LDAP auth, configure it with Active Directory remotely. Then assign the <code>developers</code> group in LDAP with <code>dev</code> policy.</p>
<p>Then user <code>adent</code> login vault against <code>ldap</code> method. The user is in the <code>developers</code> group so it will get token with permission specified by <code>dev</code> policy.</p>
<h2 id="Client-Token"><a href="#Client-Token" class="headerlink" title="Client Token"></a>Client Token</h2><p><a href="https://www.vaultproject.io/docs/concepts/tokens" target="_blank" rel="noopener">https://www.vaultproject.io/docs/concepts/tokens</a></p>
<h2 id="Wrapping-Response"><a href="#Wrapping-Response" class="headerlink" title="Wrapping Response"></a>Wrapping Response</h2><p><a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-tokenwrapping.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m4/m4-tokenwrapping.sh</a></p>
<h1 id="Operating-Vaule-Server"><a href="#Operating-Vaule-Server" class="headerlink" title="Operating Vaule Server"></a>Operating Vaule Server</h1><p>ä¸»è¦è®²äº†production Vault server setup.</p>
<ul>
<li>Vault server architecture</li>
<li>Storage backend options</li>
<li>Vault server operations</li>
</ul>
<p>è¿™é‡Œä¾‹å­ç”¨Consulä½œä¸º storage backend(ä¸æ˜¯è¯´itâ€™s not intended for thiså—ğŸ˜‚), åœ¨Vault ä¸»æœºä¸Šè¿è¡Œæœ‰Consul agent å’Œ è¿œå¤„çš„Consul serveré€šä¿¡ (gossip tcp: 8301, RPC tcp: 8300) ï¼ŒConsul serverå¯ä»¥æœ‰å¤šä¸ªä»¥å®ç°HAã€‚Vaulté€šè¿‡æœ¬åœ°çš„Consul agent port 8500å’Œå…¶äº¤äº’ï¼Œå¤–ç•Œè®¿é—®Vault ç”¨é»˜è®¤çš„port 8200:<br><a href="https://github.com/ned1313/Getting-Started-Vault/tree/master/m5" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/tree/master/m5</a></p>
<p>å¯ä»¥ç•™æ„ä¸€ä¸‹è¿™é‡Œçš„Consulé…ç½®ï¼Œä¹‹å‰ç”¨çš„ä¸€ç›´æ˜¯dev modeï¼Œè¿™é‡Œæ˜¯production modeäº†, æŠŠConsul åŒ…è£…æˆäº†ä¸€ä¸ªservice, run as daemon, in <code>consul</code> folder:</p>
<ul>
<li>consul-deploy.sh</li>
<li>consul.hcl</li>
<li>server.hcl</li>
<li>consul.service</li>
</ul>
<p>æ³¨æ„æŠŠ <code>.hcl</code> and <code>.service</code> æ–‡ä»¶å†…å®¹pasteåˆ° <code>consul-deploy.sh</code> åˆ›å»ºçš„æ–‡ä»¶ä¸­ã€‚scriptä¸­çš„<code>useradd</code> commandä¹Ÿå€¼å¾—å€Ÿé‰´ã€‚<code>consul keygen</code> æ˜¯ç”¨æ¥äº§ç”Ÿencrypt stringçš„ï¼Œç”¨åœ¨server å’Œ clientçš„ <code>.hcl</code>ä¸­ã€‚</p>
<p>Consul agent setup:</p>
<ul>
<li>consul-deploy-agent.sh</li>
<li>consul-agent.hcl</li>
</ul>
<p>å¥½äº†ï¼Œè¿™é‡Œå¼•å‡ºä¸€ä¸ªæœ‰æ„æ€çš„ä¸œè¥¿: <strong>Create Custom Systemd Service</strong>ï¼Œä¹‹å‰ä»æ¥æ²¡æœ‰è¿™ä¹ˆåšè¿‡ï¼ŒåŸæ¥systemdæ˜¯å¯ä»¥è‡ªå·±é…ç½®çš„ï¼<br><a href="https://medium.com/@benmorel/creating-a-linux-service-with-systemd-611b5c8b91d6" target="_blank" rel="noopener">https://medium.com/@benmorel/creating-a-linux-service-with-systemd-611b5c8b91d6</a></p>
<p>Vault server Config, also set Vault as systemd service, in <code>vault</code> folder:</p>
<ul>
<li>vault-deploy.sh</li>
<li>vault.hcl</li>
<li>vault.service</li>
</ul>
<p>åœ¨ <code>.hcl</code> ä¸­å°±é…ç½®äº†Consul ä¸ºstorage backendï¼Œçœ‹ä¸Šå»æœ¬æ¥å°±æœ‰è¿™ç§ç‰¹æ€§ï¼Œæ‰€ä»¥ä¸éœ€è¦è¿‡å¤šçš„è®¾ç½®ã€‚</p>
<h2 id="Server-Operations"><a href="#Server-Operations" class="headerlink" title="Server Operations"></a>Server Operations</h2><p>Operator command:<br><a href="https://www.vaultproject.io/docs/commands/operator" target="_blank" rel="noopener">https://www.vaultproject.io/docs/commands/operator</a></p>
<p>Setup production Vault server, sealed and need to unseal:<br><a href="https://github.com/ned1313/Getting-Started-Vault/blob/master/m5/m5-serveroperations.sh" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/blob/master/m5/m5-serveroperations.sh</a></p>
<h1 id="Auditing"><a href="#Auditing" class="headerlink" title="Auditing"></a>Auditing</h1><p>Everything is audited, sensitive data is hashed unless you explicitly set false.<br><a href="https://github.com/ned1313/Getting-Started-Vault/tree/master/m6" target="_blank" rel="noopener">https://github.com/ned1313/Getting-Started-Vault/tree/master/m6</a></p>
<p>Auditing device type:</p>
<ul>
<li>File, JSON format</li>
<li>Syslog</li>
<li>Socket: TCP/UDP</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## enable auditing device</span></span><br><span class="line">vault audit <span class="built_in">enable</span> [<span class="built_in">type</span>] [-path=valut_path]</span><br><span class="line"><span class="comment">## log_raw=true means no encrypt sensitive data</span></span><br><span class="line">vault audit <span class="built_in">enable</span> file file_path=/var/<span class="built_in">log</span>/vault/vault_audit.log log_raw=<span class="literal">true</span></span><br><span class="line">vault audit <span class="built_in">enable</span> -path=file2 file file_path=/var/<span class="built_in">log</span>/vault/vault_audit2.log</span><br><span class="line">vault audit <span class="built_in">enable</span> syslog tag=<span class="string">"vault"</span> facility=<span class="string">"LOCAL7"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## disable</span></span><br><span class="line">vault audit <span class="built_in">disable</span> [vault_path]</span><br><span class="line"><span class="comment">## disable file2 created above</span></span><br><span class="line">vault audit <span class="built_in">disable</span> file2</span><br><span class="line"><span class="comment">## list</span></span><br><span class="line">vault audit list -detailed</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/infra/" rel="tag"># infra</a>
          
            <a href="/tags/vault/" rel="tag"># vault</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/13/infra-consul/" rel="next" title="Consul Quick Start">
                <i class="fa fa-chevron-left"></i> Consul Quick Start
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/25/pipeline-jenkinsX-learn/" rel="prev" title="Jenkins X Quick Start">
                Jenkins X Quick Start <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="æµ·èƒ†é˜¶æ®µ">
            
              <p class="site-author-name" itemprop="name">æµ·èƒ†é˜¶æ®µ</p>
              <p class="site-description motion-element" itemprop="description">éªéª¥ä¸€è·ƒï¼Œä¸èƒ½åæ­¥ï¼›é©½é©¬åé©¾ï¼ŒåŠŸåœ¨ä¸èˆ</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">207</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">38</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">127</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Questions"><span class="nav-number">1.</span> <span class="nav-text">Questions</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">2.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Working-with-Secrets"><span class="nav-number">3.</span> <span class="nav-text">Working with Secrets</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-New-Secret-Engine"><span class="nav-number">3.1.</span> <span class="nav-text">Create New Secret Engine</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-Mysql-DB-Secret-Engine"><span class="nav-number">3.2.</span> <span class="nav-text">Create Mysql DB Secret Engine</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Controlling-Access"><span class="nav-number">4.</span> <span class="nav-text">Controlling Access</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Vault-Auth-Method"><span class="nav-number">4.1.</span> <span class="nav-text">Vault Auth Method</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vault-Policy"><span class="nav-number">4.2.</span> <span class="nav-text">Vault Policy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Client-Token"><span class="nav-number">4.3.</span> <span class="nav-text">Client Token</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Wrapping-Response"><span class="nav-number">4.4.</span> <span class="nav-text">Wrapping Response</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Operating-Vaule-Server"><span class="nav-number">5.</span> <span class="nav-text">Operating Vaule Server</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Server-Operations"><span class="nav-number">5.1.</span> <span class="nav-text">Server Operations</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Auditing"><span class="nav-number">6.</span> <span class="nav-text">Auditing</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 â€“ <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="Symbols count total">911k</span>
  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme â€“ <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
