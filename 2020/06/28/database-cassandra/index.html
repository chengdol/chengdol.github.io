<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="TODOSingle node cluster: practice CQLMultiple node cluster/ multiple data center: verify replication stratefy and tunable consistency Seed for joining, private ip for each, config cassandra.yaml, use">
<meta name="keywords" content="database,cassandra">
<meta property="og:type" content="article">
<meta property="og:title" content="Apache Cassandra">
<meta property="og:url" content="http://yoursite.com/2020/06/28/database-cassandra/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="TODOSingle node cluster: practice CQLMultiple node cluster/ multiple data center: verify replication stratefy and tunable consistency Seed for joining, private ip for each, config cassandra.yaml, use">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-07-12T22:26:38.836Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Apache Cassandra">
<meta name="twitter:description" content="TODOSingle node cluster: practice CQLMultiple node cluster/ multiple data center: verify replication stratefy and tunable consistency Seed for joining, private ip for each, config cassandra.yaml, use">






  <link rel="canonical" href="http://yoursite.com/2020/06/28/database-cassandra/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Apache Cassandra | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">107</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">32</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">181</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/28/database-cassandra/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Apache Cassandra

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-28 14:17:18" itemprop="dateCreated datePublished" datetime="2020-06-28T14:17:18-07:00">2020-06-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-07-12 15:26:38" itemprop="dateModified" datetime="2020-07-12T15:26:38-07:00">2020-07-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Database/" itemprop="url" rel="index"><span itemprop="name">Database</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">68k</span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><p>Single node cluster: practice CQL<br>Multiple node cluster/ multiple data center: verify replication stratefy and tunable consistency</p>
<p>Seed for joining, private ip for each, config cassandra.yaml, use rpm to install<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## you will see the cluster node status</span></span><br><span class="line">./bin/nodetool status</span><br><span class="line"><span class="comment">## see token range and belongs to which node</span></span><br><span class="line">./bin/nodetool ring</span><br></pre></td></tr></table></figure></p>
<p>Token number is acutally the virtual node number in one physical node.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CASSANDRA_SEEDS=ip or hostname?</span><br><span class="line"><span class="comment">## or</span></span><br><span class="line">nodetool join - Join the ring</span><br></pre></td></tr></table></figure>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Vagrant Cassandra lab environment:<br><a href="https://github.com/chengdol/vagrant-cassandra" target="_blank" rel="noopener">https://github.com/chengdol/vagrant-cassandra</a></p>
<p>Cassandra web site:<br><a href="https://cassandra.apache.org/" target="_blank" rel="noopener">https://cassandra.apache.org/</a></p>
<p>Open-source <strong>NoSQL</strong> Database, originally developed from Facebook. Data stored is associated with token.</p>
<p><code>Virtual node</code> concept. When new physical node is added, actually it is represented by multiple virtual nodes inserted randemly in the token range, the virtual node will talk to its neighbor to take over the data originally belongs to them.</p>
<p><code>Snitch</code>, let Cassandra know environment.</p>
<h2 id="Replication-Strategy"><a href="#Replication-Strategy" class="headerlink" title="Replication Strategy"></a>Replication Strategy</h2><p><code>Keyspace</code>: a namespace that defines data replication on nodes, one keyspace may have mutliple related tables, the <code>Replicatin Strategy</code> is keyspace-wide:</p>
<ul>
<li>simply strategy for single data center</li>
<li>network topology strategy for multiple data centers</li>
</ul>
<p>Data center can have multiple racks.</p>
<p>For example, one data center has 2 racks, rack1 has 2 nodes, rack2 has one node, if the simply strategy is 1, then rack1 owns 50% data, each node in rack1 owns 25%, rack2 owns 50%, since rack2 only contains 1 node, so that node owns 50%.</p>
<h2 id="Tunable-Consistency"><a href="#Tunable-Consistency" class="headerlink" title="Tunable Consistency"></a>Tunable Consistency</h2><p><code>Coordinator Node</code>: client connect to perform actions. Each connection to Cassandra may have a different coordinator node.</p>
<p>Consistency level for <strong>write</strong>: </p>
<ul>
<li><code>ONE</code>, <code>TWO</code>, <code>THREE</code> </li>
<li><code>QUORUM</code>(majority of nodes succeeds)</li>
<li><code>ALL</code>(must all good)</li>
<li><code>ANY</code>(include coordinator itself).</li>
</ul>
<p><code>Hinted Handoff</code>: when one write node is unavaiable, the data is written to coordinator node, the coordinator node will try repeatedly write to the unavailable node until succeeded.</p>
<p>Consistency level for <strong>read</strong>: how many nodes to consult to return the most current data to caller.</p>
<ul>
<li><code>ONE</code>, <code>TWO</code>, <code>THREE</code></li>
<li><code>QUORUM</code>(majority of nodes succeeds)</li>
<li><code>ALL</code> (must all good)</li>
</ul>
<p><code>Read Repair</code>: 当对一个node写失败了but back online later，在read时如果有多个replicas的数据可以参考，则对那个node可重新写入上次wirte失败的数据. Run <code>nodetool repair</code> periodically will resolve the inconsistencies in cluster.</p>
<p>Achieving strong consistency:</p>
<ul>
<li>write consistency + read consistency &gt; replication factor</li>
</ul>
<p>Multiple data center consistency level:</p>
<ul>
<li><code>EACH_QUORUM</code></li>
<li><code>LOCAL_QUORUM</code>: local means current coordinator node data center</li>
<li><code>LOCAL_ONE</code>: the same as <code>ONE</code></li>
</ul>
<h1 id="CQL"><a href="#CQL" class="headerlink" title="CQL"></a>CQL</h1><p>A single Vagrant node is enough for playing this section.</p>
<p>Cassandra Query Language:</p>
<ul>
<li><p><a href="https://cassandra.apache.org/doc/latest/cql/index.html" target="_blank" rel="noopener">https://cassandra.apache.org/doc/latest/cql/index.html</a></p>
</li>
<li><p>Keyspace, table and basic data type</p>
</li>
<li>CRUD operations</li>
<li>Counters</li>
<li>Aggregate functions</li>
</ul>
<p>With <code>cqlsh</code> script, you can specify remote Cassandra node with port to connect, by default it will connect to localhost 9042 port. (类似于consul, 连接本地服务即可作用于全局)</p>
<p>Keyspace -&gt; Tables -&gt; partitions -&gt; row.</p>
<p>In brief, each table requires a unique <code>primary key</code>. The first field listed is the <code>partition key</code>, since its hashed value is used to determine the node to store the data. If those fields are wrapped in parentheses then the partition key is composite. Otherwise the first field is the partition key. Any fields listed after the primary key are called <code>clustering columns</code>. These store data in ascending or descending order within the partition for the fast retrieval of similar values. All the fields together are the primary key.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## help</span></span><br><span class="line">cqlsh&gt; <span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Documented shell commands:</span><br><span class="line">===========================</span><br><span class="line">CAPTURE  CLS          COPY  DESCRIBE  EXPAND  LOGIN   SERIAL  SOURCE   UNICODE</span><br><span class="line">CLEAR    CONSISTENCY  DESC  EXIT      HELP    PAGING  SHOW    TRACING</span><br><span class="line"></span><br><span class="line">CQL <span class="built_in">help</span> topics:</span><br><span class="line">================</span><br><span class="line">AGGREGATES               CREATE_KEYSPACE           DROP_TRIGGER      TEXT     </span><br><span class="line">ALTER_KEYSPACE           CREATE_MATERIALIZED_VIEW  DROP_TYPE         TIME     </span><br><span class="line">ALTER_MATERIALIZED_VIEW  CREATE_ROLE               DROP_USER         TIMESTAMP</span><br><span class="line">ALTER_TABLE              CREATE_TABLE              FUNCTIONS         TRUNCATE </span><br><span class="line">ALTER_TYPE               CREATE_TRIGGER            GRANT             TYPES    </span><br><span class="line">ALTER_USER               CREATE_TYPE               INSERT            UPDATE   </span><br><span class="line">APPLY                    CREATE_USER               INSERT_JSON       USE      </span><br><span class="line">ASCII                    DATE                      INT               UUID     </span><br><span class="line">BATCH                    DELETE                    JSON            </span><br><span class="line">BEGIN                    DROP_AGGREGATE            KEYWORDS        </span><br><span class="line">BLOB                     DROP_COLUMNFAMILY         LIST_PERMISSIONS</span><br><span class="line">BOOLEAN                  DROP_FUNCTION             LIST_ROLES      </span><br><span class="line">COUNTER                  DROP_INDEX                LIST_USERS      </span><br><span class="line">CREATE_AGGREGATE         DROP_KEYSPACE             PERMISSIONS     </span><br><span class="line">CREATE_COLUMNFAMILY      DROP_MATERIALIZED_VIEW    REVOKE          </span><br><span class="line">CREATE_FUNCTION          DROP_ROLE                 SELECT          </span><br><span class="line">             DROP_TABLE                SELECT_JSON </span><br><span class="line"></span><br><span class="line"><span class="comment">## specified</span></span><br><span class="line">cqlsh&gt; <span class="built_in">help</span> consistency;</span><br></pre></td></tr></table></figure>
<p>Create a keyspace with:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> keyspace pluralsight <span class="keyword">with</span> <span class="keyword">replication</span> = &#123;<span class="string">'class'</span>:<span class="string">'SimpleStrategy'</span>, <span class="string">'replication_factor'</span>:<span class="number">1</span>&#125;;</span><br></pre></td></tr></table></figure></p>
<p>Create a table in this keyspace with:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> pluralsight;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> courses (<span class="keyword">id</span> <span class="built_in">varchar</span> primary <span class="keyword">key</span>);</span><br></pre></td></tr></table></figure></p>
<p>Optionally attempt to create the table again with:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> courses (<span class="keyword">id</span> <span class="built_in">varchar</span> primary <span class="keyword">key</span>);</span><br></pre></td></tr></table></figure></p>
<p>(and note that you will not get an error as long as the ‘if not exists’ is present)</p>
<p>Add a few columns to the courses table with:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> courses <span class="keyword">add</span> <span class="keyword">duration</span> <span class="built_in">int</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> courses <span class="keyword">add</span> released <span class="built_in">timestamp</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> courses <span class="keyword">add</span> author <span class="built_in">varchar</span>;</span><br></pre></td></tr></table></figure></p>
<p>Add a comment to the table with:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> courses <span class="keyword">with</span> <span class="keyword">comment</span> = <span class="string">'A table of courses'</span>;</span><br></pre></td></tr></table></figure></p>
<p>View the complete table and all its default properties with:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- describe</span></span><br><span class="line">desc table courses;</span><br></pre></td></tr></table></figure></p>
<p>Drop and recreate a more complete courses table with:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> courses;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> courses (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">varchar</span> primary <span class="keyword">key</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>,</span><br><span class="line">    author <span class="built_in">varchar</span>,</span><br><span class="line">    audience <span class="built_in">int</span>,</span><br><span class="line">    <span class="keyword">duration</span> <span class="built_in">int</span>,</span><br><span class="line">    cc <span class="built_in">boolean</span>,</span><br><span class="line">    released <span class="built_in">timestamp</span></span><br><span class="line">    ) <span class="keyword">with</span> <span class="keyword">comment</span> = <span class="string">'A table of courses'</span>;</span><br></pre></td></tr></table></figure></p>
<p>(Note that when entering the lines as above cqlsh will automatically detect a multi-line CQL statement)</p>
<p>Exit cqlsh:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure></p>
<p>Load course data by running a series of CQL commands from an external file<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat courses.cql | cqlsh</span><br></pre></td></tr></table></figure></p>
<p>Verify that the CQL commands in the file were indeed executed:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> pluralsight;</span><br><span class="line">desc tables;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses;</span><br></pre></td></tr></table></figure></p>
<p>(The ‘desc tables’ should show a single ‘courses’ table, and the ‘select’ statement should show 5 rows of sample data.)</p>
<p>The ‘expand’ cqlsh command will display the query results in a ‘one column per line’ format:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- pretty format</span></span><br><span class="line">expand on;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses;</span><br><span class="line">expand off;</span><br></pre></td></tr></table></figure></p>
<p>You can display the time a piece of data was written with the ‘writetime’ function:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, cc, writetime(cc) <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'advanced-javascript'</span>;</span><br></pre></td></tr></table></figure></p>
<p>We can update this cc column with an ‘update’ statement:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> courses <span class="keyword">set</span> cc = <span class="literal">true</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'advanced-javascript'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Now re-run the select statement containing the ‘writetime’ function and notice that the time has changed.<br>You can prove to yourself that this write time is stored on a per column basis by selecting this for a different column:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span>, writetime(<span class="keyword">name</span>) <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'advanced-javascript'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Note that this writetime value is the same as the one returned by our first ‘cc’ query.</p>
<p>Cassandra also provides a function for returning the token associated with a partition key:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, token(<span class="keyword">id</span>) <span class="keyword">from</span> courses;</span><br></pre></td></tr></table></figure></p>
<p>If you try to select from a column other than the primary key, you’ll get an error:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> author = <span class="string">'Cory House'</span>;</span><br></pre></td></tr></table></figure></p>
<p>(We’ll show how to do this in a later module.)</p>
<p>Let’s create a users table:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">users</span> (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">varchar</span> primary <span class="keyword">key</span>,</span><br><span class="line">    first_name <span class="built_in">varchar</span>,</span><br><span class="line">    last_name <span class="built_in">varchar</span>,</span><br><span class="line">    email <span class="built_in">varchar</span>,</span><br><span class="line">    <span class="keyword">password</span> <span class="built_in">varchar</span></span><br><span class="line">    ) <span class="keyword">with</span> <span class="keyword">comment</span> = <span class="string">'A table of users'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Then we’ll insert and “upsert” two rows of data:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">users</span> (<span class="keyword">id</span>, first_name, last_name) <span class="keyword">values</span> (<span class="string">'john-doe'</span>, <span class="string">'John'</span>, <span class="string">'Doe'</span>);</span><br><span class="line"><span class="keyword">update</span> <span class="keyword">users</span> <span class="keyword">set</span> first_name = <span class="string">'Jane'</span>, last_name = <span class="string">'Doe'</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'jane-doe'</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span>;</span><br></pre></td></tr></table></figure></p>
<p>(Note that the net effect of the insert and update are the same.)</p>
<p>Now we’ll add a new ‘reset_token’ column to this table, and add a value to this column with a TTL:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">users</span> <span class="keyword">add</span> reset_token <span class="built_in">varchar</span>;</span><br><span class="line"><span class="keyword">update</span> <span class="keyword">users</span> <span class="keyword">using</span> ttl <span class="number">120</span> <span class="keyword">set</span> reset_token = <span class="string">'abc123'</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'john-doe'</span>;</span><br></pre></td></tr></table></figure></p>
<p>We can retrieve the time remaining for a ttl with the ‘ttl’ query function:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ttl(reset_token) <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'john-doe'</span>;</span><br></pre></td></tr></table></figure></p>
<p>We can turn on tracing and do a select to see that there are currently no tombstones:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tracing on;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'john-doe'</span>;</span><br></pre></td></tr></table></figure></p>
<p>(Re-run this several times until the 2 minutes have elasped and the token_value will be gone, and tracing will show a tombstone.)</p>
<p>Turn off tracing:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tracing off;</span><br></pre></td></tr></table></figure></p>
<p>Create a ratings table with two counter columns:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ratings (</span><br><span class="line">    course_id <span class="built_in">varchar</span> primary <span class="keyword">key</span>,</span><br><span class="line">    ratings_count counter,</span><br><span class="line">    ratings_total counter</span><br><span class="line">    ) <span class="keyword">with</span> <span class="keyword">comment</span> = <span class="string">'A table of course ratings'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Now let’s increment both counter columns to represent receiving a new course rating of 4:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> ratings <span class="keyword">set</span> ratings_count = ratings_count + <span class="number">1</span>, ratings_total = ratings_total + <span class="number">4</span> <span class="keyword">where</span> course_id = <span class="string">'nodejs-big-picture'</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> ratings;</span><br></pre></td></tr></table></figure></p>
<p>(The select should show the data we just upserted.)</p>
<p>Now let’s add a second course rating of 3:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> ratings <span class="keyword">set</span> ratings_count = ratings_count + <span class="number">1</span>, ratings_total = ratings_total + <span class="number">3</span> <span class="keyword">where</span> course_id = <span class="string">'nodejs-big-picture'</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> ratings;</span><br><span class="line">exit</span><br></pre></td></tr></table></figure></p>
<p>This should show the new values of “2” and “7” for ratings_count and ratings_total respectively.</p>
<p>Drop and re-create “ratings” to use with the “avg” aggregate function<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> ratings;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> ratings (</span><br><span class="line">    course_id <span class="built_in">varchar</span>,</span><br><span class="line">    user_id <span class="built_in">varchar</span>,</span><br><span class="line">    rating <span class="built_in">int</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (course_id, user_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>Insert a few sample ratings<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ratings (course_id, user_id, rating) <span class="keyword">values</span> (<span class="string">'cassandra-developers'</span>, <span class="string">'user1'</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ratings (course_id, user_id, rating) <span class="keyword">values</span> (<span class="string">'cassandra-developers'</span>, <span class="string">'user2'</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ratings (course_id, user_id, rating) <span class="keyword">values</span> (<span class="string">'cassandra-developers'</span>, <span class="string">'user3'</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ratings (course_id, user_Id, rating) <span class="keyword">values</span> (<span class="string">'advanced-python'</span>, <span class="string">'user1'</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure></p>
<p>You can select the average for a single course (across users):<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> course_id, <span class="keyword">avg</span>(rating) <span class="keyword">from</span> ratings <span class="keyword">where</span> course_id = <span class="string">'cassandra-developers'</span>;</span><br><span class="line"><span class="keyword">select</span> course_id, <span class="keyword">avg</span>(rating) <span class="keyword">from</span> ratings <span class="keyword">where</span> course_id = <span class="string">'advanced-python'</span>;</span><br></pre></td></tr></table></figure></p>
<p>However, you can’t apply aggregate functions across partition keys:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> course_id, <span class="keyword">avg</span>(rating) <span class="keyword">from</span> ratings;  <span class="comment">-- incorrect results</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Multi-Row-Partition"><a href="#Multi-Row-Partition" class="headerlink" title="Multi-Row Partition"></a>Multi-Row Partition</h1><h2 id="Composite-Key"><a href="#Composite-Key" class="headerlink" title="Composite Key"></a>Composite Key</h2><p>Previously we only have one primary key in table, that primary is the partition key. But it could be:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- composite key</span></span><br><span class="line">PRIMARY KEY (partition_key, clustering_key, ...)</span><br></pre></td></tr></table></figure></p>
<p><code>partition_key</code> can also be composite.</p>
<p>There is no <code>join</code> operation in Cassandra.</p>
<p>Drop this table and create a new one to hold both course and module data<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> courses;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> courses (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">varchar</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>,</span><br><span class="line">    author <span class="built_in">varchar</span>,</span><br><span class="line">    audience <span class="built_in">int</span>,</span><br><span class="line">    <span class="keyword">duration</span> <span class="built_in">int</span>,</span><br><span class="line">    cc <span class="built_in">boolean</span>,</span><br><span class="line">    released <span class="built_in">timestamp</span>,</span><br><span class="line">    module_id <span class="built_in">int</span>,</span><br><span class="line">    module_name <span class="built_in">varchar</span>,</span><br><span class="line">    module_duration <span class="built_in">int</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="keyword">id</span>, module_id)</span><br><span class="line">) <span class="keyword">with</span> <span class="keyword">comment</span> = <span class="string">'A table of courses and modules'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Insert data for the course, plus the first two modules<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (<span class="keyword">id</span>, <span class="keyword">name</span>, author, audience, <span class="keyword">duration</span>, cc, released, module_id, module_name, module_duration)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>,<span class="string">'Node.js: The Big Picture'</span>,<span class="string">'Paul O''Fallon'</span>, <span class="number">1</span>, <span class="number">3240</span>, <span class="literal">true</span>, <span class="string">'2019-06-03'</span>,<span class="number">1</span>,<span class="string">'Course Overview'</span>,<span class="number">70</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (<span class="keyword">id</span>, <span class="keyword">name</span>, author, audience, <span class="keyword">duration</span>, cc, released, module_id, module_name, module_duration)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>,<span class="string">'Node.js: The Big Picture'</span>,<span class="string">'Paul O''Fallon'</span>, <span class="number">1</span>, <span class="number">3240</span>, <span class="literal">true</span>, <span class="string">'2019-06-03'</span>,<span class="number">2</span>,<span class="string">'Considering Node.js'</span>,<span class="number">900</span>);</span><br></pre></td></tr></table></figure></p>
<p>Select the data we just inserted<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- get same result</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'nodejs-big-picture'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Now we can include both id and module_id in our where clause<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'nodejs-big-picture'</span> <span class="keyword">and</span> module_id = <span class="number">2</span>;</span><br></pre></td></tr></table></figure></p>
<p>We can’t select by just module, unless we enable ‘ALLOW FILTERING’<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- if no partition_key, performance downgrade</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> module_id = <span class="number">2</span>;                  // fails</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> module_id = <span class="number">2</span> <span class="keyword">allow</span> filtering;   // succeeds</span><br></pre></td></tr></table></figure></p>
<p>Now insert the remaining modules for the course<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (<span class="keyword">id</span>, <span class="keyword">name</span>, author, audience, <span class="keyword">duration</span>, cc, released, module_id, module_name, module_duration)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>,<span class="string">'Node.js: The Big Picture'</span>,<span class="string">'Paul O''Fallon'</span>, <span class="number">1</span>, <span class="number">3240</span>, <span class="literal">true</span>, <span class="string">'2019-06-03'</span>, <span class="number">3</span>, <span class="string">'Thinking Asynchronously'</span>, <span class="number">1304</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (<span class="keyword">id</span>, <span class="keyword">name</span>, author, audience, <span class="keyword">duration</span>, cc, released, module_id, module_name, module_duration)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>,<span class="string">'Node.js: The Big Picture'</span>,<span class="string">'Paul O''Fallon'</span>, <span class="number">1</span>, <span class="number">3240</span>, <span class="literal">true</span>, <span class="string">'2019-06-03'</span>, <span class="number">4</span>, <span class="string">'Defining an Application and Managing Dependencies'</span>, <span class="number">525</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (<span class="keyword">id</span>, <span class="keyword">name</span>, author, audience, <span class="keyword">duration</span>, cc, released, module_id, module_name, module_duration)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>,<span class="string">'Node.js: The Big Picture'</span>,<span class="string">'Paul O''Fallon'</span>, <span class="number">1</span>, <span class="number">3240</span>, <span class="literal">true</span>, <span class="string">'2019-06-03'</span>, <span class="number">5</span>, <span class="string">'Assembling a Development Toolset'</span>, <span class="number">489</span>);</span><br></pre></td></tr></table></figure></p>
<p>We can also use module_id as part of an “in” clause<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'nodejs-big-picture'</span> <span class="keyword">and</span> module_id <span class="keyword">in</span> (<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br></pre></td></tr></table></figure></p>
<p>And we can order by module_id<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'nodejs-big-picture'</span> <span class="keyword">order</span> <span class="keyword">by</span> module_id <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure></p>
<p>We can “select distinct” just the id, but not the id and course name:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span> <span class="keyword">from</span> courses;         // succeeds</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">from</span> courses;   // fails</span><br></pre></td></tr></table></figure></p>
<h2 id="Static-Columns"><a href="#Static-Columns" class="headerlink" title="Static Columns"></a>Static Columns</h2><p>Static Columns are static within the partition.<br>Its the common data in a partition.</p>
<p>From cqlsh, drop and recreate the courses table, using static columns<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> pluralsight;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> courses;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> courses (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">varchar</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span> <span class="keyword">static</span>,</span><br><span class="line">    author <span class="built_in">varchar</span> <span class="keyword">static</span>,</span><br><span class="line">    audience <span class="built_in">int</span> <span class="keyword">static</span>,</span><br><span class="line">    <span class="keyword">duration</span> <span class="built_in">int</span> <span class="keyword">static</span>,</span><br><span class="line">    cc <span class="built_in">boolean</span> <span class="keyword">static</span>,</span><br><span class="line">    released <span class="built_in">timestamp</span> <span class="keyword">static</span>,</span><br><span class="line">    module_id <span class="built_in">int</span>,</span><br><span class="line">    module_name <span class="built_in">varchar</span>,</span><br><span class="line">    module_duration <span class="built_in">int</span>,</span><br><span class="line">    primary <span class="keyword">key</span> (<span class="keyword">id</span>, module_id)</span><br><span class="line">) <span class="keyword">with</span> <span class="keyword">comment</span> = <span class="string">'A table of courses and modules'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Insert just the course data, and select it back<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (<span class="keyword">id</span>, <span class="keyword">name</span>, author, audience, <span class="keyword">duration</span>, cc, released)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>,<span class="string">'Node.js: The Big Picture'</span>,<span class="string">'Paul O''Fallon'</span>, <span class="number">1</span>, <span class="number">3240</span>, <span class="literal">true</span>, <span class="string">'2019-06-03'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'nodejs-big-picture'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Now insert the module data for the first two modules<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (<span class="keyword">id</span>, module_id, module_name, module_duration)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>,<span class="number">1</span>,<span class="string">'Course Overview'</span>,<span class="number">70</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (<span class="keyword">id</span>, module_id, module_name, module_duration)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>,<span class="number">2</span>,<span class="string">'Considering Node.js'</span>,<span class="number">900</span>);</span><br></pre></td></tr></table></figure></p>
<p>Selecting from courses now returns both course and module data in each row<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'nodejs-big-picture'</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'nodejs-big-picture'</span> <span class="keyword">and</span> module_id = <span class="number">2</span>;</span><br></pre></td></tr></table></figure></p>
<p>Insert the third module, but also change the name of the course.  Select all rows to show the course title changed everywhere.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (<span class="keyword">id</span>, <span class="keyword">name</span>, module_id, module_name, module_duration)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>, <span class="string">'The Big Node.js Picture'</span>, <span class="number">3</span>, <span class="string">'Thinking Asynchronously'</span>, <span class="number">1304</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'nodejs-big-picture'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Insert the fourth module, and fix the course name<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (<span class="keyword">id</span>, <span class="keyword">name</span>, module_id, module_name, module_duration)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>, <span class="string">'Node.js: The Big Picture'</span>, <span class="number">4</span>, <span class="string">'Defining an Application and Managing Dependencies'</span>, <span class="number">525</span>);</span><br></pre></td></tr></table></figure></p>
<p>Insert the remaining course module<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> courses (<span class="keyword">id</span>, module_id, module_name, module_duration)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>, <span class="number">5</span>, <span class="string">'Assembling a Development Toolset'</span>, <span class="number">489</span>);</span><br></pre></td></tr></table></figure></p>
<p>The ‘in’ and ‘order by’ clauses work the same as before<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'nodejs-big-picture'</span> <span class="keyword">and</span> module_id <span class="keyword">in</span> (<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'nodejs-big-picture'</span> <span class="keyword">order</span> <span class="keyword">by</span> module_id <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure></p>
<p>Select course info, repeated based on the number of modules in the course<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span>, author, audience, <span class="keyword">duration</span>, cc, released <span class="keyword">from</span> courses;</span><br></pre></td></tr></table></figure></p>
<p>Now “select distinct” course info and only get one row back<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">name</span>, author, audience, <span class="keyword">duration</span>, cc, released <span class="keyword">from</span> courses;</span><br></pre></td></tr></table></figure></p>
<p>Select just the module information for the course<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> module_id, module_name, module_duration <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'nodejs-big-picture'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Load module-level course data by running a series of CQL commands from an external file<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat data/courses2.cql | cqlsh</span><br></pre></td></tr></table></figure></p>
<p>Select module information for the ‘advanced-javascript’ course<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> pluralsight;</span><br><span class="line"><span class="keyword">select</span> module_id, module_name, module_duration <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'advanced-javascript'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Select module information for the ‘docker-fundamentals’ course<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> module_id, module_name, module_duration <span class="keyword">from</span> courses <span class="keyword">where</span> <span class="keyword">id</span> = <span class="string">'advanced-python'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Select just the course-level information for all 5 courses<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">id</span>, <span class="keyword">name</span>, author <span class="keyword">from</span> courses;</span><br></pre></td></tr></table></figure></p>
<h2 id="Time-Series-Data"><a href="#Time-Series-Data" class="headerlink" title="Time Series Data"></a>Time Series Data</h2><p>Launch our one Cassandra node and (when it’s ready) load our sample course data<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat data/courses2.cql | cqlsh</span><br></pre></td></tr></table></figure></p>
<p>From cqlsh, create a new table to hold course page views<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> pluralsight;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> course_page_views (</span><br><span class="line">    course_id <span class="built_in">varchar</span>,</span><br><span class="line">    view_id timeuuid,</span><br><span class="line">    primary <span class="keyword">key</span> (course_id, view_id)</span><br><span class="line">) <span class="keyword">with</span> <span class="keyword">clustering</span> <span class="keyword">order</span> <span class="keyword">by</span> (view_id <span class="keyword">desc</span>);</span><br></pre></td></tr></table></figure></p>
<p>Insert a row into this table, using “now()” to create a timeuuid with the current date/time.  Include a one year TTL.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course_page_views (course_id, view_id)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>, <span class="keyword">now</span>()) <span class="keyword">using</span> TTL <span class="number">31536000</span>;</span><br></pre></td></tr></table></figure></p>
<p>Insert another row into the table with a manually generated v1 UUID (also with a TTL)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course_page_views (course_id, view_id)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>, bb9807aa-fb68<span class="number">-11e9</span><span class="number">-8</span>f0b<span class="number">-362</span>b9e155667) <span class="keyword">using</span> TTL <span class="number">31536000</span>;</span><br></pre></td></tr></table></figure></p>
<p>Insert two more rows using “now()”<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course_page_views (course_id, view_id)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>, <span class="keyword">now</span>()) <span class="keyword">using</span> TTL <span class="number">31536000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course_page_views (course_id, view_id)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>, <span class="keyword">now</span>()) <span class="keyword">using</span> TTL <span class="number">31536000</span>;</span><br></pre></td></tr></table></figure></p>
<p>Select the rows, and then use dateOf() to extract the date/time portion of the view_id<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> course_page_views;</span><br><span class="line"><span class="keyword">select</span> dateOf(view_id) <span class="keyword">from</span> course_page_views <span class="keyword">where</span> course_id = <span class="string">'nodejs-big-picture'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Reverse the date order of the results<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dateOf(view_id) <span class="keyword">from</span> course_page_views <span class="keyword">where</span> course_id = <span class="string">'nodejs-big-picture'</span> <span class="keyword">order</span> <span class="keyword">by</span> view_id <span class="keyword">asc</span>;</span><br></pre></td></tr></table></figure></p>
<p>Select only those dates based on Timeuuids that span a 2 day range<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dateOf(view_id) <span class="keyword">from</span> course_page_views <span class="keyword">where</span> course_id = <span class="string">'nodejs-big-picture'</span></span><br><span class="line"><span class="keyword">and</span> view_id &gt;= maxTimeuuid(<span class="string">'2019-10-30 00:00+0000'</span>)</span><br><span class="line"><span class="keyword">and</span> view_id &lt; minTimeuuid(<span class="string">'2019-11-02 00:00+0000'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- adjust these dates as necessary to match a more current date range</span></span><br></pre></td></tr></table></figure></p>
<p>Truncate the table, and add a static column<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">truncate</span> course_page_views;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> course_page_views <span class="keyword">add</span> last_view_id timeuuid <span class="keyword">static</span>;</span><br></pre></td></tr></table></figure></p>
<p>Now insert three rows, using “now()” for both Timeuuids (with TTLs)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course_page_views (course_id, last_view_id, view_id)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>, <span class="keyword">now</span>(), <span class="keyword">now</span>()) <span class="keyword">using</span> TTL <span class="number">31536000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course_page_views (course_id, last_view_id, view_id)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>, <span class="keyword">now</span>(), <span class="keyword">now</span>()) <span class="keyword">using</span> TTL <span class="number">31536000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course_page_views (course_id, last_view_id, view_id)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'nodejs-big-picture'</span>, <span class="keyword">now</span>(), <span class="keyword">now</span>()) <span class="keyword">using</span> TTL <span class="number">31536000</span>;</span><br></pre></td></tr></table></figure></p>
<p>Selecting all rows shows different view_ids but the same last_view_id for all rows<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> course_page_views;</span><br></pre></td></tr></table></figure></p>
<p>Use ‘select distinct’ to get just the latest page view for this course<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> course_id, last_view_id <span class="keyword">from</span> course_page_views;</span><br></pre></td></tr></table></figure></p>
<p>For just one course, this can also be accomplished with the view_id and a LIMIT clause<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> course_id, view_id <span class="keyword">from</span> course_page_views <span class="keyword">where</span> course_id = <span class="string">'nodejs-big-picture'</span> <span class="keyword">limit</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>However, a ‘limit’ won’t work across multiple courses.  Insert multiple views for another course.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course_page_views (course_id, last_view_id, view_id)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'advanced-javascript'</span>, <span class="keyword">now</span>(), <span class="keyword">now</span>()) <span class="keyword">using</span> TTL <span class="number">31536000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course_page_views (course_id, last_view_id, view_id)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'advanced-javascript'</span>, <span class="keyword">now</span>(), <span class="keyword">now</span>()) <span class="keyword">using</span> TTL <span class="number">31536000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> course_page_views (course_id, last_view_id, view_id)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">'advanced-javascript'</span>, <span class="keyword">now</span>(), <span class="keyword">now</span>()) <span class="keyword">using</span> TTL <span class="number">31536000</span>;</span><br></pre></td></tr></table></figure></p>
<p>Select latest view_id from each course, using the limit clause<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> course_id, view_id <span class="keyword">from</span> course_page_views <span class="keyword">where</span> course_id = <span class="string">'nodejs-big-picture'</span> <span class="keyword">limit</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> course_id, view_id <span class="keyword">from</span> course_page_views <span class="keyword">where</span> course_id = <span class="string">'advanced-javascript'</span> <span class="keyword">limit</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>Retrieve the latest course page view for all courses with ‘select distinct’ and the static column<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> course_id, last_view_id <span class="keyword">from</span> course_page_views;</span><br></pre></td></tr></table></figure></p>
<p>Select all the individual views for each course, one at a time<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> course_id, view_id <span class="keyword">from</span> course_page_views <span class="keyword">where</span> course_id = <span class="string">'nodejs-big-picture'</span>;</span><br><span class="line"><span class="keyword">select</span> course_id, view_id <span class="keyword">from</span> course_page_views <span class="keyword">where</span> course_id = <span class="string">'advanced-javascript'</span>;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/database/" rel="tag"># database</a>
          
            <a href="/tags/cassandra/" rel="tag"># cassandra</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/25/pipeline-jenkinsX-learn/" rel="next" title="Jenkins X Quick Start">
                <i class="fa fa-chevron-left"></i> Jenkins X Quick Start
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/07/05/linux-centos8-new/" rel="prev" title="What's New in CentOS 8">
                What's New in CentOS 8 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">181</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">32</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">107</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#TODO"><span class="nav-number">1.</span> <span class="nav-text">TODO</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">2.</span> <span class="nav-text">Introduction</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Replication-Strategy"><span class="nav-number">2.1.</span> <span class="nav-text">Replication Strategy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tunable-Consistency"><span class="nav-number">2.2.</span> <span class="nav-text">Tunable Consistency</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CQL"><span class="nav-number">3.</span> <span class="nav-text">CQL</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Multi-Row-Partition"><span class="nav-number">4.</span> <span class="nav-text">Multi-Row Partition</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Composite-Key"><span class="nav-number">4.1.</span> <span class="nav-text">Composite Key</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Static-Columns"><span class="nav-number">4.2.</span> <span class="nav-text">Static Columns</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Time-Series-Data"><span class="nav-number">4.3.</span> <span class="nav-text">Time Series Data</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="Symbols count total">761k</span>
  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
