<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="这段时间开始研究Operator了，刚好有这本书，计划快速过一遍，recap quick start. 看完了一遍，最深得感受就是，如果K8s是云的操作系统，那么Operator就是一个云应用程序自己的管理工具，也就是书中说的application SRE。 Book accompanying git repo: https://github.com/chengdol/chapters/ (thi">
<meta name="keywords" content="book,kubernetes,operator">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes Operators">
<meta property="og:url" content="http://yoursite.com/2020/06/03/book-k8s-operator/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="这段时间开始研究Operator了，刚好有这本书，计划快速过一遍，recap quick start. 看完了一遍，最深得感受就是，如果K8s是云的操作系统，那么Operator就是一个云应用程序自己的管理工具，也就是书中说的application SRE。 Book accompanying git repo: https://github.com/chengdol/chapters/ (thi">
<meta property="og:locale" content="中文|English">
<meta property="og:updated_time" content="2020-06-29T04:58:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubernetes Operators">
<meta name="twitter:description" content="这段时间开始研究Operator了，刚好有这本书，计划快速过一遍，recap quick start. 看完了一遍，最深得感受就是，如果K8s是云的操作系统，那么Operator就是一个云应用程序自己的管理工具，也就是书中说的application SRE。 Book accompanying git repo: https://github.com/chengdol/chapters/ (thi">






  <link rel="canonical" href="http://yoursite.com/2020/06/03/book-k8s-operator/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Kubernetes Operators | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">152</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">43</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">270</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/03/book-k8s-operator/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Kubernetes Operators

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-06-03 21:31:05" itemprop="dateCreated datePublished" datetime="2020-06-03T21:31:05-07:00">2020-06-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-06-28 21:58:12" itemprop="dateModified" datetime="2020-06-28T21:58:12-07:00">2020-06-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Book/" itemprop="url" rel="index"><span itemprop="name">Book</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这段时间开始研究Operator了，刚好有这本书，计划快速过一遍，recap quick start. 看完了一遍，最深得感受就是，如果K8s是云的操作系统，那么Operator就是一个云应用程序自己的管理工具，也就是书中说的application SRE。</p>
<p>Book accompanying git repo:
<a href="https://github.com/chengdol/chapters/" target="_blank" rel="noopener">https://github.com/chengdol/chapters/</a> (this is forked from origin)
还推荐几本书, from O’reilly:</p>
<ul>
<li>Programming Kubernetes (dive deeper into API)</li>
<li>Extending Kubernetes</li>
</ul>
<p>My K8s operator-sdk demo git repo, step by step guide you setup a go-based operator and deploy in K8s cluster:
<a href="https://github.com/chengdol/k8s-operator-sdk-demo" target="_blank" rel="noopener">https://github.com/chengdol/k8s-operator-sdk-demo</a></p>
<p>其他一些资料收集在了这篇blog中:
<a href="https://chengdol.github.io/2020/01/23/k8s-operator/" target="_blank" rel="noopener">Kubernetes Operator Learning</a></p>
<h1>Chapter 1 Introduction</h1>
<p>Operators grew out of work at CoreOS during 2015 and 2016. User experience with the Operators built there and continuing at Red Hat.</p>
<p>An Operator continues to monitor its application as it runs, and can back up data, recover from failures, and upgrade the application over time, automatically.</p>
<p>An Operator is a custom Kubernetes controller watching a CR type and taking application-specific actions to make reality match the spec in that resource.</p>
<p>Making an Operator means creating a CRD and providing a program that runs in a loop watching CRs of that kind.</p>
<p>The Operator pattern arose in response to infrastructure engineers and developers wanting to extend Kubernetes to provide features <strong>specific</strong> to their sites and software.</p>
<p>看到这里产生了一个疑问: Helm and Operator.</p>
<ul>
<li><a href="https://medium.com/@cloudark/kubernetes-operators-and-helm-it-takes-two-to-tango-3ff6dcf65619" target="_blank" rel="noopener">Kubernetes Operators and Helm — It takes Two to Tango</a></li>
<li><a href="https://www.openshift.com/blog/make-a-kubernetes-operator-in-15-minutes-with-helm" target="_blank" rel="noopener">Make a Kubernetes Operator in 15 minutes with Helm</a></li>
</ul>
<h1>Chapter 2 Running Operators</h1>
<p>这是最基本的operator 演示，一个etcd cluster，有很大的启发价值，注意下面例子中各自的创建顺序:
<a href="https://github.com/kubernetes-operators-book/chapters/tree/master/ch03" target="_blank" rel="noopener">https://github.com/kubernetes-operators-book/chapters/tree/master/ch03</a></p>
<p>First need cluster-wise privilege:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## need cluster wide privilege</span></span><br><span class="line">kubectl describe clusterrole cluster-admin</span><br><span class="line"></span><br><span class="line"><span class="comment">## good</span></span><br><span class="line">Name:         cluster-admin</span><br><span class="line">Labels:       kubernetes.io/bootstrapping=rbac-defaults</span><br><span class="line">Annotations:  rbac.authorization.kubernetes.io/autoupdate: <span class="literal">true</span></span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------  -----------------  --------------  -----</span><br><span class="line">  *.*        []                 []              [*]</span><br><span class="line">             [*]                []              [*]</span><br></pre></td></tr></table></figure>
<p>Start with <code>etcd</code> as ‘hello world’ example. Deviation:</p>
<ul>
<li>Raft protocol: <a href="https://raft.github.io/" target="_blank" rel="noopener">https://raft.github.io/</a></li>
</ul>
<p>you’ll deploy the etcd Operator, then have it create an etcd cluster according to your specifications. You will have the Operator recover from failures and perform a version upgrade while the etcd API continues to service read and write requests, showing how an Operator automates the lifecycle of a piece of foundation software.</p>
<p>A <code>CRD</code> is akin to a schema for a <code>CR</code>, defining the <code>CR</code>’s fields and the types of values those fields contain:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">etcdclusters.etcd.database.coreos.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  group:</span> <span class="string">etcd.database.coreos.com</span></span><br><span class="line"><span class="attr">  names:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">EtcdCluster</span></span><br><span class="line"><span class="attr">    listKind:</span> <span class="string">EtcdClusterList</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">etcdclusters</span></span><br><span class="line"><span class="attr">    shortNames:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">etcdclus</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">etcd</span></span><br><span class="line"><span class="attr">    singular:</span> <span class="string">etcdcluster</span></span><br><span class="line"><span class="attr">  scope:</span> <span class="string">Namespaced</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1beta2</span></span><br><span class="line"><span class="attr">  versions:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">v1beta2</span></span><br><span class="line"><span class="attr">    served:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>The <code>CR</code>’s group, version, and kind together form the fully qualified name of a Kubernetes resource type. That canonical name must be unique across a cluster.</p>
<p>Defining an Operator Service Account:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">etcd-operator-sa</span></span><br></pre></td></tr></table></figure>
<p>Defining role:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">etcd-operator-role</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">etcd.database.coreos.com</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">etcdclusters</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">etcdbackups</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">etcdrestores</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">services</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">endpoints</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">events</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">apps</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deployments</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">secrets</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br></pre></td></tr></table></figure>
<p>Defining rolebinding, assigns the role to the service account for the etcd Operator:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">etcd-operator-rolebinding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">etcd-operator-role</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">etcd-operator-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>
<p>The Operator is a custom controller running in a pod, and it watches the EtcdCluster CR you defined earlier.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">etcd-operator</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">etcd-operator</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">etcd-operator</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">etcd-operator</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">quay.io/coreos/etcd-operator:v0.9.4</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">etcd-operator</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">--create-crd=false</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_POD_NAMESPACE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MY_POD_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">etcd-operator-sa</span></span><br></pre></td></tr></table></figure>
<p>Declaring an etcd cluster:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">etcd.database.coreos.com/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EtcdCluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">example-etcd-cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  size:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  version:</span> <span class="number">3.1</span><span class="number">.10</span></span><br></pre></td></tr></table></figure>
<p>After create <code>CR</code> resource, operator will generate 3 replicas pod (the pod definition is written by operator logic).</p>
<p>This example etcd cluster is a first-class citizen, an <code>EtcdCluster</code> in your cluster’s API. Since it’s an API resource, you can get the etcd cluster spec and status directly from Kubernetes.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## etcdcluster is a resource just like pod/deploy/sts</span></span><br><span class="line">kubectl describe etcdcluster example-etcd-cluster</span><br></pre></td></tr></table></figure>
<p>The etcd Operator creates a Kubernetes service in the etcd cluster’s namespace:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get services --selector etcd_cluster=example-etcd-cluster</span><br></pre></td></tr></table></figure>
<p>Run the etcd client on the cluster and use it to connect to the client service and interact with the etcd API.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run --rm -i --tty etcdctl --image quay.io/coreos/etcd --restart=Never -- /bin/sh</span><br></pre></td></tr></table></figure>
<p>From the etcd container’s shell, create and read a key-value pair in etcd with etcdctl’s put and get verbs:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line"><span class="built_in">export</span> ETCDCSVC=http://example-etcd-cluster-client:2379</span><br><span class="line">etcdctl --endpoints <span class="variable">$ETCDCSVC</span> put foo bar</span><br><span class="line">etcdctl --endpoints <span class="variable">$ETCDCSVC</span> get foo</span><br><span class="line"></span><br><span class="line"><span class="comment">## check etcd cluster general health</span></span><br><span class="line">etcdctl --endpoints http://example-etcd-cluster-client:2379 cluster-health</span><br></pre></td></tr></table></figure>
<p>You can try to delete etcd pod or upgrade the version (edit cr file then apply) and watching the operator recover the health.</p>
<p>kubectl tricks for upgrade:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch etcdcluster example-etcd-cluster --<span class="built_in">type</span>=<span class="string">'json'</span> \</span><br><span class="line">  -p <span class="string">'[&#123;"op": "replace", "path": "/spec/version", "value":3.3.12&#125;]'</span></span><br></pre></td></tr></table></figure>
<h1>Chapter 3 Operators at the Kubernetes Interface</h1>
<p>Operators extend two key Kubernetes concepts: <code>resources</code> and <code>controllers</code>. The Kubernetes API includes a mechanism, the CRD, for defining new resources.</p>
<p>这2段话把一般通用控制器和operator的区别讲清楚了:</p>
<blockquote>
<p>The actions the ReplicaSet controller takes are intentionally general and application agnostic. It does not, should not, and truly cannot know the particulars of startup and shutdown sequences for every application that might run on a Kubernetes cluster.</p>
</blockquote>
<blockquote>
<p>An Operator is the application-specific combination of CRs and a custom controller that does know all the details about starting, scaling, recovering, and managing its application.</p>
</blockquote>
<p>Every Operator has one or more custom controllers implementing its application-specific management logic.</p>
<p>An Operator, in turn, can be limited to a namespace, or it can maintain its operand across an entire cluster.</p>
<p>For example, cluster-scoped operator:</p>
<blockquote>
<p>Istio operator: <a href="https://github.com/istio/operator" target="_blank" rel="noopener">https://github.com/istio/operator</a>
cert-manager: <a href="https://github.com/jetstack/cert-manager" target="_blank" rel="noopener">https://github.com/jetstack/cert-manager</a></p>
</blockquote>
<p>A <code>service account</code> is a special type of cluster user for authorizing programs instead of people. An Operator is a program that uses the Kubernetes API, and most Operators should derive their access rights from a service account.</p>
<h1>Chapter 4 The Operator Framework</h1>
<p>This chapter introduced the three pillars of the Operator Framework: the Operator SDK for building and developing Operators; Operator Lifecycle Manager for distributing, installing, and upgrading them; and Operator Metering for measuring Operator performance and resource consumption.</p>
<p>The <code>Red Hat Operator Framework</code> makes it simpler to create and distribute Operators. It makes building Operators easier with a <code>software development kit (SDK)</code> that automates much of the repetitive implementation work. The Framework also provides mechanisms for deploying and managing Operators. <code>Operator Lifecycle Manager (OLM)</code> is an Operator that installs, manages, and upgrades other Operators. <code>Operator Metering</code> is a metrics system that accounts for Operators’ use of cluster resources.</p>
<p><code>Operator SDK</code>: <a href="https://github.com/operator-framework/operator-sdk" target="_blank" rel="noopener">https://github.com/operator-framework/operator-sdk</a>
The SDK currently includes first-class support for constructing Operators in the <code>Go</code> programming language, with support for other languages planned. The SDK also offers what might be described as an adapter architecture for <code>Helm</code> charts or <code>Ansible</code> playbooks.</p>
<p><code>Operator Lifecycle Manager</code> takes the Operator pattern one level up the stack: it’s an Operator that acquires, deploys, and manages Operators on a Kubernetes cluster.</p>
<p><code>Operator Metering</code> is a system for analyzing the resource usage of the Operators running on Kubernetes clusters.</p>
<p><strong>Install operator SDK</strong>: <a href="https://sdk.operatorframework.io/docs/install-operator-sdk/" target="_blank" rel="noopener">https://sdk.operatorframework.io/docs/install-operator-sdk/</a>
注意k8s version是否与当前operator sdk兼容，比如我实验的时候k8s version 1.13.2，它支持的crd api version is <code>apiextensions.k8s.io/v1beta1</code>, 而最近的operator sdk生成的crd api version is <code>apiextensions.k8s.io/v1</code>. 书中用的operator sdk version <code>0.11.0</code>.</p>
<h1>Chapter 5 Sample Application: Visitors Site</h1>
<p>In the chapters that follow, we’ll create Operators to deploy this application using each of the approaches provided by the Operator SDK (<strong>Helm, Ansible, and Go</strong>), and explore the benefits and drawbacks of each.</p>
<p>读到这里，疑惑Helm是如何处理这个问题的，特别是对同一个charts之中的依赖:
When deploying applications through manifests, awareness of these relationships is required to ensure that the values line up.</p>
<p>The manifest-based installation for this demo:
<a href="https://github.com/kubernetes-operators-book/chapters/tree/master/ch05" target="_blank" rel="noopener">https://github.com/kubernetes-operators-book/chapters/tree/master/ch05</a>
Now deploying it manually with correct order:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f database.yaml</span><br><span class="line">kubectl create -f backend.yaml    </span><br><span class="line">kubectl create -f frontend.yaml</span><br></pre></td></tr></table></figure>
<p>Deletion:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f database.yaml</span><br><span class="line">kubectl delete -f backend.yaml    </span><br><span class="line">kubectl delete -f frontend.yaml</span><br></pre></td></tr></table></figure>
<h1>Chapter 6 Adapter Operators</h1>
<p>You would have to create <code>CRDs</code> to specify the interface for end users.
Kubernetes controllers would not only need to be written with the Operator’s domain-specific logic, but also be correctly hooked into a running cluster to receive the proper notifications. Roles and service accounts would need to be created to permit the Operator to function in the capacity it needs. An Operator is run as a pod inside of a cluster, so an <code>image</code> would need to be built, along with its accompanying deployment manifest.</p>
<p>这章节主要是利用已有的Helm or Ansibel去构造Adapter Operator:
The Operator SDK provides a solution to both these problems through its <code>Adapter Operators</code>. Through the command-line tool, the SDK generates the code necessary to run technologies such as Helm and Ansible in an Operator.</p>
<p>First understand the role of <code>CRDs</code>.</p>
<ul>
<li>A CRD is the specification of what constitutes a CR. In particular, the CRD defines the allowed configuration values and the expected output that describes the current state of the resource.</li>
<li>A CRD is created when a new Operator project is generated by the SDK.</li>
<li>The SDK prompts the user for two pieces of information about the CRD during project creation: <code>kind</code>, <code>api-version</code></li>
</ul>
<p>Official operator SDK sample:
<a href="https://github.com/operator-framework/operator-sdk-samples" target="_blank" rel="noopener">https://github.com/operator-framework/operator-sdk-samples</a></p>
<h2 id="Helm-Operator">Helm Operator</h2>
<p>demo git repo to generate helm operator:
<a href="https://github.com/kubernetes-operators-book/chapters/tree/master/ch06/visitors-helm" target="_blank" rel="noopener">https://github.com/kubernetes-operators-book/chapters/tree/master/ch06/visitors-helm</a></p>
<p>A Helm Operator can deploy each instance of an application with a different version of <code>values.yaml</code>. The Operator SDK generates Kubernetes controller code for a Helm Operator when it is passed the <code>--type=helm</code> argument.
As a prerequisite, be sure to install the <code>Helm</code> command-line tools on your machine.</p>
<h3 id="New-Chart">New Chart</h3>
<p>Generate a blank helm chart structure within the operator project code:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OPERATOR_NAME=visitors-helm-operator</span><br><span class="line">operator-sdk new <span class="variable">$OPERATOR_NAME</span> --api-version=example.com/v1 --kind=VisitorsApp --<span class="built_in">type</span>=helm</span><br></pre></td></tr></table></figure>
<p>At this point, everything is in place to begin to implement your chart.</p>
<p>There are several direcotyies created:</p>
<ul>
<li>build: it contains Dockerfile for operator image</li>
<li>deploy: crds definition, role and rolebinding, service account</li>
<li>helm-charts: helm chart structure for your app</li>
<li>watches.yaml: maps each CR type to the specific Helm chart that is used to handle it.</li>
</ul>
<h3 id="Existing-Chart">Existing Chart</h3>
<p>Helm install command 其实有很多参数可以customize，比如选择values yaml file, 但这里没有这么灵活，用的是默认的values.yaml.</p>
<p>一定要事先检查template validation，比如对于helm3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm template &lt;chart dir or archive file&gt; [--debug] | less</span><br></pre></td></tr></table></figure>
<p>查看每个rendering 是否格式正确，helm template对format issue并不会报错。</p>
<p>Generate Helm operator atop existing helm archive, 对于OpenShift，要先<code>oc login</code>，否则operator-sdk 不能获得cluster info:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OPERATOR_NAME=visitors-helm-operator</span><br><span class="line"><span class="comment">## download existing chart archive</span></span><br><span class="line">wget https://github.com/kubernetes-operators-book/chapters/releases/download/1.0.0/visitors-helm.tgz</span><br><span class="line"><span class="comment">## generate helm operator</span></span><br><span class="line">operator-sdk new <span class="variable">$OPERATOR_NAME</span> --api-version=example.com/v1 --kind=VisitorsApp --<span class="built_in">type</span>=helm --helm-chart=./visitors-helm.tgz</span><br></pre></td></tr></table></figure>
<ul>
<li><code>--helm-chart</code>: A URL to a chart archive, The repository and name of a remote chart, or The location of a local directory</li>
<li><code>--helm-chart-repo</code>: Specifies a remote repository URL for the chart</li>
<li><code>--helm-chart-version</code>: Tells the SDK to fetch a specific version of the chart. If this is omitted, the latest available version is used.</li>
</ul>
<p>You will see <code>deploy/crds/example.com_v1_visitorsapp_cr.yaml</code> has the fields exactly the same as <code>values.yaml</code> in helm chart.</p>
<p>Before running the chart, the Operator will map the values found in the custom resource’s spec field to the <code>values.yaml</code> file.</p>
<p>如此生成的CRD 和 role (extremely permissive) 可以直接使用，但可能不满足具体要求，比如constraints 以及权限限制，需要自己调整:</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#specifying-a-structural-schema" target="_blank" rel="noopener">CRD structure schema</a></li>
</ul>
<h2 id="Ansible-Operator">Ansible Operator</h2>
<p>More or less the same as Helm operator generation.
Generate blank Ansible operator project:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OPERATOR_NAME=visitors-ansible-operator</span><br><span class="line">operator-sdk new <span class="variable">$OPERATOR_NAME</span> --api-version=example.com/v1 --kind=VisitorsApp --<span class="built_in">type</span>=ansible</span><br></pre></td></tr></table></figure>
<h2 id="Test-Operator">Test Operator</h2>
<p>An Operator is delivered as a normal container image. However, during the development and testing cycle, it is often easier to skip the image creation process and simply run the Operator <strong>outside of the cluster</strong>.
这个用在开发测试的时候，它不会部署一个真正的operator deployment，只是一个process，但实验效果和真实的一样。这里只是针对helm and ansible的类型.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## go to root path of operator project</span></span><br><span class="line"><span class="comment">## set full path in `chart` field to chart</span></span><br><span class="line">cp watches.yaml <span class="built_in">local</span>-watches.yaml</span><br><span class="line">kubectl apply -f deploy/crds/*_crd.yaml</span><br><span class="line"><span class="comment">## start opeerator process</span></span><br><span class="line">operator-sdk up <span class="built_in">local</span> --watches-file ./<span class="built_in">local</span>-watches.yaml</span><br></pre></td></tr></table></figure>
<p>The process is up and running, next is to apply your <code>cr</code> yaml:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deploy/crds/*_cr.yaml</span><br><span class="line">kubectl delete -f deploy/crds/*_cr.yaml</span><br></pre></td></tr></table></figure>
<p>你会看到log的变化，以及application在k8s cluster中的更新。
Once the test is complete, end the running process by pressing <code>Ctrl-C</code>.</p>
<p>During development, repeat this process to test changes. On each iteration, be sure to restart the Operator process to pick up any changes to the Helm or Ansible files</p>
<h2 id="Deploy-Operator">Deploy Operator</h2>
<p>Running an Operator outside of the cluster, is convenient for testing and debugging purposes, but production Operators run as Kubernetes deployments.</p>
<ol>
<li>Build the operator image. The Operator SDK’s <code>build</code> command chains to the underlying Docker daemon to build the Operator image, and takes the full image name and version when run:</li>
</ol>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">operator-sdk build jdob/visitors-operator:0.1</span><br></pre></td></tr></table></figure>
<p>You can check the Dockerfile, no additional changes are needed. the <code>${HOME}</code> is consistent with the path in <code>watches.yaml</code>.</p>
<p>Once built, push the image to an externally accessible repository</p>
<ol start="2">
<li>
<p>Configure the deployment. Update the <code>deploy/operator.yaml</code> file that the SDK generates with the name of the image.</p>
</li>
<li>
<p>Deploy CRD</p>
</li>
<li>
<p>Deploy Service account and Role</p>
</li>
<li>
<p>Deploy Operator deployment</p>
</li>
</ol>
<h1>Chapter 7 Operators in Go with the Operator SDK</h1>
<p>这一节的code参考，没有把所有logic都写到一个文件下，而是针对不同的resource分开写的，还将公用的部分单独分出来了，很有参考价值, 我总结了一下实现，看这里:
<a href="https://github.com/chengdol/k8s-operator-sdk-demo" target="_blank" rel="noopener">https://github.com/chengdol/k8s-operator-sdk-demo</a></p>
<p>The Operator SDK provides that flexibility by making it easy for developers to use the <code>Go</code> programming language, including its ecosystem of external libraries, in their Operators. Write acutall business logic of operator.</p>
<p>While you can write all these pieces manually, the Operator SDK provides commands that will automate the creation of much of the supporting code, allowing you to focus on implementing the actual <code>business logic</code> of the Operator.</p>
<p>We will explore the files that need to be edited with custom application logic and discuss some common practices for Operator development.</p>
<h2 id="Create-Go-Based-Operator">Create Go Based Operator</h2>
<p>关于如何command line创建go-based operator书中的表述不清楚，我参考了Red Hat的文档:</p>
<ul>
<li><a href="https://docs.openshift.com/container-platform/4.3/operators/operator_sdk/osdk-getting-started.html#building-memcached-operator-using-osdk_osdk-getting-started" target="_blank" rel="noopener">Building a Go-based Memcached Operator using the Operator SDK</a></li>
</ul>
<p>这描述太含糊了:
In particular, the Operator code <strong>must</strong> be located in your <code>$GOPATH</code>, 关键是怎么设置<code>$GOPATH</code>:</p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/understanding-the-gopath" target="_blank" rel="noopener">Understand the GOPATH</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-go-and-set-up-a-local-programming-environment-on-ubuntu-18-04" target="_blank" rel="noopener">Setting up local Go environment</a></li>
</ul>
<p>如果用<code>go env | grep GOPATH</code>，发现已经有默认值了<code>$HOME/go</code>，但还需要在bash env中export:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GOPATH=<span class="variable">$HOME</span>/go</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOPATH</span>/bin</span><br><span class="line"><span class="comment">#export GO111MODULE=on</span></span><br><span class="line"></span><br><span class="line">OPERATOR_NAME=visitors-operator</span><br><span class="line"><span class="comment">## 这个路径和后面的controller import中的路径要一致！</span></span><br><span class="line">OPERATOR_PATH=<span class="variable">$GOPATH</span>/src/github.com/jdob</span><br><span class="line">mkdir -p <span class="variable">$OPERATOR_PATH</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$OPERATOR_PATH</span></span><br><span class="line"><span class="comment">## no --type specified, default is go</span></span><br><span class="line">operator-sdk new <span class="variable">$OPERATOR_NAME</span></span><br></pre></td></tr></table></figure>
<p>针对operator-sdk new出现的错误信息，我export了<code>GO111MODULE=on</code>，但后来重做一遍后这个错误又消失了:</p>
<ul>
<li><a href="https://dev.to/maelvls/why-is-go111module-everywhere-and-everything-about-go-modules-24k" target="_blank" rel="noopener">Why is GO111MODULE everywhere, and everything about Go Modules</a></li>
</ul>
<p>The generation can take a few minutes as all of the Go dependencies are downloaded.</p>
<h2 id="Add-CRDs">Add CRDs</h2>
<p>You can add new CRDs to an Operator using the SDK’s add api command. Run from the Operator project <code>root</code> directory to generate CRD: 这应该说明一个Operator可以有多个CRDs.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$OPERATOR_PATH</span>/<span class="variable">$OPERATOR_NAME</span></span><br><span class="line">operator-sdk add api --api-version=example.com/v1 --kind=VisitorsApp</span><br><span class="line"><span class="comment">## from command outputs, you will see what files are generated</span></span><br></pre></td></tr></table></figure>
<p>3 files are important:</p>
<ul>
<li><code>deploy/crds/*cr.yaml</code></li>
<li><code>deploy/crds/*crd.yaml</code></li>
<li><code>pkg/apis/example/v1/visitorsapp_types.go</code>: contains a number of struct objects that the Operator codebase leverages</li>
</ul>
<p>For example, in <code>pkg/apis/example/v1/visitorsapp_types.go</code> edit the Spec and Status struct:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VisitorsAppSpec defines the desired state of VisitorsApp</span></span><br><span class="line"><span class="comment">// +k8s:openapi-gen=true</span></span><br><span class="line"><span class="keyword">type</span> VisitorsAppSpec <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span></span><br><span class="line">	<span class="comment">// Important: Run "operator-sdk generate k8s" to regenerate code after modifying this file</span></span><br><span class="line">	<span class="comment">// Add custom validation using kubebuilder tags: https://book.kubebuilder.io/beyond_basics/generating_crd.html</span></span><br><span class="line"></span><br><span class="line">	Size       <span class="keyword">int32</span>  <span class="string">`json:"size"`</span></span><br><span class="line">	Title      <span class="keyword">string</span> <span class="string">`json:"title"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VisitorsAppStatus defines the observed state of VisitorsApp</span></span><br><span class="line"><span class="comment">// +k8s:openapi-gen=true</span></span><br><span class="line"><span class="keyword">type</span> VisitorsAppStatus <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster</span></span><br><span class="line">	<span class="comment">// Important: Run "operator-sdk generate k8s" to regenerate code after modifying this file</span></span><br><span class="line">	<span class="comment">// Add custom validation using kubebuilder tags: https://book.kubebuilder.io/beyond_basics/generating_crd.html</span></span><br><span class="line"></span><br><span class="line">	BackendImage  <span class="keyword">string</span> <span class="string">`json:"backendImage"`</span></span><br><span class="line">	FrontendImage <span class="keyword">string</span> <span class="string">`json:"frontendImage"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After editing, run</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## After any change to a *_types.go file, you need to update any generated code</span></span><br><span class="line">operator-sdk generate k8s</span><br></pre></td></tr></table></figure>
<p>Then customize <code>deploy/crds/example_v1_visitorsapp_crd.yaml</code> file to reflect the struct content, for example:
<a href="https://github.com/chengdol/chapters/tree/master/ch07/visitors-operator/deploy/crds" target="_blank" rel="noopener">https://github.com/chengdol/chapters/tree/master/ch07/visitors-operator/deploy/crds</a></p>
<p>这里并没有特意修改RBAC，用的默认Operator permission:
<a href="https://github.com/chengdol/chapters/tree/master/ch07/visitors-operator/deploy" target="_blank" rel="noopener">https://github.com/chengdol/chapters/tree/master/ch07/visitors-operator/deploy</a></p>
<h2 id="Write-Control-Logic">Write Control Logic</h2>
<p>Inside of the Operator pod itself, you need a controller to watch for changes to CRs and react accordingly. Similar to adding a CRD, you use the SDK to generate the controller’s skeleton code.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## generate controller code skeleton</span></span><br><span class="line">operator-sdk add controller --api-version=example.com/v1 --kind=VisitorsApp</span><br></pre></td></tr></table></figure>
<p>The file <code>pkg/controller/visitorsapp/visitorsapp_controller.go</code> will be created, the is the controller file that implements the Operator’s custom logic.</p>
<p>More information on K8s controller:
<a href="https://kubernetes.io/docs/concepts/architecture/controller/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/architecture/controller/</a></p>
<p>主要有2个func需要customize: <code>add</code> and <code>Reconcile</code>，一个是watch也就是告诉K8s哪些resource需要监控，一个是控制逻辑.
While the bulk of the Operator logic resides in the controller’s <code>Reconcile</code> function, the <code>add</code> function establishes the watches that will trigger reconcile events:
<a href="https://github.com/chengdol/chapters/tree/master/ch07/visitors-operator/pkg/controller/visitorsapp" target="_blank" rel="noopener">https://github.com/chengdol/chapters/tree/master/ch07/visitors-operator/pkg/controller/visitorsapp</a></p>
<p>The first watch listens for changes to the <code>primary resource</code> that the controller monitors. 也就是自定义的kind类型。
The second watch, or more accurately, series of watches, listens for changes to any <code>child resources</code> the Operator created to support the primary resource. 也就是自定义kind类型中间接的其他resources，比如deployment, sts, service等</p>
<p><strong>Reconcile function</strong>
The Reconcile function, also known as the <code>reconcile loop</code>, is where the Operator’s logic resides:
<a href="https://github.com/chengdol/chapters/blob/master/ch07/visitors-operator/pkg/controller/visitorsapp/visitorsapp_controller.go" target="_blank" rel="noopener">https://github.com/chengdol/chapters/blob/master/ch07/visitors-operator/pkg/controller/visitorsapp/visitorsapp_controller.go</a></p>
<p>The Reconcile function returns <code>two</code> objects: a ReconcileResult instance and an error.
有几种可能:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> reconcile.Result&#123;&#125;, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">return</span> reconcile.Result&#123;&#125;, err</span><br><span class="line"><span class="keyword">return</span> reconcile.Result&#123;Requeue: <span class="literal">true</span>&#125;, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">return</span> reconcile.Result&#123;RequeueAfter: time.Second*<span class="number">5</span>&#125;, <span class="literal">nil</span></span><br></pre></td></tr></table></figure>
<p>Since Go-based Operators make heavy use of the Go Kubernetes libraries, it may be useful to review:
<a href="https://pkg.go.dev/k8s.io/api" target="_blank" rel="noopener">https://pkg.go.dev/k8s.io/api</a>
the <code>core/v1</code> and <code>apps/v1</code> modules are frequently used to interact with the common Kubernetes resources.</p>
<p>这里提到了update status value，应该对应的是resource yaml中底部的status 信息:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">instance.Status.BackendImage = <span class="string">"example"</span></span><br><span class="line">err := r.client.Status().Update(context.TODO(), instance)</span><br></pre></td></tr></table></figure>
<p>如同我在这章开头提到的，作者将不同resource的逻辑分开到不同的go file了，可以仔细观察怎么写的.</p>
<p><strong>关于Child resource deletion:</strong>
If the child resource’s owner type is correctly set to the primary resource, when the parent is deleted, Kubernetes garbage collection will automatically clean up all of its child resources</p>
<p>It is important to understand that when Kubernetes deletes a resource, it still calls the Reconcile function.</p>
<p>There are times, however, where specific cleanup logic is required. The approach in such instances is to block the deletion of the primary resource through the use of a <code>finalizer</code>. A finalizer is simply a series of strings on a resource, 感觉就是一个mark.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">finalizer := <span class="string">"visitors.example.com"</span></span><br><span class="line"></span><br><span class="line">beingDeleted := instance.GetDeletionTimestamp() != <span class="literal">nil</span></span><br><span class="line"><span class="keyword">if</span> beingDeleted &#123;</span><br><span class="line">    <span class="keyword">if</span> contains(instance.GetFinalizers(), finalizer) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Perform finalization logic. If this fails, leave the finalizer</span></span><br><span class="line">        <span class="comment">// intact and requeue the reconcile request to attempt the clean</span></span><br><span class="line">        <span class="comment">// up again without allowing Kubernetes to actually delete</span></span><br><span class="line">        <span class="comment">// the resource.</span></span><br><span class="line"></span><br><span class="line">        instance.SetFinalizers(remove(instance.GetFinalizers(), finalizer))</span><br><span class="line">        err := r.client.Update(context.TODO(), instance)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> reconcile.Result&#123;&#125;, err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> reconcile.Result&#123;&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Idempotency">Idempotency</h2>
<p>It is critical that Operators are idempotent. Multiple calls to reconcile an unchanged resource must produce the same effect each time.</p>
<ol>
<li>
<p>Before creating child resources, check to see if they already exist. Remember, Kubernetes may call the reconcile loop for a variety of reasons beyond when a user first creates a CR. Your controller should not duplicate the CR’s children on each iteration through the loop.</p>
</li>
<li>
<p>Changes to a resource’s spec (in other words, its configuration values) trigger the reconcile loop. Therefore, it is often not enough to simply check for the existence of expected child resources. The Operator also needs to verify that the child resource configuration matches what is defined in the parent resource at the time of reconciliation.</p>
</li>
<li>
<p>Reconciliation is not necessarily called for each change to the resource. It is possible that a single reconciliation may contain multiple changes. The Operator must be careful to ensure the entire state of the CR is represented by all of its child resources.</p>
</li>
<li>
<p>Just because an Operator does not need to make changes during a reconciliation request doesn’t mean it doesn’t need to update the CR’s Status field. Depending on what values are captured in the CR’s status, it may make sense to update these even if the Operator determines it doesn’t need to make any changes to the existing resources.</p>
</li>
</ol>
<h2 id="Operator-Impact">Operator Impact</h2>
<p>If the Operator incorrectly handles operations, they can negatively affect the performance of the entire cluster.</p>
<h2 id="Test-Operator-2">Test Operator</h2>
<blockquote>
<p>如果operator test有错误，则image build之后运行也会出现同样的错误！</p>
</blockquote>
<p>The process running the Operator may be outside of the cluster, but Kubernetes will treat it as it does any other controller.</p>
<p>Go to the root project directory:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## deploy CRD</span></span><br><span class="line">kubectl apply -f deploy/crds/*_crd.yaml</span><br><span class="line"><span class="comment">## start operator in local mode</span></span><br><span class="line">operator-sdk up <span class="built_in">local</span> --namespace default</span><br><span class="line"><span class="comment">## deploy CR</span></span><br><span class="line">kubectl apply -f deploy/crds/*_cr.yaml</span><br></pre></td></tr></table></figure>
<p>The Operator SDK uses credentials from the kubectl configuration file to connect to the cluster and attach the Operator. The running process acts as if it were an Operator pod running inside of the cluster and writes logging information to standard output.</p>
<h1>Chapter 8 Operator Lifecycle Manager</h1>
<p>这章节概念性的东西较多，建议多读几遍。
<code>OLM</code> git repo:
<a href="https://github.com/operator-framework/operator-lifecycle-manager" target="_blank" rel="noopener">https://github.com/operator-framework/operator-lifecycle-manager</a></p>
<p>Once you have written an Operator, it’s time to turn your attention to its installation and management. As there are multiple steps involved in deploying an Operator, a management layer becomes necessary to facilitate the process. 就是管理Operator的东西.</p>
<p><code>OLM</code>’s benefits extend beyond installation into Day 2 operations, including managing upgrades to existing Operators, providing a means to convey Operator stability through version channels, and the ability to aggregate multiple Operator hosting sources into a single interface. OLM在Openshift 上是自带的，K8s上没有。OLM也是通过CRD实现的，在Openshift 中run <code>oc get crd</code> 就可以看到相关CRDs.</p>
<ol>
<li>ClusterServiceVersion
You can think of a CSV as analogous to a Linux package, such as a Red Hat Package Manager (RPM) file.</li>
</ol>
<p>Much like how a deployment describes the “pod template” for the pods it creates, a CSV contains a “deployment template” for the deployment of the Operator pod.</p>
<ol start="2">
<li>CatalogSource
A CatalogSource contains information for accessing a repository of Operators. OLM provides a utility API named packagemanifests for querying catalog sources, which provides a list of Operators and the catalogs in which they are found.</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n olm get packagemanifests</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>Subscription
End users create a subscription to install, and subsequently update, the Operators that OLM provides. A subscription is made to a <code>channel</code>, which is a stream of Operator versions, such as “stable” or “nightly.”</li>
</ol>
<p>To continue with the earlier analogy to Linux packages, a subscription is equivalent to a command that installs a package, such as yum install.</p>
<ol start="4">
<li>
<p>InstallPlan
A subscription creates an InstallPlan, which describes the full list of resources that OLM will create to satisfy the CSV’s resource requirements.</p>
</li>
<li>
<p>OperatorGroup
An Operator belonging to an OperatorGroup will not react to custom resource changes in a namespace not indicated by the group.</p>
</li>
</ol>
<h2 id="Installing-OLM">Installing OLM</h2>
<p>version <code>v0.11.0</code>, 我用的k8s <code>v1.13.2</code>，最近的版本不兼容了
<a href="https://github.com/operator-framework/operator-lifecycle-manager/releases" target="_blank" rel="noopener">https://github.com/operator-framework/operator-lifecycle-manager/releases</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/operator-framework/operator-lifecycle-manager/releases/download/0.11.0/crds.yaml</span><br><span class="line">kubectl apply -f https://github.com/operator-framework/operator-lifecycle-manager/releases/download/0.11.0/olm.yaml</span><br></pre></td></tr></table></figure>
<p>After applying, The CRDs for OLM are created, the olm pods are up and running in <code>olm</code> namespace. OLM可以用于和<code>OperatorHub.io</code> 进行交互，如同Helm 和HelmHub, Docker 和DockerHub. 书中用了个例子说明如何部署etcd operator from operatorHub.</p>
<p>后面主要是讲如何publish自己的operator了, 目前用不到。</p>
<h1>Chapter 9 Operator Philosophy</h1>
<p>Let’s try to connect those tactics to the strategic ideas that underpin them to understand an existential question: what are Operators for?</p>
<p>An Operator reduces human intervention bugs by automating the regular chores that keep its application running. <code>Operators: Kubernetes Application Reliability Engineering</code></p>
<p>有些启发价值:
You can build Operators that not only run and upgrade an application, but respond to errors or slowing performance.</p>
<p>Control loops in Kubernetes watch resources and react when they don’t match some desired state. Operators let you customize a control loop for resources that represent your application. The first Operator concerns are usually automatic deployment and self-service provisioning of the operand. Beyond that first level of the maturity model, an Operator should know its application’s critical state and how to repair it. The Operator can then be extended to observe key application metrics and act to tune, repair, or report on them.</p>
<p>Site Reliability Engineering lists the <code>four golden signals</code> as <code>latency</code>, <code>traffic</code>, <code>errors</code>, and <code>saturation</code>.</p>
<p>Highly Successful Operators:</p>
<ol>
<li>An Operator should run as a single Kubernetes deployment.</li>
<li>Operators should define new custom resource types on the cluster.</li>
<li>Operators should use appropriate Kubernetes abstractions whenever possible.</li>
<li>Operator termination should not affect the operand.</li>
<li>Operator termination should not affect the operand.</li>
<li>Operator termination should not affect the operand.</li>
<li>Operators should be thoroughly tested, including chaos testing.</li>
</ol>
<h1>Appendix</h1>
<h2 id="Running-an-Operator-as-a-Deployment-Inside-a-Cluster">Running an Operator as a Deployment Inside a Cluster</h2>
<p>Please see my git repo for more details.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## build operator image</span></span><br><span class="line"><span class="comment">## go to project root directory</span></span><br><span class="line">operator-sdk build image:tag</span><br></pre></td></tr></table></figure>
<p>Then docker push image to docker registry, replace the image placeholder in <code>operator.yaml</code> file. Then apply the CR yaml.</p>
<p>书中另外2个appendix 是关于CRD validation and RBAC control的设置。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/book/" rel="tag"># book</a>
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
            <a href="/tags/operator/" rel="tag"># operator</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/02/pipeline-jenkins-git-checkin/" rel="next" title="Jenkins Git Check in">
                <i class="fa fa-chevron-left"></i> Jenkins Git Check in
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/04/car-insurance/" rel="prev" title="Car Insurance">
                Car Insurance <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">270</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">43</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">152</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Chapter 1 Introduction</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Chapter 2 Running Operators</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Chapter 3 Operators at the Kubernetes Interface</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">Chapter 4 The Operator Framework</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">Chapter 5 Sample Application: Visitors Site</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">Chapter 6 Adapter Operators</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm-Operator"><span class="nav-number">6.1.</span> <span class="nav-text">Helm Operator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#New-Chart"><span class="nav-number">6.1.1.</span> <span class="nav-text">New Chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Existing-Chart"><span class="nav-number">6.1.2.</span> <span class="nav-text">Existing Chart</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible-Operator"><span class="nav-number">6.2.</span> <span class="nav-text">Ansible Operator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Test-Operator"><span class="nav-number">6.3.</span> <span class="nav-text">Test Operator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deploy-Operator"><span class="nav-number">6.4.</span> <span class="nav-text">Deploy Operator</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">7.</span> <span class="nav-text">Chapter 7 Operators in Go with the Operator SDK</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-Go-Based-Operator"><span class="nav-number">7.1.</span> <span class="nav-text">Create Go Based Operator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Add-CRDs"><span class="nav-number">7.2.</span> <span class="nav-text">Add CRDs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Write-Control-Logic"><span class="nav-number">7.3.</span> <span class="nav-text">Write Control Logic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Idempotency"><span class="nav-number">7.4.</span> <span class="nav-text">Idempotency</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Operator-Impact"><span class="nav-number">7.5.</span> <span class="nav-text">Operator Impact</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Test-Operator-2"><span class="nav-number">7.6.</span> <span class="nav-text">Test Operator</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">8.</span> <span class="nav-text">Chapter 8 Operator Lifecycle Manager</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Installing-OLM"><span class="nav-number">8.1.</span> <span class="nav-text">Installing OLM</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">9.</span> <span class="nav-text">Chapter 9 Operator Philosophy</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">10.</span> <span class="nav-text">Appendix</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Running-an-Operator-as-a-Deployment-Inside-a-Cluster"><span class="nav-number">10.1.</span> <span class="nav-text">Running an Operator as a Deployment Inside a Cluster</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>





  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
