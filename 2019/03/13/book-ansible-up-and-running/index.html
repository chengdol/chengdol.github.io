<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="这本书其实挺不错的，我还总结了在工作中ansible的常用模块在另一个blog里面。 Could we remove major architectural components from the IT automation stack? Eliminating management daemons and relying instead on OpenSSH meant the system c">
<meta name="keywords" content="ansible,book">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible Up and Running, 2nd Edition">
<meta property="og:url" content="http://yoursite.com/2019/03/13/book-ansible-up-and-running/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="这本书其实挺不错的，我还总结了在工作中ansible的常用模块在另一个blog里面。 Could we remove major architectural components from the IT automation stack? Eliminating management daemons and relying instead on OpenSSH meant the system c">
<meta property="og:locale" content="中文|English">
<meta property="og:updated_time" content="2020-12-15T07:36:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ansible Up and Running, 2nd Edition">
<meta name="twitter:description" content="这本书其实挺不错的，我还总结了在工作中ansible的常用模块在另一个blog里面。 Could we remove major architectural components from the IT automation stack? Eliminating management daemons and relying instead on OpenSSH meant the system c">






  <link rel="canonical" href="http://yoursite.com/2019/03/13/book-ansible-up-and-running/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Ansible Up and Running, 2nd Edition | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">158</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">47</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">287</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/13/book-ansible-up-and-running/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Ansible Up and Running, 2nd Edition

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-03-13 00:04:25" itemprop="dateCreated datePublished" datetime="2019-03-13T00:04:25-07:00">2019-03-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-12-14 23:36:49" itemprop="dateModified" datetime="2020-12-14T23:36:49-08:00">2020-12-14</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Book/" itemprop="url" rel="index"><span itemprop="name">Book</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这本书其实挺不错的，我还总结了在工作中ansible的常用模块在另一个blog里面。</p>
<p>Could we remove major architectural components from the IT automation stack? Eliminating management daemons and relying instead on OpenSSH meant the system could start managing a computer fleet immediately, without having to set up anything on the managed machines.</p>
<p>the “Making Ansible Go Even Faster” chapter now covers asynchronous tasks, and the “Debugging Ansible Playbooks” chapter now covers the debugger that was introduced in version 2.1.</p>
<p>we are all slowly turning into system engineers.</p>
<h1>Chapter 1. Introduction</h1>
<p>When we talk about configuration management, we are typically talking about writing some kind of state description for our servers, and then using a tool to enforce that the servers are, indeed, in that state: the right packages are installed, configuration files contain the expected values and have the expected permissions, the right services are running, and so on.</p>
<p>Ansible is a great tool for deployment as well as configuration management. Using a single tool for both configuration management and deployment makes life simpler for the folks responsible for operations.</p>
<p>Some people talk about the need for <em>orchestration</em> of deployment. This is where multiple remote servers are involved, and things have to happen in a specific order.</p>
<h2 id="How-Ansible-works">How Ansible works</h2>
<p>In Ansible, a script is called a playbook. A playbook describes which hosts (what Ansible calls remote servers) to configure, and an ordered list of tasks to perform on those hosts.</p>
<p>Ansible will make SSH connections in parallel to web1, web2, and web3. It will execute the first task on the list on all three hosts simultaneously</p>
<p>To manage a remote server with Ansible, the server needs to have SSH and Python 2.5 or later installed, or Python 2.4 with the Python <code>simplejsonlibrary</code> installed. There’s no need to preinstall an agent or anyother software on the host.</p>
<p>The control machine (the one that you use to control remote machines) needs to have Python 2.6 or later installed.</p>
<p>Ansible is <strong>push based</strong>, and has been used successfully in production with thousands of nodes, and has excellent support for environments where servers are dynamically added and removed.</p>
<p>Ansible modules are declarative; you use them to describe the state you want the server to be in. Modules are also idempotent.</p>
<p>Ansible has excellent support for templating, as well as defining variables at different scopes. Anybody who thinks Ansible is equivalent to working with shell scripts has never had to maintain a nontrivial program written in shell. I’ll always choose Ansible over shell scripts for config management tasks if given a choice.</p>
<p>To be productive with Ansible, you need to be familiar with basic Linux system administration tasks. Ansible makes it easy to automate your tasks, but it’s not the kind of tool that “automagically” does things that you otherwise wouldn’t know how to do.</p>
<p>Ansible uses the YAML file format and the Jinja2 templating languages, so you’ll need to learn some YAML and Jinja2 to use Ansible, but both technologies are easy to pick up.</p>
<p>If you prefer not to spend the money on a public cloud, I recommend you install Vagrant on your machine. Vagrant is an excellent open source tool for managing virtual machines. You can use Vagrant to boot a Linux virtual machine inside your laptop, and you can use that as a test server.</p>
<p>Vagrant needs the VirtualBox virtualizer to be installed on your machine. Download <a href="http://www.virtualbox.org/" target="_blank" rel="noopener">VirtualBox</a> and then download <a href="http://www.vagrantup.com/" target="_blank" rel="noopener">Vagrant</a>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir playbooks</span><br><span class="line">cd playbooks</span><br><span class="line">vagrant init ubuntu/trusty64</span><br><span class="line">vagrant up</span><br></pre></td></tr></table></figure>
<p>The first time you use vagrant up, it will download the virtual machine image file, which might take a while, depending on your internet connection.</p>
<p>You should be able to SSH into your new Ubuntu 14.04 virtual machine by running the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant ssh</span><br></pre></td></tr></table></figure>
<p>This approach lets us interact with the shell, but Ansible needs to connect to the virtual machine by using the regular SSH client, not the vagrant ssh command.</p>
<p>Tell Vagrant to output the SSH connection details by typing the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant ssh-config</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh vagrant@127.0.0.1 -p 2222 -i /Users/lorin/dev/ansiblebook/ch01/</span><br><span class="line">playbooks/.vagrant/machines/default/virtualbox/private_key</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testserver ansible_host=127.0.0.1 ansible_port=2222 ansible_user=vagrant ansible_private_key_file=.vagrant/machines/default/virtualbox/private_key</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/.ansible.cfg</span><br></pre></td></tr></table></figure>
<p>Ansible supports the ssh-agent program, so you don’t need to explicitly specify SSH key files in your inventory files. See <a href="https://learning.oreilly.com/library/view/Ansible:+Up+and+Running,+2nd+Edition/9781491979792/app01.html#SSH_AGENT" target="_blank" rel="noopener">“SSH Agent”</a> for more details if you haven’t used ssh-agent before</p>
<p>If Ansible did not succeed, add the <code>-vvvv</code> flag to see more details about the error:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible testserver -i hosts -m ping -vvvv</span><br></pre></td></tr></table></figure>
<h2 id="Simplify-by-ansible-cfg-file">Simplify by <em>ansible.cfg</em> file</h2>
<p>we’ll use one such mechanism, the <code>ansible.cfg</code> file, to set some defaults so we don’t need to type as much.</p>
<p>Ansible looks for an <code>ansible.cfg</code> file in the following places, in this order:</p>
<ul>
<li>File specified by the ANSIBLE_CONFIG environment variable</li>
<li>./ansible.cfg (ansible.cfg in the current directory)</li>
<li>~/.ansible.cfg (.ansible.cfg in your home directory)</li>
<li>/etc/ansible/ansible.cfg</li>
</ul>
<p>I typically put <em>ansible.cfg</em> in the current directory, alongside my playbooks. That way, I can check it into the same version-control repository that my playbooks are in.</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="attr">inventory</span> = hosts</span><br><span class="line"><span class="attr">remote_user</span> = vagrant</span><br><span class="line"><span class="attr">private_key_file</span> = .vagrant/machines/default/virtualbox/private_key</span><br><span class="line"><span class="attr">host_key_checking</span> = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p>Disables SSH host-key checking. Otherwise, we need to edit our <em>~/.ssh/known_hosts</em> file every time we destroy and re-create a nodes.</p>
<p>Ansible uses <code>/etc/ansible/hosts</code> as the default location for the inventory file. However, I never use this because I like to keep my inventory files version-controlled alongside my playbooks.</p>
<p>The <code>command</code> module is so commonly used that it’s the default module, so we can omit it</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ansible testserver -a uptime</span><br><span class="line"><span class="comment">## spaces in command use quotes</span></span><br><span class="line">ansible testserver -a <span class="string">"tail /var/log/dmesg"</span></span><br><span class="line"><span class="comment">## -b becomes root user</span></span><br><span class="line">ansible testserver -b -a <span class="string">"tail /var/log/syslog"</span></span><br></pre></td></tr></table></figure>
<h1>Chapter 2. Playbooks: A Beginning</h1>
<p>Most of your time in Ansible will be spent writing <em>playbooks</em>. A playbook is the term that Ansible uses for a configuration management script.</p>
<p>vargant virtual machine ports mapping in <em>vagrantfile</em>:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VAGRANTFILE_API_VERSION = <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line">Vagrant.configure(VAGRANTFILE_API_VERSION) <span class="keyword">do</span> <span class="params">|config|</span></span><br><span class="line">  config.vm.box = <span class="string">"ubuntu/trusty64"</span></span><br><span class="line">  config.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">80</span>, <span class="symbol">host:</span> <span class="number">8080</span></span><br><span class="line">  config.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">443</span>, <span class="symbol">host:</span> <span class="number">8443</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vagrant reload</span><br><span class="line"></span><br><span class="line">==&gt; default: Forwarding ports...</span><br><span class="line">    default: 80 =&gt; 8080 (adapter 1)</span><br><span class="line">    default: 443 =&gt; 8443 (adapter 1)</span><br><span class="line">    default: 22 =&gt; 2222 (adapter 1)</span><br></pre></td></tr></table></figure>
<h2 id="TLS-VERSUS-SSL">TLS VERSUS SSL</h2>
<p>You might be familiar with the term <em>SSL</em> rather than <em>TLS</em>(Transport Layer Security) in the context of secure web servers. SSL is an older protocol that was used to secure communications between browsers and web servers, and it has been superseded by a newer protocol named TLS. Although many continue to use the term <em>SSL</em> to refer to the current secure protocol, in this book, I use the more accurate <em>TLS</em>.</p>
<h2 id="WHY-DO-YOU-USE-TRUE-IN-ONE-PLACE-AND-YES-IN-ANOTHER">WHY DO YOU USE TRUE IN ONE PLACE AND YES IN ANOTHER?</h2>
<p>Strictly speaking, module arguments (for example, update_cache=yes) are treated differently from values elsewhere in playbooks (for example, sudo: True). Values elsewhere are handled by the YAML parser and so use the YAML conventions of truthiness:</p>
<p>YAML truthy</p>
<blockquote>
<p>true, True, TRUE, yes, Yes, YES, on, On, ON, y, Y</p>
</blockquote>
<p>YAML falsey</p>
<blockquote>
<p>false, False, FALSE, no, No, NO, off, Off, OFF, n, N</p>
</blockquote>
<p>Module arguments are passed as strings and use Ansible’s internal conventions:</p>
<p>module arg truthy</p>
<blockquote>
<p>yes, on, 1, true</p>
</blockquote>
<p>module arg falsey</p>
<blockquote>
<p>no, off, 0, false</p>
</blockquote>
<p>I tend to follow the examples in the official Ansible documentation. These typically use yes and no when passing arguments to modules (since that’s consistent with the module documentation), and True and False elsewhere in playbooks.</p>
<h2 id="NOTE">NOTE</h2>
<p>An Ansible convention is to keep files in a subdirectory named <em>files</em>, and Jinja2 templates in a subdirectory named <em>templates</em>. I follow this convention throughout the book.</p>
<p>For <code>.j2</code> file, when Ansible renders this template, it will replace this variable with the real value.</p>
<p>Inventory files are in the <code>.ini</code> file format.</p>
<h2 id="COWSAY"><a href="https://michaelheap.com/cowsay-and-ansible/" target="_blank" rel="noopener">COWSAY</a></h2>
<p>If you have the <em>cowsay</em> program installed on your local machine, Ansible output will look like this instead:</p>
<p>you can download <em>cowsay</em> rpm and install it:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cowsay -l</span><br><span class="line"></span><br><span class="line">Cow files in /usr/share/cowsay:</span><br><span class="line">beavis.zen blowfish bong bud-frogs bunny cheese cower default dragon</span><br><span class="line">dragon-and-cow elephant elephant-in-snake eyes flaming-sheep ghostbusters</span><br><span class="line">head-in hellokitty kiss kitty koala kosh luke-koala mech-and-cow meow milk</span><br><span class="line">moofasa moose mutilated ren satanic sheep skeleton small sodomized</span><br><span class="line">stegosaurus stimpy supermilker surgery telebears three-eyes turkey turtle</span><br><span class="line">tux udder vader vader-koala www</span><br></pre></td></tr></table></figure>
<p>set what animal you like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ANSIBLE_COW_SELECTION=tux</span><br></pre></td></tr></table></figure>
<p>enable cowsay:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ANSIBLE_NOCOWS=0</span><br></pre></td></tr></table></figure>
<p>then if you run playbook:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt; PLAY [Configure webserver with nginx] &gt;</span><br><span class="line"> ---------------------------------------</span><br><span class="line">        \   ^__^</span><br><span class="line">         \  (oo)\_______</span><br><span class="line">            (__)\       )\/\</span><br><span class="line">                ||----w |</span><br><span class="line">                ||     ||</span><br></pre></td></tr></table></figure>
<p>If you don’t want to see the cows, you can disable cowsay by setting the <code>ANSIBLE_NOCOWS</code> environment variable like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ANSIBLE_NOCOWS=1</span><br></pre></td></tr></table></figure>
<p>You can also disable cowsay by adding the following to your <em>ansible.cfg</em> file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">nocows = 1</span><br></pre></td></tr></table></figure>
<h2 id="TIP">TIP</h2>
<p>If your playbook file is marked as executable and starts with a line that looks like this</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env ansible-playbook</span><br></pre></td></tr></table></figure>
<p>then you can execute it by invoking it directly, like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./playbook-file.yml</span><br></pre></td></tr></table></figure>
<h2 id="YAML-syntax">YAML syntax</h2>
<h3 id="Start-of-file">Start of file</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---</span><br></pre></td></tr></table></figure>
<p>However, if you forget to put those three dashes at the top of your playbook files, Ansible won’t complain.</p>
<h3 id="String">String</h3>
<p>In general, YAML strings don’t have to be quoted, although you can quote them if you prefer. Even if there are spaces, you don’t need to quote them.</p>
<p>In some scenarios in Ansible, you will need to quote strings. These typically involve the use of  for variable substitution.</p>
<h3 id="Boolean">Boolean</h3>
<p>YAML has a native Boolean type, and provides you with a wide variety of strings that can be interpreted as true or false.</p>
<h3 id="List">List</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- My Fair Lady</span><br><span class="line">- Oklahoma</span><br><span class="line">- The Pirates of Penzance</span><br></pre></td></tr></table></figure>
<h3 id="Dictionary">Dictionary</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">address: 742 Evergreen Terrace</span><br><span class="line">city: Springfield</span><br><span class="line">state: North Takoma</span><br></pre></td></tr></table></figure>
<h3 id="Line-folding">Line folding</h3>
<p>When writing playbooks, you’ll often encounter situations where you’re passing many arguments to a module. For aesthetics, you might want to break this up across multiple lines in your file, but you want Ansible to treat the string as if it were a single line.</p>
<p>You can do this with YAML by using line folding with the greater than (<code>&gt;</code>) character. The YAML parser will replace line breaks with spaces. For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">address: &gt;</span><br><span class="line">    Department of Computer Science,</span><br><span class="line">    A.V. Williams Building,</span><br><span class="line">    University of Maryland</span><br><span class="line">city: College Park</span><br><span class="line">state: Maryland</span><br></pre></td></tr></table></figure>
<h2 id="Anatomy-of-a-Playbook"><a href="https://learning.oreilly.com/library/view/ansible-up-and/9781491979792/ch02.html#playbooks_a_beginning" target="_blank" rel="noopener">Anatomy of a Playbook</a></h2>
<p>A playbook is a list of plays:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name: Configure webserver with nginx</span><br><span class="line">  hosts: webservers</span><br><span class="line">  become: True</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install nginx</span><br><span class="line">      apt: name=nginx update_cache=yes</span><br><span class="line"></span><br><span class="line">  - name: copy nginx config file</span><br><span class="line">    copy: src=files/nginx.conf dest=/etc/nginx/sites-available/default</span><br><span class="line"></span><br><span class="line">  - name: enable configuration</span><br><span class="line">    file: &gt;</span><br><span class="line">      dest=/etc/nginx/sites-enabled/default</span><br><span class="line">      src=/etc/nginx/sites-available/default</span><br><span class="line">      state=link</span><br><span class="line"></span><br><span class="line">  - name: copy index.html</span><br><span class="line">    template: src=templates/index.html.j2  dest=/usr/share/nginx/html/index.html mode=0644</span><br><span class="line"></span><br><span class="line">  - name: restart nginx</span><br><span class="line">    service: name=nginx state=restarted</span><br></pre></td></tr></table></figure>
<p>you’ll see in <a href="https://learning.oreilly.com/library/view/ansible-up-and/9781491979792/ch16.html#DEBUGGING" target="_blank" rel="noopener">Chapter 16</a>, you can use the <code>--start-at-task &lt;task name&gt;</code> flag to tell <code>ansible-playbook</code> to start a playbook in the middle of a play, but you need to reference the task by name.</p>
<p>Every task must contain a key with the name of a module and a value with the arguments to that module. In the preceding example, the module name is <code>apt</code> and the arguments are <code>name=nginx update_cache=yes</code>.</p>
<p>The arguments are treated as a string, not as a dictionary. This means that if you want to break arguments into multiple lines, you need to use the YAML folding syntax, like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: install nginx</span><br><span class="line">  apt: &gt;</span><br><span class="line">      name=nginx</span><br><span class="line">      update_cache=yes</span><br></pre></td></tr></table></figure>
<p>Ansible also supports a task syntax that will let you specify module arguments as a YAML dictionary, which is helpful when using modules that support complex arguments. For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- name: Install docker</span><br><span class="line">  any_errors_fatal: true</span><br><span class="line">  yum:</span><br><span class="line">    name: docker-ce</span><br><span class="line">    state: present</span><br><span class="line">    enablerepo: docker-local</span><br></pre></td></tr></table></figure>
<h2 id="Modules">Modules</h2>
<p>Modules are scripts that come packaged with Ansible and perform some kind of action on a host.</p>
<p>commonly used modules:</p>
<ul>
<li>yum</li>
<li>copy</li>
<li>file</li>
<li>service</li>
<li>template</li>
</ul>
<h3 id="VIEWING-ANSIBLE-MODULE-DOCUMENTATION">VIEWING ANSIBLE MODULE DOCUMENTATION</h3>
<p>Ansible ships with the <code>ansible-doc</code> command-line tool, which shows documentation about modules. Think of it as man pages for Ansible modules.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc yum</span><br></pre></td></tr></table></figure>
<p>Recall from the first chapter that Ansible executes a task on a host by generating a custom script based on the module name and arguments, and then copies this script to the host and runs it.</p>
<p>More than 200 modules ship with Ansible, and this number grows with every release. You can also find third-party Ansible modules out there, or write your own.</p>
<h2 id="Putting-It-All-Together">Putting It All Together</h2>
<p>To sum up, a playbook contains one or more plays. A play associates an unordered set of hosts with an ordered list of tasks. Each task is associated with exactly one module.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">+-------------+</span>         <span class="string">+------------+</span>          <span class="string">+-------------+</span></span><br><span class="line"><span class="string">|             |     +---&gt;            |      +---&gt;             |</span></span><br><span class="line"><span class="string">|  playbook   +---------&gt;    play    +----------&gt;    hosts    |</span></span><br><span class="line"><span class="string">|             |     +---&gt;            |      +---&gt;             |</span></span><br><span class="line"><span class="string">+-------------+         +------+-----+          +-------------+</span></span><br><span class="line"><span class="string">                               |</span></span><br><span class="line"><span class="string">                               |</span></span><br><span class="line"><span class="string">                               |</span></span><br><span class="line"><span class="string">                             +---+</span></span><br><span class="line"><span class="string">                             | | |</span></span><br><span class="line"><span class="string">                        +----v-v-v----+         +-------------+</span></span><br><span class="line"><span class="string">                        |             |         |             |</span></span><br><span class="line"><span class="string">                        |   task      +--------&gt;+   module    |</span></span><br><span class="line"><span class="string">                        |             |         |             |</span></span><br><span class="line"><span class="string">                        +-------------+         +-------------+</span></span><br></pre></td></tr></table></figure>
<h2 id="Did-Anything-Change-Tracking-Host-State">Did Anything Change? Tracking Host State</h2>
<p>Ansible modules will first check to see whether the state of the host needs to be changed before taking any action. If the state of the host matches the arguments of the module, Ansible takes no action on the host and responds with a state of <code>ok</code>.</p>
<p>Ansible’s detection of state change can be used to trigger additional actions through the use of <em>handlers</em>. But, even without using handlers, it is still a useful form of feedback to see whether your hosts are changing state as the playbook runs.</p>
<h2 id="Variables-and-Handlers">Variables and Handlers</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- name: Configure webserver with nginx and tls</span><br><span class="line">  hosts: webservers</span><br><span class="line">  become: True</span><br><span class="line">  vars:</span><br><span class="line">    key_file: /etc/nginx/ssl/nginx.key</span><br><span class="line">    cert_file: /etc/nginx/ssl/nginx.crt</span><br><span class="line">    conf_file: /etc/nginx/sites-available/default</span><br><span class="line">    server_name: localhost</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install nginx</span><br><span class="line">      apt: name=nginx update_cache=yes cache_valid_time=3600</span><br><span class="line"></span><br><span class="line">    - name: create directories for ssl certificates</span><br><span class="line">      file: path=/etc/nginx/ssl state=directory</span><br><span class="line"></span><br><span class="line">    - name: copy TLS key</span><br><span class="line">      copy: src=files/nginx.key dest=&#123;&#123; key_file &#125;&#125; owner=root mode=0600</span><br><span class="line">      notify: restart nginx</span><br><span class="line"></span><br><span class="line">    - name: copy TLS certificate</span><br><span class="line">      copy: src=files/nginx.crt dest=&#123;&#123; cert_file &#125;&#125;</span><br><span class="line">      notify: restart nginx</span><br><span class="line"></span><br><span class="line">    - name: copy nginx config file</span><br><span class="line">      template: src=templates/nginx.conf.j2 dest=&#123;&#123; conf_file &#125;&#125;</span><br><span class="line">      notify: restart nginx</span><br><span class="line"></span><br><span class="line">    - name: enable configuration</span><br><span class="line">      file: dest=/etc/nginx/sites-enabled/default src=&#123;&#123; conf_file &#125;&#125; state=link</span><br><span class="line">      notify: restart nginx</span><br><span class="line"></span><br><span class="line">    - name: copy index.html</span><br><span class="line">      template: src=templates/index.html.j2 dest=/usr/share/nginx/html/index.html</span><br><span class="line">             mode=0644</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart nginx</span><br><span class="line">      service: name=nginx state=restarted</span><br></pre></td></tr></table></figure>
<h3 id="Generating-a-TLS-Certificate">Generating a TLS Certificate</h3>
<p>In a production environment, you’d purchase your TLS certificate from a certificate authority, or use a free service such as <a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let’s Encrypt</a>, which Ansible supports via the letsencrypt module.</p>
<p>Here we use self-signed certificate generated free of charge:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir files</span><br><span class="line">openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \</span><br><span class="line">    -subj /CN=localhost \</span><br><span class="line">    -keyout files/nginx.key -out files/nginx.crt</span><br></pre></td></tr></table></figure>
<p>Any valid YAML can be used as the value of a variable. You can use lists and dictionaries in addition to strings and Booleans.</p>
<h3 id="Variables">Variables</h3>
<p>Variables can be used in tasks, as well as in template files. You reference variables by using the <code></code> notation. Ansible replaces these braces with the value of the variable.</p>
<h3 id="WHEN-QUOTING-IS-NECESSARY">WHEN QUOTING IS NECESSARY</h3>
<p>bad:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: perform some task</span><br><span class="line">  command: &#123;&#123; myapp &#125;&#125; -a foo</span><br></pre></td></tr></table></figure>
<p>good:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: perform some task</span><br><span class="line">  command: &quot;&#123;&#123; myapp &#125;&#125; -a foo&quot;</span><br></pre></td></tr></table></figure>
<p>A similar problem arises if your argument contains a colon. For example, bad:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: show a debug message</span><br><span class="line">  debug: msg=&quot;The debug module will print a message: neat, eh?&quot;</span><br></pre></td></tr></table></figure>
<p>good:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: show a debug message</span><br><span class="line">  debug: &quot;msg=&apos;The debug module will print a message: neat, eh?&apos;&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Generating-the-Template">Generating the Template</h2>
<p>We put templates in <code>templates</code> folder, we use the <code>.j2</code> extension to indicate that the file is a Jinja2 template. However, you can use a different extension if you like; Ansible doesn’t care.</p>
<p>You can use all of the Jinja2 features in your templates, you probably won’t need to use those advanced templating features, though. One Jinja2 feature you probably will use with Ansible is filters: <a href="http://jinja.pocoo.org/docs/dev/templates/" target="_blank" rel="noopener">Jinja2 Template Designer Documentation</a>.</p>
<h3 id="Handlers">Handlers</h3>
<p>Handlers are one of the conditional forms that Ansible supports. A handler is similar to a task, but it runs only if it has been notified by a task. A task will fire the notification if Ansible recognizes that the task has changed the state of the system. A task notifies a handler by passing the handler’s name as the argument.</p>
<h3 id="A-FEW-THINGS-TO-KEEP-IN-MIND-ABOUT-HANDLERS">A FEW THINGS TO KEEP IN MIND ABOUT HANDLERS</h3>
<p>Handlers usually run after all of the tasks are run at the end of the <em>play</em>. They run only <em>once</em>, even if they are notified multiple times. If a play contains multiple handlers, the handlers always run in the order that they are <em>defined</em> in the handlers section, not the notification order.</p>
<p>The official Ansible docs mention that the only common uses for handlers are for restarting services and for reboots. Personally, I’ve always used them only for restarting services.Even then, it’s a pretty small optimization, since we can always just unconditionally restart the service at the end of the playbook instead of notifying it on change, and restarting a service doesn’t usually take very long.</p>
<h1>Chapter 3. Inventory: Describing Your Servers</h1>
<p>The collection of hosts that Ansible knows about is called the inventory. In this chapter, you will learn how to describe a set of hosts as an Ansible inventory.</p>
<p>Ansible automatically adds one host to the inventory by default: <em>localhost</em>. Ansible understands that localhost refers to your local machine, so it will interact with it directly rather than connecting by SSH.</p>
<h2 id="Preliminaries-Multiple-Vagrant-Machines">Preliminaries: Multiple Vagrant Machines</h2>
<p>Before you modify your existing Vagrantfile, make sure you destroy your existing virtual machine by running the following:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vagrant destroy --force</span><br></pre></td></tr></table></figure>
<p><em>vagrantfile</em> for three servers:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">VAGRANTFILE_API_VERSION = <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line">Vagrant.configure(VAGRANTFILE_API_VERSION) <span class="keyword">do</span> <span class="params">|config|</span></span><br><span class="line">  <span class="comment"># Use the same key for each machine</span></span><br><span class="line">  config.ssh.insert_key = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  config.vm.define <span class="string">"vagrant1"</span> <span class="keyword">do</span> <span class="params">|vagrant1|</span></span><br><span class="line">    vagrant1.vm.box = <span class="string">"ubuntu/trusty64"</span></span><br><span class="line">    vagrant1.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">80</span>, <span class="symbol">host:</span> <span class="number">8080</span></span><br><span class="line">    vagrant1.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">443</span>, <span class="symbol">host:</span> <span class="number">8443</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  config.vm.define <span class="string">"vagrant2"</span> <span class="keyword">do</span> <span class="params">|vagrant2|</span></span><br><span class="line">    vagrant2.vm.box = <span class="string">"ubuntu/trusty64"</span></span><br><span class="line">    vagrant2.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">80</span>, <span class="symbol">host:</span> <span class="number">8081</span></span><br><span class="line">    vagrant2.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">443</span>, <span class="symbol">host:</span> <span class="number">8444</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  config.vm.define <span class="string">"vagrant3"</span> <span class="keyword">do</span> <span class="params">|vagrant3|</span></span><br><span class="line">    vagrant3.vm.box = <span class="string">"ubuntu/trusty64"</span></span><br><span class="line">    vagrant3.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">80</span>, <span class="symbol">host:</span> <span class="number">8082</span></span><br><span class="line">    vagrant3.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">443</span>, <span class="symbol">host:</span> <span class="number">8445</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Using the same key on each host simplifies our Ansible setup because we can specify a single SSH key in the <em>ansible.cfg</em> file:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="attr">inventory</span> = inventory</span><br><span class="line"><span class="attr">remote_user</span> = vagrant</span><br><span class="line"><span class="attr">private_key_file</span> = ~/.vagrant.d/insecure_private_key</span><br><span class="line"><span class="attr">host_key_checking</span> = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p>In the inventory file, you can use <code>ansible_host</code> to explicitly specify IP and <code>ansible_port</code> indicates SSH port number:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vagrant1 ansible_host=127.0.0.1 ansible_port=2222</span><br><span class="line">vagrant2 ansible_host=127.0.0.1 ansible_port=2200</span><br><span class="line">vagrant3 ansible_host=127.0.0.1 ansible_port=2201</span><br></pre></td></tr></table></figure>
<h2 id="Behavioral-Inventory-Parameters">Behavioral Inventory Parameters</h2>
<p><a href="https://www.tablesgenerator.com/markdown_tables" target="_blank" rel="noopener">Markdown table generator</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">|            Name            	|     Default     	|                                   Description                                   	|</span><br><span class="line">|:--------------------------:	|:---------------:	|:-------------------------------------------------------------------------------:	|</span><br><span class="line">| ansible_host               	| Name of host    	| Hostname or IP address to SSH to                                                	|</span><br><span class="line">| ansible_port               	| 22              	| Port to SSH to                                                                  	|</span><br><span class="line">| ansible_user               	| Root            	| User to SSH as                                                                  	|</span><br><span class="line">| ansible_password           	| (None)          	| Password to use for SSH authentication                                          	|</span><br><span class="line">| ansible_connection         	| smart           	| How Ansible will connect to host (see the following section)                    	|</span><br><span class="line">| ansible_private_key_file   	| (None)          	| SSH private key to use for SSH authenticatio                                    	|</span><br><span class="line">| ansible_shell_type         	| sh              	| Shell to use for commands (see the following section)                           	|</span><br><span class="line">| ansible_python_interpreter 	| /usr/bin/python 	| Python interpreter on host (see the following section)                          	|</span><br><span class="line">| ansible_*_interpreter      	| (None)          	| Like ansible_python_interpreter for other languages (see the following section) 	|</span><br></pre></td></tr></table></figure>
<p>Explanation:</p>
<ul>
<li>
<p>ansible_connection
Ansible supports multiple <em>transports</em>, which are mechanisms that Ansible uses to connect to the host. The default transport, <code>smart</code>, will check whether the locally installed SSH client supports a feature called <em>ControlPersist</em>. If the SSH client supports ControlPersist, Ansible will use the local SSH client. If the SSH client doesn’t support ControlPersist, the smart transport will fall back to using a Python-based SSH client library called <em>Paramiko</em>.</p>
</li>
<li>
<p>ansible_shell_type
Ansible works by making SSH connections to remote machines and then invoking scripts. By default, Ansible assumes that the remote shell is the Bourne shell located at <em>/bin/sh</em>, and will generate the appropriate command-line parameters that work with Bourne shell.</p>
<p>Ansible also accepts <code>csh</code>, <code>fish</code>, and (on Windows) <code>powershell</code> as valid values for
this parameter. I’ve never encountered a need for changing the shell type.</p>
</li>
<li>
<p>ansible_python_interpreter
Because the modules that ship with Ansible are implemented in Python 2, Ansible needs to know the location of the Python interpreter on the remote machine. You might need to change this if your remote host does not have a Python 2 interpreter at <em>/usr/bin/python</em>. For example, if you are managing hosts that run Arch Linux, you will need to change this to <em>/usr/bin/python2</em>, because Arch Linux installs Python 3 at <em>/usr/bin/python</em>, and Ansible modules are not (yet) compatible with Python 3.</p>
</li>
<li>
<p>ansible_*_interpreter
If you are using a custom module that is not written in Python, you can use this parameter to specify the location of the interpreter (e.g., /usr/bin/ruby).</p>
</li>
</ul>
<p><strong>Note</strong>: You can override some of the behavioral parameter default values in the defaults section of the <code>ansible.cfg</code> file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">| Behavioral inventory parameter 	| ansible.cfg option 	|</span><br><span class="line">|:------------------------------:	|:------------------:	|</span><br><span class="line">| ansible_port                   	| remote_port        	|</span><br><span class="line">| ansible_user                   	| remote_user        	|</span><br><span class="line">| ansible_private_key_file       	| private_key_file   	|</span><br><span class="line">| ansible_shell_type             	| executable         	|</span><br></pre></td></tr></table></figure>
<h2 id="Groups">Groups</h2>
<p>Ansible automatically defines a group called <code>all</code> (or <code>*</code>), which includes all of the hosts in the inventory. For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible all -a &quot;date&quot;</span><br><span class="line">ansible &apos;*&apos; -a &quot;date&quot;</span><br></pre></td></tr></table></figure>
<p>We can define our own groups in the inventory file. Ansible uses the <em>.ini</em> file format for inventory files. In the <em>.ini</em> format, configuration values are grouped together into sections. For example:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[master]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[workers]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[nodes]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[all:vars]</span></span><br><span class="line"><span class="attr">ansible_connection</span>=ssh</span><br><span class="line"><span class="attr">ansible_user</span>=root</span><br><span class="line"><span class="attr">ansible_ssh_private_key_file</span>=null</span><br><span class="line"><span class="attr">gather_facts</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">gathering</span>=smart</span><br><span class="line"><span class="attr">host_key_checking</span>=<span class="literal">False</span></span><br></pre></td></tr></table></figure>
<h2 id="Alias-and-Ports">Alias and Ports:</h2>
<p>In inventory file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[master]</span><br><span class="line">&lt;hostname&gt;</span><br><span class="line">&lt;hostname&gt;:&lt;port number&gt;</span><br><span class="line">&lt;alias&gt; ansible_host=&lt;IP&gt; ansible_port=&lt;port number&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Groups-of-groups">Groups of groups</h2>
<p>Ansible also allows you to define groups that are made up of other groups. Here web and task are groups, diango subgroup wrap them up.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[django:children]</span><br><span class="line">web</span><br><span class="line">task</span><br></pre></td></tr></table></figure>
<h2 id="Numbered-hosts">Numbered hosts</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[host]</span><br><span class="line">web[1:20].example.com</span><br><span class="line">## leading 0</span><br><span class="line">web[01:20].example.com</span><br><span class="line">web-[a-t].example.com</span><br></pre></td></tr></table></figure>
<h2 id="Host-and-Group-Variables">Host and Group Variables</h2>
<p>Format: [<group name="">:vars]</group></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[all:vars]</span><br><span class="line"></span><br><span class="line">[production:vars]</span><br><span class="line"></span><br><span class="line">[staging:vars]</span><br></pre></td></tr></table></figure>
<p>Additionally, though Ansible variables can hold Booleans, strings, lists, and dictionaries, in an inventory file, you can specify only Booleans and strings.</p>
<p>Ansible offers a more scalable approach to keep track of host and group variables: you can create a separate variable file for each host and each group. Ansible expects these variable files to be in YAML format.</p>
<p>Ansible looks for host variable files in a directory called <code>host_vars</code> and group variable files in a directory called <code>group_vars</code>. Ansible expects these directories to be either in the directory that contains your playbooks or in the directory adjacent to your inventory file. For example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">playbooks</span> <span class="attr">folder:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">playbook.yml</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">group_vars</span> <span class="string">folder</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">production</span></span><br></pre></td></tr></table></figure>
<p>If we use YAML dictionary format in group variable file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db:</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">widgetuser</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">pFmMxcyD;Fc6)6</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">widget_production</span></span><br><span class="line"><span class="attr">    primary:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">rhodeisland.example.com</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">5432</span></span><br><span class="line"><span class="attr">    replica:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">virginia.example.com</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">5432</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">pennsylvania.example.com</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">5672</span></span><br></pre></td></tr></table></figure>
<p>when reference in playbook:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; db.primary.host &#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Dynamic-Inventory">Dynamic Inventory</h2>
<p>If the inventory file is marked executable, Ansible will assume it is a dynamic inventory script and will execute the file instead of reading it.</p>
<p>If some other system, such as AWS EC2, will keep track of the virtual machine information for us, we don’t necessarily need to write the inventory file manually, we can use dynamic inventory script to query about which machines are running and use them.</p>
<p><a href="https://github.com/ansible/ansible/blob/devel/contrib/inventory/vagrant.py" target="_blank" rel="noopener">preexisting inventory scripts</a></p>
<h2 id="Adding-Entries-at-Runtime-with-add-host-and-group-by">Adding Entries at Runtime with add_host and group_by</h2>
<p>Ansible will let you add hosts and groups to the inventory during the execution of a playbook.
<strong>not use yet</strong></p>
<h1>Chapter 4. Variables and Facts</h1>
<p>Ansible is not a full-fledged programming language, but it does have several programming language features, and one of the most important of these is <strong>variable substitution</strong>. This chapter presents Ansible’s support for variables in more detail, including a certain type of variable that Ansible calls a <em>fact</em>.</p>
<h2 id="Defining-Variables-in-Playbooks">Defining Variables in Playbooks</h2>
<p>There are two scenarios, for example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Configure</span> <span class="string">Kubeadm</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  any_errors_fatal:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    NODE_COUNT:</span> <span class="string">"<span class="template-variable">&#123;&#123; groups['nodes'] | length &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">setup.master</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## or</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Configure</span> <span class="string">Kubeadm</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  any_errors_fatal:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  vars_files:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">config.yml</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">setup.master</span></span><br></pre></td></tr></table></figure>
<h2 id="Viewing-the-Values-of-Variables">Viewing the Values of Variables</h2>
<p>We use the <code>debug</code> module to print out an arbitrary message. We can also use it to output the value of the variable.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- debug: var=&lt;myvarname&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Registering-Variables">Registering Variables</h2>
<p>Often, you’ll find that you need to set the value of a variable based on the result of a <a href="http://task.To" target="_blank" rel="noopener">task.To</a> do so, we create a <em>registered variable</em> using the <code>register</code> clause when invoking a module. Below shows how to capture the output of the <code>whoami</code> command to a variable named <code>login</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: capture output of whoami command</span><br><span class="line">  command: whoami</span><br><span class="line">  register: login</span><br></pre></td></tr></table></figure>
<p><strong>Note</strong>, if you want to use <code>login</code> variable registered here, it’s not like that you can call it as <code></code></p>
<p>In order to use the login variable later, we need to know the type of value to expect. The value of a variable set using the register clause is always a dictionary, but the specific keys of the dictionary are different, depending on the module that was invoked.</p>
<p>Unfortunately, the official Ansible module documentation doesn’t contain information about what the return values look like for each module. The module docs do often contain examples that use the register clause, which can be helpful. I’ve found the simplest way to find out what a module returns is to register a variable and then output that variable with the debug module.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: show return value of command module</span><br><span class="line">  hosts: server1</span><br><span class="line">  tasks:</span><br><span class="line">    - name: capture output of id command</span><br><span class="line">      command: id -un</span><br><span class="line">      register: login</span><br><span class="line">    - debug: var=login</span><br></pre></td></tr></table></figure>
<p>The <code>shell</code> module has the same output structure as the <code>command</code> module, but other modules contain different keys, the output here is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">TASK: [debug var=login] *******************************************************</span><br><span class="line">ok: [server1] =&gt; &#123;</span><br><span class="line">    &quot;login&quot;: &#123;</span><br><span class="line">        &quot;changed&quot;: true, 1</span><br><span class="line">        &quot;cmd&quot;: [ 2</span><br><span class="line">            &quot;id&quot;,</span><br><span class="line">            &quot;-un&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;delta&quot;: &quot;0:00:00.002180&quot;,</span><br><span class="line">        &quot;end&quot;: &quot;2015-01-11 15:57:19.193699&quot;,</span><br><span class="line">        &quot;invocation&quot;: &#123;</span><br><span class="line">            &quot;module_args&quot;: &quot;id -un&quot;,</span><br><span class="line">            &quot;module_name&quot;: &quot;command&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;rc&quot;: 0, 3</span><br><span class="line">        &quot;start&quot;: &quot;2015-01-11 15:57:19.191519&quot;,</span><br><span class="line">        &quot;stderr&quot;: &quot;&quot;, 4</span><br><span class="line">        &quot;stdout&quot;: &quot;vagrant&quot;, 5</span><br><span class="line">        &quot;stdout_lines&quot;: [ 6</span><br><span class="line">            &quot;vagrant&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;warnings&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>The <code>changed</code> key is present in the return value of all Ansible modules, and Ansible uses it to determine whether a state change has occurred. For the <code>command</code> and <code>shell</code>module, this will always be set to <code>true</code> unless overridden with the <code>changed_when</code>clause.</p>
</li>
<li>
<p>The <code>cmd</code> key contains the invoked command as a list of strings.</p>
</li>
<li>
<p>The <code>rc</code> key contains the return code. If it is nonzero, Ansible will assume the task failed to execute.</p>
</li>
<li>
<p>The <code>stdout</code> key contains any text written to standard out, as a single string.</p>
</li>
<li>
<p>The <code>stdout_lines</code> key contains any text written to split by newline. It is a list, and each element of the list is a line of output.</p>
</li>
</ul>
<p>So now you can access <code>login</code> with:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: capture output of id command</span><br><span class="line">  command: id -un</span><br><span class="line">  register: login</span><br><span class="line">- debug: msg=&quot;Logged in as user &#123;&#123; login.stdout &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="ACCESSING-DICTIONARY-KEYS-IN-A-VARIABLE">ACCESSING DICTIONARY KEYS IN A VARIABLE</h3>
<p>If a variable contains a dictionary, you can access the keys of the dictionary by using either a dot (.) or a subscript ([]).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; login.stdout &#125;&#125;</span><br><span class="line">&#123;&#123; login[&apos;stdout&apos;] &#125;&#125;</span><br><span class="line"></span><br><span class="line">ansible_eth1[&apos;ipv4&apos;][&apos;address&apos;]</span><br><span class="line">ansible_eth1[&apos;ipv4&apos;].address</span><br><span class="line">ansible_eth1.ipv4[&apos;address&apos;]</span><br><span class="line">ansible_eth1.ipv4.address</span><br></pre></td></tr></table></figure>
<h3 id="CAUTION">CAUTION</h3>
<p>If your playbooks use registered variables, make sure you know the content of those variables, both for cases where the module changes the host’s state and for when the module doesn’t change the host’s state. Otherwise, your playbook might fail when it tries to access a key in a registered variable that doesn’t exist.</p>
<h2 id="Facts">Facts</h2>
<p>As you’ve already seen, when Ansible runs a playbook, before the first task runs, this happens:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GATHERING FACTS **************************************************</span><br><span class="line">ok: [servername]</span><br></pre></td></tr></table></figure>
<p>When Ansible gathers facts, it connects to the host and queries it for all kinds of details about the host: CPU architecture, operating system, IP addresses, memory info, disk info, and more. This information is stored in variables that are called <em>facts</em>, and they behave just like any other variable. For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: print out operating system</span><br><span class="line">  hosts: all</span><br><span class="line">  gather_facts: True</span><br><span class="line">  tasks:</span><br><span class="line">  - debug: var=ansible_distribution</span><br></pre></td></tr></table></figure>
<p>List of facts variable can be found <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#information-discovered-from-systems-facts" target="_blank" rel="noopener">here</a></p>
<h3 id="Viewing-All-Facts-Associated-with-a-Server">Viewing All Facts Associated with a Server</h3>
<p>Ansible implements fact collecting through the use of a special module called the <code>setup</code>module. You don’t need to call this module in your playbooks because Ansible does that automatically when it gathers facts.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible server1 -m setup</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server1 | success &gt;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_all_ipv4_addresses&quot;: [</span><br><span class="line">            &quot;10.0.2.15&quot;,</span><br><span class="line">            &quot;192.168.4.10&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;ansible_all_ipv6_addresses&quot;: [</span><br><span class="line">            &quot;fe80::a00:27ff:fefe:1e4d&quot;,</span><br><span class="line">            &quot;fe80::a00:27ff:fe67:bbf3&quot;</span><br><span class="line">        ],</span><br><span class="line">(many more facts)</span><br></pre></td></tr></table></figure>
<p>Note that the returned value is a dictionary whose key is <code>ansible_facts</code> and whose value is a dictionary that contains the name and value of the actual facts.</p>
<h3 id="Viewing-a-Subset-of-Facts">Viewing a Subset of Facts</h3>
<p>The <code>setup</code> module supports a <code>filter</code> parameter that lets you filter by fact name by specifying a glob.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible web -m setup -a &apos;filter=ansible_eth*&apos;</span><br></pre></td></tr></table></figure>
<h3 id="Any-Module-Can-Return-Facts">Any Module Can Return Facts</h3>
<p>The use of <code>ansible_facts</code> in the return value is an Ansible idiom. If a module returns a dictionary that contains <code>ansible_facts</code> as a key, Ansible will create variable names in the environment with those values and associate them with the active host.</p>
<p>For modules that return facts, there’s no need to register variables, since Ansible creates these variables for you automatically.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: get ec2 facts</span><br><span class="line">  ec2_facts:</span><br><span class="line"></span><br><span class="line">- debug: var=ansible_ec2_instance_id</span><br></pre></td></tr></table></figure>
<p>Several modules ship with Ansible that return facts. You’ll see another one of them, the <code>docker</code> module.</p>
<h3 id="Local-Facts">Local Facts</h3>
<p>Ansible provides an additional mechanism for associating facts with a host. You can place one or more files on the remote host machine in the <code>/etc/ansible/facts.d</code> directory.
<strong>not used yet</strong></p>
<h3 id="Using-set-fact-to-Define-a-New-Variable">Using set_fact to Define a New Variable</h3>
<p>Ansible also allows you to set a fact (effectively the same as defining a new variable) in a task by using the <code>set_fact</code> module. I often like to use <code>set_fact</code> immediately after <code>register</code> to make it simpler to refer to a variable.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- name: get snapshot id</span><br><span class="line">  shell: &gt;</span><br><span class="line">    aws ec2 describe-snapshots --filters</span><br><span class="line">    Name=tag:Name,Values=my-snapshot</span><br><span class="line">    | jq --raw-output &quot;.Snapshots[].SnapshotId&quot;</span><br><span class="line">  register: snap_result</span><br><span class="line"></span><br><span class="line">- set_fact: snap=&#123;&#123; snap_result.stdout &#125;&#125;</span><br><span class="line"></span><br><span class="line">- name: delete old snapshot</span><br><span class="line">  command: aws ec2 delete-snapshot --snapshot-id &quot;&#123;&#123; snap &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Built-in-Variables">Built-in Variables</h2>
<p>Ansible defines several variables that are always available in a playbook</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">| Parameter                	| Description                                                                                                                                                                                 	|</span><br><span class="line">|--------------------------	|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	|</span><br><span class="line">| hostvars                 	| A dict whose keys are Ansible hostnames and values are dicts  that map variable names to values                                                                                             	|</span><br><span class="line">| inventory_hostname       	| Fully qualified domain name of the current host as known by Ansible  (e.g., myhost.example.com)                                                                                             	|</span><br><span class="line">| inventory_hostname_short 	| Name of the current host as known by Ansible, without the domain name  (e.g., myhost)                                                                                                       	|</span><br><span class="line">| group_names              	| A list of all groups that the current host is a member of                                                                                                                                   	|</span><br><span class="line">| groups                   	| A dict whose keys are Ansible group names and values are a list of  hostnames that are members of the group. Includes all and ungrouped groups:  &#123;&quot;all&quot;: […], &quot;web&quot;: […], &quot;ungrouped&quot;: […]&#125; 	|</span><br><span class="line">| ansible_check_mode       	| A boolean that is true when running in check mode                                                                                                                                           	|</span><br><span class="line">| ansible_play_batch       	| A list of the inventory hostnames that are active in the current batch                                                                                                                      	|</span><br><span class="line">| ansible_play_hosts       	| A list of all of the inventory hostnames that are active in the current  play                                                                                                               	|</span><br><span class="line">| ansible_version          	| A dict with Ansible version info:  &#123;&quot;full&quot;: 2.3.1.0&quot;, &quot;major&quot;: 2, &quot;minor&quot;: 3, &quot;revision&quot;: 1, &quot;string&quot;: &quot;2.3.1.0&quot;&#125;                                                                           	|</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>hostvars</strong>
This is a dictionary that contains all of the variables defined on all of the hosts, keyed by the hostname as known to Ansible. If Ansible has not yet gathered facts on a host, you will not be able to access its facts by using the hostvars variable, unless fact caching is enabled.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; hostvars[&apos;db.example.com&apos;].ansible_eth1.ipv4.address &#125;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>inventory_hostname</strong>
The inventory_hostname is the hostname of the current host, as known by Ansible.</p>
</li>
<li>
<p><strong>groups</strong>
The groups variable can be useful when you need to access variables for a group of hosts.</p>
</li>
</ul>
<p>I encounter this in playbook vars section:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- name: xxx</span><br><span class="line">  hosts: master</span><br><span class="line">  become: true</span><br><span class="line">  any_errors_fatal: true</span><br><span class="line">  vars:</span><br><span class="line">    NODE_COUNT: &quot;&#123;&#123; groups[&apos;nodes&apos;] | length &#125;&#125;&quot;</span><br><span class="line">  roles:</span><br><span class="line">    - ...</span><br><span class="line"></span><br><span class="line">- name: xxx</span><br><span class="line">  any_errors_fatal: true</span><br><span class="line">  shell: &quot;...&quot;</span><br><span class="line">  when: &quot;inventory_hostname == groups.master[0]&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Setting-Variables-on-the-Command-Line">Setting Variables on the Command Line</h2>
<p>Variables set by passing <code>-e var=value</code> to <code>ansible-playbook</code> have the highest precedence, which means you can use this to override variables that are already defined.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook greet.yml -e &apos;greeting=&quot;hi there&quot;&apos;</span><br></pre></td></tr></table></figure>
<p>Ansible also allows you to pass a file containing the variables instead of passing them directly on the command line by passing @filename.yml as the argument to <code>-e</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook greet.yml -e @greetvars.yml</span><br></pre></td></tr></table></figure>
<p>content in <code>greetvars.yml</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">greeting: hiya</span><br></pre></td></tr></table></figure>
<h2 id="Precedence">Precedence</h2>
<p>We’ve covered several ways of defining variables, and it can happen that you define the same variable multiple times for a host, using different values. Avoid this when you can, but if you can’t, then keep in mind Ansible’s precedence rules.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1. (Highest) ansible-playbook -e var=value</span><br><span class="line">2. Task variables</span><br><span class="line">3. Block variables</span><br><span class="line">4. Role and include variables</span><br><span class="line">5. set_fact</span><br><span class="line">6. Registered variables</span><br><span class="line">7. vars_files</span><br><span class="line">8. vars_prompt</span><br><span class="line">9. Play variables</span><br><span class="line">10. Host facts</span><br><span class="line">11. host_vars set on a playbook</span><br><span class="line">12. group_vars set on a playbook</span><br><span class="line">13. host_vars set in the inventory</span><br><span class="line">14. group_vars set in the inventory</span><br><span class="line">15. Inventory variables</span><br><span class="line">16. In defaults/main.yml of a role</span><br></pre></td></tr></table></figure>
<h1>Chapter 5. Introducing Mezzanine: Our Test Application</h1>
<p>Let’s take a little detour and talk about the differences between running software in development mode on your laptop versus running the software in production. Mezzanine is a great example of an application that is much easier to run in development mode than it is to deploy.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">virtualenv venv</span><br><span class="line">source venv/bin/activate</span><br><span class="line">pip install mezzanine</span><br><span class="line">mezzanine-project myproject</span><br><span class="line">cd myproject</span><br><span class="line">sed -i &apos;s/ALLOWED_HOSTS = \[\]/ALLOWED_HOSTS = [&quot;127.0.0.1&quot;]/&apos; settings.py</span><br><span class="line">python manage.py createdb</span><br><span class="line">python manage.py runserver</span><br></pre></td></tr></table></figure>
<p>You’ll be prompted to answer several questions. I answered “yes” to each yes/no question, and accepted the default answer whenever one was available.</p>
<p>Now, let’s look at what happens when you deploy to production.</p>
<ul>
<li>
<p><strong>PostgreSQL: The Database</strong>
In production, we want to run a server-based database, because those have better support for multiple, concurrent requests, and server-based databases allow us to run multiple HTTP servers for load balancing. This means we need to deploy a database management system such as MySQL or PostgreSQL (aka Postgres).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Install the database software.</span><br><span class="line">Ensure the database service is running.</span><br><span class="line">Create the database inside the database management system.</span><br><span class="line">Create a database user who has the appropriate permissions for the database system.</span><br><span class="line">Configure our Mezzanine application with the database user credentials and </span><br><span class="line">connection information.</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>Gunicorn: The Application Server</strong></p>
</li>
<li>
<p><strong>Nginx: The Web Server</strong></p>
</li>
</ul>
<blockquote>
<p>Note: Application server and Web server, their usage is different. Here Nginx is like a <a href="https://www.cnblogs.com/Anker/p/6056540.html" target="_blank" rel="noopener">reverse proxy</a> for Gunicorn.</p>
</blockquote>
<ul>
<li><strong>Supervisor: The Process Manager</strong></li>
</ul>
<h1>Chapter 7. Roles: Scaling Up Your Playbooks</h1>
<p>Ansible scales down well because simple tasks are easy to implement. It scales up well because it provides mechanisms for decomposing complex jobs into smaller pieces.</p>
<p>In Ansible, the <code>role</code> is the primary mechanism for breaking a playbook into multiple files. This simplifies writing complex playbooks, and it makes them easier to reuse.</p>
<h2 id="Basic-Structure-of-a-Role">Basic Structure of a Role</h2>
<p>An Ansible role has a name, such as <code>database</code>. Files associated with the <code>database</code> role go in the <em>roles/database</em> directory, which contains the following files and directories:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">| roles/database/tasks/main.yml    	| Tasks                                    	|</span><br><span class="line">| roles/database/files/            	| Holds files to be uploaded to hosts      	|</span><br><span class="line">| roles/database/templates/        	| Holds Jinja2 template files              	|</span><br><span class="line">| roles/database/handlers/main.yml 	| Handlers                                 	|</span><br><span class="line">| roles/database/vars/main.yml     	| Variables that shouldn’t be overridden   	|</span><br><span class="line">| roles/database/defaults/main.yml 	| Default variables that can be overridden 	|</span><br><span class="line">| roles/database/meta/main.yml     	| Dependency information about a role      	|</span><br></pre></td></tr></table></figure>
<p>Each individual file is optional; if your role doesn’t have any handlers, there’s no need to have an empty handlers/main.yml file.</p>
<h2 id="WHERE-DOES-ANSIBLE-LOOK-FOR-MY-ROLES">WHERE DOES ANSIBLE LOOK FOR MY ROLES?</h2>
<p>Ansible looks for roles in the <em>roles</em> directory alongside your playbooks. It also looks for systemwide roles in <em>/etc/ansible/roles</em>. You can customize the systemwide location of roles by setting the <code>roles_path</code> setting in the <code>defaults</code> section of your <em>ansible.cfg</em> file.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">roles_path = ~/ansible_roles</span><br></pre></td></tr></table></figure>
<h2 id="Using-Roles-in-Your-Playbooks">Using Roles in Your Playbooks</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- name: deploy mezzanine on vagrant</span><br><span class="line">  ## target hosts</span><br><span class="line">  hosts: web</span><br><span class="line">  vars_files:</span><br><span class="line">    - secrets.yml</span><br><span class="line">  ## role section</span><br><span class="line">  roles:</span><br><span class="line">    - role: database</span><br><span class="line">       ## pass variables into role task</span><br><span class="line">      database_name: &quot;&#123;&#123; mezzanine_proj_name &#125;&#125;&quot;</span><br><span class="line">      database_user: &quot;&#123;&#123; mezzanine_proj_name &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">    - role: mezzanine</span><br><span class="line">      live_hostname: 192.168.33.10.xip.io</span><br><span class="line">      domains:</span><br><span class="line">        - 192.168.33.10.xip.io</span><br><span class="line">        - www.192.168.33.10.xip.io</span><br></pre></td></tr></table></figure>
<p>Note that we can pass in variables when invoking the roles. If these variables have already been defined in the role (either in vars/main.yml or defaults/main.yml), then the values will be overridden with the variables that were passed in.</p>
<h2 id="Pre-Tasks-and-Post-Tasks">Pre-Tasks and Post-Tasks</h2>
<p>Sometimes you want to run tasks before or after you invoke your roles. Let’s say you want to update the apt cache before you deploy Mezzanine, and you want to send a notification to a Slack channel after you deploy.</p>
<p>Ansible allows you to define a list of tasks that execute before the roles with a <code>pre_tasks</code> section, and a list of tasks that execute after the roles with a <code>post_tasks</code>section.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">deploy</span> <span class="string">mezzanine</span> <span class="string">on</span> <span class="string">vagrant</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">  vars_files:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">secrets.yml</span></span><br><span class="line"><span class="attr">  pre_tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">update</span> <span class="string">the</span> <span class="string">apt</span> <span class="string">cache</span></span><br><span class="line"><span class="attr">      apt:</span> <span class="string">update_cache=yes</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="attr">    - role:</span> <span class="string">mezzanine</span></span><br><span class="line"><span class="attr">  post_tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">notify</span> <span class="string">Slack</span> <span class="string">that</span> <span class="string">the</span> <span class="string">servers</span> <span class="string">have</span> <span class="string">been</span> <span class="string">updated</span></span><br><span class="line"><span class="attr">      local_action:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">        slack</span></span><br><span class="line"><span class="string">        domain=acme.slack.com</span></span><br><span class="line"><span class="string">        token=<span class="template-variable">&#123;&#123; slack_token &#125;&#125;</span></span></span><br><span class="line"><span class="string">        msg="web server <span class="template-variable">&#123;&#123; inventory_hostname &#125;&#125;</span> configured"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: you need to define and put variables in right place, for example, the variables that would be used by multiple roles or playbooks should be put in <code>group_vars/all</code> file.</p>
</blockquote>
<h2 id="WHY-ARE-THERE-TWO-WAYS-TO-DEFINE-VARIABLES-IN-ROLES">WHY ARE THERE TWO WAYS TO DEFINE VARIABLES IN ROLES?</h2>
<p>When Ansible first introduced support for roles, there was only one place to define role variables, in <em>vars/main.yml</em>. Variables defined in this location have a higher precedence than those defined in the <code>vars</code> section of a play, which meant you couldn’t override the variable unless you explicitly passed it as an argument to the role.</p>
<p>Ansible later introduced the notion of default role variables that go in <em>defaults/main.yml</em>.This type of variable is defined in a role, but has a low precedence, so it will be overridden if another variable with the same name is defined in the playbook.</p>
<p>If you think you might want to change the value of a variable in a role, use a default variable. If you don’t want it to change, use a regular variable.</p>
<h2 id="Some-role-practices">Some role practices</h2>
<p><strong>Note</strong> that if for role variables, it’s better to add prefix like <code>&lt;role name&gt;_&lt;var name&gt;</code>. It’s good practice to do this with role variables because Ansible doesn’t have any notion of namespace across roles. This means that variables that are defined in other roles, or elsewhere in a playbook, will be accessible everywhere. This can cause some unexpected behavior if you accidentally use the same variable name in two different roles. For example, for the role called <code>mezzanine</code>, in <code>roles/mezzanine/vars/main.yml</code> file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mezzanine_user: &quot;&#123;&#123; ansible_user &#125;&#125;&quot;</span><br><span class="line">mezzanine_venv_home: &quot;&#123;&#123; ansible_env.HOME &#125;&#125;&quot;</span><br><span class="line">mezzanine_venv_path: &quot;&#123;&#123; mezzanine_venv_home &#125;&#125;/&#123;&#123; mezzanine_proj_name &#125;&#125;&quot;</span><br><span class="line">mezzanine_repo_url: git@github.com:lorin/mezzanine-example.git</span><br><span class="line">mezzanine_proj_dirname: project</span><br></pre></td></tr></table></figure>
<p>For role variables in <em>default/main.yml</em>, no need to add prefix because we may intentionally override them elsewhere.</p>
<p>If the role task is very long, you can break it into several task files, for example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">roles/mezzanine/tasks/django.yml</span><br><span class="line">roles/mezzanine/tasks/main.yml</span><br><span class="line">roles/mezzanine/tasks/nginx.yml</span><br></pre></td></tr></table></figure>
<p>In the <code>main.yml</code> task file you can invoke other tasks by using <code>include</code> statement:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: install apt packages</span><br><span class="line">  apt: pkg=&#123;&#123; item &#125;&#125; update_cache=yes cache_valid_time=3600</span><br><span class="line">  become: True</span><br><span class="line">  with_items:</span><br><span class="line">    - git</span><br><span class="line">    - supervisor</span><br><span class="line"></span><br><span class="line">- include: django.yml</span><br><span class="line">- include: nginx.yml</span><br></pre></td></tr></table></figure>
<p><strong>Note</strong>: there’s one important difference between tasks defined in a role and tasks defined in a regular playbook, and that’s when using the <code>copy</code> or <code>template</code> modules.</p>
<p>When invoking <code>copy</code> in a task defined in a role, Ansible will first check the <em>rolename/files/</em> directory for the location of the file to copy. Similarly, when invoking <code>template</code> in a task defined in a role, Ansible will first check the <em>rolename/templates</em> directory for the location of the template to use.</p>
<p>This means that a task that used to look like this in a playbook:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: set the nginx config file</span><br><span class="line">  template: src=templates/nginx.conf.j2 \</span><br><span class="line">  dest=/etc/nginx/sites-available/mezzanine.conf</span><br></pre></td></tr></table></figure>
<p>now looks like this when invoked from inside the role (note the change of the src parameter):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: set the nginx config file</span><br><span class="line">  template: src=nginx.conf.j2 dest=/etc/nginx/sites-available/mezzanine.conf</span><br><span class="line">  notify: restart nginx</span><br></pre></td></tr></table></figure>
<h2 id="Creating-Role-Files-and-Directories-with-ansible-galaxy">Creating Role Files and Directories with ansible-galaxy</h2>
<p>Ansible ships with another command-line tool we haven’t talked about yet, <code>ansible-galaxy</code>. Its primary purpose is to download roles that have been shared by the Ansible community. But it can also be used to generate <em>scaffolding</em>, an initial set of files and directories involved in a role:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-galaxy init &lt;path&gt;/roles/web</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">└── roles</span><br><span class="line">    └── web</span><br><span class="line">        ├── README.md</span><br><span class="line">        ├── defaults</span><br><span class="line">        │   └── main.yml</span><br><span class="line">        ├── files</span><br><span class="line">        ├── handlers</span><br><span class="line">        │   └── main.yml</span><br><span class="line">        ├── meta</span><br><span class="line">        │   └── main.yml</span><br><span class="line">        ├── tasks</span><br><span class="line">        │   └── main.yml</span><br><span class="line">        ├── templates</span><br><span class="line">        ├── tests</span><br><span class="line">        │   ├── inventory</span><br><span class="line">        │   └── test.yml</span><br><span class="line">        └── vars</span><br><span class="line">            └── main.yml</span><br></pre></td></tr></table></figure>
<h2 id="Dependent-Roles">Dependent Roles</h2>
<p>Ansible supports a feature called <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_roles.html#role-dependencies" target="_blank" rel="noopener">dependent roles</a> to deal with this scenario. When you define a role, you can specify that it depends on one or more other roles. Ansible will ensure that roles that are specified as dependencies are executed first.</p>
<p>Let’s say that we create an<code>ntp</code> role that configures a host to synchronize its time with an NTP server. Ansible allows us to pass parameters to dependent roles, so let’s also assume that we can pass the NTP server as a parameter to that role.</p>
<p>We specify that the <code>web</code> role depends on the <code>ntp</code> role by creating a <em>roles/web/meta/main.yml</em> file and listing <code>ntp</code> as a role, with a parameter:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">    - &#123; role: ntp, ntp_server=ntp.ubuntu.com &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Ansible-Galaxy">Ansible Galaxy</h2>
<p>Whether you want to reuse a role somebody has already written, or you just want to see how someone else solved the problem you’re working on, <a href="https://galaxy.ansible.com/" target="_blank" rel="noopener">Ansible Galaxy</a> can help you out. Ansible Galaxy is an open source repository of Ansible roles contributed by the Ansible community. The roles themselves are stored on GitHub.</p>
<h1>Chapter 8. Complex Playbooks</h1>
<p>This chapter touches on those additional features, which makes it a bit of a grab bag.</p>
<h2 id="Dealing-with-Badly-Behaved-Commands">Dealing with Badly Behaved Commands</h2>
<p>What if we didn’t have a module that could invoke equivalent commands (wasn’t idempotent)? The answer is to use <code>changed_when</code> and <code>failed_when</code> clauses to change how Ansible identifies that a task has changed state or failed.</p>
<p>First, we need to understand the output of this command the first time it’s run, and the output when it’s run the second time.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- name: initialize the database</span><br><span class="line">  django_manage:</span><br><span class="line">    command: createdb --noinput --nodata</span><br><span class="line">    app_path: &quot;&#123;&#123; proj_path &#125;&#125;&quot;</span><br><span class="line">    virtualenv: &quot;&#123;&#123; venv_path &#125;&#125;&quot;</span><br><span class="line">  failed_when: False</span><br><span class="line">  register: result</span><br><span class="line"></span><br><span class="line">- debug: var=result</span><br><span class="line"></span><br><span class="line">- fail:</span><br></pre></td></tr></table></figure>
<p><code>failed_when: False</code> is to close task fail, so ansible play will continue to execute. We can run several times of the playbook and see different register variable output.
<code>fail</code> statement here is to stop the execution.</p>
<p>Some module may not report changed state even though it did make change in target machine, so we can check if state changed ourselves by using <code>changed_when</code> clause:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: initialize the database</span><br><span class="line">  django_manage:</span><br><span class="line">    command: createdb --noinput --nodata</span><br><span class="line">    app_path: &quot;&#123;&#123; proj_path &#125;&#125;&quot;</span><br><span class="line">    virtualenv: &quot;&#123;&#123; venv_path &#125;&#125;&quot;</span><br><span class="line">  register: result</span><br><span class="line">  changed_when: &apos;&quot;Creating tables&quot; in result.out|default(&quot;&quot;)&apos;</span><br></pre></td></tr></table></figure>
<p>We use filter here in <code>changed_when</code> since register variable sometimes doesn’t have <code>out</code> field. Alternatively, we could provide a default value for <code>result.out</code> if it doesn’t exist by using the Jinja2 default filter.</p>
<h2 id="Filter">Filter</h2>
<p><em>Filters</em> are a feature of the Jinja2 templating engine. Since Ansible uses Jinja2 for evaluating variables, as well as for templates, you can use filters inside <code></code> in your playbooks, as well as inside your template files. Using filters resembles using Unix pipes, whereby a variable is piped through a filter. Jinja2 ships with a set of <a href="http://bit.ly/1FvOGzI" target="_blank" rel="noopener">built-in filters</a>. In addition, Ansible ships with its own filters to augment the <a href="http://bit.ly/1FvOIrj" target="_blank" rel="noopener">Jinja2 filters</a>.</p>
<h3 id="The-Default-Filter">The Default Filter</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;HOST&quot;: &quot;&#123;&#123; database_host | default(&apos;localhost&apos;) &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<p>If the variable <code>database_host</code> is defined, the braces will evaluate to the value of that variable. If the variable <code>database_host</code> is not defined, the braces will evaluate to the string localhost.</p>
<h3 id="Filters-for-Registered-Variables">Filters for Registered Variables</h3>
<p>Let’s say we want to run a task and print out its output, even if the task fails. However, if the task does fail, we want Ansible to fail for that host after printing the output.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: Run myprog</span><br><span class="line">  command: /opt/myprog</span><br><span class="line">  register: result</span><br><span class="line">  ignore_errors: True</span><br><span class="line"></span><br><span class="line">- debug: var=result</span><br><span class="line"></span><br><span class="line">- debug: msg=&quot;Stop running the playbook if myprog failed&quot;</span><br><span class="line">  failed_when: result|failed</span><br></pre></td></tr></table></figure>
<p>a list of filters you can use on registered variables to check the status:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">| Name    	| Description                                           	|</span><br><span class="line">|---------	|-------------------------------------------------------	|</span><br><span class="line">| failed  	| True if a registered value is a task that failed      	|</span><br><span class="line">| changed 	| True if a registered value is a task that changed     	|</span><br><span class="line">| success 	| True if a registered value is a task that succeeded   	|</span><br><span class="line">| skipped 	| True if a registered value is a task that was skipped 	|</span><br></pre></td></tr></table></figure>
<p>The basename filter will let us extract the index.html part of the filename from the full path, allowing us to write the playbook without repeating the filename:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vars:</span><br><span class="line">    homepage: /usr/share/nginx/html/index.html</span><br><span class="line">  tasks:</span><br><span class="line">  - name: copy home page</span><br><span class="line">    copy: src=files/&#123;&#123; homepage | basename &#125;&#125; dest=&#123;&#123; homepage &#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Lookups">Lookups</h2>
<p>Sometimes a piece of configuration data you need lives somewhere else. Maybe it’s in a text file or a <em>.csv</em> file, and you don’t want to just copy the data into an Ansible variable file because now you have to maintain two copies of the same data.</p>
<p>Ansible has a feature called <code>lookups</code> that allows you to read in configuration data from various sources and then use that data in your playbooks and template.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">| Name     	| Description                        	|</span><br><span class="line">|----------	|------------------------------------	|</span><br><span class="line">| file     	| Contents of a file                 	|</span><br><span class="line">| password 	| Randomly generate a password       	|</span><br><span class="line">| pipe     	| Output of locally executed command 	|</span><br><span class="line">| env      	| Environment variable               	|</span><br><span class="line">| template 	| Jinja2 template after evaluation   	|</span><br><span class="line">| csvfile  	| Entry in a .csv file               	|</span><br><span class="line">| dnstxt   	| DNS TXT record                     	|</span><br><span class="line">| redis_kv 	| Redis key lookup                   	|</span><br><span class="line">| etcd     	| etcd key lookup                    	|</span><br></pre></td></tr></table></figure>
<p>You can invoke lookups in your playbooks between <code></code>, or you can put them in templates.</p>
<p><strong>Note</strong> all Ansible lookup plugins execute on the control machine, not the remote host.</p>
<h3 id="file">file</h3>
<p>Let’s say you have a text file on your control machine that contains a public SSH key that you want to copy to a remote server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Add my public key as an EC2 key</span><br><span class="line">  ec2_key: name=mykey key_material=&quot;&#123;&#123; lookup(&apos;file&apos;,  &apos;/Users/lorin/.ssh/id_rsa.pub&apos;) &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="pipe">pipe</h3>
<p>The <code>pipe</code> lookup invokes an external program on the control machine and evaluates to the program’s output on standard out.</p>
<p>For example, if our playbooks are version controlled using <code>git</code>, and we want to get the <code>SHA-1</code> value of the most recent <code>git commit</code>, we could use the <code>pipe</code> lookup</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: get SHA of most recent commit</span><br><span class="line">  debug: msg=&quot;&#123;&#123; lookup(&apos;pipe&apos;, &apos;git rev-parse HEAD&apos;) &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TASK: [get the sha of the current commit] *************************************</span><br><span class="line">ok: [myserver] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;e7748af0f040d58d61de1917980a210df419eae9&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="env">env</h3>
<p>The <code>env</code> lookup retrieves the value of an environment variable set on the control machine.For example, we could use the lookup like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: get the current shell</span><br><span class="line">  debug: msg=&quot;&#123;&#123; lookup(&apos;env&apos;, &apos;SHELL&apos;) &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TASK: [get the current shell] *************************************************</span><br><span class="line">ok: [myserver] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;/bin/zsh&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="password">password</h3>
<p>The <code>password</code> lookup evaluates to a random password, and it will also write the password to a file specified in the argument. For example, if we want to create a Postgres user named <code>deploy</code> with a random password and write that password to <em>deploy-password.txt</em>on the control machine, we can do this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: create deploy postgres user</span><br><span class="line">  postgresql_user:</span><br><span class="line">    name: deploy</span><br><span class="line">    password: &quot;&#123;&#123; lookup(&apos;password&apos;, &apos;deploy-password.txt&apos;) &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="template">template</h3>
<p>The <code>template</code> lookup lets you specify a Jinja2 template file, and then returns the result of evaluating the template.</p>
<h3 id="csvfile">csvfile</h3>
<p>The <code>csvfile</code> lookup reads an entry from a <em>.csv</em> file.
For example, we have a <code>users.csv</code> file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username,email</span><br><span class="line">lorin,lorin@ansiblebook.com</span><br><span class="line">john,john@example.com</span><br><span class="line">sue,sue@example.org</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lookup(&apos;csvfile&apos;, &apos;sue file=users.csv delimiter=, col=1&apos;)</span><br></pre></td></tr></table></figure>
<p>In the case of <code>csvfile</code>, the first argument is an entry that must appear exactly once in column 0 (the first column, 0-indexed) of the table.</p>
<p>In our example, we want to look in the file named <code>users.csv</code> and locate where the fields are delimited by commas, look up the row where the value in the first column is <code>sue</code>, and return the value in the second column (column 1, indexed by 0). This evaluates to <a href="mailto:sue@example.org" target="_blank" rel="noopener">sue@example.org</a>.</p>
<h3 id="etcd">etcd</h3>
<p>Etcd is a distributed key-value store, commonly used for keeping configuration data and for implementing service discovery. You can use the <code>etcd</code> lookup to retrieve the value of a key.</p>
<p>For example, let’s say that we have an etcd server running on our control machine, and we set the key weather to the value cloudy by doing something like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L http://127.0.0.1:4001/v2/keys/weather -XPUT -d value=cloudy</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: look up value in etcd</span><br><span class="line">  debug: msg=&quot;&#123;&#123; lookup(&apos;etcd&apos;, &apos;weather&apos;) &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">TASK: [look up value in etcd] *************************************************</span><br><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;cloudy&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>By default, the etcd lookup looks for the etcd server at <a href="http://127.0.0.1:4001" target="_blank" rel="noopener">http://127.0.0.1:4001</a>, but you can change this by setting the <code>ANSIBLE_ETCD_URL</code> environment variable before invoking ansible-playbook.</p>
<h2 id="More-Complicated-Loops">More Complicated Loops</h2>
<p>Up until this point, whenever we’ve written a task that iterates over a list of items, we’ve used the <code>with_items</code> clause to specify a list of items. Although this is the most common way to do loops, Ansible supports other mechanisms for iteration.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">| Name                     	| Input                	| Looping strategy                  	|</span><br><span class="line">|--------------------------	|----------------------	|-----------------------------------	|</span><br><span class="line">| with_items               	| List                 	| Loop over list elements           	|</span><br><span class="line">| with_lines               	| Command to execute   	| Loop over lines in command output 	|</span><br><span class="line">| with_fileglob            	| Glob                 	| Loop over filenames               	|</span><br><span class="line">| with_first_found         	| List of paths        	| First file in input that exists   	|</span><br><span class="line">| with_dict                	| Dictionary           	| Loop over dictionary elements     	|</span><br><span class="line">| with_flattened           	| List of lists        	| Loop over flattened list          	|</span><br><span class="line">| with_indexed_items       	| List                 	| Single iteration                  	|</span><br><span class="line">| with_nested              	| List                 	| Nested loop                       	|</span><br><span class="line">| with_random_choice       	| List                 	| Single iteration                  	|</span><br><span class="line">| with_sequence            	| Sequence of integers 	| Loop over sequence                	|</span><br><span class="line">| with_subelements         	| List of dictionaries 	| Nested loop                       	|</span><br><span class="line">| with_together            	| List of lists        	| Loop over zipped list             	|</span><br><span class="line">| with_inventory_hostnames 	| Host pattern         	| Loop over matching hosts          	|</span><br></pre></td></tr></table></figure>
<p>The <a href="http://bit.ly/1F6kfCP" target="_blank" rel="noopener">official documentation</a> covers these quite thoroughly, so I’ll show examples from just a few of them to give you a sense of how they work.</p>
<h3 id="with-lines">with_lines</h3>
<p>The with_lines looping construct lets you run an arbitrary command on your control machine and iterate over the output, one line at a time. For example, read a file and iterate over its contents line by line.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: Send out a slack message</span><br><span class="line">  slack:</span><br><span class="line">    domain: example.slack.com</span><br><span class="line">    token: &quot;&#123;&#123; slack_token &#125;&#125;&quot;</span><br><span class="line">    msg: &quot;&#123;&#123; item &#125;&#125; was in the list&quot;</span><br><span class="line">  with_lines:</span><br><span class="line">    - cat files/turing.txt</span><br></pre></td></tr></table></figure>
<h3 id="with-fileglob">with_fileglob</h3>
<p>The with_fileglob construct is useful for iterating over a set of files on the control machine.</p>
<p>For example, iterate over files that end in <code>.pub</code> in the /var/keys directory, as well as a keys directory next to your playbook. It then uses the <code>file</code> lookup plugin to extract the contents of the file, which are passed to the authorized_key module.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: add public keys to account</span><br><span class="line">  authorized_key: user=deploy key=&quot;&#123;&#123; lookup(&apos;file&apos;, item) &#125;&#125;&quot;</span><br><span class="line">  with_fileglob:</span><br><span class="line">    - /var/keys/*.pub</span><br><span class="line">    - keys/*.pub</span><br></pre></td></tr></table></figure>
<h3 id="with-dict">with_dict</h3>
<p>The <code>with_dict</code> construct lets you iterate over a dictionary instead of a list. When you use this looping construct, the <code>item</code> loop variable is a dictionary with two fields:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: iterate over ansible_eth0</span><br><span class="line">   debug: msg=&#123;&#123; item.key &#125;&#125;=&#123;&#123; item.value &#125;&#125;</span><br><span class="line">   with_dict: &quot;&#123;&#123; ansible_eth0.ipv4 &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="Looping-Constructs-as-Lookup-Plugins">Looping Constructs as Lookup Plugins</h3>
<p>Ansible implements looping constructs as lookup plugins. That means you can alter the form of lookup to perform as a loop:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: Add my public key as an EC2 key</span><br><span class="line">  ec2_key: name=mykey key_material=&quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">  with_file: /Users/lorin/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure>
<p>Here we prefix <code>with_</code> with <code>file</code> lookup plugin. Typically, you use a lookup plugin as a looping construct only if it returns a list,</p>
<h2 id="Loop-Controls">Loop Controls</h2>
<p>With version 2.1, Ansible provides users with more control over loop handling.</p>
<h3 id="Setting-the-Variable-Name">Setting the Variable Name</h3>
<p>The <code>loop_var</code> control allows us to give the iteration variable a different name than the default name, <code>item</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- user:</span><br><span class="line">    name: &quot;&#123;&#123; user.name &#125;&#125;&quot;</span><br><span class="line">  with_items:</span><br><span class="line">  ## list of dict</span><br><span class="line">    - &#123; name: gil &#125;</span><br><span class="line">    - &#123; name: sarina &#125;</span><br><span class="line">    - &#123; name: leanne &#125;</span><br><span class="line">  loop_control:</span><br><span class="line">    loop_var: user</span><br></pre></td></tr></table></figure>
<p>Next one is a advanced usage, use <code>include</code> with <code>with_items</code>, we loop over multiple task at once, in current task we include a task called <code>vhosts.yml</code> which will be executed 3 times with different parameters passed in:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- name: run a set of tasks in one loop</span><br><span class="line">  include: vhosts.yml</span><br><span class="line">  with_items:</span><br><span class="line">    - &#123; domain: www1.example.com &#125;</span><br><span class="line">    - &#123; domain: www2.example.com &#125;</span><br><span class="line">    - &#123; domain: www3.example.com &#125;</span><br><span class="line">  loop_control:</span><br><span class="line">    loop_var: vhost</span><br></pre></td></tr></table></figure>
<p>The <code>vhosts.yml</code> file that is going to be included may also contain <code>with_items</code> in some tasks. This would produce a conflict, as the default loop_var <code>item</code> is used for both loops at the same time.</p>
<p>To prevent a naming collision, we specify a different name for loop_var in the outer loop.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- name: create nginx directories</span><br><span class="line">  file:</span><br><span class="line">    path: /var/www/html/&#123;&#123; vhost.domain &#125;&#125;/&#123;&#123; item &#125;&#125;</span><br><span class="line">  state: directory</span><br><span class="line">  with_items:</span><br><span class="line">    - logs</span><br><span class="line">    - public_http</span><br><span class="line">    - public_https</span><br><span class="line">    - includes</span><br><span class="line"></span><br><span class="line">- name: create nginx vhost config</span><br><span class="line">  template:</span><br><span class="line">    src: &quot;&#123;&#123; vhost.domain &#125;&#125;.j2&quot;</span><br><span class="line">    dest: /etc/nginx/conf.d/&#123;&#123; vhost.domain &#125;&#125;.conf</span><br></pre></td></tr></table></figure>
<h3 id="Labeling-the-Output">Labeling the Output</h3>
<p>The <code>label</code> control was added in Ansible 2.2 and provides some control over how the loop output will be shown to the user during execution.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- name: create nginx vhost configs</span><br><span class="line">  template:</span><br><span class="line">    src: &quot;&#123;&#123; item.domain &#125;&#125;.conf.j2&quot;</span><br><span class="line">    dest: &quot;/etc/nginx/conf.d/&#123;&#123; item.domain &#125;&#125;.conf&quot;</span><br><span class="line">  with_items:</span><br><span class="line">    - &#123; domain: www1.example.com, ssl_enabled: yes &#125;</span><br><span class="line">    - &#123; domain: www2.example.com &#125;</span><br><span class="line">    - &#123; domain: www3.example.com,</span><br><span class="line">      aliases: [ edge2.www.example.com, eu.www.example.com ] &#125;</span><br><span class="line">  loop_control:</span><br><span class="line">    label: &quot;for domain &#123;&#123; item.domain &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TASK [create nginx vhost configs] **********************************************</span><br><span class="line">ok: [localhost] =&gt; (item=for domain www1.example.com)</span><br><span class="line">ok: [localhost] =&gt; (item=for domain www2.example.com)</span><br><span class="line">ok: [localhost] =&gt; (item=for domain www3.example.com)</span><br></pre></td></tr></table></figure>
<h2 id="Includes">Includes</h2>
<p>The <code>include</code> feature allows you to include tasks or even whole playbooks, depending on where you define an include. It is often used in roles to separate or even group tasks and task arguments to each task in the included file.</p>
<p>For example, you can extract different part of tasks, put them into a separate yml file and include it into another task along with common arguments:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># nginx_include.yml file</span><br><span class="line">- name: install nginx</span><br><span class="line">  package:</span><br><span class="line">    name: nginx</span><br><span class="line"></span><br><span class="line">- name: ensure nginx is running</span><br><span class="line">  service:</span><br><span class="line">    name: nginx</span><br><span class="line">    state: started</span><br><span class="line">    enabled: yes</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- include: nginx_include.yml</span><br><span class="line">  tags: nginx</span><br><span class="line">  become: yes</span><br><span class="line">  when: ansible_os_family == &apos;RedHat&apos;</span><br></pre></td></tr></table></figure>
<p>Ansible <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.html" target="_blank" rel="noopener">Tags</a>: If you have a large playbook, it may become useful to be able to run only a specific part of it rather than running everything in the playbook. Ansible supports a <code>tags:</code> attribute for this reason.</p>
<h3 id="Dynamic-includes">Dynamic includes</h3>
<p>A common pattern in roles is to define tasks specific to a particular operating system into separate task files.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- include: Redhat.yml</span><br><span class="line">  when: ansible_os_family == &apos;Redhat&apos;</span><br><span class="line"></span><br><span class="line">- include: Debian.yml</span><br><span class="line">  when: ansible_os_family == &apos;Debian&apos;</span><br></pre></td></tr></table></figure>
<p>Since version 2.0, Ansible allows us to dynamically include a file by using variable substitution:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- include: &quot;&#123;&#123; ansible_os_family &#125;&#125;.yml&quot;</span><br><span class="line">  static: no</span><br></pre></td></tr></table></figure>
<p>However, there is a drawback to using dynamic includes: <code>ansible-playbook --list-tasks</code> might not list the tasks from a dynamic include if Ansible does not have enough information to populate the variables that determine which file will be included.</p>
<p>You can use <code>ansible-playbook &lt;playbook&gt; --list-tasks</code> to list all the tasks in it.</p>
<h3 id="Role-includes">Role includes</h3>
<p>A special include is the <code>include_role</code> clause. In contrast with the <code>role</code> clause, which will use all parts of the role, the <code>include_role</code> not only allows us to selectively choose what parts of a role will be included and used, but also where in the play.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: install php</span><br><span class="line">  include_role:</span><br><span class="line">    name: php</span><br></pre></td></tr></table></figure>
<p>This will include and run main.yml from the php role, remember a role can have multiple tasks yml files: main.yml and others.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: install php</span><br><span class="line">  include_role:</span><br><span class="line">    name: php</span><br><span class="line">    tasks_from: install</span><br></pre></td></tr></table></figure>
<p>This will include and run install.yml from php role.</p>
<h2 id="Blocks">Blocks</h2>
<p>Much like the <code>include</code> clause, the <code>block</code> clause provides a mechanism for grouping tasks. The <code>block</code> clause allows you to set conditions or arguments for all tasks within a block at once:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- block:</span><br><span class="line">  - name: install nginx</span><br><span class="line">    package:</span><br><span class="line">      name: nginx</span><br><span class="line">  - name: ensure nginx is running</span><br><span class="line">    service:</span><br><span class="line">      name: nginx</span><br><span class="line">      state: started</span><br><span class="line">      enabled: yes</span><br><span class="line">  become: yes</span><br><span class="line">  when: &quot;ansible_os_family == &apos;RedHat&apos;&quot;</span><br></pre></td></tr></table></figure>
<p>The <code>become</code> and <code>when</code> apply for both tasks.</p>
<h3 id="Error-Handling-with-Blocks">Error Handling with Blocks</h3>
<p>Dealing with error scenarios has always been a challenge. Historically, Ansible has been error agnostic in the sense that errors and failures may occur on a host. Ansible’s default error-handling behavior is to take a host out of the play if a task fails and continue as long as there are hosts remaining that haven’t encountered errors.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- block:</span><br><span class="line">  - debug: msg=&quot;You will see a failed tasks right after this&quot;</span><br><span class="line">  - command: /bin/false</span><br><span class="line">  - debug: &quot;You won&apos;t see this message&quot;</span><br><span class="line">  rescue: # Tasks to be executed in case of a failure in block clause</span><br><span class="line">  - debug: &quot;You only see this message in case of an failure in the block&quot;</span><br><span class="line">  always: # Tasks to always be executed</span><br><span class="line">  - debug: &quot;This will be always executed&quot;</span><br></pre></td></tr></table></figure>
<p>If you have some programming experience, the way error handling is implemented may remind you of the <code>try-catch-finally</code> paradigm, and it works much the same way.</p>
<h2 id="Encrypting-Sensitive-Data-with-Vault">Encrypting Sensitive Data with Vault</h2>
<p>Ansible provides an alternative solution: instead of keeping the <code>secrets.yml</code> file out of version control, we can commit an encrypted version. That way, even if our version-control repository were compromised, the attacker would not have access to the contents of the <code>secrets.yml</code> file unless he also had the password used for the encryption.</p>
<p>The <code>ansible-vault</code> command-line tool allows you to create and edit an encrypted file that <code>ansible-playbook</code> will recognize and decrypt automatically, given the password.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-vault create secrets.yml</span><br><span class="line">ansible-vault encrypt secrets.yml</span><br></pre></td></tr></table></figure>
<p>You will be prompted for a password, and then <code>ansible-vault</code> will launch a text editor so that you can populate the file. It launches the editor specified in the <code>$EDITOR</code> environment variable. If that variable is not defined, it defaults to <code>vim</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook &lt;playbook&gt; --ask-vault-pass</span><br><span class="line">ansible-playbook &lt;playbook&gt; --vault-password-file ~/password.txt</span><br></pre></td></tr></table></figure>
<p>If the argument to <code>--vault-password-file</code> has the executable bit set, Ansible will execute it and use the contents of standard out as the vault password. This allows you to use a script to provide the password to Ansible.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">| Command                        	| Description                                       	|</span><br><span class="line">|--------------------------------	|---------------------------------------------------	|</span><br><span class="line">| ansible-vault encrypt file.yml 	| Encrypt the plain-text file.yml file              	|</span><br><span class="line">| ansible-vault decrypt file.yml 	| Decrypt the encrypted file.yml file               	|</span><br><span class="line">| ansible-vault view file.yml    	| Print the contents of the encrypted file.yml file 	|</span><br><span class="line">| ansible-vault create file.yml  	| Create a new encrypted file.yml file              	|</span><br><span class="line">| ansible-vault edit file.yml    	| Edit an encrypted file.yml file                   	|</span><br><span class="line">| ansible-vault rekey file.yml   	| Change the password on an encrypted file.yml file 	|</span><br></pre></td></tr></table></figure>
<h1>Chapter 9. Customizing Hosts, Runs, and Handlers</h1>
<p>In this chapter, we cover Ansible features that provide customization by controlling which hosts to run against, how tasks are run, and how handlers are run.</p>
<h2 id="Patterns-for-Specifying-Hosts">Patterns for Specifying Hosts</h2>
<p>Instead of specifying a single host or group for a play, you can specify a <em>pattern</em>. You’ve already seen the <code>all</code> pattern, which will run a play against all known hosts:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts: all</span><br></pre></td></tr></table></figure>
<p>You can specify a union of two groups with a colon. You specify all dev and staging machines as follows:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts: dev:staging</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">| Action                    	| Example Usage               	|</span><br><span class="line">|---------------------------	|-----------------------------	|</span><br><span class="line">| All hosts                 	| all                         	|</span><br><span class="line">| All hosts                 	| *                           	|</span><br><span class="line">| Union                     	| dev:staging                 	|</span><br><span class="line">| Intersection              	| dev:&amp;database               	|</span><br><span class="line">| Exclusion                 	| dev:!queue                  	|</span><br><span class="line">| Wildcard                  	| *.example.com               	|</span><br><span class="line">| Range of numbered servers 	| web[5:12]                   	|</span><br><span class="line">| Regular expression        	| ~web\d+\.example\.(com|org) 	|</span><br></pre></td></tr></table></figure>
<p>Ansible supports multiple combinations of patterns—for example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts: dev:staging:&amp;database:!queue</span><br></pre></td></tr></table></figure>
<h2 id="Limiting-Which-Hosts-Run">Limiting Which Hosts Run</h2>
<p>Use the <code>-l hosts</code> or <code>--limit hosts</code> flag to tell Ansible to limit the hosts to run the playbook against the specified list of hosts</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -l hosts playbook.yml</span><br><span class="line">ansible-playbook --limit hosts playbook.yml</span><br><span class="line">ansible-playbook -l &apos;staging:&amp;database&apos; playbook.yml</span><br></pre></td></tr></table></figure>
<h2 id="Running-a-Task-on-the-Control-Machine">Running a Task on the Control Machine</h2>
<p>Sometimes you want to run a particular task on the control machine instead of on the remote host. Ansible provides the <code>local_action</code> clause for tasks to support this. For example, when we check the node ready status in k8s cluster.</p>
<p>Imagine that the server we want to install Mezzanine onto has just booted, so that if we run our playbook too soon, it will error out because the server hasn’t fully started up yet. We could start off our playbook by invoking the <code>wait_for</code> module to wait until the SSH server is ready to accept connections before we execute the rest of the playbook.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: wait for ssh server to be running</span><br><span class="line">  local_action: wait_for port=22 host=&quot;&#123;&#123; inventory_hostname &#125;&#125;&quot; search_regex=OpenSSH</span><br></pre></td></tr></table></figure>
<p>Note that <code>inventory_hostname</code> evaluates to the name of the remote host, not <code>localhost</code>. That’s because the scope of these variables is still the remote host, even though the task is executing locally.</p>
<p>If your play involves multiple hosts, and you use <code>local_action</code>, the task will be executed multiple times, one for each host. You can restrict this by using <code>run_once</code></p>
<h2 id="Running-a-Task-on-a-Machine-Other-Than-the-Host">Running a Task on a Machine Other Than the Host</h2>
<p>Sometimes you want to run a task that’s associated with a host, but you want to execute the task on a different server. You can use the <code>delegate_to</code> clause to run the task on a different host.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- name: enable alerts for web servers</span><br><span class="line">  hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: enable alerts</span><br><span class="line">      nagios: action=enable_alerts service=web host=&#123;&#123; inventory_hostname &#125;&#125;</span><br><span class="line">      delegate_to: nagios.example.com</span><br></pre></td></tr></table></figure>
<p>In this example, Ansible would execute the <code>nagios task</code> on <a href="http://nagios.example.com" target="_blank" rel="noopener">nagios.example.com</a>, but the <code>inventory_hostname</code> variable referenced in the play would evaluate to the web host.</p>
<blockquote>
<p>Note: if you specify <code>delegate_to: localhost</code> to control machine, it’s the same as <code>local_action</code>, also the same as <code>connection: local</code></p>
</blockquote>
<h2 id="Running-on-One-Host-at-a-Time">Running on One Host at a Time</h2>
<p>By default, Ansible runs each task in parallel across all hosts. Sometimes you want to run your task on one host at a time. The canonical example is when upgrading application servers that are behind a load balancer. Typically, you take the application server out of the load balancer, upgrade it, and put it back. But you don’t want to take all of your application servers out of the load balancer, or your service will become unavailable.</p>
<p>You can use the <code>serial</code> clause on a play to tell Ansible to restrict the number of hosts that a play runs on.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- name: upgrade packages on servers behind load balancer</span><br><span class="line">  hosts: myhosts</span><br><span class="line">  serial: 1</span><br><span class="line">  tasks:</span><br><span class="line">    - name: get the ec2 instance id and elastic load balancer id</span><br><span class="line">      ec2_facts:</span><br><span class="line"></span><br><span class="line">    - name: take the host out of the elastic load balancer</span><br><span class="line">      local_action: ec2_elb</span><br><span class="line">      args:</span><br><span class="line">        instance_id: &quot;&#123;&#123; ansible_ec2_instance_id &#125;&#125;&quot;</span><br><span class="line">        state: absent</span><br><span class="line"></span><br><span class="line">    - name: upgrade packages</span><br><span class="line">      apt: update_cache=yes upgrade=yes</span><br><span class="line"></span><br><span class="line">    - name: put the host back in the elastic load balancer</span><br><span class="line">      local_action: ec2_elb</span><br><span class="line">      args:</span><br><span class="line">        instance_id: &quot;&#123;&#123; ansible_ec2_instance_id &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">        ec2_elbs: &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">      with_items: ec2_elbs</span><br></pre></td></tr></table></figure>
<p>In our example, we pass 1 as the argument to the serial clause, telling Ansible to run on only one host at a time. If we had passed 2, Ansible would have run two hosts at a time.</p>
<p>Normally, when a task fails, Ansible stops running tasks against the host that fails, <strong>but</strong> continues to run against other hosts. In the load-balancing scenario, you might want Ansible to fail the entire play before all hosts have failed a task. Otherwise, you might end up with the situation where you have taken each host out of the load balancer, and have it fail, leaving no hosts left inside your load balancer.</p>
<p>You can use a <code>max_fail_percentage</code> clause along with the <code>serial</code> clause to specify the maximum percentage of failed hosts before Ansible fails the entire play. For example, assume that we specify a maximum fail percentage of 25%, as shown here:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- name: upgrade packages on servers behind load balancer</span><br><span class="line">  hosts: myhosts</span><br><span class="line">  serial: 1</span><br><span class="line">  max_fail_percentage: 25</span><br><span class="line">  tasks:</span><br><span class="line">    # tasks go here</span><br></pre></td></tr></table></figure>
<p>If you want Ansible to fail if any of the hosts fail a task, set the <code>max_fail_percentage</code> to 0.</p>
<blockquote>
<p>Note: <code>any_errors_fatal: true</code> is just like set <code>max_fail_percentage</code> to 0, with the <code>any_errors_fatal</code> option, any failure on any host in a multi-host play will be treated as fatal and Ansible will exit immediately without waiting for the other hosts.</p>
</blockquote>
<p>We can get even more sophisticated. For example, you might want to run the play on one host first, to verify that the play works as expected, and then run the play on a larger number of hosts in subsequent runs.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: configure CDN servers</span><br><span class="line">  hosts: cdn</span><br><span class="line">  serial:</span><br><span class="line">    - 1</span><br><span class="line">    - 30%</span><br><span class="line">  tasks:</span><br><span class="line">    # tasks go here</span><br></pre></td></tr></table></figure>
<p>In the preceding play with 30 CDN hosts, on the first batch run Ansible would run against one host, and on each subsequent batch run it would run against at most 30% of the hosts (e.g., 1, 10, 10, 9).</p>
<h2 id="Running-Only-Once">Running Only Once</h2>
<p>Using <code>run_once</code> can be particularly useful when using <code>local_action</code> if your playbook involves multiple hosts, and you want to run the local task only once:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: run the task locally, only once</span><br><span class="line">  local_action: command /opt/my-custom-command</span><br><span class="line">  run_once: true</span><br></pre></td></tr></table></figure>
<h2 id="Running-Strategies">Running Strategies</h2>
<p>The strategy clause on a play level gives you additional control over how Ansible behaves per task for all hosts.</p>
<p>The default behavior we are already familiar with is the <code>linear</code> strategy. This is the strategy in which Ansible executes one task on all hosts and waits until the task has completed (of failed) on all hosts before it executes the next task on all hosts. As a result, a task takes as much time as the slowest host takes to complete the task.</p>
<h3 id="Linear">Linear</h3>
<p><strong>Note</strong>: I forget that host file can define variable, here <code>sleep_seconds</code> can be referred in task:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">one   sleep_seconds=1</span><br><span class="line">two   sleep_seconds=6</span><br><span class="line">three  sleep_seconds=10</span><br></pre></td></tr></table></figure>
<p><strong>Note</strong> that the orders show up is the complete order in target host, first done at top.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TASK [setup] *******************************************************************</span><br><span class="line">ok: [two]</span><br><span class="line">ok: [three]</span><br><span class="line">ok: [one]</span><br></pre></td></tr></table></figure>
<h3 id="Free">Free</h3>
<p>Another strategy available in Ansible is the <code>free</code> strategy. In contrast to <code>linear</code>, Ansible will not wait for results of the task to execute on all hosts. Instead, if a host completes one task, Ansible will execute the next task on that host.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- hosts: all</span><br><span class="line">  strategy: free</span><br><span class="line">  tasks:</span><br><span class="line">     ...</span><br></pre></td></tr></table></figure>
<h2 id="Advanced-Handlers">Advanced Handlers</h2>
<p>When we covered handlers, you learned that they are usually executed after all tasks, once, and only when they get notified. But keep in mind there are not only <code>tasks</code>, but <code>pre_tasks</code>, <code>tasks</code>, and <code>post_tasks</code>.</p>
<p>Each tasks section in a playbook is handled separately; any handler notified in <code>pre_tasks</code>, <code>tasks</code>, or <code>post_tasks</code> is executed at the end of each section. As a result, it is possible to execute one handler several times in one play:</p>
<p><strong>Note</strong>: the rest of Chapter 9 is useless for me now, just skip it.</p>
<h1>Chapter 16. Debugging Ansible Playbooks</h1>
<h2 id="Humane-Error-Messages">Humane Error Messages</h2>
<p>Enable the plugin by adding the following to the <code>defaults</code> section of <em>ansible.cfg</em>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">stdout_callback = debug</span><br></pre></td></tr></table></figure>
<p>the <code>debug</code> callback plugin makes this output much easier for a human to read, for example the format is like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">TASK [check out the repository on the host] *************************************</span><br><span class="line">fatal: [web]: FAILED! =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;cmd&quot;: &quot;/usr/bin/git clone --origin origin &apos;&apos; /home/vagrant/mezzanine/mezzani</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">STDERR:</span><br><span class="line"></span><br><span class="line">Cloning into &apos;/home/vagrant/mezzanine/mezzanine_example&apos;...</span><br><span class="line">Permission denied (publickey).</span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line">...</span><br><span class="line">MSG:</span><br><span class="line"></span><br><span class="line">Cloning into &apos;/home/vagrant/mezzanine/mezzanine_example&apos;...</span><br><span class="line">Permission denied (publickey).</span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="Debugging-SSH-Issues">Debugging SSH Issues</h2>
<p>Sometimes Ansible fails to make a successful SSH connection with the host. When this happens, it’s helpful to see exactly what arguments Ansible is passing to the underlying SSH client so you can reproduce the problem manually on the command line.</p>
<p>If you invoke <code>ansible-playbook</code> with the <code>-vvv</code> argument, you can see the exact SSH commands that Ansible invokes. This can be handy for debugging.</p>
<blockquote>
<p>Note that usually I use <code>-v</code> flag</p>
</blockquote>
<p>Sometimes you might need to use -vvvv when debugging a connection issue, in order to see an error message that the SSH client is throwing.</p>
<h2 id="The-Debug-Module">The Debug Module</h2>
<p>We’ve used the <code>debug</code> module several times in this book. It’s Ansible’s version of a <code>print</code> statement.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- debug: var=myvariable</span><br><span class="line">- debug: msg=&quot;The value of myvariable is &#123;&#123; var &#125;&#125;&quot;</span><br><span class="line">- debug: var=hostvars[inventory_hostname]</span><br></pre></td></tr></table></figure>
<h2 id="Playbook-Debugger">Playbook Debugger</h2>
<p>Ansible 2.1 added support for an <strong>interactive debugger</strong>. To enable debugging, add <code>strategy: debug</code> to your play; for example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: an example play</span><br><span class="line">  strategy: debug</span><br><span class="line">  tasks:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>If debugging is enabled, Ansible drops into the debugger when a task fails, for example, I write a task like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: install xxx package</span><br><span class="line">  yum:</span><br><span class="line">    name: xxx</span><br><span class="line">    state: latest</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">TASK [install.components : interactive debug] ************************************************************************</span><br><span class="line">fatal: [myk8s2.fyre.ibm.com]: FAILED! =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;rc&quot;: 126,</span><br><span class="line">    &quot;results&quot;: [</span><br><span class="line">        &quot;No package matching &apos;xxx&apos; found available, installed or updated&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MSG:</span><br><span class="line"></span><br><span class="line">No package matching &apos;xxx&apos; found available, installed or updated</span><br><span class="line"></span><br><span class="line">Debugger invoked</span><br><span class="line">(debug) p task</span><br></pre></td></tr></table></figure>
<p>Let’s see the command list</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">| Command              | Description                                 |</span><br><span class="line">|----------------------|---------------------------------------------|</span><br><span class="line">| p var                | Print out the value of a supported variable |</span><br><span class="line">| task.args[key]=value | Modify an argument for the failed task      |</span><br><span class="line">| vars[key]=value      | Modify the value of a variable              |</span><br><span class="line">| r                    | rerun the failed task                       |</span><br><span class="line">| c                    | continue execute next                       |</span><br><span class="line">| q                    | abort the play                              |</span><br><span class="line">| help                 | show help message                           |</span><br></pre></td></tr></table></figure>
<p>variables supported by the debugger</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">| Command     | Description                            |</span><br><span class="line">|-------------|----------------------------------------|</span><br><span class="line">| p task      | the name of the failed task            |</span><br><span class="line">| p task.args | The module arguments                   |</span><br><span class="line">| p result    | The result returned by the failed task |</span><br><span class="line">| p vars      | Value of all known variables           |</span><br><span class="line">| p vars[key] | Value of one variable                  |</span><br></pre></td></tr></table></figure>
<h2 id="The-Assert-Module">The Assert Module</h2>
<p>The <code>assert</code> module will fail with an error if a specified condition is not met. For example, to fail the playbook if there’s no <code>eth1</code> interface:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- name: assert that eth1 interface exists</span><br><span class="line">  assert:</span><br><span class="line">    that: ansible_eth1 is defined</span><br></pre></td></tr></table></figure>
<p>When debugging a playbook, it can be helpful to insert assertions so that a failure happens as soon as any assumption you’ve made has been violated.</p>
<p>Keep in mind that the code in an <code>assert</code> statement is Jinja2, not Python.</p>
<h2 id="Checking-Your-Playbook-Before-Execution">Checking Your Playbook Before Execution</h2>
<p>The <code>ansible-playbook</code> command supports several flags that allow you to sanity check your playbook before you execute it.</p>
<h3 id="Syntax-Check">Syntax Check</h3>
<p>The <code>--syntax-check</code> flag checks that your playbook’s syntax is valid, but it does not execute it.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --syntax-check -i &lt;host file&gt; playbook.yml</span><br></pre></td></tr></table></figure>
<h3 id="List-Hosts">List Hosts</h3>
<p>The --list-hosts flag outputs the hosts that the playbook will run against, but it does not execute the playbook.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --list-hosts -i &lt;host file&gt; playbook.yml</span><br></pre></td></tr></table></figure>
<h3 id="List-Tasks">List Tasks</h3>
<p>Outputs the tasks that the playbook will run against. It does not execute the playbook.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --list-tasks -i &lt;host file&gt; playbook.yml</span><br></pre></td></tr></table></figure>
<h3 id="Check-Mode">Check Mode</h3>
<p>The <code>-C</code> and <code>--check</code> flags run Ansible in check mode (sometimes known as <em>dry-run</em>), which tells you whether each task in the playbook will modify the host, but does not make any changes to the server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --check -i &lt;host file&gt; playbook.yml</span><br></pre></td></tr></table></figure>
<p>One of the challenges with using check mode is that later parts of a playbook might succeed only if earlier parts of the playbook were executed.</p>
<h3 id="Diff-Show-File-Changes">Diff (Show File Changes)</h3>
<p>The <code>-D</code> and <code>-diff</code> flags output differences for any files that are changed on the remote machine. It’s a helpful option to use in conjunction with <code>--check</code> to show how Ansible would change the file if it were run normally:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --diff --check -i &lt;host file&gt; playbook.yml</span><br></pre></td></tr></table></figure>
<p>If Ansible would modify any files (e.g., using modules such as <code>copy</code>, <code>template</code>, and <code>lineinfile</code>), it will show the changes in .diff format, like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">TASK: [set the gunicorn config file] ******************************************</span><br><span class="line">--- before: /home/vagrant/mezzanine-example/project/gunicorn.conf.py</span><br><span class="line">+++ after: /Users/lorin/dev/ansiblebook/ch06/playbooks/templates/gunicor</span><br><span class="line">n.conf.py.j2</span><br><span class="line">@@ -1,7 +1,7 @@</span><br><span class="line"> from __future__ import unicode_literals</span><br><span class="line"> import multiprocessing</span><br><span class="line"></span><br><span class="line"> bind = &quot;127.0.0.1:8000&quot;</span><br><span class="line"> workers = multiprocessing.cpu_count() * 2 + 1</span><br><span class="line">-loglevel = &quot;error&quot;</span><br><span class="line">+loglevel = &quot;warning&quot;</span><br><span class="line"> proc_name = &quot;mezzanine-example&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Limiting-Which-Tasks-Run">Limiting Which Tasks Run</h2>
<p>Sometimes you don’t want Ansible to run every single task in your playbook, particularly when you’re first writing and debugging the playbook. Ansible provides several command-line options that let you control which tasks run.</p>
<h3 id="Step">Step</h3>
<p>The <code>--step</code> flag, shown in <a href="https://learning.oreilly.com/library/view/ansible-up-and/9781491979792/ch16.html#step-example" target="_blank" rel="noopener">Example 16-7</a>, has Ansible prompt you before running each task, like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Perform task: install packages (y/n/c):</span><br></pre></td></tr></table></figure>
<p>You can choose to execute the task (y), skip it (n), or tell Ansible to continue running the rest of the playbook without prompting you ©.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i &lt;host file&gt; --step playbook.yml</span><br></pre></td></tr></table></figure>
<h3 id="Start-at-Task">Start-at-Task</h3>
<p>The <code>--start-at-task taskname</code> flag tells Ansible to start running the playbook at the specified task, instead of at the beginning. This can be handy if one of your tasks failed because there was a bug in one of your tasks, and you want to rerun your playbook starting at the task you just fixed.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i &lt;host file&gt; --start-at-task=&quot;install packages&quot; playbook.yml</span><br></pre></td></tr></table></figure>
<h3 id="Tags">Tags</h3>
<p>Ansible allows you to add one or more tags to a task or a play. For example, here’s a play that’s tagged with <code>foo</code> and a task that’s tagged with <code>bar</code> and <code>quux</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- hosts: myservers</span><br><span class="line">  tags:</span><br><span class="line">   - foo</span><br><span class="line">  tasks:</span><br><span class="line">   - name: install editors</span><br><span class="line">     apt: name=&#123;&#123; item &#125;&#125;</span><br><span class="line">     with_items:</span><br><span class="line">       - vim</span><br><span class="line">       - emacs</span><br><span class="line">       - nano</span><br><span class="line"></span><br><span class="line">   - name: run arbitrary command</span><br><span class="line">     command: /opt/myprog</span><br><span class="line">     tags:</span><br><span class="line">       - bar</span><br><span class="line">       - quux</span><br></pre></td></tr></table></figure>
<p>Use the <code>-t tagnames</code> or <code>--tags tagnames</code> flag to tell Ansible to run only plays and tasks that have certain tags. Use the <code>--skip-tags tagnames</code> flag to tell Ansible to skip plays and tasks that have certain tags.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -t foo,bar playbook.yml</span><br><span class="line">ansible-playbook --tags=foo,bar playbook.yml</span><br><span class="line">ansible-playbook --skip-tags=baz,quux playbook.yml</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ansible/" rel="tag"># ansible</a>
          
            <a href="/tags/book/" rel="tag"># book</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/09/open-source/" rel="next" title="Open Sources">
                <i class="fa fa-chevron-left"></i> Open Sources
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/22/ansible-module-refer/" rel="prev" title="Ansible Module Reference">
                Ansible Module Reference <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">287</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">47</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">158</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Chapter 1. Introduction</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#How-Ansible-works"><span class="nav-number">1.1.</span> <span class="nav-text">How Ansible works</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Simplify-by-ansible-cfg-file"><span class="nav-number">1.2.</span> <span class="nav-text">Simplify by ansible.cfg file</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Chapter 2. Playbooks: A Beginning</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TLS-VERSUS-SSL"><span class="nav-number">2.1.</span> <span class="nav-text">TLS VERSUS SSL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WHY-DO-YOU-USE-TRUE-IN-ONE-PLACE-AND-YES-IN-ANOTHER"><span class="nav-number">2.2.</span> <span class="nav-text">WHY DO YOU USE TRUE IN ONE PLACE AND YES IN ANOTHER?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NOTE"><span class="nav-number">2.3.</span> <span class="nav-text">NOTE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#COWSAY"><span class="nav-number">2.4.</span> <span class="nav-text">COWSAY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TIP"><span class="nav-number">2.5.</span> <span class="nav-text">TIP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#YAML-syntax"><span class="nav-number">2.6.</span> <span class="nav-text">YAML syntax</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Start-of-file"><span class="nav-number">2.6.1.</span> <span class="nav-text">Start of file</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#String"><span class="nav-number">2.6.2.</span> <span class="nav-text">String</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Boolean"><span class="nav-number">2.6.3.</span> <span class="nav-text">Boolean</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#List"><span class="nav-number">2.6.4.</span> <span class="nav-text">List</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dictionary"><span class="nav-number">2.6.5.</span> <span class="nav-text">Dictionary</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Line-folding"><span class="nav-number">2.6.6.</span> <span class="nav-text">Line folding</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Anatomy-of-a-Playbook"><span class="nav-number">2.7.</span> <span class="nav-text">Anatomy of a Playbook</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Modules"><span class="nav-number">2.8.</span> <span class="nav-text">Modules</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VIEWING-ANSIBLE-MODULE-DOCUMENTATION"><span class="nav-number">2.8.1.</span> <span class="nav-text">VIEWING ANSIBLE MODULE DOCUMENTATION</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Putting-It-All-Together"><span class="nav-number">2.9.</span> <span class="nav-text">Putting It All Together</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Did-Anything-Change-Tracking-Host-State"><span class="nav-number">2.10.</span> <span class="nav-text">Did Anything Change? Tracking Host State</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Variables-and-Handlers"><span class="nav-number">2.11.</span> <span class="nav-text">Variables and Handlers</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Generating-a-TLS-Certificate"><span class="nav-number">2.11.1.</span> <span class="nav-text">Generating a TLS Certificate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Variables"><span class="nav-number">2.11.2.</span> <span class="nav-text">Variables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WHEN-QUOTING-IS-NECESSARY"><span class="nav-number">2.11.3.</span> <span class="nav-text">WHEN QUOTING IS NECESSARY</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Generating-the-Template"><span class="nav-number">2.12.</span> <span class="nav-text">Generating the Template</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Handlers"><span class="nav-number">2.12.1.</span> <span class="nav-text">Handlers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A-FEW-THINGS-TO-KEEP-IN-MIND-ABOUT-HANDLERS"><span class="nav-number">2.12.2.</span> <span class="nav-text">A FEW THINGS TO KEEP IN MIND ABOUT HANDLERS</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Chapter 3. Inventory: Describing Your Servers</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Preliminaries-Multiple-Vagrant-Machines"><span class="nav-number">3.1.</span> <span class="nav-text">Preliminaries: Multiple Vagrant Machines</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Behavioral-Inventory-Parameters"><span class="nav-number">3.2.</span> <span class="nav-text">Behavioral Inventory Parameters</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Groups"><span class="nav-number">3.3.</span> <span class="nav-text">Groups</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Alias-and-Ports"><span class="nav-number">3.4.</span> <span class="nav-text">Alias and Ports:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Groups-of-groups"><span class="nav-number">3.5.</span> <span class="nav-text">Groups of groups</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Numbered-hosts"><span class="nav-number">3.6.</span> <span class="nav-text">Numbered hosts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Host-and-Group-Variables"><span class="nav-number">3.7.</span> <span class="nav-text">Host and Group Variables</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dynamic-Inventory"><span class="nav-number">3.8.</span> <span class="nav-text">Dynamic Inventory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Adding-Entries-at-Runtime-with-add-host-and-group-by"><span class="nav-number">3.9.</span> <span class="nav-text">Adding Entries at Runtime with add_host and group_by</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">Chapter 4. Variables and Facts</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Defining-Variables-in-Playbooks"><span class="nav-number">4.1.</span> <span class="nav-text">Defining Variables in Playbooks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Viewing-the-Values-of-Variables"><span class="nav-number">4.2.</span> <span class="nav-text">Viewing the Values of Variables</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Registering-Variables"><span class="nav-number">4.3.</span> <span class="nav-text">Registering Variables</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ACCESSING-DICTIONARY-KEYS-IN-A-VARIABLE"><span class="nav-number">4.3.1.</span> <span class="nav-text">ACCESSING DICTIONARY KEYS IN A VARIABLE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CAUTION"><span class="nav-number">4.3.2.</span> <span class="nav-text">CAUTION</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Facts"><span class="nav-number">4.4.</span> <span class="nav-text">Facts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Viewing-All-Facts-Associated-with-a-Server"><span class="nav-number">4.4.1.</span> <span class="nav-text">Viewing All Facts Associated with a Server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Viewing-a-Subset-of-Facts"><span class="nav-number">4.4.2.</span> <span class="nav-text">Viewing a Subset of Facts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Any-Module-Can-Return-Facts"><span class="nav-number">4.4.3.</span> <span class="nav-text">Any Module Can Return Facts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Local-Facts"><span class="nav-number">4.4.4.</span> <span class="nav-text">Local Facts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-set-fact-to-Define-a-New-Variable"><span class="nav-number">4.4.5.</span> <span class="nav-text">Using set_fact to Define a New Variable</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Built-in-Variables"><span class="nav-number">4.5.</span> <span class="nav-text">Built-in Variables</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Setting-Variables-on-the-Command-Line"><span class="nav-number">4.6.</span> <span class="nav-text">Setting Variables on the Command Line</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Precedence"><span class="nav-number">4.7.</span> <span class="nav-text">Precedence</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">Chapter 5. Introducing Mezzanine: Our Test Application</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">Chapter 7. Roles: Scaling Up Your Playbooks</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic-Structure-of-a-Role"><span class="nav-number">6.1.</span> <span class="nav-text">Basic Structure of a Role</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WHERE-DOES-ANSIBLE-LOOK-FOR-MY-ROLES"><span class="nav-number">6.2.</span> <span class="nav-text">WHERE DOES ANSIBLE LOOK FOR MY ROLES?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Using-Roles-in-Your-Playbooks"><span class="nav-number">6.3.</span> <span class="nav-text">Using Roles in Your Playbooks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pre-Tasks-and-Post-Tasks"><span class="nav-number">6.4.</span> <span class="nav-text">Pre-Tasks and Post-Tasks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WHY-ARE-THERE-TWO-WAYS-TO-DEFINE-VARIABLES-IN-ROLES"><span class="nav-number">6.5.</span> <span class="nav-text">WHY ARE THERE TWO WAYS TO DEFINE VARIABLES IN ROLES?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Some-role-practices"><span class="nav-number">6.6.</span> <span class="nav-text">Some role practices</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-Role-Files-and-Directories-with-ansible-galaxy"><span class="nav-number">6.7.</span> <span class="nav-text">Creating Role Files and Directories with ansible-galaxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dependent-Roles"><span class="nav-number">6.8.</span> <span class="nav-text">Dependent Roles</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible-Galaxy"><span class="nav-number">6.9.</span> <span class="nav-text">Ansible Galaxy</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">7.</span> <span class="nav-text">Chapter 8. Complex Playbooks</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Dealing-with-Badly-Behaved-Commands"><span class="nav-number">7.1.</span> <span class="nav-text">Dealing with Badly Behaved Commands</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Filter"><span class="nav-number">7.2.</span> <span class="nav-text">Filter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Default-Filter"><span class="nav-number">7.2.1.</span> <span class="nav-text">The Default Filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Filters-for-Registered-Variables"><span class="nav-number">7.2.2.</span> <span class="nav-text">Filters for Registered Variables</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lookups"><span class="nav-number">7.3.</span> <span class="nav-text">Lookups</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#file"><span class="nav-number">7.3.1.</span> <span class="nav-text">file</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pipe"><span class="nav-number">7.3.2.</span> <span class="nav-text">pipe</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#env"><span class="nav-number">7.3.3.</span> <span class="nav-text">env</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#password"><span class="nav-number">7.3.4.</span> <span class="nav-text">password</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#template"><span class="nav-number">7.3.5.</span> <span class="nav-text">template</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#csvfile"><span class="nav-number">7.3.6.</span> <span class="nav-text">csvfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etcd"><span class="nav-number">7.3.7.</span> <span class="nav-text">etcd</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#More-Complicated-Loops"><span class="nav-number">7.4.</span> <span class="nav-text">More Complicated Loops</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#with-lines"><span class="nav-number">7.4.1.</span> <span class="nav-text">with_lines</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#with-fileglob"><span class="nav-number">7.4.2.</span> <span class="nav-text">with_fileglob</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#with-dict"><span class="nav-number">7.4.3.</span> <span class="nav-text">with_dict</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Looping-Constructs-as-Lookup-Plugins"><span class="nav-number">7.4.4.</span> <span class="nav-text">Looping Constructs as Lookup Plugins</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Loop-Controls"><span class="nav-number">7.5.</span> <span class="nav-text">Loop Controls</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Setting-the-Variable-Name"><span class="nav-number">7.5.1.</span> <span class="nav-text">Setting the Variable Name</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Labeling-the-Output"><span class="nav-number">7.5.2.</span> <span class="nav-text">Labeling the Output</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Includes"><span class="nav-number">7.6.</span> <span class="nav-text">Includes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-includes"><span class="nav-number">7.6.1.</span> <span class="nav-text">Dynamic includes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Role-includes"><span class="nav-number">7.6.2.</span> <span class="nav-text">Role includes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Blocks"><span class="nav-number">7.7.</span> <span class="nav-text">Blocks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Error-Handling-with-Blocks"><span class="nav-number">7.7.1.</span> <span class="nav-text">Error Handling with Blocks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Encrypting-Sensitive-Data-with-Vault"><span class="nav-number">7.8.</span> <span class="nav-text">Encrypting Sensitive Data with Vault</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">8.</span> <span class="nav-text">Chapter 9. Customizing Hosts, Runs, and Handlers</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Patterns-for-Specifying-Hosts"><span class="nav-number">8.1.</span> <span class="nav-text">Patterns for Specifying Hosts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Limiting-Which-Hosts-Run"><span class="nav-number">8.2.</span> <span class="nav-text">Limiting Which Hosts Run</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Running-a-Task-on-the-Control-Machine"><span class="nav-number">8.3.</span> <span class="nav-text">Running a Task on the Control Machine</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Running-a-Task-on-a-Machine-Other-Than-the-Host"><span class="nav-number">8.4.</span> <span class="nav-text">Running a Task on a Machine Other Than the Host</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Running-on-One-Host-at-a-Time"><span class="nav-number">8.5.</span> <span class="nav-text">Running on One Host at a Time</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Running-Only-Once"><span class="nav-number">8.6.</span> <span class="nav-text">Running Only Once</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Running-Strategies"><span class="nav-number">8.7.</span> <span class="nav-text">Running Strategies</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Linear"><span class="nav-number">8.7.1.</span> <span class="nav-text">Linear</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Free"><span class="nav-number">8.7.2.</span> <span class="nav-text">Free</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Advanced-Handlers"><span class="nav-number">8.8.</span> <span class="nav-text">Advanced Handlers</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">9.</span> <span class="nav-text">Chapter 16. Debugging Ansible Playbooks</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Humane-Error-Messages"><span class="nav-number">9.1.</span> <span class="nav-text">Humane Error Messages</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Debugging-SSH-Issues"><span class="nav-number">9.2.</span> <span class="nav-text">Debugging SSH Issues</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Debug-Module"><span class="nav-number">9.3.</span> <span class="nav-text">The Debug Module</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Playbook-Debugger"><span class="nav-number">9.4.</span> <span class="nav-text">Playbook Debugger</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Assert-Module"><span class="nav-number">9.5.</span> <span class="nav-text">The Assert Module</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Checking-Your-Playbook-Before-Execution"><span class="nav-number">9.6.</span> <span class="nav-text">Checking Your Playbook Before Execution</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Syntax-Check"><span class="nav-number">9.6.1.</span> <span class="nav-text">Syntax Check</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#List-Hosts"><span class="nav-number">9.6.2.</span> <span class="nav-text">List Hosts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#List-Tasks"><span class="nav-number">9.6.3.</span> <span class="nav-text">List Tasks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Check-Mode"><span class="nav-number">9.6.4.</span> <span class="nav-text">Check Mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Diff-Show-File-Changes"><span class="nav-number">9.6.5.</span> <span class="nav-text">Diff (Show File Changes)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Limiting-Which-Tasks-Run"><span class="nav-number">9.7.</span> <span class="nav-text">Limiting Which Tasks Run</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Step"><span class="nav-number">9.7.1.</span> <span class="nav-text">Step</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Start-at-Task"><span class="nav-number">9.7.2.</span> <span class="nav-text">Start-at-Task</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tags"><span class="nav-number">9.7.3.</span> <span class="nav-text">Tags</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>





  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
