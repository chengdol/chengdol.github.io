<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="There are some common Ansible modules that use frequently, more details please refer to Ansible online document. How to organize the ansible files structure, see this best practice. play strategyThere">
<meta name="keywords" content="ansible">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible Module Reference">
<meta property="og:url" content="http://yoursite.com/2019/03/22/ansible-module-refer/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="There are some common Ansible modules that use frequently, more details please refer to Ansible online document. How to organize the ansible files structure, see this best practice. play strategyThere">
<meta property="og:locale" content="中文|English">
<meta property="og:updated_time" content="2021-12-27T06:42:53.438Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ansible Module Reference">
<meta name="twitter:description" content="There are some common Ansible modules that use frequently, more details please refer to Ansible online document. How to organize the ansible files structure, see this best practice. play strategyThere">






  <link rel="canonical" href="http://yoursite.com/2019/03/22/ansible-module-refer/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Ansible Module Reference | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">144</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">42</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">257</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/22/ansible-module-refer/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Ansible Module Reference

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-03-22 20:58:34" itemprop="dateCreated datePublished" datetime="2019-03-22T20:58:34-07:00">2019-03-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-12-26 22:42:53" itemprop="dateModified" datetime="2021-12-26T22:42:53-08:00">2021-12-26</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Ansible/" itemprop="url" rel="index"><span itemprop="name">Ansible</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">63k</span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>There are some common Ansible modules that use frequently, more details please refer to Ansible online document.</p>
<p>How to organize the ansible files structure, see this best <a href="https://docs.ansible.com/ansible/2.8/user_guide/playbooks_best_practices.html" target="_blank" rel="noopener">practice</a>.</p>
<h2 id="play-strategy"><a href="#play-strategy" class="headerlink" title="play strategy"></a>play strategy</h2><p>There are several play <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_strategies.html#selecting-a-strategy" target="_blank" rel="noopener">strategies</a> in ansibel:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  strategy:</span> <span class="string">free</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="comment"># ...</span></span><br></pre></td></tr></table></figure></p>
<h2 id="serial"><a href="#serial" class="headerlink" title="serial"></a>serial</h2><p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_strategies.html#setting-the-batch-size-with-serial" target="_blank" rel="noopener">This</a> keyword is useful when doing rolling upgrade or patching.</p>
<p>You can also set <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_error_handling.html#setting-a-maximum-failure-percentage" target="_blank" rel="noopener">maximum failure percentage</a> to abort play during the batch execution:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">test</span> <span class="string">play</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  serial:</span> <span class="number">4</span></span><br><span class="line">  <span class="comment"># if 2 out of 4 fails, abort execution</span></span><br><span class="line"><span class="attr">  max_fail_percentage:</span> <span class="number">49</span></span><br></pre></td></tr></table></figure></p>
<h2 id="run-once"><a href="#run-once" class="headerlink" title="run_once"></a>run_once</h2><p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_strategies.html#running-on-a-single-machine-with-run-once" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/user_guide/playbooks_strategies.html#running-on-a-single-machine-with-run-once</a><br>Run task only on the first host in the batch, for example, setting on ES cluster master. Here provides other options like <code>delegate_to</code> and <code>when: inventory_hostname == webservers[0]</code>.</p>
<h2 id="k8s-management"><a href="#k8s-management" class="headerlink" title="k8s management"></a>k8s management</h2><p>挺有意思，看看这篇<a href="https://blog.51cto.com/99cloud/2336420?source=dra" target="_blank" rel="noopener">文章</a>，和Helm做了一下比较:</p>
<p>Use Ansible on k8s management:</p>
<ul>
<li><a href="https://docs.ansible.com/ansible/latest/scenario_guides/virt_guides.html" target="_blank" rel="noopener">Ansible Virtualization and Containerization Guides</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/collections/community/kubernetes/k8s_module.html" target="_blank" rel="noopener">Ansible k8s module</a></li>
</ul>
<h2 id="uri"><a href="#uri" class="headerlink" title="uri"></a>uri</h2><p><a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/uri_module.html" target="_blank" rel="noopener">rui module</a><br><a href="https://stackoverflow.com/questions/40235550/how-to-inspect-a-json-response-from-ansible-uri-call" target="_blank" rel="noopener">uri json response check</a><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PUT method and get response to result</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">disable</span> <span class="string">shard</span> <span class="string">allocation</span></span><br><span class="line"><span class="attr">  uri:</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">http://localhost:9200/_cluster/settings?format=json</span></span><br><span class="line"><span class="attr">    method:</span> <span class="string">PUT</span></span><br><span class="line"><span class="attr">    status_code:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    body_format:</span> <span class="string">json</span></span><br><span class="line"><span class="attr">    return_content:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    headers:</span></span><br><span class="line"><span class="attr">      Content-Type:</span> <span class="string">application/json</span></span><br><span class="line"><span class="attr">    body:</span> <span class="string">"&#123;\"persistent\": &#123;\"cluster.routing.allocation.enable\": \"primaries\"&#125;&#125;"</span></span><br><span class="line">    <span class="comment"># if request response is slow</span></span><br><span class="line"><span class="attr">    timeout:</span> <span class="number">900</span></span><br><span class="line"><span class="attr">  register:</span> <span class="string">result</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">display</span> <span class="string">response</span> <span class="string">body</span></span><br><span class="line"><span class="attr">  debug:</span></span><br><span class="line"><span class="attr">    var:</span> <span class="string">result.json</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if reponse is an array of dicts</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Print</span> <span class="string">certain</span> <span class="string">element</span></span><br><span class="line"><span class="attr">  debug:</span></span><br><span class="line"><span class="attr">    var:</span> <span class="string">result.json[0].xxx.yyy</span></span><br></pre></td></tr></table></figure></p>
<h2 id="pause"><a href="#pause" class="headerlink" title="pause"></a>pause</h2><p><a href="https://docs.ansible.com/ansible/latest/modules/pause_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/pause_module.html</a><br>Pauses playbook execution for a set amount of time, or until a prompt is acknowledged. All parameters are optional. The default behavior is to pause with a prompt.</p>
<p>The pause module integrates into async/parallelized playbooks without any special considerations (see Rolling Updates). When using pauses with the serial playbook parameter (as in rolling updates) you are only prompted once for the current group of hosts.</p>
<p>Useful when debug certain task to see the execution result:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># just pause </span></span><br><span class="line"><span class="attr">- pause:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># a helpful reminder of what to look out for post-update.</span></span><br><span class="line"><span class="attr">- pause:</span></span><br><span class="line"><span class="attr">    prompt:</span> <span class="string">"Make sure org.foo.FooOverload exception is not present"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pause to get some sensitive input.</span></span><br><span class="line"><span class="attr">- pause:</span></span><br><span class="line"><span class="attr">    prompt:</span> <span class="string">"Enter a secret"</span></span><br><span class="line"><span class="attr">    echo:</span> <span class="literal">no</span></span><br></pre></td></tr></table></figure></p>
<h2 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h2><p>Sometimes I need to skip tasks on some machines with prompt confirmation, how to do this?<br>It seems there is no <code>skip</code> module in ansible, but we have workaroud, see this <a href="https://unix.stackexchange.com/questions/424151/skip-some-task-with-prompt-in-ansible" target="_blank" rel="noopener">issue</a>.</p>
<p>You can also apply <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.html" target="_blank" rel="noopener"><code>tag</code></a><br>and <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html#conditionals" target="_blank" rel="noopener">condition</a>.</p>
<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><p><a href="https://docs.ansible.com/ansible/latest/modules/debug_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/debug_module.html</a><br>This module prints statements during execution and can be useful for debugging variables or expressions without necessarily halting the playbook.</p>
<p>Useful for debugging together with the <code>when:</code> directive.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Example that prints return information from the previous task</span></span><br><span class="line"><span class="attr">- shell:</span> <span class="string">/usr/bin/uptime</span></span><br><span class="line"><span class="attr">  register:</span> <span class="string">result</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## var option already runs in Jinja2 context and has an implicit &#123;&#123; &#125;&#125; wrapping</span></span><br><span class="line"><span class="attr">- debug:</span></span><br><span class="line"><span class="attr">    var:</span> <span class="string">result</span></span><br><span class="line">    <span class="comment">## this verbosity is associated with `-vv` parameter</span></span><br><span class="line"><span class="attr">    verbosity:</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## prints the loopback address and gateway for each host</span></span><br><span class="line"><span class="attr">- debug:</span></span><br><span class="line"><span class="attr">    msg:</span> <span class="string">System</span> <span class="string">&#123;&#123;</span> <span class="string">inventory_hostname</span> <span class="string">&#125;&#125;</span> <span class="string">has</span> <span class="string">gateway</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_default_ipv4.gateway</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">ansible_default_ipv4.gateway</span> <span class="string">is</span> <span class="string">defined</span></span><br></pre></td></tr></table></figure></p>
<h2 id="fail"><a href="#fail" class="headerlink" title="fail"></a>fail</h2><p><a href="https://docs.ansible.com/ansible/latest/modules/fail_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/fail_module.html</a><br>This module fails the progress with a custom message.<br>It can be useful for bailing out when a certain condition is met using when.</p>
<p>More error handling see:<br><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_error_handling.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/user_guide/playbooks_error_handling.html</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">check</span> <span class="string">async</span> <span class="string">task</span> <span class="string">status</span></span><br><span class="line"><span class="attr">  ignore_errors:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment">## check async task status</span></span><br><span class="line"><span class="attr">  async_status:</span></span><br><span class="line"><span class="attr">    jid:</span> <span class="string">"<span class="template-variable">&#123;&#123; sleepTask.ansible_job_id &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  register:</span> <span class="string">job_result</span></span><br><span class="line"><span class="attr">  until:</span> <span class="string">job_result.finished</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">"inventory_hostname == groups.master[0]"</span></span><br><span class="line"><span class="attr">  retries:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">  delay:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## other things to do</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## fail the process if the retry failed</span></span><br><span class="line"><span class="attr">- fail:</span></span><br><span class="line"><span class="attr">    msg:</span> <span class="string">The</span> <span class="string">time</span> <span class="string">limit</span> <span class="string">hit,</span> <span class="string">the</span> <span class="string">cluster</span> <span class="string">may</span> <span class="string">not</span> <span class="string">be</span> <span class="string">in</span> <span class="string">ready</span> <span class="string">status!</span></span><br><span class="line">  <span class="comment">## it depends what output is in the register variable</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">job_result.failed</span> <span class="string">==</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h2><p><a href="https://docs.ansible.com/ansible/latest/modules/copy_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/copy_module.html</a><br>The copy module copies a file from the local or remote machine to a location on the remote machine (depends on the condition). 和template类似, 如果task下面有files文件夹, 在不指定src路径的时候, eg: <code>src: xxx.txt</code>, 会从files文件夹里copy.</p>
<p>Use the <code>fetch</code> module to copy files from remote locations to the local box.</p>
<p>If you need variable interpolation in copied files, use the <code>template</code> module. Using a variable in the content field will result in unpredictable output.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## &#123;&#123; baseDir &#125;&#125;/registry-certs/tls.crt is in control machine</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Copy</span> <span class="string">secure</span> <span class="string">docker</span> <span class="string">registry</span> <span class="string">ssl/tls</span> <span class="string">certs</span> <span class="string">to</span> <span class="string">all</span> <span class="string">worker</span> <span class="string">nodes</span></span><br><span class="line"><span class="attr">  any_errors_fatal:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  copy:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseDir &#125;&#125;</span>/registry-certs/tls.crt"</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">"/etc/docker/certs.d/<span class="template-variable">&#123;&#123; service name &#125;&#125;</span>:5000/tls.crt"</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="string">'0644'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## remote_src: yes means copy is happening on remote machine</span></span><br><span class="line"><span class="comment">## remote_src supports recursive copying as of version 2.8</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Copy</span> <span class="string">a</span> <span class="string">"sudoers"</span> <span class="string">file</span> <span class="string">on</span> <span class="string">the</span> <span class="string">remote</span> <span class="string">machine</span> <span class="string">for</span> <span class="string">editing</span></span><br><span class="line"><span class="attr">  copy:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">/etc/sudoers</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/sudoers.edit</span></span><br><span class="line"><span class="attr">    remote_src:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure></p>
<p>注意mode 必须是4 digits!! 比如0644 不能是644，否则没对齐会造成sticky bit.<br><a href="https://askubuntu.com/questions/976168/difference-between-three-and-four-digit-file-permissions" target="_blank" rel="noopener">ansible copy make sticky bit</a></p>
<h2 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h2><p>This module works like copy, but in reverse.</p>
<p>It is used for fetching files from remote machines and storing them locally in a file tree, organized by hostname.</p>
<p>Files that already exist at dest will be overwritten if they are different than the src.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## fetched file is marked by the remote hostname </span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Store</span> <span class="string">file</span> <span class="string">into</span> <span class="string">/tmp/fetched/host.example.com/tmp/somefile</span></span><br><span class="line"><span class="attr">  fetch:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">/tmp/somefile</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/tmp/fetched</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## If dest ends with '/', it will use the basename of the source file, similar to the copy module.</span></span><br><span class="line"><span class="comment">## This can be useful if working with a single host, or if retrieving files that are uniquely named per host.</span></span><br><span class="line"><span class="comment">## If using multiple hosts with the same filename, the file will be overwritten for each host.</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Specifying</span> <span class="string">a</span> <span class="string">destination</span> <span class="string">path</span></span><br><span class="line"><span class="attr">  fetch:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">/tmp/uniquefile</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/tmp/special/</span></span><br><span class="line"><span class="attr">    flat:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure></p>
<h2 id="template"><a href="#template" class="headerlink" title="template"></a>template</h2><p><a href="https://docs.ansible.com/ansible/latest/modules/template_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/template_module.html</a><br>这个module在统一设置配置文件时很常用, 或者可以用来初始化script template中的参数, 然后传递到各个host去运行.<br>Templates are processed by the <code>Jinja2</code> templating language.<br>Documentation on the template formatting can be found in the <a href="https://jinja.palletsprojects.com/en/2.10.x/templates/" target="_blank" rel="noopener">Template Designer Documentation</a>.</p>
<p>Usually we have the ansible role structure:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">roles/</span></span><br><span class="line">  <span class="string">install.components/</span></span><br><span class="line">      <span class="string">defaults/</span></span><br><span class="line">        <span class="string">main.yml</span></span><br><span class="line">      <span class="string">tasks/</span></span><br><span class="line">        <span class="string">main.yml</span></span><br><span class="line">      <span class="string">templates/</span></span><br><span class="line">        <span class="string">example.conf.j2</span></span><br><span class="line">        <span class="string">example.sh.j2</span></span><br><span class="line">      <span class="string">files/</span></span><br><span class="line">        <span class="string">bar.txt</span></span><br><span class="line">        <span class="string">foo.sh</span></span><br></pre></td></tr></table></figure></p>
<p>When template works it picks source file from role’s <code>templates/</code> folder.<br>If the template file contains jinja2 placeholder, it will be interpolated.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## from control machine to other nodes</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Template</span> <span class="string">a</span> <span class="string">file</span> <span class="string">to</span> <span class="string">/etc/files.conf</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">/mytemplates/foo.j2</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/file.conf</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">bin</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">wheel</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="string">'0644'</span></span><br></pre></td></tr></table></figure>
<h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><p><a href="https://docs.ansible.com/ansible/latest/modules/shell_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/shell_module.html</a><br>这个太常用了, 可以做几乎所有其他module的工作.</p>
<p>It is almost exactly like the <code>command</code> module but runs the command through a shell (<code>/bin/sh</code>) on the remote node.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Copy</span> <span class="string">IIS</span> <span class="string">docker</span> <span class="string">images</span> <span class="string">to</span> <span class="string">specified</span> <span class="string">worker</span> <span class="string">nodes</span></span><br><span class="line"><span class="attr">  any_errors_fatal:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  shell:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    /tmp/copyIISDockers.sh <span class="template-variable">&#123;&#123; iisDockers &#125;&#125;</span> <span class="template-variable">&#123;&#123; imageTag &#125;&#125;</span></span></span><br><span class="line"><span class="string">    if [[ $? -eq 0 ]]; then</span></span><br><span class="line"><span class="string">      touch /tmp/copyIISImageToWorker.done</span></span><br><span class="line"><span class="string">    fi</span></span><br><span class="line"><span class="string"></span><span class="attr">  when:</span> <span class="string">"inventory_hostname == groups.master[0]"</span></span><br><span class="line"><span class="attr">  args:</span></span><br><span class="line">    <span class="comment">## A filename, when it already exists, this step will not be run.</span></span><br><span class="line"><span class="attr">    creates:</span> <span class="string">/tmp/copyIISImageToWorker.done</span></span><br><span class="line">    <span class="comment">## A filename, when it does not exist, this step will not be run.</span></span><br><span class="line"><span class="attr">    removes:</span> <span class="string">/tmp/preTaskOk.done</span></span><br><span class="line">    <span class="comment">## disable task warning</span></span><br><span class="line"><span class="attr">    warn:</span> <span class="literal">no</span></span><br><span class="line">    <span class="comment">## change the shell</span></span><br><span class="line"><span class="attr">    executable:</span> <span class="string">/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Change</span> <span class="string">the</span> <span class="string">working</span> <span class="string">directory</span> <span class="string">to</span> <span class="string">somedir/</span> <span class="string">before</span> <span class="string">executing</span> <span class="string">the</span> <span class="string">command.</span></span><br><span class="line"><span class="attr">  shell:</span> <span class="string">somescript.sh</span> <span class="string">&gt;&gt;</span> <span class="string">somelog.txt</span></span><br><span class="line"><span class="attr">  args:</span></span><br><span class="line"><span class="attr">    chdir:</span> <span class="string">somedir/</span></span><br></pre></td></tr></table></figure>
<h2 id="command"><a href="#command" class="headerlink" title="command"></a>command</h2><p><a href="https://docs.ansible.com/ansible/latest/modules/command_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/command_module.html</a><br>The <code>command</code> module takes the command name followed by a list of space-delimited arguments.<br>The given command will be executed on all selected nodes.<br>The command(s) will <strong>not</strong> be processed through the <code>shell</code>, so variables like $HOME and operations like “&lt;”, “&gt;”, “|”, “;” and “&amp;” will not work. Use the shell module if you need these features.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">return</span> <span class="string">motd</span> <span class="string">to</span> <span class="string">registered</span> <span class="string">var</span></span><br><span class="line"><span class="attr">  command:</span> <span class="string">cat</span> <span class="string">/etc/motd</span></span><br><span class="line"><span class="attr">  register:</span> <span class="string">mymotd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 'args' is a task keyword, passed at the same level as the module</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Run</span> <span class="string">command</span> <span class="string">if</span> <span class="string">/path/to/database</span> <span class="string">does</span> <span class="string">not</span> <span class="string">exist</span> <span class="string">(with</span> <span class="string">'args'</span> <span class="string">keyword).</span></span><br><span class="line"><span class="attr">  command:</span> <span class="string">/usr/bin/make_database.sh</span> <span class="string">db_user</span> <span class="string">db_name</span></span><br><span class="line"><span class="attr">  args:</span></span><br><span class="line"><span class="attr">    creates:</span> <span class="string">/path/to/database</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 'cmd' is module parameter</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Run</span> <span class="string">command</span> <span class="string">if</span> <span class="string">/path/to/database</span> <span class="string">does</span> <span class="string">not</span> <span class="string">exist</span> <span class="string">(with</span> <span class="string">'cmd'</span> <span class="string">parameter).</span></span><br><span class="line"><span class="attr">  command:</span></span><br><span class="line"><span class="attr">    cmd:</span> <span class="string">/usr/bin/make_database.sh</span> <span class="string">db_user</span> <span class="string">db_name</span></span><br><span class="line"><span class="attr">    creates:</span> <span class="string">/path/to/database</span></span><br></pre></td></tr></table></figure>
<h2 id="service"><a href="#service" class="headerlink" title="service"></a>service</h2><p><a href="https://docs.ansible.com/ansible/latest/modules/service_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/service_module.html</a><br>Controls services on remote hosts. Supported init systems include BSD init, OpenRC, SysV, Solaris SMF, systemd, upstart.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Start</span> <span class="string">service</span> <span class="string">httpd,</span> <span class="string">if</span> <span class="string">not</span> <span class="string">started</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">started</span></span><br></pre></td></tr></table></figure>
<h2 id="systemd"><a href="#systemd" class="headerlink" title="systemd"></a>systemd</h2><p><a href="https://docs.ansible.com/ansible/latest/modules/systemd_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/systemd_module.html</a><br>more dedicated then service module, controls systemd services on remote hosts.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Enable</span> <span class="string">and</span> <span class="string">start</span> <span class="string">docker</span></span><br><span class="line"><span class="attr">  any_errors_fatal:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  systemd:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">docker</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">started</span></span><br></pre></td></tr></table></figure>
<h2 id="file"><a href="#file" class="headerlink" title="file"></a>file</h2><p>Set attributes of files, symlinks or directories.<br>Alternatively, remove files, symlinks or directories.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Create</span> <span class="string">a</span> <span class="string">directory</span> <span class="string">if</span> <span class="string">it</span> <span class="string">does</span> <span class="string">not</span> <span class="string">exist</span></span><br><span class="line"><span class="attr">  file:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/some_directory</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">directory</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="string">'0755'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Touch</span> <span class="string">a</span> <span class="string">file,</span> <span class="string">using</span> <span class="string">symbolic</span> <span class="string">modes</span> <span class="string">to</span> <span class="string">set</span> <span class="string">the</span> <span class="string">permissions</span> <span class="string">(equivalent</span> <span class="string">to</span> <span class="number">0644</span><span class="string">)</span></span><br><span class="line"><span class="attr">  file:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/foo.conf</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">touch</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="string">u=rw,g=r,o=r</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Remove</span> <span class="string">file</span> <span class="string">(delete</span> <span class="string">file)</span></span><br><span class="line"><span class="attr">  file:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/foo.txt</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">absent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Recursively</span> <span class="string">remove</span> <span class="string">directory</span></span><br><span class="line"><span class="attr">  file:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/foo</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">absent</span></span><br></pre></td></tr></table></figure>
<h2 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h2><p><a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/replace_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/replace_module.html</a><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># note to escape regex character</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">update</span> <span class="string">elasticsearch</span> <span class="string">jvm</span> <span class="string">deprecated</span> <span class="string">options</span></span><br><span class="line"><span class="attr">  replace:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/elasticsearch/jvm.options</span></span><br><span class="line"><span class="attr">    regexp:</span> <span class="string">"<span class="template-variable">&#123;&#123; update_item.old &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    replace:</span> <span class="string">"<span class="template-variable">&#123;&#123; update_item.new &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  loop:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">old:</span> <span class="string">^-XX:\+UseConcMarkSweepGC,</span> <span class="attr">new:</span> <span class="number">8</span><span class="bullet">-13</span><span class="string">:-XX:+UseConcMarkSweepGC</span> <span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">old:</span> <span class="string">^-XX:CMSInitiatingOccupancyFraction=75,</span> <span class="attr">new:</span> <span class="number">8</span><span class="bullet">-13</span><span class="string">:-XX:CMSInitiatingOccupancyFraction=75</span> <span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">old:</span> <span class="string">^-XX:\+UseCMSInitiatingOccupancyOnly,</span> <span class="attr">new:</span> <span class="number">8</span><span class="bullet">-13</span><span class="string">:-XX:+UseCMSInitiatingOccupancyOnly</span> <span class="string">&#125;</span></span><br><span class="line"><span class="attr">  loop_control:</span></span><br><span class="line"><span class="attr">    loop_var:</span> <span class="string">update_item</span></span><br></pre></td></tr></table></figure></p>
<h2 id="lineinfile"><a href="#lineinfile" class="headerlink" title="lineinfile"></a>lineinfile</h2><p><a href="https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html</a><br>If you use <code>sed</code> in command module, you will get warning, you can disable the warning by add <code>warn: false</code> or use lineinfile module.</p>
<p>This module ensures a particular line is in a file, or replace an existing line using a back-referenced regular expression.</p>
<p>This is primarily useful when you want to change a single line in a file only.</p>
<p>See the <code>replace</code> module if you want to change multiple, similar lines or check <code>blockinfile</code> if you want to insert/update/remove a block of lines in a file. For other cases, see the copy or template modules.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># remove</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">remove</span> <span class="string">old</span> <span class="string">node</span> <span class="string">role</span> <span class="string">syntax</span> <span class="string">in</span> <span class="string">elasticsearch.yml</span> <span class="string">file</span></span><br><span class="line"><span class="attr">  lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/elasticsearch/elasticsearch.yml</span></span><br><span class="line"><span class="attr">    regexp:</span> <span class="string">"<span class="template-variable">&#123;&#123; remove_item &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">absent</span></span><br><span class="line"><span class="attr">  loop:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">^node\.data</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">^node\.master</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">^node\.roles</span></span><br><span class="line"><span class="attr">  loop_control:</span></span><br><span class="line"><span class="attr">    loop_var:</span> <span class="string">remove_item</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># insert</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Update</span> <span class="string">G1GC</span> <span class="string">config</span> <span class="string">for</span> <span class="string">jdk</span> <span class="number">14</span><span class="string">+</span> <span class="string">in</span> <span class="string">jvm</span> <span class="string">options</span> <span class="string">file</span></span><br><span class="line"><span class="attr">  lineinfile:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/elasticsearch/jvm.options</span></span><br><span class="line"><span class="attr">    insertafter:</span> <span class="string">"^# To use G1GC uncomment the lines below."</span></span><br><span class="line"><span class="attr">    line:</span> <span class="string">"<span class="template-variable">&#123;&#123; add_item &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  loop:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">14</span><span class="bullet">-:-XX:+UseG1GC</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">14</span><span class="bullet">-:-XX:G1ReservePercent=25</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">14</span><span class="bullet">-:-XX:InitiatingHeapOccupancyPercent=30</span></span><br><span class="line"><span class="attr">  loop_control:</span></span><br><span class="line"><span class="attr">    loop_var:</span> <span class="string">add_itema</span></span><br></pre></td></tr></table></figure>
<p>Note that if run multiple times, only the first time take effect! it will not remove or insert duplicates.</p>
<h2 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h2><p><a href="https://docs.ansible.com/ansible/latest/modules/mount_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/mount_module.html</a><br>This module controls active and configured mount points in <code>/etc/fstab</code></p>
<p>For <code>/etc/exports</code>, no dedicated module for it.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Edit</span> <span class="string">/etc/fstab</span> <span class="string">file</span> <span class="string">to</span> <span class="string">mount</span> <span class="string">share</span> <span class="string">directory</span></span><br><span class="line"><span class="attr">  any_errors_fatal:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  mount:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">"/mnt"</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">"<span class="template-variable">&#123;&#123; dfsFileServer &#125;&#125;</span>:<span class="template-variable">&#123;&#123; dfsDataDir &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    fstype:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">    opts:</span> <span class="string">"defaults,timeo=10,retrans=3,rsize=1048576,wsize=1048576"</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">mounted</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Edit</span> <span class="string">/etc/fstab</span> <span class="string">file</span> <span class="string">to</span> <span class="string">unmout</span> <span class="string">share</span> <span class="string">directory</span></span><br><span class="line"><span class="attr">  any_errors_fatal:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  mount:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">"/mnt"</span></span><br><span class="line"><span class="attr">    fstype:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">    opts:</span> <span class="string">"defaults,timeo=10,retrans=3,rsize=1048576,wsize=1048576"</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">absent</span></span><br></pre></td></tr></table></figure>
<h2 id="asynchronous"><a href="#asynchronous" class="headerlink" title="asynchronous"></a>asynchronous</h2><p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_async.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/user_guide/playbooks_async.html</a><br>By default task in playbook blocks, this may not always be desirable, or you may be running operations that take longer than the SSH timeout.</p>
<p>This module can be use to create progress bar for long time task.</p>
<blockquote>
<p>Notice that async task can only be accessed in the same playbook.<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">async</span> <span class="string">task</span> <span class="string">in</span> <span class="string">background</span></span><br><span class="line"><span class="attr">  any_errors_fatal:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  shell:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    echo "start first task"</span></span><br><span class="line"><span class="string">    sleep 20</span></span><br><span class="line"><span class="string">    touch /tmp/sleep.done</span></span><br><span class="line"><span class="string">  ## when poll &gt; 0, task still blocks</span></span><br><span class="line"><span class="string">  ## when poll = 0, task run in background</span></span><br><span class="line"><span class="string"></span><span class="attr">  poll:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment">## explicitly sets the timeout 1000 seconds</span></span><br><span class="line"><span class="attr">  async:</span> <span class="number">1000</span> </span><br><span class="line">  <span class="comment">## register for later check</span></span><br><span class="line"><span class="attr">  register:</span> <span class="string">sleepTask</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">"inventory_hostname == groups.master[0]"</span></span><br><span class="line"><span class="attr">  args:</span></span><br><span class="line"><span class="attr">    creates:</span> <span class="string">/tmp/sleep.done</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">check</span> <span class="string">async</span> <span class="string">task</span> <span class="string">status</span></span><br><span class="line"><span class="attr">  any_errors_fatal:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment">## check async task status</span></span><br><span class="line"><span class="attr">  async_status:</span></span><br><span class="line"><span class="attr">    jid:</span> <span class="string">"<span class="template-variable">&#123;&#123; sleepTask.ansible_job_id &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  register:</span> <span class="string">job_result</span></span><br><span class="line"><span class="attr">  until:</span> <span class="string">job_result.finished</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">"inventory_hostname == groups.master[0]"</span></span><br><span class="line"><span class="attr">  retries:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">  delay:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="ini-file"><a href="#ini-file" class="headerlink" title="ini_file"></a>ini_file</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">"Add override config file for xxx service"</span></span><br><span class="line"><span class="attr">  ini_file:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/etc/systemd/system/xxx.service.d/override.conf</span></span><br><span class="line"><span class="attr">    section:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">    option:</span> <span class="string">MemoryLimit</span></span><br><span class="line"><span class="attr">    value:</span> <span class="string">"800M"</span></span><br><span class="line"><span class="attr">    no_extra_spaces:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br></pre></td></tr></table></figure>
<h2 id="synchronize"><a href="#synchronize" class="headerlink" title="synchronize"></a>synchronize</h2><p>rsync wrapper</p>
<h2 id="loop"><a href="#loop" class="headerlink" title="loop"></a>loop</h2><p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html" target="_blank" rel="noopener">Loops</a><br>需要注意的是在有嵌套循环时，要rename default <code>item</code>, for example, below loop is a inner loop, rename the loop var to <code>inner_item</code>, otherwise you get warning message:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># main.yml</span></span><br><span class="line"><span class="attr">- include_tasks:</span> <span class="string">inner.yml</span></span><br><span class="line"><span class="attr">  loop:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">2</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  loop_control:</span></span><br><span class="line"><span class="attr">    loop_var:</span> <span class="string">outer_item</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># inner.yml</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Add</span> <span class="string">several</span> <span class="string">users</span></span><br><span class="line"><span class="attr">  debug:</span></span><br><span class="line"><span class="attr">    msg:</span> <span class="string">"<span class="template-variable">&#123;&#123; inner_item.name &#125;&#125;</span> and <span class="template-variable">&#123;&#123; inner_item.groups &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  loop:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'testuser1'</span><span class="string">,</span> <span class="attr">groups:</span> <span class="string">'wheel'</span> <span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'testuser2'</span><span class="string">,</span> <span class="attr">groups:</span> <span class="string">'root'</span> <span class="string">&#125;</span></span><br><span class="line"><span class="attr">  loop_control:</span></span><br><span class="line"><span class="attr">    loop_var:</span> <span class="string">inner_item</span></span><br></pre></td></tr></table></figure></p>
<h2 id="variables"><a href="#variables" class="headerlink" title="variables"></a>variables</h2><p>inventory_hostname<br>groups<br>jinjia2 template <figure class="highlight plain"><figcaption><span>&#125;&#125;```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">operator: in</span><br><span class="line"></span><br><span class="line">Here is an case about using ansible internal variable to get machine memory size:</span><br><span class="line">https://www.redhat.com/sysadmin/configuration-verification-ansible</span><br><span class="line">Then we can use it for example to calculate and set heap size used for ES.</span><br><span class="line"></span><br><span class="line">## conditional</span><br><span class="line">when clause</span><br><span class="line"></span><br><span class="line">```yaml</span><br><span class="line">## 不是每个module都支持creates的</span><br><span class="line">args:</span><br><span class="line">  creates: xxx</span><br></pre></td></tr></table></figure></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ansible/" rel="tag"># ansible</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/13/book-ansible-up-and-running/" rel="next" title="Ansible Up and Running, 2nd Edition">
                <i class="fa fa-chevron-left"></i> Ansible Up and Running, 2nd Edition
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/26/k8s-external-access/" rel="prev" title="Kubernetes NodePort vs LoadBalancer vs Ingress">
                Kubernetes NodePort vs LoadBalancer vs Ingress <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">257</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">42</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">144</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#play-strategy"><span class="nav-number">1.</span> <span class="nav-text">play strategy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serial"><span class="nav-number">2.</span> <span class="nav-text">serial</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#run-once"><span class="nav-number">3.</span> <span class="nav-text">run_once</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k8s-management"><span class="nav-number">4.</span> <span class="nav-text">k8s management</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uri"><span class="nav-number">5.</span> <span class="nav-text">uri</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pause"><span class="nav-number">6.</span> <span class="nav-text">pause</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#skip"><span class="nav-number">7.</span> <span class="nav-text">skip</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#debug"><span class="nav-number">8.</span> <span class="nav-text">debug</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fail"><span class="nav-number">9.</span> <span class="nav-text">fail</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#copy"><span class="nav-number">10.</span> <span class="nav-text">copy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fetch"><span class="nav-number">11.</span> <span class="nav-text">fetch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#template"><span class="nav-number">12.</span> <span class="nav-text">template</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shell"><span class="nav-number">13.</span> <span class="nav-text">shell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#command"><span class="nav-number">14.</span> <span class="nav-text">command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#service"><span class="nav-number">15.</span> <span class="nav-text">service</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#systemd"><span class="nav-number">16.</span> <span class="nav-text">systemd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#file"><span class="nav-number">17.</span> <span class="nav-text">file</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#replace"><span class="nav-number">18.</span> <span class="nav-text">replace</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lineinfile"><span class="nav-number">19.</span> <span class="nav-text">lineinfile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mount"><span class="nav-number">20.</span> <span class="nav-text">mount</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#asynchronous"><span class="nav-number">21.</span> <span class="nav-text">asynchronous</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ini-file"><span class="nav-number">22.</span> <span class="nav-text">ini_file</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#synchronize"><span class="nav-number">23.</span> <span class="nav-text">synchronize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#loop"><span class="nav-number">24.</span> <span class="nav-text">loop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#variables"><span class="nav-number">25.</span> <span class="nav-text">variables</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="Symbols count total">1.2m</span>
  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
