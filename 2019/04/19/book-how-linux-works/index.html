<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Great book for all Linux developers and administrators! Just note for future quick revisit! Chapter1. The Big picture The most effective way to understand how an operating system works is through abst">
<meta name="keywords" content="book,linux">
<meta property="og:type" content="article">
<meta property="og:title" content="How Linux Works, 2nd Edition">
<meta property="og:url" content="http://yoursite.com/2019/04/19/book-how-linux-works/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="Great book for all Linux developers and administrators! Just note for future quick revisit! Chapter1. The Big picture The most effective way to understand how an operating system works is through abst">
<meta property="og:locale" content="中文|English">
<meta property="og:image" content="https://drive.google.com/uc?id=1e0ziORmoEx6zPk6J6qEid26aWl-zw21G">
<meta property="og:image" content="https://drive.google.com/uc?id=1Hy8vWUIBuo33oH976PNEkVzvAOzCuyKJ">
<meta property="og:updated_time" content="2021-03-16T07:37:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How Linux Works, 2nd Edition">
<meta name="twitter:description" content="Great book for all Linux developers and administrators! Just note for future quick revisit! Chapter1. The Big picture The most effective way to understand how an operating system works is through abst">
<meta name="twitter:image" content="https://drive.google.com/uc?id=1e0ziORmoEx6zPk6J6qEid26aWl-zw21G">






  <link rel="canonical" href="http://yoursite.com/2019/04/19/book-how-linux-works/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>How Linux Works, 2nd Edition | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">159</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">48</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">295</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/19/book-how-linux-works/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">How Linux Works, 2nd Edition

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-19 09:52:29" itemprop="dateCreated datePublished" datetime="2019-04-19T09:52:29-07:00">2019-04-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-03-16 00:37:43" itemprop="dateModified" datetime="2021-03-16T00:37:43-07:00">2021-03-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Book/" itemprop="url" rel="index"><span itemprop="name">Book</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Great book for all Linux developers and administrators! Just note for future quick revisit!</p>
<h2 id="Chapter1-The-Big-picture">Chapter1. The Big picture</h2>
<p>The most effective way to understand how an operating system works is through abstraction—a fancy way of saying that you can ignore most of the details.</p>
<p>The <code>kernel</code> is software residing in memory that tells the CPU what to do. The kernel manages the hardware and acts primarily as an interface between the hardware and any running program.</p>
<p>Processes—the running programs that the kernel manages—collectively make up the system’s upper level, called <code>user space</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------------------------------------------------------+</span><br><span class="line">|                                                                         |</span><br><span class="line">|  User process                                                           |</span><br><span class="line">|                                                                         |</span><br><span class="line">|   +-------------------+   +-----------------+    +---------------+      |</span><br><span class="line">|   |  GUI              |   |  Servers        |    |  Shell        |      |</span><br><span class="line">|   |                   |   |                 |    |               |      |</span><br><span class="line">|   +-------------------+   +-----------------+    +---------------+      |</span><br><span class="line">|                                                                         |</span><br><span class="line">+-------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+-------------------------------------------------------------------------+</span><br><span class="line">|                                                                         |</span><br><span class="line">|  Linux kernel                                                           |</span><br><span class="line">|  +--------------+     +--------------------------+                      |</span><br><span class="line">|  |  system calls|     |   process management     |                      |</span><br><span class="line">|  +--------------+     +--------------------------+                      |</span><br><span class="line">|                                                                         |</span><br><span class="line">|  +---------------------+        +-------------------------------+       |</span><br><span class="line">|  |  device driver      |        |   memory management           |       |</span><br><span class="line">|  +---------------------+        +-------------------------------+       |</span><br><span class="line">+-------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">+-------------------------------------------------------------------------+</span><br><span class="line">|                                                                         |</span><br><span class="line">|  Hardware                                                               |</span><br><span class="line">|                                                                         |</span><br><span class="line">|  +-------------------+   +-------------------+   +---------------+      |</span><br><span class="line">|  |   CPU             |   |    RAM            |   |  Disk         |      |</span><br><span class="line">|  +-------------------+   +-------------------+   +---------------+      |</span><br><span class="line">|  +---------------------+                                                |</span><br><span class="line">|  |   Network           |                                                |</span><br><span class="line">|  +---------------------+                                                |</span><br><span class="line">+-------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>There is a critical difference between the ways that the kernel and user processes run: The kernel runs in kernel mode, and the user processes run in user mode. Code running in kernel mode has unrestricted access to the processor and main memory. This is a powerful but dangerous privilege that allows a kernel process to easily crash the entire system. The area that only the kernel can access is called kernel space.</p>
<p>User mode, in comparison, restricts access to a (usually quite small) subset of memory and safe CPU operations. User space refers to the parts of main memory that the user processes can access. If a process makes a mistake and crashes, the consequences are limited and can be cleaned up by the kernel. This means that if your web browser crashes, it probably won’t take down the scientific computation that you’ve been running in the background for days.</p>
<h3 id="Hardware">Hardware</h3>
<p>A CPU is just an operator on memory; it reads its instructions and data from the memory and writes data back out to the memory.</p>
<p>You’ll often hear the term <code>state</code> in reference to memory, processes, the kernel, and other parts of a computer system. Strictly speaking, a state is a particular arrangement of bits. For example, if you have four bits in your memory, 0110, 0001, and 1011 represent three different states.</p>
<p>The term <code>image</code> refers to a particular physical arrangement of bits.</p>
<h3 id="Kernel">Kernel</h3>
<p>Nearly everything that the kernel does revolves around main memory. One of the kernel’s tasks is to split memory into many subdivisions, and it must maintain certain state information about those subdivisions at all times. Each process gets its own share of memory, and the kernel must ensure that each process keeps to its share.</p>
<p>The kernel is in charge of managing tasks in four general system areas:
<strong>Processes</strong>. The kernel is responsible for determining which processes are allowed to use the CPU.</p>
<p><strong>Memory</strong>. The kernel needs to keep track of all memory—what is currently allocated to a particular process, what might be shared between processes, and what is free.</p>
<p><strong>Device drivers</strong>. The kernel acts as an interface between hardware (such as a disk) and processes. It’s usually the kernel’s job to operate the hardware.</p>
<p><strong>System calls and support</strong>. Processes normally use system calls to communicate with the kernel.</p>
<p>The act of one process giving up control of the CPU to another process is called a <strong>context switch</strong>.</p>
<p>The kernel is responsible for context switching. To understand how this works, let’s think about a situation in which a process is running in user mode but its time slice is up. Here’s what happens:</p>
<ol>
<li>The CPU (the actual hardware) interrupts the current process based on an internal timer, switches into kernel mode, and hands control back to the kernel.</li>
<li>The kernel records the current state of the CPU and memory, which will be essential to resuming the process that was just interrupted.</li>
<li>The kernel performs any tasks that might have come up during the preceding time slice (such as collecting data from input and output, or I/O, operations).</li>
<li>The kernel is now ready to let another process run. The kernel analyzes the list of processes that are ready to run and chooses one.</li>
<li>The kernel prepares the memory for this new process, and then prepares the CPU.</li>
<li>The kernel tells the CPU how long the time slice for the new process will last.</li>
<li>The kernel switches the CPU into user mode and hands control of the CPU to the process.</li>
</ol>
<p>The context switch answers the important question of <strong>when</strong> the kernel runs. The answer is that it runs <strong>between</strong> process time slices during a context switch.</p>
<p>Modern CPUs include a <code>memory management unit (MMU)</code> that enables a memory access scheme called <code>virtual memory</code>. When using virtual memory, a process does not directly access the memory by its physical location in the hardware. Instead, the kernel sets up each process to act as if it had an entire machine to itself. When the process accesses some of its memory, the MMU intercepts the access and uses a memory address map to translate the memory location from the process into an actual physical memory location on the machine. The kernel must still initialize and continuously maintain and alter this memory address map. For example, during a context switch, the kernel has to change the map from the outgoing process to the incoming process.</p>
<blockquote>
<p>The implementation of a memory address map is called a page table.</p>
</blockquote>
<p>The kernel’s role with devices is pretty simple. A device is typically accessible only in kernel mode because improper access (such as a user process asking to turn off the power) could crash the machine. Another problem is that different devices rarely have the same programming interface, even if the devices do the same thing, such as two different network cards. Therefore, device drivers have traditionally been part of the kernel.</p>
<p>There are several other kinds of kernel features available to user processes. For example, <code>system calls</code> (or syscalls) perform specific tasks that a user process alone cannot do well or at all. For example, the acts of opening, reading, and writing files all involve system calls.</p>
<p>Other than <code>init</code>, <strong>all</strong> user processes on a Linux system start as a result of <code>fork()</code>, and most of the time, you also run <code>exec()</code> to start a new program instead of running a copy of an existing process.</p>
<h3 id="User-Space">User Space</h3>
<p>As mentioned earlier, the main memory that the kernel allocates for user processes is called <code>user space</code>. Because a process is simply a state (or image) in memory, user space also refers to the memory for the entire collection of running processes.</p>
<h3 id="Users">Users</h3>
<p>A <code>user</code> is an entity that can run processes and own files. A user is associated with a username. For example, a system could have a user named billyjoe. However, the kernel does not manage the usernames; instead, it identifies users by simple numeric identifiers called userids.</p>
<p>Users exist primarily to support permissions and boundaries.</p>
<p>In addition, as powerful as the <strong>root</strong> user is, it still runs in the operating system’s user mode, not kernel mode.</p>
<p><code>Groups</code> are sets of users. The primary purpose of groups is to allow a user to share file access to other users in a group.</p>
<h2 id="Chapter-2-Basic-Commands-and-Directory-Hierarchy">Chapter 2. Basic Commands and Directory Hierarchy</h2>
<p>Some resources:
<code>&lt;&lt;UNIX for the Impatient&gt;&gt;</code>
<code>&lt;&lt;Learning the UNIX Operating System&gt;&gt;</code></p>
<p>The <code>shell</code> is one of the most important parts of a Unix system. A shell is a program that runs commands. The shell also serves as a small programming environment.</p>
<p>Many important parts of the system are actually <code>shell scripts</code>—text files that contain a sequence of shell commands.</p>
<p>There are many different Unix shells, but all derive several of their features from the <code>Bourne shell</code> (/bin/sh), a standard shell developed at Bell Labs for early versions of Unix. Every Unix system needs the Bourne shell in order to function correctly, as you will see throughout this book.</p>
<p>Linux uses an enhanced version of the Bourne shell called <code>bash</code> or the “Bourne-again” shell. The bash shell is the default shell on most Linux distributions, and /bin/sh is normally a link to bash on a Linux system.</p>
<blockquote>
<p><code>cat</code> command: The command is called cat because it performs concatenation when it prints the contents of more than one file.</p>
</blockquote>
<p>Pressing <code>CTRL-D</code> on an empty line stops the current standard input entry from the terminal (and often terminates a program). Don’t confuse this with <code>CTRL-C</code>, which terminates a program regardless of its input or output.</p>
<blockquote>
<p>Unix filenames do not need extensions and often do not carry them.</p>
</blockquote>
<p><code>shell globs</code> don’t match dot files unless you explicitly use a pattern such as <code>.*</code>. This is why <code>rm -rf ./*</code> doesn’t remove hidden objects.</p>
<blockquote>
<p>You can run into problems with globs because <code>.*</code> matches <code>.</code> and <code>..</code> (the current and parent directories)</p>
</blockquote>
<p>The shell can store temporary variables, called <code>shell variables</code>, containing the values of text strings. Shell variables are very useful for keeping track of values in scripts, and some shell variables control the way the shell behaves.</p>
<p>An <code>environment variable</code> is like a shell variable, but it’s not specific to the shell. All processes on Unix systems have environment variable storage. The main difference between environment and shell variables is that the operating system passes all of your shell’s <code>environment variables</code> to programs that the shell runs (for example, the sub-script), whereas shell variables cannot be accessed in the commands that you run.</p>
<p>Assign an environment variable with the shell’s <code>export</code> command. For example, if you’d like to make the <code>$STUFF</code> shell variable into an environment variable, use the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">STUFF=123</span><br><span class="line">export STUFF</span><br></pre></td></tr></table></figure>
<p><code>PATH</code> is a special environment variable that contains the <code>command path</code> (or path for short). A command path is a list of system directories that the shell searches when trying to locate a command.</p>
<p>resource:
<code>&lt;&lt;Learning the vi and Vim Editor&gt;&gt;</code></p>
<p>Some <code>kill process</code> ways.There are many types of signals. The default is <code>TERM</code>, or terminate.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kill -STOP pid</span><br><span class="line">kill -CONT pid</span><br><span class="line">kill -KILL pid  # the same as kill -9 pid</span><br></pre></td></tr></table></figure>
<p>To see if you’ve accidentally suspended any processes on your current terminal, run the <code>jobs</code> command.</p>
<p>You can detach a process from the shell and put it in the “background” with the ampersand <code>&amp;</code>. The best way to make sure that a background process doesn’t bother you is to redirect its output (and possibly input).</p>
<p>Some executable files have an <code>s</code> in the <code>owner permissions</code> listing instead of an x. This indicates that the executable is <code>setuid</code>, meaning that when you execute the program, it runs as though the file owner is the user instead of you. Many programs use this <code>setuid</code> bit to run as root in order to get the privileges they need to change system files. One example is the <code>passwd</code> program, which needs to change the <code>/etc/passwd</code> file.</p>
<p>Directories also have permissions. You can list the contents of a directory if it’s readable, but you can only access a file in a directory if the directory is <code>executable</code>. (One common mistake people make when setting the permissions of directories is to accidentally remove the execute permission when using absolute modes.)</p>
<p>You can specify a set of default permissions with the <code>umask (user file-creation mode mask) </code>shell command, which applies a predefined set of permissions to any new file you create. In general, use <code>umask 022</code> if you want everyone to be able to see all of the files and directories that you create, and use <code>umask 077</code> if you don’t. (You’ll need to put the umask command with the desired mode in one of your startup files to make your new default permissions apply to later sessions).</p>
<blockquote>
<p>How to calculate the <code>umask</code>?</p>
<p>For directories, the base permissions are (rwxrwxrwx) <code>0777</code> and for files they are <code>0666</code> (rw-rw-rw).</p>
<p>You can simply subtract the umask from the base permissions to determine the final permission for file as follows:
666 – 022 = 644
subtract to get permissions of new file (666-022) : 644 (rw-r–r–)</p>
<p>You can simply subtract the umask from the base permissions to determine the final permission for directory as follows:
777 – 022 = 755
Subtract to get permissions of new directory (777-022) : 755 (rwxr-xr-x)</p>
</blockquote>
<p>Another compression program in Unix is <code>bzip2</code>, whose compressed files end with <code>.bz2</code>. While marginally slower than gzip, bzip2 often compacts text files a little more, and it is therefore increasingly popular in the distribution of source code.</p>
<p>The <code>bzip2</code> compression/decompression option for tar is <code>j</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar jcvf xx.bz2 file...</span><br><span class="line">tar jxvf xx.bz2</span><br></pre></td></tr></table></figure>
<h3 id="Linux-Directory-Hierarchy-Essentials">Linux Directory Hierarchy Essentials</h3>
<p>Simplified overview of the hierarchy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">                                                  +---------+</span><br><span class="line">                                                  |   /     |</span><br><span class="line">                                                  +-----+---+</span><br><span class="line">                                                        |</span><br><span class="line">    +-------------+-------------+-----------+----------------------+-----------+-----------+----------+</span><br><span class="line">    |             |             |           |           |          |           |           |          |</span><br><span class="line">    |             |             |           |           |          |           |           |          |</span><br><span class="line">    |             |             |           |           |          |           |           |          |</span><br><span class="line">    v             v             v           v           v          v           v           v          v</span><br><span class="line">+---+----+    +---+----+   +----+---+  +----+---+  +----+---+  +---+---+  +----+---+  +----+----+ +---------+</span><br><span class="line">|  /bin  |    |  /dev  |   |  /etc  |  |   /usr |  | /home  |  | /lib  |  |  /sbin |  |   /tmp  | |  /var   |</span><br><span class="line">+--------+    +--------+   +--------+  +----+---+  +--------+  +-------+  +--------+  +---------+ +----+----+</span><br><span class="line">                                            |                                                          |</span><br><span class="line">                                            |                                                     +----+-----+</span><br><span class="line">                                            |                                                     |          |</span><br><span class="line">              +---------+----------+--------------------+----------+                              |          |</span><br><span class="line">              |         |          |        |           |          |                              |          |</span><br><span class="line">              v         v          v        v           v          v                              v          v</span><br><span class="line">         +----+--+  +---+--+  +----+---+  +-+----+  +---+---+  +---+---+                     +----+---+  +---+----+</span><br><span class="line">         | bin/  |  | man/ |  |  lib/  |  |local/|  | sbin/ |  | share/|                     | log/   |  |  /tmp  |</span><br><span class="line">         +-------+  +------+  +--------+  +------+  +-------+  +-------+                     +--------+  +--------+</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><code>/bin</code> Contains ready-to-run programs (also known as an executables), including most of the basic Unix commands such as ls and cp. Most of the programs in /bin are in binary format, having been created by a C compiler, but some are shell scripts in modern systems.</p>
</li>
<li>
<p><code>/dev</code> Contains device files.</p>
</li>
<li>
<p><code>/etc</code> This core system configuration directory contains the user password, boot, device, networking, and other setup files. Many items in /etc are specific to the machine’s hardware.</p>
</li>
<li>
<p><code>/home</code> Holds personal directories for regular users.</p>
</li>
<li>
<p><code>/lib</code> An abbreviation for library, this directory holds library files containing code that executables can use.</p>
</li>
<li>
<p><code>/proc</code> Provides system statistics through a browsable directory-and-file interface. The <code>/proc</code> directory contains information about currently running processes as well as some kernel parameters.</p>
</li>
<li>
<p><code>/sys</code> This directory is similar to /proc in that it provides a device and system interface.</p>
</li>
<li>
<p><code>/sbin</code> The place for system executables. Programs in /sbin directories relate to system management.</p>
</li>
<li>
<p><code>/tmp</code> A storage area for smaller, temporary files that you don’t care much about. If something is extremely important, don’t put it in /tmp because most distributions clear /tmp when the machine boots and some even remove its old files periodically. Also, don’t let /tmp fill up with garbage because its space is usually shared with something critical</p>
</li>
<li>
<p><code>/usr</code> Although pronounced “user,” this subdirectory has no user files. Instead, it contains a large directory hierarchy, including the bulk of the Linux system. Many of the directory names in /usr are the same as those in the root directory (like /usr/bin and /usr/lib), and they hold the same type of files. (The reason that the root directory does not contain the complete system is primarily historic—in the past, it was to keep space requirements low for the root.)</p>
</li>
<li>
<p><code>/var</code> The variable subdirectory, where programs record runtime information. System logging, user tracking, caches, and other files that system programs create and manage are here.</p>
</li>
<li>
<p><code>/boot</code> Contains kernel boot loader files. These files pertain only to the very first stage of the Linux startup procedure.</p>
</li>
<li>
<p><code>/media</code> A base attachment point for removable media such as flash drives that is found in many distributions.</p>
</li>
<li>
<p><code>/opt</code> This may contain additional third-party software.</p>
</li>
</ul>
<h3 id="Kernel-Location">Kernel Location</h3>
<p>On Linux systems, the kernel is normally in <code>/vmlinuz</code> or <code>/boot/vmlinuz</code>. A boot loader loads this file into memory and sets it in motion when the system boots.</p>
<p>Once the boot loader runs and sets the kernel in motion, the main kernel file is no longer used by the running system. However, you’ll find many modules that the kernel can load and unload on demand during the course of normal system operation. Called loadable kernel modules, they are located under <code>/lib/modules</code>.</p>
<h2 id="Chapter-3-Devices">Chapter 3. Devices</h2>
<p>It’s important to understand how the kernel interacts with user space when presented with new devices. The <code>udev</code> system enables user-space programs to automatically configure and use new devices.</p>
<blockquote>
<p><code>udev</code> (userspace /dev) is a device manager for the Linux kernel. As the successor of devfsd and hotplug, udev primarily manages device nodes in the /dev directory.</p>
</blockquote>
<h3 id="Device-Files">Device Files</h3>
<p>It is easy to manipulate most devices on a Unix system because the kernel presents many of the device I/O interfaces to user processes as <strong>files</strong>. These device files are sometimes called <code>device nodes</code>. Not only can a programmer use regular file operations to work with a device, but some devices are also accessible to standard programs like <code>cat</code>. However, not all devices or device capabilities are accessible with standard file I/O.</p>
<p>Device files are in the <code>/dev</code> directory, and running <code>ls /dev</code> reveals more than a few files in <code>/dev</code>.</p>
<p>if run</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls -l</span><br><span class="line">brw-rw----     1 root disk 8, 1 Sep  6 08:37 sda1</span><br><span class="line">crw-rw-rw-     1 root root 1, 3 Sep  6 08:37 null</span><br><span class="line">prw-r--r--     1 root root    0 Mar  3 19:17 fdata</span><br><span class="line">srw-rw-rw-     1 root root    0 Dec 18 07:43 log</span><br></pre></td></tr></table></figure>
<p>if the first char in file mode is <code>b</code>, <code>c</code>, <code>p</code>, or <code>s</code>, the file is a device. These letters stand for block, character, pipe, and socket, respectively.</p>
<p>The numbers before the dates in the first two lines are the <code>major</code> and <code>minor</code> device numbers that help the kernel identify the device. Similar devices usually have the same major number.</p>
<h4 id="Block-device">Block device</h4>
<p>Programs access data from a block device in fixed chunks. The sda1 in the preceding example is a disk device, a type of block device.</p>
<h4 id="Character-device">Character device</h4>
<p>Character devices work with data streams. Printers directly attached to your computer are represented by character devices. It’s important to note that during character device interaction, the kernel cannot back up and reexamine the data stream after it has passed data to a device or process.</p>
<h4 id="Pipe-device">Pipe device</h4>
<p>Named pipes are like character devices, with another process at the other end of the I/O stream instead of a kernel driver.</p>
<h3 id="Socket-device">Socket device</h3>
<p>Sockets are special-purpose interfaces that are frequently used for <code>interprocess communication</code>.</p>
<blockquote>
<p>Not all devices have device files because the block and character device I/O interfaces are not appropriate in all cases. For example, <code>network interfaces</code> don’t have device files. It is theoretically possible to interact with a network interface using a single character device, but because it would be exceptionally difficult, the kernel uses other I/O interfaces.</p>
</blockquote>
<h3 id="The-sysfs-Device-Path">The sysfs Device Path</h3>
<p>To provide a uniform view for attached devices based on their actual hardware attributes, the Linux kernel offers the <code>sysfs</code> interface through a system of files and directories. The base path for devices is <code>/sys/devices</code> (this is a real directory!).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ls -ltr /sys/devices/</span><br><span class="line"></span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 21 root root 0 Apr 25 23:18 virtual</span><br><span class="line">drwxr-xr-x  3 root root 0 Apr 25 23:18 tracepoint</span><br><span class="line">drwxr-xr-x 10 root root 0 Apr 25 23:18 system</span><br><span class="line">drwxr-xr-x  3 root root 0 Apr 25 23:18 software</span><br><span class="line">drwxr-xr-x  8 root root 0 Apr 25 23:18 pnp0</span><br><span class="line">drwxr-xr-x  9 root root 0 Apr 25 23:18 platform</span><br><span class="line">drwxr-xr-x 15 root root 0 Apr 25 23:18 pci0000:00</span><br><span class="line">drwxr-xr-x  5 root root 0 Apr 25 23:18 msr</span><br><span class="line">drwxr-xr-x  6 root root 0 Apr 25 23:18 LNXSYSTM:00</span><br><span class="line">drwxr-xr-x  3 root root 0 Apr 25 23:18 breakpoint</span><br></pre></td></tr></table></figure>
<p>The <code>/dev</code> file is there so that user processes can use the device, whereas the <code>/sys/devices</code> path is used to view information and manage the device. In <code>/dev</code> you can run:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">udevadm info --query=all --name=/dev/null</span><br><span class="line"></span><br><span class="line">P: /devices/virtual/mem/null</span><br><span class="line">N: null</span><br><span class="line">E: DEVMODE=0666</span><br><span class="line">E: DEVNAME=/dev/null</span><br><span class="line">E: DEVPATH=/devices/virtual/mem/null</span><br><span class="line">E: MAJOR=1</span><br><span class="line">E: MINOR=3</span><br><span class="line">E: SUBSYSTEM=mem</span><br></pre></td></tr></table></figure>
<p>this command will show the sysfs location <code>/devices/virtual/mem/null</code></p>
<h3 id="dd-and-Devices">dd and Devices</h3>
<p>The program <code>dd</code> is extremely useful when working with block and character devices. This program’s sole function is to read from an input file or stream and write to an output file or stream, possibly doing some encoding conversion on the way.</p>
<p>I am not using it.</p>
<h3 id="Device-Name-Summary">Device Name Summary</h3>
<p>Not necessarily as described below, may be some variations:</p>
<ul>
<li>Hard Disks: /dev/sd*</li>
</ul>
<p>Most hard disks attached to current Linux systems correspond to device names with an <code>sd</code> prefix, such as <code>/dev/sda</code>, <code>/dev/sdb</code>, and so on. These devices represent entire disks; the kernel makes separate device files, such as <code>/dev/sda1</code> and <code>/dev/sda2</code>, for the partitions on a disk.</p>
<blockquote>
<p>The <code>sd</code> portion of the name stands for SCSI disk.</p>
</blockquote>
<p>Linux assigns devices to device files in the <strong>order</strong> in which its drivers encounter devices. This may cause problem when you remove one disk and insert another, because the device name changed for old disk. Most modern Linux systems use the Universally Unique Identifier (<code>UUID</code>) for persistent disk device access.</p>
<ul>
<li>CD and DVD Drives: /dev/sr*</li>
</ul>
<p>Linux recognizes most optical storage drives as the SCSI devices /dev/sr0, /dev/sr1, and so on.</p>
<ul>
<li>
<p>PATA Hard Disks: /dev/hd*</p>
</li>
<li>
<p>Terminals: /dev/tty*, /dev/pts/*, and /dev/tty</p>
</li>
</ul>
<p>Terminals are devices for moving characters between a user process and an I/O device, usually for text output to a terminal screen.</p>
<p><code>Pseudoterminal</code> devices are emulated terminals that understand the I/O features of real terminals.</p>
<p>Two common terminal devices are <code>/dev/tty1</code> (the first virtual console) and <code>/dev/pts/0</code> (the first pseudoterminal device). The <code>/dev/tty</code> device is the controlling terminal of the current process.</p>
<blockquote>
<p>teletypewriter, <code>tty</code> in shorthand</p>
</blockquote>
<p>I am always confused, at least you need to know <strong>shell</strong> is the command line interpreter!
<a href="https://askubuntu.com/questions/506510/what-is-the-difference-between-terminal-console-shell-and-command-line" target="_blank" rel="noopener">What is the difference between Terminal, Console, Shell, and Command Line?</a></p>
<p>Linux has two primary display modes: <code>text mode</code> and an <code>X Window System server</code> (graphics mode, usually via a display manager). Although Linux systems traditionally booted in text mode, most distributions now use kernel parameters and interim graphical display mechanisms to completely hide text mode as the system is booting. In such cases, the system switches over to full graphics mode near the end of the boot process.</p>
<p>OK, skip rest of the content in Chapter 3.</p>
<h2 id="Chapter-4-Disks-and-Filesystems">Chapter 4. Disks and Filesystems</h2>
<p>Schematic of a typical Linux disk:</p>
<p><img src="https://drive.google.com/uc?id=1e0ziORmoEx6zPk6J6qEid26aWl-zw21G" alt=""></p>
<p><code>Partitions</code> are subdivisions of the whole disk. On Linux, they’re denoted with a number after the whole block device, and therefore have device names such as <code>/dev/sda1</code> and <code>/dev/sdb3</code>.</p>
<p>Partitions are defined on a small area of the disk called a <code>partition table</code>.</p>
<p>The next layer after the partition is the <code>filesystem</code>, the database of files and directories that you’re accustomed to interacting with in user space.</p>
<p>To access data on a disk, the Linux kernel uses the system of layers like this:</p>
<p><img src="https://drive.google.com/uc?id=1Hy8vWUIBuo33oH976PNEkVzvAOzCuyKJ" alt=""></p>
<blockquote>
<p>Notice that you can work with the disk through the filesystem as well as directly through the disk devices.</p>
</blockquote>
<h3 id="Partitioning-Disk-Devices">Partitioning Disk Devices</h3>
<blockquote>
<p>You can view RedHat <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/ch-partitions" target="_blank" rel="noopener">Doc</a> for more information about partition</p>
</blockquote>
<p>Let’s view the partition table:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">parted -l</span><br><span class="line"></span><br><span class="line">Model: ATA WDC WD3200AAJS-2 (scsi)</span><br><span class="line">Disk /dev/sda: 320GB</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: msdos</span><br><span class="line"></span><br><span class="line">Number   Start   End    Size   Type      File system    Flags</span><br><span class="line"> 1       1049kB  316GB  316GB  primary   ext4           boot</span><br><span class="line"> 2       316GB   320GB  4235MB extended</span><br><span class="line"> 5       316GB   320GB  4235MB logical   linux-swap(v1)</span><br><span class="line"></span><br><span class="line">Model: FLASH Drive UT_USB20 (scsi)</span><br><span class="line">Disk /dev/sdf: 4041MB</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line"></span><br><span class="line">Number  Start   End     Size     File system  Name        Flags</span><br><span class="line"> 1      17.4kB  1000MB  1000MB                myfirst</span><br><span class="line"> 2      1000MB  4040MB  3040MB                mysecond</span><br></pre></td></tr></table></figure>
<p>There are 2 different partition tables: MBR (msdos) and GPT (gpt). The MBR table in this example contains primary, extended, and logical partitions.</p>
<h3 id="Changing-Partition-Tables">Changing Partition Tables</h3>
<p>You can use <code>parted</code> command to change partition. Check <code>/proc/partitions</code> can get full partition information.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/partitions</span><br><span class="line"></span><br><span class="line">major minor  #blocks  name</span><br><span class="line"> 252        0  262144000 vda</span><br><span class="line"> 252        1    1048576 vda1</span><br><span class="line"> 252        2  260976640 vda2</span><br><span class="line"> 253        0  252706816 dm-0</span><br><span class="line"> 253        1    8257536 dm-1</span><br></pre></td></tr></table></figure>
<h3 id="Filesystems">Filesystems</h3>
<p>The last link between the kernel and user space for disks is typically the file-system; this is what you’re accustomed to interacting with when you run commands such as <code>ls</code> and <code>cd</code>. As previously mentioned, the <strong>filesystem is a form of database</strong>; it supplies the structure to transform a simple block device into the sophisticated hierarchy of files and subdirectories that users can understand.</p>
<h4 id="Filesystem-Types">Filesystem Types</h4>
<ul>
<li>The <code>Fourth Extended filesystem (ext4)</code> is the current iteration of a line of filesystems native to Linux. The <code>Second Extended filesystem (ext2)</code> was a longtime default for Linux systems inspired by traditional Unix filesystems such as the Unix File System (UFS) and the Fast File System (FFS). The <code>Third Extended filesystem (ext3)</code> added a journal feature (a small cache outside the normal filesystem data structure) to enhance data integrity and hasten booting. The ext4 filesystem is an incremental improvement with support for larger files than ext2 or ext3 support and a greater number of subdirectories.</li>
</ul>
<h4 id="Create-a-Filesystems">Create a Filesystems</h4>
<p>Once you’re done with the partitioning process, you’re ready to create filesystems. As with partitioning, you’ll do this in user space because a user-space process can directly access and manipulate a block device.</p>
<p>For example, you can create an ext4 partition on /dev/sdf2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs -t ext4 /dev/sdf2</span><br></pre></td></tr></table></figure>
<p>Filesystem creation is a task that you should only need to perform after adding a new disk or repartitioning an old one. You should create a filesystem just once for each new partition that has no preexisting data (or that has data that you want to remove). Creating a new filesystem on top of an existing filesystem will effectively destroy the old data.</p>
<p>It turns out that mkfs is only a frontend for a series of filesystem creation programs:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ls -l /sbin/mkfs.*</span><br><span class="line"></span><br><span class="line">-rwxr-xr-x. 1 root root 375240 Mar  7  2017 /sbin/mkfs.btrfs</span><br><span class="line">-rwxr-xr-x  1 root root  37080 Jul 12  2018 /sbin/mkfs.cramfs</span><br><span class="line">-rwxr-xr-x  4 root root  96384 Apr 10  2018 /sbin/mkfs.ext2</span><br><span class="line">-rwxr-xr-x  4 root root  96384 Apr 10  2018 /sbin/mkfs.ext3</span><br><span class="line">-rwxr-xr-x  4 root root  96384 Apr 10  2018 /sbin/mkfs.ext4</span><br><span class="line">-rwxr-xr-x  1 root root  37184 Jul 12  2018 /sbin/mkfs.minix</span><br><span class="line">-rwxr-xr-x. 1 root root 368504 Feb 27  2018 /sbin/mkfs.xfs</span><br></pre></td></tr></table></figure>
<h4 id="Mounting-a-Filesystem">Mounting a Filesystem</h4>
<p>On Unix, the process of attaching a filesystem is called <code>mounting</code>. When the system boots, the kernel reads some configuration data and mounts root (/) based on the configuration data.</p>
<p>When mounting a filesystem, the common terminology is <em>mount a device on a mount point.</em></p>
<p>To see current system mount status:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mount </span><br><span class="line">...</span><br><span class="line">cgroup on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)</span><br><span class="line">/dev/mapper/rhel-root on / type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">mqueue on /dev/mqueue type mqueue (rw,relatime)</span><br><span class="line">hugetlbfs on /dev/hugepages type hugetlbfs (rw,relatime)</span><br><span class="line">/dev/vda1 on /boot type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">tmpfs on /run/user/0 type tmpfs (rw,nosuid,nodev,relatime,size=800956k,mode=700)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>There are 3 key fields:</p>
<ul>
<li>The filesystem’s device, such as a disk partition; where the actual file-system data resides</li>
<li>The filesystem type</li>
<li>The mount point—that is, the place in the current system’s directory hierarchy where the filesystem will be attached.</li>
</ul>
<p>For example, to mount the Fourth Extended filesystem /dev/sdf2 on /home/extra, use this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t ext4 /dev/sdf2 /home/extra</span><br></pre></td></tr></table></figure>
<p>To unmount (detach) a filesystem, use the umount command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount mountpoint</span><br></pre></td></tr></table></figure>
<h4 id="Filesystem-UUID">Filesystem UUID</h4>
<p>You can identify and mount filesystems by their <code>Universally Unique Identifier (UUID)</code>, a software standard. The UUID is a type of serial number, and each one should be different.</p>
<p>For example, if you know the UUID of /dev/sdf2 is a9011c2b-1c03-4288-b3fe-8ba961ab0898, so you can mount it as:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount UUID=a9011c2b-1c03-4288-b3fe-8ba961ab0898 /home/extra</span><br></pre></td></tr></table></figure>
<p>Here no <code>-t  ext4</code> option, because mount know that.</p>
<p>To view a list of devices and the corresponding filesystems and UUIDs on your system, use the blkid (block ID) program:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">blkid</span><br><span class="line"></span><br><span class="line">/dev/sdf2: UUID=&quot;a9011c2b-1c03-4288-b3fe-8ba961ab0898&quot; TYPE=&quot;ext4&quot;</span><br><span class="line">/dev/sda1: UUID=&quot;70ccd6e7-6ae6-44f6-812c-51aab8036d29&quot; TYPE=&quot;ext4&quot;</span><br><span class="line">/dev/sda5: UUID=&quot;592dcfd1-58da-4769-9ea8-5f412a896980&quot; TYPE=&quot;swap&quot;</span><br><span class="line">/dev/sde1: SEC_TYPE=&quot;msdos&quot; UUID=&quot;3762-6138&quot; TYPE=&quot;vfat&quot;</span><br></pre></td></tr></table></figure>
<p>For one thing, they’re the preferred way to automatically mount filesystems in <code>/etc/fstab</code> at boot time.</p>
<h4 id="Disk-Buffering-Caching-and-Filesystems">Disk Buffering, Caching, and Filesystems</h4>
<p>Linux, like other versions of Unix, buffers writes to the disk. This means that the kernel usually doesn’t immediately write changes to filesystems when processes request changes. <strong>Instead it stores the changes in RAM until the kernel can conveniently make the actual change to the disk</strong>. This buffering system is transparent to the user and improves performance.</p>
<blockquote>
<p>This is the reason why before we remove the USB, we need to unmount it in case of data lose.</p>
</blockquote>
<p>When you unmount a filesystem with umount, the kernel automatically synchronizes with the disk. At any other time, you can force the kernel to write the changes in its buffer to the disk by running the <code>sync</code> command.</p>
<h4 id="The-etc-fstab-Filesystem-Table">The /etc/fstab Filesystem Table</h4>
<p>I encounter this when write <code>/etc/fstab</code> file with NFS when developing k8s.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/dev/mapper/rhel-root   /                       xfs     defaults        0 0</span><br><span class="line">UUID=a44461e9-e1d7-45fd-a387-255fafd14746 /boot                   xfs     defaults        0 0</span><br><span class="line">/dev/mapper/rhel-swap   swap                    swap    defaults        0 0</span><br><span class="line">halos1.fyre.ibm.com:/data /mnt nfs defaults,timeo=10,retrans=3,rsize=1048576,wsize=1048576 0 0</span><br></pre></td></tr></table></figure>
<p>To mount filesystems at boot time and take the drudgery out of the mount command, Linux systems keep a permanent list of filesystems and options in <code>/etc/fstab</code>.</p>
<ul>
<li>
<p><code>The device or UUID</code>. Most current Linux systems no longer use the device in /etc/fstab, preferring the UUID.</p>
</li>
<li>
<p><code>The mount point</code>. Indicates where to attach the filesystem.</p>
</li>
<li>
<p><code>The filesystem type</code>.</p>
</li>
<li>
<p><code>Options</code>. Use long mount options separated by commas.</p>
</li>
<li>
<p><code>Backup information for use by the dump command</code>. You should always use a 0 in this field.</p>
</li>
<li>
<p><code>The filesystem integrity test order.</code> To ensure that fsck always runs on the root first, always set this to 1 for the root filesystem and 2 for any other filesystems on a hard disk. Use <code>0</code> to disable the bootup check for everything else, including CD-ROM drives, swap, and the /proc file-system</p>
</li>
</ul>
<p>You can also try to mount all entries at once in /etc/fstab that do not contain the noauto option with this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -a</span><br></pre></td></tr></table></figure>
<p>Let’s see some commonly use options:</p>
<ul>
<li>
<p><code>defaults</code>. This uses the mount defaults: read-write mode, enable device files, executables, the setuid bit, and so on. Use this when you don’t want to give the filesystem any special options but you do want to fill all fields in /etc/fstab.</p>
</li>
<li>
<p><code>noauto</code>. This option tells a mount -a command to ignore the entry.</p>
</li>
</ul>
<h4 id="Filesystem-Capacity">Filesystem Capacity</h4>
<p>To view the size and utilization of your currently mounted filesystems, use the <code>df</code> command.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">df -BM</span><br><span class="line"></span><br><span class="line">Filesystem                1M-blocks   Used Available Use% Mounted on</span><br><span class="line">/dev/mapper/rhel-root       245640M 75636M   170005M  31% /</span><br><span class="line">devtmpfs                      7931M     0M     7931M   0% /dev</span><br><span class="line">tmpfs                         7943M     0M     7943M   0% /dev/shm</span><br><span class="line">tmpfs                         7943M   835M     7109M  11% /run</span><br><span class="line">tmpfs                         7943M     0M     7943M   0% /sys/fs/cgroup</span><br><span class="line">/dev/vda1                     1014M   183M      832M  19% /boot</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="Checking-and-Repairing-Filesystems">Checking and Repairing Filesystems</h4>
<p>Filesystem errors are usually due to a user shutting down the system in a rude way (for example, by pulling out the power cord). In such cases, the filesystem cache in memory may not match the data on the disk, and the system also may be in the process of altering the filesystem when you happen to give the computer a kick. Although a new generation of filesystems supports journals to make filesystem corruption far less common, you should always shut the system down properly. And regardless of the filesystem in use, filesystem checks are still necessary every now and to maintain sanity.</p>
<p>The tool to check a filesystem is <code>fsck</code>.</p>
<p>In the worst cases, you can try:</p>
<ul>
<li>
<p>You can try to extract the entire filesystem image from the disk with <code>dd</code> and transfer it to a partition on another disk of the same size.</p>
</li>
<li>
<p>You can try to patch the filesystem as much as possible, mount it in read-only mode, and salvage what you can.</p>
</li>
<li>
<p>You can try <code>debugfs</code>.</p>
</li>
</ul>
<h4 id="Special-Purpose-Filesystems">Special-Purpose Filesystems</h4>
<p>Not all filesystems represent storage on physical media. Specifically, most versions of Unix have filesystems that serve as system interfaces. That is, rather than serving only as a means to store data on a device, a filesystem can represent system information such as process IDs and kernel diagnostics.</p>
<p>The special filesystem types in common use on Linux include the following:</p>
<ul>
<li>
<p><code>proc</code>. Mounted on /proc. The name proc is actually an abbreviation for process. Each numbered directory inside /proc is actually the process ID of a current process on the system; the files in those directories represent various aspects of the processes. The file /proc/self represents the current process.</p>
</li>
<li>
<p><code>sysfs</code>. Mounted on /sys.</p>
</li>
<li>
<p><code>tmpfs</code>. Mounted on /run and other locations. With tmpfs, you can use your physical memory and swap space as temporary storage, stored in volatile memory instead of a persistent storage device.</p>
</li>
</ul>
<h3 id="Swap-Space">Swap Space</h3>
<p>Not every partition on a disk contains a filesystem. It’s also possible to augment the RAM on a machine with disk space. The disk area used to store memory pages is called <code>swap space</code> (or just swap for short).</p>
<p>you can use <code>free</code> command to see the swap usage:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">free -m</span><br><span class="line"></span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:          32010       10894        3992        1605       17123       18811</span><br><span class="line">Swap:          8063          64        7999</span><br></pre></td></tr></table></figure>
<p>you can use a disk partition and a regular file as swap space, for disk:</p>
<ol>
<li>Ensure partition is empty</li>
<li>Run <code>mkswap dev</code>, dev is the partition device</li>
<li>Execute <code>swapon dev</code> to register the space with the kernel.</li>
<li>Register in <code>/etc/fstab</code> file</li>
</ol>
<p>Use these commands to create an empty file, initialize it as swap, and add it to the swap pool:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/zero of=swap_file bs=1024k count=num_mb</span><br><span class="line">mkswap swap_file</span><br><span class="line">swapon swap_file</span><br></pre></td></tr></table></figure>
<p>Here, <code>swap_file</code> is the name of the new swap file, and <code>num_mb</code> is the desired size, in megabytes.</p>
<p>To remove a swap partition or file from the kernel’s active pool, use the <code>swapoff</code> command.</p>
<p><strong>Note</strong> some administrators configure certain systems with <strong>no</strong> swap space at all. For example, high-performance network servers should never dip into swap space and should avoid disk access if at all possible.</p>
<p>It’s dangerous to do this on a general-purpose machine. If a machine completely runs out of both real memory and swap space, the Linux kernel invokes the <code>out-of-memory (OOM)</code> killer to kill a process in order to free up some memory. You obviously don’t want this to happen to your desktop applications. On the other hand, high-performance servers include sophisticated monitoring and load-balancing systems to ensure that they never reach the danger zone.</p>
<h3 id="Looking-Forward-Disks-and-User-Space">Looking Forward: Disks and User Space</h3>
<p>In disk-related components on a Unix system, the boundaries between user space and the kernel can be difficult to characterize. As you’ve seen, the kernel handles raw block I/O from the devices, and user-space tools can use the block I/O through device files. However, user space typically uses the block I/O only for initializing operations such as partitioning, file-system creation, and swap space creation.</p>
<p>In normal use, user space uses only the filesystem support that the kernel provides on top of the block I/O.</p>
<h2 id="Chapter-5-How-the-Linux-Kernel-Boots">Chapter 5. How the Linux Kernel Boots</h2>
<p>You’ll learn how the kernel moves into memory up to the point where the first user process starts.</p>
<p><strong>A simplified view of the boot process looks like this:</strong></p>
<ol>
<li>The machine’s BIOS or boot firmware loads and runs a boot loader.</li>
<li>The boot loader finds the kernel image on disk, loads it into memory, and starts it.</li>
<li>The kernel initializes the devices and its drivers.</li>
<li>The kernel mounts the root filesystem.</li>
<li>The kernel starts a program called init with a process ID of 1. This point is the user space start.</li>
<li>init sets the rest of the system processes in motion.</li>
<li>At some point, init starts a process allowing you to log in, usually at the end or near the end of the boot.</li>
</ol>
<h3 id="Startup-Messages">Startup Messages</h3>
<p>There are two ways to view the kernel’s boot and runtime diagnostic messages:</p>
<ul>
<li>
<p>Look at the kernel system log file. You’ll often find this in <code>/var/log/ kern.log</code>, but depending on how your system is configured, it might also be lumped together with a lot of other system logs in <code>/var/log/messages</code> or elsewhere.</p>
</li>
<li>
<p>Use the <code>dmesg</code> command, but be sure to pipe the output to less because there will be much more than a screen’s worth. The <code>dmesg</code> command uses the kernel ring buffer, which is of limited size, but most newer kernels have a large enough buffer to hold boot messages for a long time.</p>
</li>
</ul>
<h3 id="Kernel-Initialization-and-Boot-Options">Kernel Initialization and Boot Options</h3>
<p>Upon startup, the Linux kernel initializes in this general order:</p>
<ol>
<li>CPU inspection</li>
<li>Memory inspection</li>
<li>Device bus discovery</li>
<li>Device discovery</li>
<li>Auxiliary kernel subsystem setup (networking, and so on)</li>
<li>Root filesystem mount</li>
<li>User space start</li>
</ol>
<p>The following memory management messages are a good indication that the user-space handoff is about to happen because this is where the kernel protects its own memory from user-space processes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[    0.972934] Freeing unused kernel memory: 1844k freed</span><br><span class="line">[    0.973411] Write protecting the kernel read-only data: 12288k</span><br><span class="line">[    0.975623] Freeing unused kernel memory: 832k freed</span><br><span class="line">[    0.977405] Freeing unused kernel memory: 676k freed</span><br></pre></td></tr></table></figure>
<h3 id="Kernel-Parameters">Kernel Parameters</h3>
<p>I just encountered an issue about kernel parameters for Db2… Let’s see.</p>
<p>When running the Linux kernel, the boot loader passes in a set of text-based <strong>kernel parameters</strong> that tell the kernel how it should start. The parameters specify many different types of behavior, such as the amount of diagnostic output the kernel should produce and device driver–specific options.</p>
<p>You can view the kernel parameters from your system’s boot by looking at the <code>/proc/cmdline</code> file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BOOT_IMAGE=/vmlinuz-3.10.0-862.14.4.el7.x86_64 root=/dev/mapper/rhel-root ro crashkernel=auto rd.lvm.lv=rhel/root rd.lvm.lv=rhel/swap rhgb quiet elevator=noop LANG=en_US.UTF-8</span><br></pre></td></tr></table></figure>
<p>The <code>root=/dev/mapper/rhel-root</code> is where root filesystem resides.</p>
<h3 id="Boot-Loader">Boot Loader</h3>
<p><a href="https://searchdatacenter.techtarget.com/definition/boot-loader-boot-manager" target="_blank" rel="noopener">Other boot loader intro</a></p>
<p>At the start of the boot process, before the kernel and init start, a boot loader starts the kernel. The task of a boot loader sounds simple: It loads the kernel into memory, and then starts the kernel with a set of kernel parameters.</p>
<p>Kernel and its parameters are usually somewhere on the root filesystem.</p>
<p>On PCs, boot loaders use the <code>Basic Input/Output System (BIOS)</code> or <code>Unified Extensible Firmware Interface (UEFI)</code> to access disks. Nearly all disk hardware has firmware that allows the BIOS to access attached storage hardware with <code>Linear Block Addressing (LBA)</code>. Although it exhibits poor performance, this mode of access does allow universal access to disks. Boot loaders are often the only programs to use the BIOS for disk access; the kernel uses its own high-performance drivers.</p>
<p>Most modern boot loaders can read partition tables and have built-in support for read-only access to filesystems.</p>
<h4 id="Boot-loader-tasks">Boot loader tasks</h4>
<ol>
<li>Select among multiple kernels.</li>
<li>Switch between sets of kernel parameters.</li>
<li>Allow the user to manually override and edit kernel image names and parameters</li>
<li>Provide support for booting other operating systems.</li>
</ol>
<h4 id="Boot-loader-typres">Boot loader typres</h4>
<ul>
<li>GRUB. A near-universal standard on Linux systems (mainly talks about this)</li>
<li>LILO. One of the first Linux boot loaders.</li>
<li>LOADLIN. Boots a kernel from MS-DOS</li>
</ul>
<h3 id="GRUB-Introduction">GRUB Introduction</h3>
<p>GRUB stands for Grand Unified Boot Loader. We’ll cover GRUB 2.</p>
<p>This section talks about GRUB menu and look into some boot options, actually, if you check <code>/boot</code> directory, you will see kernel image file and initial RAM filesystem:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">-rwxr-xr-x. 1 root root  6381872 Mar 21  2018 vmlinuz-3.10.0-862.el7.x86_64</span><br><span class="line">-rw-r--r--. 1 root root   304926 Mar 21  2018 symvers-3.10.0-862.el7.x86_64.gz</span><br><span class="line">drwx------. 5 root root       97 Oct  1  2018 grub2</span><br><span class="line">-rw-------  1 root root 21096334 Oct  1  2018 initramfs-3.10.0-862.9.1.el7.x86_64.img</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Not interested in the rest of the content in this chapter.</p>
<h2 id="Chapter-6-How-User-Space-Starts">Chapter 6. How User Space Starts</h2>
<p>The point where the kernel starts its first user-space process, init, is significant—not just because that’s where the memory and CPU are finally ready for normal system operation, but because that’s where you can see how the rest of the system builds up as a whole.</p>
<p>User space is far more modular. It’s much easier to see what goes into the user space startup and operation.</p>
<p>User space starts in roughly this order:</p>
<ol>
<li>init</li>
<li>Essential low-level services such as udevd and syslogd</li>
<li>Network configuration</li>
<li>Mid- and high-level services (cron, printing, and so on)</li>
<li>Login prompts, GUIs, and other high-level applications</li>
</ol>
<h3 id="Introduction-to-init">Introduction to init</h3>
<p><a href="https://en.wikipedia.org/wiki/Init" target="_blank" rel="noopener">wiki init</a></p>
<p>The init program is a <strong>user-space program</strong> like any other program on the Linux system, and you’ll find it in <code>/sbin</code> along with many of the other system binaries. Its main purpose is to start and stop the essential service processes on the system, but newer versions have more responsibilities.</p>
<p>In my vm <code>/sbin</code> directory:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lrwxrwxrwx  1 root root          22 Oct  1  2018 init -&gt; ../lib/systemd/systemd</span><br></pre></td></tr></table></figure>
<p>There are three major implementations of init in Linux distributions:</p>
<ul>
<li><code>System V</code> init. A traditional sequenced init (Sys V, usually <em>pronounced “sys-five”</em>). Red Hat Enterprise Linux and several other distributions use this version.</li>
<li><code>systemd</code>. The emerging standard for init. Many distributions have moved to systemd, and most that have not yet done so are planning to move to it.</li>
<li><code>Upstart</code>. The init on Ubuntu installations. However, as of this writing, Ubuntu has also planned to migrate to systemd.</li>
</ul>
<p>There are many different implementations of init because <code>System V</code> init and other older versions relied on a sequence that performed only one startup task at a time. <code>systemd</code> and <code>Upstart</code> attempt to remedy the performance issue by allowing many services to start in parallel thereby speeding up the boot process.</p>
<h3 id="System-V-Runlevels">System V Runlevels</h3>
<p><a href="https://en.wikipedia.org/wiki/Runlevel" target="_blank" rel="noopener">wiki Runlevel</a></p>
<p>At any given time on a Linux system, a certain base set of processes is running. In System V init, this state of the machine is called its <code>runlevel</code>, which is denoted by a number from 0 through 6. A system spends most of its time in a single runlevel, but when you shut the machine down, init switches to a different runlevel in order to terminate the system services in an orderly fashion and to tell the kernel to stop.</p>
<p>You can check your system’s runlevel with the <code>who -r</code> command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">who -r</span><br><span class="line"></span><br><span class="line">run-level 3  2019-04-17 13:49</span><br></pre></td></tr></table></figure>
<p>Runlevels serve various purposes, but the most common one is to distinguish between system startup, shutdown, single-user mode, and console mode states.</p>
<p>But runlevels are becoming a thing of the past. Even though all three init versions in this book support them, systemd and Upstart consider runlevels obsolete as end states for the system.</p>
<h3 id="Identifying-Your-init">Identifying Your init</h3>
<ul>
<li>
<p>If your system has /usr/lib/systemd and /etc/systemd directories, you have systemd.</p>
</li>
<li>
<p>If you have an /etc/init directory that contains several .conf files, you’re probably running Upstart</p>
</li>
<li>
<p>If neither of the above is true, but you have an /etc/inittab file, you’re probably running System V init.</p>
</li>
</ul>
<p><strong>Here I focus on systemd</strong></p>
<h3 id="systemd">systemd</h3>
<p>The systemd init is one of the newest init implementations on Linux. In addition to handling the regular boot process, systemd aims to incorporate a number of standard Unix services such as cron and inetd. One of its most significant features is its ability to defer the start of services and operating system features until they are necessary.</p>
<p>Let’s outline what happens when systemd runs at boot time:</p>
<ol>
<li>systemd loads its configuration.</li>
<li>systemd determines its boot goal, which is usually named default.target.</li>
<li>systemd determines all of the dependencies of the default boot goal, dependencies of these dependencies, and so on.</li>
<li>systemd activates the dependencies and the boot goal.</li>
<li>After boot, systemd can react to system events (such as uevents) and activate additional components.</li>
</ol>
<h4 id="Units-and-Unit-Types">Units and Unit Types</h4>
<p>One of the most interesting things about <code>systemd</code> is that it does not just operate processes and services; it can also mount filesystems, monitor network sockets, run timers, and more. Each type of capability is called a <code>unit type</code>, and each specific capability is called a <code>unit</code>. When you turn on a unit, you activate it.</p>
<p>The default boot goal is usually a <code>target unit</code> that groups together a number of <code>service</code> and <code>mount</code> units as dependencies.</p>
<p><a href="https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files" target="_blank" rel="noopener">understand systemd unit and unit files</a></p>
<h4 id="systemd-Dependencies">systemd Dependencies</h4>
<p>To accommodate the need for flexibility and fault tolerance, systemd offers a myriad of dependency types and styles:</p>
<ul>
<li>
<p><code>Requires</code> Strict dependencies. When activating a unit with a Requires dependency unit, systemd attempts to activate the dependency unit. If the dependency unit fails, systemd deactivates the dependent unit.</p>
</li>
<li>
<p><code>Wants</code>. Dependencies for activation only. Upon activating a unit, systemd activates the unit’s Wants dependencies, but it doesn’t care if those dependencies fail.</p>
</li>
<li>
<p><code>Requisite</code>. Units that must already be active.</p>
</li>
<li>
<p><code>Conflicts</code>. Negative dependencies. When activating a unit with a Conflict dependency, systemd automatically deactivates the dependency if it is active.</p>
</li>
</ul>
<p>There are many other dependency syntax, like ordering, conditional, etc…</p>
<h4 id="systemd-Configuration">systemd Configuration</h4>
<p>The systemd configuration files are spread among many directories across the system, so you typically won’t find the files for all of the units on a system in one place.</p>
<p>That said, there are two main directories for systemd configuration: the system unit directory (globally configured, usually <code>/usr/lib/systemd/system</code>) and a system configuration directory (local definitions, usually <code>/etc/systemd/system</code>).</p>
<blockquote>
<p>Note: Avoid making changes to the system unit directory because your distribution will maintain it for you. Make your local changes to the system configuration directory.</p>
</blockquote>
<p>To see the system unit and configuration directories on your system, use the following commands:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkg-config systemd --variable=systemdsystemunitdir</span><br></pre></td></tr></table></figure>
<p>Let’s see Unit files in <code>/usr/lib/systemd/system</code>, there is a sshd.service file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=OpenSSH server daemon</span><br><span class="line">Documentation=man:sshd(8) man:sshd_config(5)</span><br><span class="line">After=network.target sshd-keygen.service</span><br><span class="line">Wants=sshd-keygen.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/etc/sysconfig/sshd</span><br><span class="line">ExecStart=/usr/sbin/sshd -D $OPTIONS</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=42s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>The [Unit] section gives some details about the unit and contains description and dependency information.</p>
<p>You’ll find the details about the service in the [Service] section, including how to prepare, start, and reload the service.</p>
<p>During normal operation, systemd ignores the [Install] section. However, consider the case when sshd.service is disabled on your system and you would like to turn it on. When you enable a unit, systemd reads the [Install] section.</p>
<p>The [Install] section is usually responsible for the the .wants and .requires directories in the system configuration directory (<code>/etc/systemd/system</code>), see:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">basic.target.wants                                       getty.target.wants           remote-fs.target.wants</span><br><span class="line">default.target                                           local-fs.target.wants        sockets.target.wants</span><br><span class="line">default.target.wants                                     multi-user.target.wants      sysinit.target.wants</span><br><span class="line">dev-virtio\x2dports-org.qemu.guest_agent.0.device.wants  network-online.target.wants  system-update.target.wants</span><br></pre></td></tr></table></figure>
<p>the $OPTIONS in unit file is the variable, also specifier is another variable-like feature often found in unit files, like %n and %H.</p>
<h3 id="systemd-Operation">systemd Operation</h3>
<p>You’ll interact with systemd primarily through the <code>systemctl</code> command, which allows you to activate and deactivate services, list status, reload the configuration, and much more.</p>
<p>List of active units:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl</span><br><span class="line"></span><br><span class="line">  UNIT                                           LOAD   ACTIVE SUB       DESCRIPTION</span><br><span class="line">...</span><br><span class="line">  sys-kernel-debug.mount                         loaded active mounted   Debug File System</span><br><span class="line">  var-lib-nfs-rpc_pipefs.mount                   loaded active mounted   RPC Pipe File System</span><br><span class="line">  brandbot.path                                  loaded active waiting   Flexible branding</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>List all units, includes inactives:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl --all</span><br></pre></td></tr></table></figure>
<p>Get status of a unit:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status sshd.service</span><br></pre></td></tr></table></figure>
<p>To activate, deactivate, and restart units, use the systemd <code>start</code>, <code>stop</code>, and <code>restart</code> commands. However, if you’ve changed a unit configuration file, you can tell systemd to reload the file in one of two ways:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reload unit #Reloads just the configuration for unit.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload #Reloads all unit configurations.</span><br></pre></td></tr></table></figure>
<h4 id="systemd-Process-Tracking-and-Synchronization">systemd Process Tracking and Synchronization</h4>
<p>systemd wants a reasonable amount of information and control over every process that it starts. The main problem that it faces is that a service can start in different ways; it may fork new instances of itself or even daemonize and detach itself from the original process.</p>
<p>To minimize the work that a package developer or administrator needs to do in order to create a working unit file, systemd uses <code>control groups (cgroups)</code>, an optional Linux kernel feature that allows for finer tracking of a process hierarchy.</p>
<h4 id="systemd-On-Demand-and-Resource-Parallelized-Startup">systemd On-Demand and Resource-Parallelized Startup</h4>
<p>One of systemd’s most significant features is its ability to delay a unit startup until it is absolutely needed.</p>
<h4 id="systemd-Auxiliary-Programs">systemd Auxiliary Programs</h4>
<p>When starting out with systemd, you may notice the exceptionally large number of programs in <code>/lib/systemd</code>. These are primarily support programs for units. For example, <code>udevd</code> is part of systemd, and you’ll find it there as <code>systemd-udevd</code>. Another, the <code>systemd-fsck</code> program, works as a middleman between systemd and fsck.</p>
<h3 id="Shutting-Down-Your-System">Shutting Down Your System</h3>
<p>init controls how the system shuts down and reboots. The commands to shut down the system are the same regardless of which version of init you run. The proper way to shut down a Linux machine is to use the <code>shutdown</code> command.</p>
<p>to shutdown machine immediately:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -h now</span><br></pre></td></tr></table></figure>
<p>to reboot the machine now:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -r now</span><br></pre></td></tr></table></figure>
<p>When system shutdown time finally arrives, shutdown tells init to begin the shutdown process. On systemd, it means activating the shutdown units; and on System V init, it means changing the runlevel to 0 or 6.</p>
<h3 id="The-Initial-RAM-Filesystem">The Initial RAM Filesystem</h3>
<p>The <code>initramfs</code> is in <code>/boot</code> directory.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ls -ltr | grep init</span><br><span class="line"></span><br><span class="line">-rw-------. 1 root root 55376391 Apr 13  2018 initramfs-0-rescue-e57cfe9136e9430587366e04f14195e1.img</span><br><span class="line">-rw-------. 1 root root 13131435 Apr 13  2018 initramfs-3.10.0-862.el7.x86_64kdump.img</span><br><span class="line">-rw-------  1 root root 21098233 Jul 23  2018 initramfs-3.10.0-862.el7.x86_64.img</span><br><span class="line">-rw-------  1 root root 21134858 Oct  1  2018 initramfs-3.10.0-862.14.4.el7.x86_64.img</span><br><span class="line">-rw-------  1 root root 21096334 Oct  1  2018 initramfs-3.10.0-862.9.1.el7.x86_64.img</span><br></pre></td></tr></table></figure>
<p>The problem stems from the availability of many different kinds of storage hardware. Remember, the Linux kernel does not talk to the PC BIOS or EFI interfaces to get data from disks, so in order to mount its root file-system, it needs driver support for the underlying storage mechanism.</p>
<p>The workaround is to gather a small collection of kernel driver modules along with a few other utilities into an archive. The boot loader loads this archive into memory before running the kernel.</p>
<h2 id="Chapter-7-System-Configuration">Chapter 7. System Configuration</h2>
<p>When you first look in the <code>/etc</code> directory, you might feel a bit overwhelmed. Although most of the files that you see affect a system’s operations to some extent, a few are fundamental.</p>
<h3 id="The-Structure-of-etc">The Structure of /etc</h3>
<p>Most system configuration files on a Linux system are found in <code>/etc</code>. Historically, each program had one or more configuration files there, and because there are so many packages on a Unix system, /etc would accumulate files quickly.</p>
<p>The trend for many years now has been to place system configuration files into subdirectories under <code>/etc</code>. There are still a few individual configuration files in /etc, but for the most part, if you run <code>ls -F /etc</code>, you’ll see that most of the items there are now subdirectories.</p>
<p>What kind of configuration files are found in <code>/etc</code>? The basic guideline is that customizable configurations for a single machine. And you’ll often find that noncustomizable system configuration files may be found elsewhere, as with the prepackaged systemd unit files in <code>/usr/lib/systemd</code>.</p>
<h3 id="System-Logging">System Logging</h3>
<p>Most system programs write their diagnostic output to the <code>syslog</code> service. The traditional syslogd daemon waits for messages and, depending on the type of message received, funnels the output to a file, the screen, users, or some combination of these, or just ignores it.</p>
<h4 id="The-System-Logger">The System Logger</h4>
<p>Most Linux distributions run a new version of syslogd called <code>rsyslogd</code> that does much more than simply write log messages to files. For example, in my vm:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl status rsyslog</span><br><span class="line"></span><br><span class="line">   rsyslog.service - System Logging Service</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/rsyslog.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Wed 2019-04-17 13:49:14 PDT; 2 weeks 6 days ago</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Many of the files in <code>/var/log</code> aren’t maintained by the system logger. The only way to know for sure which ones belong to rsyslogd is to look at its configuration file.</p>
<h4 id="Configuration-Files">Configuration Files</h4>
<p>The base rsyslogd configuration file is <code>/etc/rsyslog.conf</code>, but you’ll find certain configurations in other directories, such as <code>/etc/rsyslog.d</code>.</p>
<p>It talks about the syntax in the configuration file:
The configuration format is a blend of traditional rules and <code>rsyslog-specific</code> extensions. One rule of thumb is that anything beginning with a dollar sign ($) is an extension.</p>
<h3 id="User-Management-Files">User Management Files</h3>
<p>Unix systems allow for multiple independent users. At the kernel level, users are simply numbers (user IDs).</p>
<h4 id="The-etc-passwd-File">The /etc/passwd File</h4>
<p>The plaintext file /etc/passwd maps usernames to user IDs.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:Superuser:/root:/bin/sh</span><br><span class="line">######</span><br><span class="line">daemon:*:1:1:daemon:/usr/sbin:/bin/sh</span><br><span class="line">#or</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">######</span><br><span class="line">bin:*:2:2:bin:/bin:/bin/sh</span><br><span class="line">sys:*:3:3:sys:/dev:/bin/sh</span><br><span class="line">nobody:*:65534:65534:nobody:/home:/bin/false</span><br><span class="line">juser:x:3119:1000:J. Random User:/home/juser:/bin/bash</span><br><span class="line">beazley:x:143:1000:David Beazley:/home/beazley:/bin/bash</span><br></pre></td></tr></table></figure>
<p>The fields are as follows:</p>
<ul>
<li>
<p>The username.</p>
</li>
<li>
<p>The user’s encrypted password. On most Linux systems, the password is not actually stored in the <code>passwd</code> file, but rather, in the <code>shadow</code> file . Normal users do not have read permission for shadow. The second field in <code>passwd</code> or <code>shadow</code> is the encrypted password, Unix passwords are never stored as clear text.</p>
</li>
<li>
<p>An <code>x</code> in the second passwd file field indicates that the encrypted password is stored in the <code>shadow</code> file. A <code>*</code> indicates that the user cannot log in, and if the field is blank (that is, you see two colons in a row, like ::), no password is required to log in. (Beware of blank passwords. You should never have a user without a password.)</p>
</li>
<li>
<p>The user ID (UID), which is the user’s representation in the kernel.</p>
</li>
<li>
<p>The group ID (GID). This should be one of the numbered entries in the <code>/etc/group</code> file. Groups determine file permissions and little else. This group is also called the user’s <code>primary</code> group.</p>
</li>
<li>
<p>The user’s real name. You’ll sometimes find commas in this field, denoting room and telephone numbers.</p>
</li>
<li>
<p>The user’s home directory.</p>
</li>
<li>
<p>The user’s shell (the program that runs when the user runs a terminal session).</p>
</li>
</ul>
<h4 id="Special-Users">Special Users</h4>
<p>The superuser (root) always has UID 0 and GID 0. Some users, such as daemon, have no login privileges. The nobody user is an underprivileged user. Some processes run as nobody because the nobody user cannot write to anything on the system.</p>
<p>The users that cannot log in are called <code>pseudo-users</code>. Although they can’t log in, the system can start processes with their user IDs. Pseudo-users such as nobody are usually created for security reasons.</p>
<h4 id="The-etc-shadow-File">The /etc/shadow File</h4>
<p>The shadow password file <code>/etc/shadow</code> on a Linux system normally contains user authentication information, including the encrypted passwords and password expiration information that correspond to the users in <code>/etc/passwd</code>.</p>
<p>Regular users interact with <code>/etc/passwd</code> using the <code>passwd</code> command. By default, <code>passwd</code> changes the user’s password. The <code>passwd</code> command is an <code>suid-root</code> program, because only the superuser can change the <code>/etc/passwd</code> file.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rwsr-xr-x. 1 root root 27832 Jan 29  2014 /usr/bin/passwd</span><br></pre></td></tr></table></figure>
<blockquote>
<p>in <code>/etc/shells</code> file have multiple shell types:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; /bin/sh</span><br><span class="line">&gt; /bin/bash</span><br><span class="line">&gt; /sbin/nologin</span><br><span class="line">&gt; /usr/bin/sh</span><br><span class="line">&gt; /usr/bin/bash</span><br><span class="line">&gt; /usr/sbin/nologin</span><br><span class="line">&gt; /bin/ksh</span><br><span class="line">&gt; /bin/rksh</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>Because /etc/passwd is plaintext, the superuser may use any text editor to make changes. To add a user, simply add an appropriate line and create a home directory for the user; to delete, do the opposite. However, to edit the file, you’ll most likely want to use the <code>vipw</code> program</p>
<p>Use <code>adduser</code> and <code>userde</code>l to add and remove users. Run <code>passwd user</code> as the superuser.</p>
<h4 id="Working-with-Groups">Working with Groups</h4>
<p>Groups in Unix offer a way to <strong>share</strong> files with certain users but deny access to all others. The idea is that you can set read or write permission bits for a particular group, excluding everyone else.</p>
<p>The <code>/etc/group</code> file defines the group IDs:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root:*:0:juser</span><br><span class="line">daemon:*:1:</span><br><span class="line">bin:*:2:</span><br><span class="line">disk:*:6:juser,beazley</span><br><span class="line">nogroup:*:65534:</span><br><span class="line">user:*:1000:</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>The group name.</p>
</li>
<li>
<p>The group password. This is hardly ever used, nor should you use it. Use * or any other default value.</p>
</li>
<li>
<p>The group ID (a number). The GID must be unique within the group file. This number goes into a user’s group field in that user’s <code>/etc/passwd</code> entry.</p>
</li>
<li>
<p>An optional list of users that belong to the group. In addition to the users listed here, users with the corresponding group ID in their passwd file entries also belong to the group.</p>
</li>
</ul>
<blockquote>
<p>Linux distributions often create a new group for each new user added, with the same name as the user.</p>
</blockquote>
<h3 id="Setting-the-Time">Setting the Time</h3>
<p>Unix machines depend on accurate timekeeping. The kernel maintains the system clock, which is the clock that is consulted when you run commands like date.</p>
<p>PC hardware has a battery-backed <code>real-time clock (RTC)</code>. The RTC isn’t the best clock in the world, but it’s better than nothing. The kernel usually sets its time based on the RTC at boot time, and you can reset the system clock to the current hardware time with <code>hwclock</code>.</p>
<p>You should not try to fix the time drift with <code>hwclock</code> because time-based system events can get lost or mangled. Usually it’s best to keep your system time correct with a network time daemon.</p>
<h4 id="Network-Time">Network Time</h4>
<p>If your machine is permanently connected to the Internet, you can run a <code>Network Time Protocol (NTP)</code> daemon to maintain the time using a remote server. Many distributions have built-in support for an NTP daemon, but it may not be enabled by default. You might need to install an ntpd package to get it to work.</p>
<h3 id="Scheduling-Recurring-Tasks-with-cron">Scheduling Recurring Tasks with cron</h3>
<p>The Unix cron service runs programs repeatedly on a fixed schedule. Most experienced administrators consider cron to be <strong>vital</strong> to the system because it can perform automatic system maintenance. For example, cron runs log file rotation utilities to ensure that your hard drive doesn’t fill up with old log files. You should know how to use cron because it’s just plain useful.</p>
<blockquote>
<p>Also see <code>cronjob</code> in k8s <a href="https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/" target="_blank" rel="noopener">doc</a>.</p>
</blockquote>
<p>You can run any program with <code>cron</code> at whatever times suit you. The program running through cron is called a <code>cron job</code>. To install a cron job, you’ll create an entry line in your <code>crontab</code> file, usually by running the <code>crontab</code> command.</p>
<p>for example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">15 09 * * * /home/juser/bin/spmake</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>Minute (0 through 59). The cron job above is set for minute 15.</p>
</li>
<li>
<p>Hour (0 through 23). The job above is set for the ninth hour.</p>
</li>
<li>
<p>Day of month (1 through 31).</p>
</li>
<li>
<p>Month (1 through 12).</p>
</li>
<li>
<p>Day of week (0 through 7). The numbers 0 and 7 are Sunday.</p>
</li>
</ul>
<p>A <code>*</code> in any field means to match every value. The preceding example runs spmake daily because the day of month, month, and day of week fields are all filled with stars, which cron reads as “run this job every day, of every month, of every week.”</p>
<p>also can be 5th and the 14th day of each month:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">15 09 5,14 * * /home/juser/bin/spmake</span><br></pre></td></tr></table></figure>
<h4 id="Installing-Crontab-Files">Installing Crontab Files</h4>
<p>Each user can have his or her own crontab file, which means that every system may have multiple crontabs, usually found in <code>/var/spool/cron/</code> folder. the <code>crontab</code> command installs, lists, edits, and removes a user’s crontab.</p>
<p>The easiest way to install a crontab is to put your crontab entries into a file and then use <code>crontab file</code> to install file as your current crontab.</p>
<p>Actually, there is a default place for every user crontab file includes root. Once you create a crontab file for the user, the corresponding folder is put under /var/spool/cron/`.</p>
<p>For example, run as root, I want to set a recurring task for user <code>dsadm</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -u dsadm -e</span><br></pre></td></tr></table></figure>
<p>Then edit like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00 21 * * * /home/dsadm/test.sh &gt; /tmp/cron-log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>after run the job, go to <code>/tmp</code> folder you will see the log file.</p>
<p>to list the <code>dsadm</code> cron job:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -l -u dsadm</span><br></pre></td></tr></table></figure>
<p>to remove cron job for <code>dsadm</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -r -u dsadm</span><br></pre></td></tr></table></figure>
<h4 id="System-Crontab-Files">System Crontab Files</h4>
<p>Linux distributions normally have an <code>/etc/crontab</code> file. You can also edit here, but the format is a little bit difference:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Example of job definition:</span><br><span class="line"># .---------------- minute (0 - 59)</span><br><span class="line"># |  .------------- hour (0 - 23)</span><br><span class="line"># |  |  .---------- day of month (1 - 31)</span><br><span class="line"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span><br><span class="line"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span><br><span class="line"># |  |  |  |  |</span><br><span class="line"># *  *  *  *  * user-name  command to be executed</span><br></pre></td></tr></table></figure>
<h3 id="Understanding-User-IDs-and-User-Switching">Understanding User IDs and User Switching</h3>
<p>We’ve discussed how <code>setuid</code> programs such as <code>sudo</code> and <code>su</code> allow you to change users:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">---s--x--x 1 root root 143248 May 28  2018 /usr/bin/sudo</span><br><span class="line">-rwsr-xr-x 1 root root 32184 Jul 12  2018 /usr/bin/su</span><br></pre></td></tr></table></figure>
<p>In reality, every process has more than one user ID. When you run a setuid program, Linux sets the effective user ID to the program’s owner during execution, but it keeps your original user ID in the real user ID.</p>
<p>Think of the effective user ID as the actor and the real user ID as the owner. The real user ID defines the user that can interact with the running process—most significantly, which user can kill and send signals to a process. For example, if user A starts a new process that runs as user B (based on setuid permissions), user A still owns the process and can kill it.</p>
<p>On normal Linux systems, most processes have the <strong>same</strong> <code>effective user ID</code> and <code>real user ID</code>. I verify this by a <a href="http://test.sh" target="_blank" rel="noopener">test.sh</a> script run as<code> dsadm</code>, the euser and ruser are the same:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rwsr-xr-x 1 root  root        56 May 11 22:17 test.sh</span><br></pre></td></tr></table></figure>
<p>By default, <code>ps</code> and other system diagnostic programs show the <code>effective user ID</code>.</p>
<p>In conductor container, I run many su commands, you can see this, the euser and ruser are different:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ps -eo pid,euser,ruser,comm</span><br><span class="line"></span><br><span class="line">1574 root     dsadm    su</span><br><span class="line">2735 root     dsadm    su</span><br><span class="line">4535 root     dsadm    su</span><br></pre></td></tr></table></figure>
<h3 id="PAM">PAM</h3>
<p>In 1995 Sun Microsystems proposed a new standard called <code>Pluggable Authentication Modules (PAM)</code>, a system of shared libraries for authentication. To authenticate a user, an application hands the user to PAM to determine whether the user can successfully identify itself.</p>
<p>Because there are many kinds of authentication scenarios, PAM employs a number of dynamically <code>loadable authentication modules</code>. Each module performs a specific task; for example, the <code>pam_unix.so</code> module can check a user’s password.</p>
<h4 id="PAM-Configuration">PAM Configuration</h4>
<p>You’ll normally find PAM’s application configuration files in the <code>/etc/pam.d</code> directory (older systems may use a single <code>/etc/pam.conf</code> file).</p>
<p>Let’s see an example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth       requisite     pam_shells.so</span><br></pre></td></tr></table></figure>
<p>Each configuration line has three fields: <code>function type</code>, <code>control argument</code>, and <code>module</code>:</p>
<ul>
<li>
<p>Function type. The function that a user application asks PAM to perform. Here, it’s <code>auth</code>, the task of authenticating the user.</p>
</li>
<li>
<p>Control argument. This setting controls what PAM does after success or failure of its action for the current line (<code>requisite</code> in this example).</p>
</li>
<li>
<p>Module. The authentication module that runs for this line, determining what the line actually does. Here, the <code>pam_shells.so</code> module checks to see whether the user’s current shell is listed in <code>/etc/shells</code>.</p>
</li>
</ul>
<p>PAM configuration is detailed on the pam.conf(5) manual page:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man 5 pam.conf</span><br></pre></td></tr></table></figure>
<h2 id="Chapter-8-A-Closer-Look-at-Processes-and-Resource-Utilization">Chapter 8. A Closer Look at Processes and Resource Utilization</h2>
<p>This chapter takes you deeper into the relationships between processes, the kernel, and system resources.</p>
<p>Many of the tools that you see in this chapter are often thought of as performance-monitoring tools. They’re particularly helpful if your system is slowing to a crawl and you’re trying to figure out why.</p>
<h3 id="Tracking-Processes">Tracking Processes</h3>
<p>The <code>top</code> program is often more useful than <code>ps</code> because it displays the current system status as well as many of the fields in a <code>ps</code> listing, and it updates the display every second.</p>
<p>You can send commands to <code>top</code> with keystrokes. When you enter <code>top</code> command:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Tasks: <span class="number">382</span> total,   <span class="number">2</span> running, <span class="number">380</span> sleeping,   <span class="number">0</span> stopped,   <span class="number">0</span> zombie</span><br><span class="line">%Cpu(s):  <span class="number">1.2</span> us,  <span class="number">0.5</span> sy,  <span class="number">0.0</span> ni, <span class="number">96.4</span> id,  <span class="number">0.4</span> wa,  <span class="number">0.0</span> hi,  <span class="number">0.2</span> si,  <span class="number">1.3</span> st</span><br><span class="line">KiB Mem :  <span class="number">8009536</span> total,   <span class="number">441360</span> free,   <span class="number">930236</span> used,  <span class="number">6637940</span> buff/cache</span><br><span class="line">KiB Swap:        <span class="number">0</span> total,        <span class="number">0</span> free,        <span class="number">0</span> used.  <span class="number">6284448</span> avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"><span class="number">10438</span> root      <span class="number">20</span>   <span class="number">0</span>  <span class="number">519148</span> <span class="number">282140</span>  <span class="number">19392</span> S   <span class="number">4.6</span>  <span class="number">3.5</span> <span class="number">586</span>:<span class="number">19.28</span> kube-apiserver</span><br><span class="line"><span class="number">10449</span> root      <span class="number">20</span>   <span class="number">0</span>  <span class="number">275308</span>  <span class="number">80184</span>  <span class="number">14584</span> S   <span class="number">4.3</span>  <span class="number">1.0</span> <span class="number">516</span>:<span class="number">46.86</span> kube-controller</span><br><span class="line"> <span class="number">9691</span> root      <span class="number">20</span>   <span class="number">0</span> <span class="number">1648968</span> <span class="number">159104</span>  <span class="number">30708</span> S   <span class="number">2.6</span>  <span class="number">2.0</span> <span class="number">492</span>:<span class="number">06.83</span> kubelet</span><br><span class="line"><span class="number">10206</span> root      <span class="number">20</span>   <span class="number">0</span>   <span class="number">10.1</span>g  <span class="number">56568</span>   <span class="number">7760</span> S   <span class="number">2.0</span>  <span class="number">0.7</span> <span class="number">262</span>:<span class="number">08.45</span> etcd</span><br><span class="line"><span class="number">19459</span> root      <span class="number">20</span>   <span class="number">0</span>   <span class="number">82100</span>  <span class="number">53780</span>   <span class="number">9392</span> S   <span class="number">1.7</span>  <span class="number">0.7</span> <span class="number">209</span>:<span class="number">35.52</span> calico-node</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>If you see task %CPU is larger than 100, it must be a multi-thread and leverages multi-core. You can use <code>H</code> to toggle thread display rather than task, you will see multi-thead and each of them %CPU.</p>
<blockquote>
<p>Note: if you want to see memory in MB, GB… Typing <code>shift + e/E</code> cycle through.</p>
</blockquote>
<p>then type followings:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Spacebar:</span> <span class="string">Updates</span> <span class="string">the</span> <span class="string">display</span> <span class="string">immediately.</span></span><br><span class="line"><span class="attr">H:</span> <span class="string">show</span> <span class="string">threads</span> <span class="string">in</span> <span class="string">stead</span> <span class="string">of</span> <span class="string">tasks.</span></span><br><span class="line"><span class="attr">M:</span> <span class="string">Sorts</span> <span class="string">by</span> <span class="string">current</span> <span class="string">resident</span> <span class="string">memory</span> <span class="string">usage.</span></span><br><span class="line"><span class="attr">T:</span> <span class="string">Sorts</span> <span class="string">by</span> <span class="string">total</span> <span class="string">(cumulative)</span> <span class="string">CPU</span> <span class="string">usage.</span></span><br><span class="line"><span class="attr">P:</span> <span class="string">Sorts</span> <span class="string">by</span> <span class="string">current</span> <span class="string">CPU</span> <span class="string">usage</span> <span class="string">(the</span> <span class="string">default).</span></span><br><span class="line"><span class="attr">u:</span> <span class="string">Displays</span> <span class="string">only</span> <span class="string">one</span> <span class="string">user’s</span> <span class="string">processes.</span></span><br><span class="line"><span class="attr">f:</span> <span class="string">Selects</span> <span class="string">different</span> <span class="string">statistics</span> <span class="string">to</span> <span class="string">display</span> <span class="string">and</span> <span class="string">sort.</span> <span class="string">(use</span> <span class="string">arrow</span> <span class="string">to</span> <span class="string">move</span> <span class="string">and</span> <span class="string">space</span> <span class="string">to</span> <span class="string">select)</span></span><br><span class="line"><span class="string">?:</span> <span class="string">Displays</span> <span class="string">a</span> <span class="string">usage</span> <span class="string">summary</span> <span class="string">for</span> <span class="string">all</span> <span class="string">top</span> <span class="string">commands.</span></span><br></pre></td></tr></table></figure>
<h3 id="Finding-Open-Files-by-lsof">Finding Open Files by lsof</h3>
<p>One use for this command is when a disk cannot be unmounted because (unspecified) files are in use. The listing of open files can be consulted (suitably filtered if necessary) to identify the process that is using the files.</p>
<p>The <code>lsof</code> command lists open files and the processes using them. <code>lsof</code> doesn’t stop at regular files, it can list network resources, dynamic libraries, pipes, and more.</p>
<p>For example:
Display entries for open files in <code>/usr</code> directory and successors.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof /usr/*</span><br></pre></td></tr></table></figure>
<p>List open files for a particular PID:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -p 1623</span><br></pre></td></tr></table></figure>
<h3 id="Tracing-Program-Execution-and-System-Calls">Tracing Program Execution and System Calls</h3>
<p>The most common use is to start a program using <code>strace</code>, which prints a list of <code>system calls</code> made by the program. This is useful if the program continually crashes, or does not behave as expected; for example using strace may reveal that the program is attempting to access a file which does not exist or cannot be read.</p>
<p>The <code>strace</code> (system call trace) and <code>ltrace</code> (library trace) commands can help you discover what a program attempts to do. These tools produce extraordinarily large amounts of output, but once you know what to look for, you’ll have more tools at your disposal for tracking down problems.</p>
<p>For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strace cat not_a_file</span><br></pre></td></tr></table></figure>
<p>you get errors in <code>open(&quot;not_a_file&quot;, O_RDONLY)</code> line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">execve(&quot;/usr/bin/cat&quot;, [&quot;cat&quot;, &quot;not_a_file&quot;], [/* 23 vars */]) = 0</span><br><span class="line">brk(NULL)                               = 0x81f000</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fc85159d000</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">close(3)                                = 0</span><br><span class="line">fstat(1, &#123;st_mode=S_IFCHR|0620, st_rdev=makedev(136, 0), ...&#125;) = 0</span><br><span class="line">open(&quot;not_a_file&quot;, O_RDONLY)            = -1 ENOENT (No such file or directory)</span><br><span class="line">write(2, &quot;cat: &quot;, 5cat: )                    = 5</span><br><span class="line">write(2, &quot;not_a_file&quot;, 10not_a_file) </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="Threads">Threads</h3>
<p>In Linux, some processes are divided into pieces called threads.</p>
<p>To display the thread information in <code>ps</code>, add the m option.
For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps axm -o pid,tid,command</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PID   TID   COMMAND</span><br><span class="line">1891     - db2ckpwd 0</span><br><span class="line">    -  1891 -</span><br><span class="line">1892     - db2ckpwd 0</span><br><span class="line">    -  1892 -</span><br><span class="line">3501     - db2fmp ( ,1,0,0,0,0,0,00000000,0,0,0,0000000000000000,0000000000000000,00000000,00000000,00000000,0000000</span><br><span class="line">    -  3501 -</span><br><span class="line">    -  3502 -</span><br><span class="line">    -  3503 -</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>The main thread ID is the as the process ID</p>
<h3 id="Introduction-to-Resource-Monitoring">Introduction to Resource Monitoring</h3>
<p>To monitor one or more specific processes over time, use the <code>-p</code> option to <code>top</code>, with this syntax:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top -p &lt;pid&gt;</span><br></pre></td></tr></table></figure>
<h4 id="Adjusting-Process-Priorities">Adjusting Process Priorities</h4>
<p>You can change the way the kernel <strong>schedules</strong> a process in order to give the process more or less CPU time than other processes.</p>
<p>The kernel runs each process according to its scheduling priority, which is a number between <code>–20</code> and <code>20</code>, with <code>–20</code> being the <strong>foremost</strong> priority.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ps axl</span><br><span class="line"></span><br><span class="line">F   UID   PID  PPID PRI  NI    VSZ   RSS WCHAN  STAT TTY        TIME COMMAND</span><br><span class="line">4  1000     1     0  20   0  15120  1596 do_wai Ss   ?          0:00 /bin/bash /opt/IBM/InformationServer/initScripts</span><br><span class="line">4     0  1882     1  20   0 1225076 48936 futex_ Sl  ?          0:00 db2wdog 0 [db2inst1]</span><br><span class="line">4  1000  1884  1882  20   0 10302284 1699292 futex_ Sl ?       58:25 db2sysc 0</span><br><span class="line">5     0  1890  1882  20   0 1227236 18292 do_msg S   ?          0:13 db2ckpwd 0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">top</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 1884 db2inst1  20   0    9.8g   1.6g   1.6g S   1.3 10.4  58:25.82 db2sysc</span><br><span class="line">    1 db2inst1  20   0   15120   1596   1360 S   0.0  0.0   0:00.01 startcontainer.</span><br><span class="line"> 1882 root      20   0 1225076  48936  33072 S   0.0  0.3   0:00.13 db2syscr</span><br></pre></td></tr></table></figure>
<p><code>PR</code> is the priority value. <code>NI</code> (nice value), high nice value means nicer, more likely to give up CPU time.</p>
<p>Alter the nice value:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">renice &lt;value&gt; &lt;pid&gt;</span><br></pre></td></tr></table></figure>
<h4 id="Load-Averages">Load Averages</h4>
<p>The <code>load average</code> is the average number of processes currently ready to run. Keep in mind that most processes on your system are usually waiting for input (from the keyboard, mouse, or network, for example), meaning that most processes are not ready to run and should contribute nothing to the load average. Only processes that are actually doing something affect the load average.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># uptime</span></span><br><span class="line">... up 91 days, ... load average: 0.08, 0.03, 0.01</span><br></pre></td></tr></table></figure>
<p>The three numbers are the load averages for the past 1 minute, 5 minutes, and 15 minutes, respectively. An average of only 0.01 processes have been running across all processors for the past 15 minutes.</p>
<p>If a load average goes up to around 1, a single process is probably using the CPU nearly all of the time. To identify that process, use the top command; the process will usually rise to the the top of the display.</p>
<p>If you have two cores, a load average of 1 means that only one of the cores is likely active at any given time, and a load average of 2 means that both cores have just enough to do all of the time.</p>
<p>A high load average does not necessarily mean that your system is having trouble. A system with enough memory and I/O resources can easily handle many running processes. If your load average is high and your system still responds well, don’t panic</p>
<p>However, if you sense that the system is slow and the load average is high, you might be running into memory performance problems.</p>
<h3 id="Memory">Memory</h3>
<p>CPU has a <code>memory management unit (MMU)</code> that translates the virtual memory addresses used by processes into real ones. The kernel assists the MMU by breaking the memory used by processes into smaller chunks called <code>pages</code>.</p>
<p>The kernel maintains a data structure, called a <code>page table</code>, that contains a mapping of a processes’ virtual page addresses to real page addresses in memory. As a process accesses memory, the MMU translates the virtual addresses used by the process into real addresses based on the kernel’s page table.</p>
<p>A user process does not actually need all of its pages to be immediately available in order to run. The kernel generally loads and allocates pages as a process needs them; this system is known as <code>on-demand paging</code> or just <code>demand paging</code>.</p>
<h4 id="Page-Faults">Page Faults</h4>
<p>If a memory page is not ready when a process wants to use it, the process triggers a <code>page fault</code>.</p>
<ul>
<li>
<p>MINOR PAGE FAULTS
A minor page fault occurs when the desired page is actually in main memory but the MMU doesn’t know where it is. This can happen when the process requests more memory or when the MMU doesn’t have enough space to store all of the page locations for a process. In this case, the kernel tells the MMU about the page and permits the process to continue. Minor page faults aren’t such a big deal, and many occur as a process runs. Unless you need maximum performance from some memory-intensive program, you probably shouldn’t worry about them.</p>
</li>
<li>
<p>MAJOR PAGE FAULTS
A major page fault occurs when the desired memory page isn’t in main memory at all, which means that the <strong>kernel must load it from the disk or some other slow storage mechanism</strong>. Some major page faults are unavoidable, such as those that occur when you load the code from disk when running a program for the first time.</p>
</li>
</ul>
<p>Let’s see the page faults:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># /usr/bin/time netstat &gt; /dev/null</span><br><span class="line"></span><br><span class="line">0.05user 0.02system 0:01.74elapsed 4%CPU (0avgtext+0avgdata 2556maxresident)k</span><br><span class="line">1752inputs+0outputs (3major+781minor)pagefaults 0swaps</span><br></pre></td></tr></table></figure>
<p>There are 3 major page faults and 781 minor page faults when running <code>netstat</code> program. The major page faults occurred when the kernel needed to load the program from the disk for the first time. If you ran the command again, you probably wouldn’t get any major page faults because the kernel would have cached the pages from the disk:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># /usr/bin/time netstat &gt; /dev/null</span><br><span class="line"></span><br><span class="line">0.04user 0.02system 0:01.61elapsed 3%CPU (0avgtext+0avgdata 2552maxresident)k</span><br><span class="line">0inputs+0outputs (0major+783minor)pagefaults 0swaps</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note that <code>time</code> here is not the shell built-in <code>time</code> command! If you run</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; type -a time</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>you will see</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; time is a shell keyword</span><br><span class="line">&gt; time is /usr/bin/time</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>see this <a href="https://www.cyberciti.biz/faq/linux-command-to-see-major-minor-pagefaults/" target="_blank" rel="noopener">doc</a></p>
</blockquote>
<p>If you’d rather see the <strong>number</strong> of page faults of processes as they’re running, use <code>top</code> or <code>ps</code>. When running <code>top</code>, use <code>f</code> to add the displayed fields and space to display the <code>nMaj</code> and <code>nMin</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># top</span><br><span class="line"></span><br><span class="line">  PID USER      %CPU  PR  NI    VIRT    RES    SHR S %MEM     TIME+ COMMAND                                nMaj nMin</span><br><span class="line"> 1303 dsadm      1.7  20   0 4753196  82704  13412 S  0.5 158:31.05 java                                      0  25k</span><br><span class="line"> 1929 dsadm      0.3  20   0  203344   2556   2116 S  0.0   2:16.80 ResTrackApp                               0 1028</span><br></pre></td></tr></table></figure>
<p>When using <code>ps</code>, you can use a custom output format to view the page faults for a particular process:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ps -o pid,min_flt,maj_flt 1</span><br><span class="line"></span><br><span class="line">  PID  MINFL  MAJFL</span><br><span class="line">    1   2059      6</span><br></pre></td></tr></table></figure>
<h3 id="Monitoring-CPU-and-Memory-Performance">Monitoring CPU and Memory Performance</h3>
<p>Among the many tools available to monitor system performance, the <code>vmstat</code> command is one of the oldest, with minimal overhead. You’ll find it handy for getting a high-level view of how often the kernel is swapping pages in and out, how busy the CPU is, and IO utilization.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vmstat 2</span><br><span class="line"></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class="line"> 2  0      0 174452   1064 6874152    0    0    17    55    4    0  2  2 95  0  1</span><br><span class="line"> 2  0      0 173900   1064 6874168    0    0     0    16 10362 12869  5  3 90  0  2</span><br><span class="line"> 3  0      0 173932   1064 6874180    0    0     0   291 9110 10761  2  1 95  1  1</span><br><span class="line"> 0  0      0 174056   1064 6874180    0    0     0    59 9126 12447  3  3 92  0  1</span><br><span class="line"> 0  0      0 174228   1064 6874184    0    0     0   167 7100 9601  1  1 97  0  1</span><br></pre></td></tr></table></figure>
<p>Not easy to understand, can dig deeper into it by reading vmstat(8) manual page.</p>
<h3 id="I-O-Monitoring">I/O Monitoring</h3>
<p>Like <code>vmstat</code> and <code>netstat</code> (talk later), we have <code>iostat</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">iostat 2 -d -p ALL</span><br><span class="line"></span><br><span class="line">Linux 3.10.0-862.14.4.el7.x86_64 (dstest1.fyre.ibm.com)         05/21/2019      _x86_64_        (8 CPU)</span><br><span class="line"></span><br><span class="line">Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</span><br><span class="line">vda              18.12        87.72       201.61  270042131  620650624</span><br><span class="line">vda1              0.00         0.00         0.00      11165       2270</span><br><span class="line">vda2             13.59        87.71       201.61  270022634  620648353</span><br><span class="line">dm-0             17.99        86.13       201.61  265157850  620648353</span><br><span class="line">dm-1              0.06         1.58         0.00    4860836          0</span><br></pre></td></tr></table></figure>
<p>This means update every 2 seconds, show device only and show all partitions.</p>
<p>If you need to dig even deeper to see I/O resources used by individual processes, the <code>iotop</code> tool can help. Using <code>iotop</code> is similar to using top.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iotop</span><br><span class="line"></span><br><span class="line">Total DISK READ:         4.76 K/s | Total DISK WRITE:     333.31 K/s</span><br><span class="line">  TID  PRIO  USER       DISK READ DISK  WRITE  SWAPIN     IO&gt; COMMAND</span><br><span class="line">  260 be/3 root          0.00 B/s  38.09 K/s  0.00 %  6.98 % [jbd2/sda1-8]</span><br><span class="line"> 2611 be/4 juser         4.76 K/s  10.32 K/s  0.00 %  0.21 % zeitgeist-daemon</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<p>It shows TID (thread ID) instead of PID, PRIO (priority) indicates the IO priority, <code>be/3</code> is more important than <code>be/4</code>. The kernel uses the <code>scheduling class</code> to add more control for I/O scheduling. You’ll see three scheduling classes from <code>iotop</code>:</p>
<ul>
<li>
<p><strong>be</strong> Best-effort. The kernel does its best to fairly schedule I/O for this class. Most processes run under this I/O scheduling class.</p>
</li>
<li>
<p><strong>rt</strong> Real-time. The kernel schedules any real-time I/O before any other class of I/O, no matter what.</p>
</li>
<li>
<p><strong>idle</strong> Idle. The kernel performs I/O for this class only when there is no other I/O to be done. There is no priority level for the idle scheduling class.</p>
</li>
</ul>
<h3 id="Per-Process-Monitoring">Per-Process Monitoring</h3>
<p>The <code>pidstat</code> utility allows you to see the resource consumption of a process over time in the style of <code>vmstat</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># pidstat -p 27946 1</span><br><span class="line"></span><br><span class="line">Linux 3.10.0-862.14.4.el7.x86_64 (myk8s1.fyre.ibm.com)  05/21/2019      _x86_64_        (4 CPU)</span><br><span class="line"></span><br><span class="line">08:16:27 PM   UID       PID    %usr %system  %guest    %CPU   CPU  Command</span><br><span class="line">08:16:28 PM  1002     27946    0.00    0.00    0.00    0.00     3  tail</span><br><span class="line">08:16:29 PM  1002     27946    0.00    0.00    0.00    0.00     3  tail</span><br><span class="line">08:16:30 PM  1002     27946    0.00    0.00    0.00    0.00     3  tail</span><br></pre></td></tr></table></figure>
<p>The <code>CPU</code> column tells you about this process is running on which CPU.</p>
<h2 id="Chapter-9-Network-and-Configuration">Chapter 9. Network and Configuration</h2>
<blockquote>
<p>Note that the <code>ifconfig</code> command, as well some of the others you’ll see later in this chapter (such as <code>route</code> and <code>arp</code>), has been technically supplanted with the newer <code>ip</code> command. The ip command can do more than the old commands, and it is preferable when writing scripts. However, most people still use the old commands when manually working with the network, and these commands can also be used on other versions of Unix. For this reason, we’ll use the old-style commands.</p>
</blockquote>
<h3 id="Routes-and-the-Kernel-Routing-Table">Routes and the Kernel Routing Table</h3>
<p>Let’s see the routing table by <code>route</code> command, <code>-n</code> means show numerical address instead of hostname:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># route -n</span><br><span class="line"></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         9.30.94.1       0.0.0.0         UG    0      0        0 eth1</span><br><span class="line">9.30.94.0       0.0.0.0         255.255.254.0   U     0      0        0 eth1</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 eth0</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1003   0        0 eth1</span><br><span class="line">172.16.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">192.168.0.0     0.0.0.0         255.255.255.0   U     0      0        0 *</span><br><span class="line">192.168.0.2     0.0.0.0         255.255.255.255 UH    0      0        0 calib4daf4f1db0</span><br><span class="line">192.168.0.3     0.0.0.0         255.255.255.255 UH    0      0        0 cali987b4d0c33f</span><br><span class="line">192.168.1.0     172.16.182.156  255.255.255.0   UG    0      0        0 eth0</span><br><span class="line">192.168.2.0     172.16.182.187  255.255.255.0   UG    0      0        0 eth0</span><br></pre></td></tr></table></figure>
<p>The <code>Destination</code> column tells you a network prefix (outside network), and the <code>Genmask</code> column is the netmask corresponding to that network. Each network has a <code>U</code> under its <code>Flags</code> column, indicating that the route is active (“up”).</p>
<p>There is a <code>G</code> in the <code>Flags</code> column, meaning that communication for this network must be sent through the gateway in the Gateway column, for example, for networl <code>0.0.0.0/0</code> send through it’s gateway <code>9.30.94.1</code>. If no <code>G</code> in <code>Flags</code>, indicating that the network is directly connected in some way.</p>
<p>An entry for <code>0.0.0.0/0</code> in the routing table has special significance because it matches any address on the Internet. This is the default route, and the address configured under the Gateway column (in the <code>route -n</code> output) in the default route is the <code>default gateway</code>.</p>
<h3 id="Basic-ICMP-and-DNS-Tools">Basic ICMP and DNS Tools</h3>
<h4 id="ping">ping</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># ping baidu.com</span><br><span class="line"></span><br><span class="line">PING baidu.com (123.125.114.144) 56(84) bytes of data.</span><br><span class="line">64 bytes from 123.125.114.144 (123.125.114.144): icmp_seq=1 ttl=40 time=212 ms</span><br><span class="line">64 bytes from 123.125.114.144 (123.125.114.144): icmp_seq=2 ttl=40 time=212 ms</span><br><span class="line">64 bytes from 123.125.114.144 (123.125.114.144): icmp_seq=3 ttl=40 time=212 ms</span><br><span class="line">^C</span><br><span class="line">--- baidu.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2002ms</span><br><span class="line">rtt min/avg/max/mdev = 212.335/212.495/212.578/0.393 ms</span><br></pre></td></tr></table></figure>
<p><code>56(84) bytes of data</code> means send a 56 bytes packet (84 bytes when include header).
<code>icmp_seq</code> is sequence number, sometimes you will have gap, usually means there’s some kind of connectivity problem.
<code>time</code> is round-trip time.</p>
<h4 id="traceroute">traceroute</h4>
<p>One of the best things about <code>traceroute</code> is that it reports return trip times at each step in the route:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">## -n will not do hostname lookup for IP in output</span><br><span class="line"># traceroute -n google.com</span><br><span class="line"></span><br><span class="line">traceroute to google.com (172.217.1.206), 30 hops max, 60 byte packets</span><br><span class="line"> 1  9.30.94.3  0.626 ms  0.742 ms  0.845 ms</span><br><span class="line"> 2  9.30.156.13  0.529 ms  0.801 ms  0.918 ms</span><br><span class="line"> 3  9.55.129.109  0.668 ms  0.852 ms 9.55.129.105  0.515 ms</span><br><span class="line"> 4  9.55.187.13  0.476 ms  0.255 ms  0.425 ms</span><br><span class="line"> 5  9.55.128.6  0.326 ms  0.433 ms  0.294 ms</span><br><span class="line"> 6  9.64.38.194  0.941 ms  0.898 ms  0.843 ms</span><br><span class="line"> 7  9.64.3.86  18.220 ms  18.230 ms  18.229 ms</span><br><span class="line"> 8  9.64.3.85  31.521 ms  31.527 ms  31.563 ms</span><br><span class="line"> 9  9.17.3.35  31.803 ms  31.613 ms  31.875 ms</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<h4 id="DNS-and-host">DNS and host</h4>
<p>To find the IP address behind a domain name, use the <code>host</code> command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># host www.google.com</span><br><span class="line"></span><br><span class="line">www.google.com has address 172.217.11.228</span><br><span class="line">www.google.com has IPv6 address 2607:f8b0:400f:801::2004</span><br></pre></td></tr></table></figure>
<p>You can also use <code>host</code> in reverse: Enter an IP address instead of a hostname to try to discover the hostname behind the IP address. But don’t expect this to work reliably. Many hostnames can represent a single IP address, and DNS doesn’t know how to determine which hostname should correspond to an IP address.</p>
<h3 id="Kernel-Network-Interfaces">Kernel Network Interfaces</h3>
<p>Network interfaces have names that usually indicate the kind of hardware underneath, such as <code>eth0</code> (the first Ethernet card in the computer) and <code>wlan0</code> (a wireless interface).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 9.30.94.85  netmask 255.255.254.0  broadcast 9.30.95.255</span><br><span class="line">        ether 00:20:09:1e:5e:55  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 17164860  bytes 9046289828 (8.4 GiB)</span><br><span class="line">        RX errors 0  dropped 6  overruns 0  frame 0</span><br><span class="line">        TX packets 11669220  bytes 9566003426 (8.9 GiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<p><code>UP,RUNNING</code> means this interface is active.</p>
<h3 id="Resolving-Hostnames">Resolving Hostnames</h3>
<p>On most systems, you can <strong>override</strong> hostname lookups with the <code>/etc/hosts</code> file.
Usually resolution will first check this file before resort to DNS server.</p>
<p>The traditional configuration file for DNS servers is <code>/etc/resolv.conf</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## this is the search pattern:</span><br><span class="line">search fyre.ibm.com. svl.ibm.com.</span><br><span class="line">nameserver 172.16.200.52</span><br><span class="line">nameserver 172.16.200.50</span><br></pre></td></tr></table></figure>
<p><code>172.16.200.52</code> and <code>172.16.200.50</code> are the DNS server IP.</p>
<h3 id="netstat-command">netstat command</h3>
<p>This <code>netstat</code> command is extremely important and common in use. Ususally I use <code>netstat -tunlp</code>, let’s dig deeper into it:</p>
<ul>
<li><code>-t</code>: show TCP connection.</li>
<li><code>-u</code>: show UDP connection.</li>
<li><code>-n</code>: show numerical addresses.</li>
<li><code>-l</code>: show only listening sockets.</li>
<li><code>-p</code>: show PID belongs to.</li>
</ul>
<p>Instead of <code>ifconfig</code> to see the interface, you can use:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># netstat -i</span><br><span class="line"></span><br><span class="line">Kernel Interface table</span><br><span class="line">Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg</span><br><span class="line">cali9550  1440 60880456      0      6 0      37444050      0      0      0 BMRU</span><br><span class="line">cali986f  1440        0      0      0 0             0      0      0      0 BMRU</span><br><span class="line">docker0   1500        0      0      0 0             0      0      0      0 BMU</span><br><span class="line">eth0      1500 5606028968      0      0 0      33647018      0      0      0 BMRU</span><br><span class="line">eth1      1500 60880456      0      6 0      37444050      0      0      0 BMRU</span><br><span class="line">lo       65536 431426103      0      0 0      431426103      0      0      0 LRU</span><br></pre></td></tr></table></figure>
<p>Instead of <code>route -n</code> to see route table, you can use:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># netstat -rn</span><br></pre></td></tr></table></figure>
<p>Show TCP connections (not include listening sockets):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># netstat -tn</span><br></pre></td></tr></table></figure>
<p>To see well-known ports translate into names. check <code>/etc/services</code> file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">http            80/tcp          www www-http    # WorldWideWeb HTTP</span><br><span class="line">http            80/udp          www www-http    # HyperText Transfer Protocol</span><br><span class="line">http            80/sctp                         # HyperText Transfer Protoco</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>On Linux, only processes running as the superuser can use ports 1 through 1023. All user processes may listen on and create connections from ports 1024 and up.</p>
<p><strong>I skip the rest of this chapter, majority is concept</strong></p>
<h2 id="Chapter-10-Network-Applications-and-Services">Chapter 10. Network Applications and Services</h2>
<p>Let’s mainly focus on some important commands here:</p>
<h3 id="curl-command">curl command</h3>
<p><code>curl</code> is a command line tool to transfer data to or from a server, using any of the supported protocols (HTTP, FTP, IMAP, POP3, SCP, SFTP, SMTP, TFTP, TELNET, LDAP or FILE). <code>curl</code> is powered by <code>Libcurl</code>. This tool is preferred for automation, since it is designed to work without user interaction. curl can transfer multiple file at once.</p>
<p>you can refer this <a href="https://www.geeksforgeeks.org/curl-command-in-linux-with-examples/" target="_blank" rel="noopener">article</a>.</p>
<h3 id="Diagnostic-Tools">Diagnostic Tools</h3>
<p><code>lsof</code>(list open files) can track open files, but it can also list the programs currently using or listening to ports. Please read more when you need this tool.</p>
<p><code>tcpdump</code>, a command tool version of wireshark.</p>
<p><code>netcat</code>(or <code>nc</code>) I used it before for developing PXEngine, we use TCP to replace ssh connection between conductor and compute containers. <code>netcat</code> can connect to remote TCP/UDP ports, specify a local port, listen on ports, scan ports, redirect standard I/O to and from network connections, and more.</p>
<p>I remember I use <code>nc</code> to listen on a port and on other side connect to that port and transfer data.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## install</span></span><br><span class="line">yum install -y nc</span><br><span class="line">apt install -y netcat</span><br><span class="line"></span><br><span class="line"><span class="comment">## -l: listening mode</span></span><br><span class="line"><span class="comment">## -p: port</span></span><br><span class="line">nc -l -p 1234</span><br><span class="line"><span class="comment">## client</span></span><br><span class="line">nc localhost 1234</span><br></pre></td></tr></table></figure>
<p><code>netcat</code> can be used for TCP, UDP, Unix-domain sockets.</p>
<p><code>nmap</code> scans all ports on a machine or network of machines looking for open ports, and it lists the ports it finds.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># nmap myk8s1.fyre.ibm.com</span><br><span class="line"></span><br><span class="line">Starting Nmap 6.40 ( http://nmap.org ) at 2019-05-22 23:33 PDT</span><br><span class="line">Nmap scan report for myk8s1.fyre.ibm.com (9.30.94.85)</span><br><span class="line">Host is up (0.00024s latency).</span><br><span class="line">Not shown: 995 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">179/tcp  open  bgp</span><br><span class="line">2049/tcp open  nfs</span><br><span class="line">5000/tcp open  upnp</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 0.20 seconds</span><br></pre></td></tr></table></figure>
<h2 id="Chapter-11-Introduction-to-Shell-Scripts">Chapter 11. Introduction to Shell Scripts</h2>
<p>A shell script is a series of commands written in a file.
The <code>#!</code> part is called a <code>shebang</code>.</p>
<p>When writing scripts and working on the command line, just remember what happens whenever the shell runs a command:</p>
<ol>
<li>Before running the command, the shell looks for variables, globs, and other substitutions and performs the substitutions if they appear.</li>
<li>The shell passes the results of the substitutions to the command.</li>
</ol>
<p>if you use single quote:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &apos;r.*t&apos; /etc/passwd</span><br></pre></td></tr></table></figure>
<p>This will prevent sheel from expanding the <code>*</code> in current directory.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &apos;r.*t /etc/passwd&apos;</span><br></pre></td></tr></table></figure>
<p>This will fail, because things wrapped by single/double quote treat as one parameter.</p>
<p>Double quotes (&quot;) work just like single quotes, except that the shell expands <strong>variables</strong> that appear within double quotes. It will not expand globs like <code>*</code> in double quotes!</p>
<p>Just like I saw, use <code>shift</code> to forward arguments passed in:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">echo $1</span><br><span class="line">shift</span><br><span class="line">echo $1</span><br></pre></td></tr></table></figure>
<p><code>$#</code> is the number of arguments passed in, used in loop to pick up parameters.
<code>$@</code> represents all of the script arguments.
<code>$$</code> holds the PID of current shell.</p>
<p>bad message should go to standard error, just like redriect standard error to standard output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo $0: bad option ... 1&gt;&amp;2</span><br></pre></td></tr></table></figure>
<p><code>$?</code> exit code: If you intend to use the exit code of a command, you <strong>must</strong> use or store the code immediately after running the command.</p>
<h3 id="if-condition">if condition</h3>
<p>Let’s see an example, these 2 are good:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if [ &quot;$1&quot; = hi ]; then</span><br><span class="line">if [ x&quot;$1&quot; = x&quot;hi&quot; ]; then</span><br></pre></td></tr></table></figure>
<p>Here, <code>&quot;&quot;</code> is vital, since user may not input <code>$1</code>, if no double quotes, it could be:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if [ = hi ]; then</span><br></pre></td></tr></table></figure>
<p>the test (<code>[</code>) command aborts immediately.</p>
<blockquote>
<p>Note that the stuff follows <code>if</code> is a command! so we have <code>;</code> before <code>then</code>.</p>
</blockquote>
<p>So you can use other commands instead of <code>[</code> command, cool!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">if grep -q daemon /etc/passwd; then</span><br><span class="line">    echo The daemon user is in the passwd file.</span><br><span class="line">else</span><br><span class="line">    echo There is a big problem. daemon is not in the passwd file.</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>Let’s see <code>&amp;&amp;</code> and <code>||</code> and test condition:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">if [ &quot;$1&quot; = hi ] || [ &quot;$1&quot; = bye ]; then</span><br><span class="line">    echo &apos;The first argument was &quot;&apos;$1&apos;&quot;&apos;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>The <code>-a</code> and <code>-o</code> flags are the logical <code>and</code> and <code>or</code> operators in test:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ &quot;$1&quot; = hi -o &quot;$1&quot; = ho ]</span><br></pre></td></tr></table></figure>
<h3 id="test-command">test command</h3>
<p>There are dozens of test operations, all of which fall into three general categories: file tests, string tests, and arithmetic tests.</p>
<h4 id="file-filter">file filter</h4>
<p><code>-f</code>: regular file return 0
<code>-e</code>: file exist return 0
<code>-s</code>: not empty file return 0
<code>-d</code>: directory return 0
<code>-h</code>: softlink return 0</p>
<p>File permission:
<code>-r</code>: readable
<code>-w</code>: writable
<code>-x</code>: executable
<code>-u</code>: setuid
<code>-g</code>: setgid
<code>-k</code>: sticky</p>
<blockquote>
<p>The test command follows symbolic links (except for the <code>-h</code> test). That is, if link is a symbolic link to a regular file, [ <code>-f</code> link ] returns an exit code of true (0).</p>
</blockquote>
<p>Finally, three binary operators (tests that need two files as arguments) are used in file tests, but they’re not terribly common.
<code>[ file1 -nt file2 ]</code>: if file1 has a newer modification date than file2 return 0
<code>[ file1 -ot file2 ]</code>: if file1 has a older modification date than file2 return 0
<code>[ file1 -ef file2 ]</code>: compares two files and returns true if they share inode numbers and devices.</p>
<h4 id="string-test">string test</h4>
<p><code>=</code>: equal
<code>!=</code>: not equal
<code>-z</code>: empty string return 0
<code>-n</code>: not empty return 0</p>
<h4 id="arithmetic-test">arithmetic test</h4>
<p><code>-eq</code>: equal to
<code>-ne</code>: not equal to
<code>-lt</code>: less than
<code>-gt</code>: greater than
<code>-le</code>: less than or equal to
<code>-ge</code>: greater than or equal to</p>
<h3 id="case-condition">case condition</h3>
<p>The case keyword forms another conditional construct that is exceptionally useful for matching strings, it can do pattern matching:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">case $1 in</span><br><span class="line">    bye)</span><br><span class="line">        echo Fine, bye.</span><br><span class="line">        ;;</span><br><span class="line">    hi|hello)</span><br><span class="line">        echo Nice to see you.</span><br><span class="line">        ;;</span><br><span class="line">    what*)</span><br><span class="line">        echo Whatever.</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &apos;Huh?&apos;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Each case must end with a double semicolon (;;) or you risk a syntax error.</p>
</blockquote>
<h3 id="loop">loop</h3>
<p>for loop:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">for str in one two three four; do</span><br><span class="line">    echo $str</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>while loop:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">FILE=/tmp/whiletest.$$;</span><br><span class="line">echo firstline &gt; $FILE</span><br><span class="line">while tail -10 $FILE | grep -q firstline; do</span><br><span class="line">    # add lines to $FILE until tail -10 $FILE no longer prints &quot;firstline&quot;</span><br><span class="line">    echo -n Number of lines in $FILE:&apos; &apos;</span><br><span class="line">    wc -l $FILE | awk &apos;&#123;print $1&#125;&apos;</span><br><span class="line">    echo newline &gt;&gt; $FILE</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">rm -f $FILE</span><br></pre></td></tr></table></figure>
<p>In fact, if you find that you need to use while, you should probably be using a language like awk or Python instead.</p>
<h3 id="Command-Substitution">Command Substitution</h3>
<p>You can use a command’s output as an argument to another command, or you can store the command output in a shell variable by enclosing a command in <code>$()</code>.</p>
<h3 id="Temporary-File-Management">Temporary File Management</h3>
<p>Note the <code>mktemp</code> command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">TMPFILE1=$(mktemp /tmp/im1.XXXXXX)</span><br><span class="line">TMPFILE2=$(mktemp /tmp/im2.XXXXXX)</span><br><span class="line"></span><br><span class="line">cat /proc/interrupts &gt; $TMPFILE1</span><br><span class="line">sleep 2</span><br><span class="line">cat /proc/interrupts &gt; $TMPFILE2</span><br><span class="line">diff $TMPFILE1 $TMPFILE2</span><br><span class="line">rm -f $TMPFILE1 $TMPFILE2</span><br></pre></td></tr></table></figure>
<p>If the script is aborted, the temporary files could be left behind. In the preceding example, pressing <code>CTRL-C</code> before the second cat command leaves a temporary file in <code>/tmp</code>. Avoid this if possible. Instead, use the <code>trap</code> command to create a signal handler to catch the signal that <code>CTRL-C</code> generates and remove the temporary files, as in this handler:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">TMPFILE1=$(mktemp /tmp/im1.XXXXXX)</span><br><span class="line">TMPFILE2=$(mktemp /tmp/im2.XXXXXX)</span><br><span class="line">trap &quot;rm -f $TMPFILE1 $TMPFILE2; exit 1&quot; INT</span><br></pre></td></tr></table></figure>
<p>You must use exit in the handler to explicitly end script execution, or the shell will continue running as usual after running the signal handler.</p>
<blockquote>
<p>Note that in <code>startcontainer.sh</code> we also have trap and we use shell function there, now I understand!</p>
</blockquote>
<h3 id="Important-Shell-Script-Utilities">Important Shell Script Utilities</h3>
<h4 id="basename">basename</h4>
<p>This one strip the extension of file name:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># basename example.html .html</span><br><span class="line"></span><br><span class="line">example</span><br></pre></td></tr></table></figure>
<p>This one git rid of directory in full path:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># basename /usr/local/bin/example</span><br><span class="line"></span><br><span class="line">example</span><br></pre></td></tr></table></figure>
<h4 id="awk">awk</h4>
<p>The <code>awk</code> command is not a simple single-purpose command; it’s actually a powerful programming language. Unfortunately, awk usage is now something of a lost art, having been replaced by larger languages such as Python.</p>
<h4 id="sed">sed</h4>
<p>The sed program (sed stands for stream editor) is an automatic <strong>text editor</strong> that takes an input stream (a file or the standard input), alters it according to some expression, and prints the results to standard output.</p>
<h4 id="expr">expr</h4>
<p>The <code>expr</code> command is a clumsy, slow way of doing math. If you find yourself using it frequently, you should probably be using a language like Python instead of a shell script.</p>
<h3 id="Subshells">Subshells</h3>
<p>An entirely <strong>new</strong> shell process that you can create just to run a command or two. The new shell has a <strong>copy</strong> of the original shell’s environment, and when the new shell exits, any changes you made to its shell environment disappear, leaving the initial shell to run as normal.</p>
<p>Using a subshell to make a single-use alteration to an environment variable is such a common task:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># (PATH=/usr/confusing:$PATH; ./runprogram.sh)</span><br></pre></td></tr></table></figure>
<h2 id="Chapter-12-Moving-Files-Across-the-Network">Chapter 12. Moving Files Across the Network</h2>
<h3 id="Quick-copy-browser">Quick copy browser</h3>
<p>Go to target directory run:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer</span><br></pre></td></tr></table></figure>
<p>This usually open 8000 port on your machine, then go to another machine open:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># use ifconfig to check the source machine IP</span><br><span class="line">192.168.1.29:8000</span><br></pre></td></tr></table></figure>
<p>you can see the content there.</p>
<h3 id="rsync">rsync</h3>
<p>Actually you can first enable Mac ssh access then use <code>rsync</code> to backup files:
System Preference -&gt; Sharing -&gt; check remote login</p>
<p>To get <code>rsync</code> working between two hosts, the rsync program must be installed on both the source and destination, and you’ll need a way to access one machine from the other.</p>
<p>Copy files to remote home:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rsync files remote:</span><br><span class="line">rsync files user@remote:</span><br></pre></td></tr></table></figure>
<p>If <code>rsync</code> isn’t in the remote path but is on the system, use <code>--rsync-path=path</code> to manually specify its location.</p>
<p>Unless you supply extra options, <code>rsync</code> copies only files. You will see:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skipping directory xxx</span><br></pre></td></tr></table></figure>
<p>To transfer entire directory hierarchies, complete with symbolic links, permissions, modes, and devices—use the <code>-a</code> option.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -nv files -a dir user@remote:</span><br></pre></td></tr></table></figure>
<p><code>-n</code>: dry-run, this is vital when you are not sure.
<code>-vv</code>: verbose mode</p>
<p>To make an exact replica of the source directory, you must delete files in the destination directory that do not exist in the source directory:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -v --delete -a dir user@remote:</span><br></pre></td></tr></table></figure>
<p>Please use <code>-n</code> dry-run to see what will be deleted before performing command.</p>
<p>Be particular careful with tailing slash after dir:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -a dir/ user@remote:dest</span><br></pre></td></tr></table></figure>
<p>This will copy all files under dir to dest folder in remote instead of copy dir into dest.</p>
<p>You can also <code>--exclude=</code>, <code>--exclude-from=</code> and <code>--include=</code> in command.</p>
<p>To speed operation, <code>rsync</code> uses a quick check to determine whether any files on the transfer source are already on the destination. The quick check uses a combination of the file size and its last-modified date.</p>
<p>When the files on the source side are not identical to the files on the destination side, <code>rsync</code> transfers the source files and overwrites any files that exist on the remote side. The default behavior may be inadequate, though, because you may need additional reassurance that files are indeed the same before skipping over them in transfers, or you may want to put in some extra safeguards.</p>
<ul>
<li>
<p><code>--checksum </code>(abbreviation: <code>-c</code>) Compute checksums (mostly unique signatures) of the files to see if they’re the same. This consumes additional I/O and CPU resources during transfers, but if you’re dealing with sensitive data or files that often have uniform sizes, this option is a must. (This will focus on file content, not date stamp)</p>
</li>
<li>
<p><code>--ignore-existing</code> Doesn’t clobber files already on the target side.</p>
</li>
<li>
<p><code>--backup</code> (abbreviation: <code>-b</code>) Doesn’t clobber files already on the target but rather renames these existing files by adding a <code>~</code> suffix to their names before transferring the new files.</p>
</li>
<li>
<p><code>--suffix=s</code> Changes the suffix used with --backup from <code>~</code> to <code>s</code>.</p>
</li>
<li>
<p><code>--update</code> (abbreviation: <code>-u</code>) Doesn’t clobber any file on the target that has a later date than the corresponding file on the source.</p>
</li>
</ul>
<p>You can also compress the dir when transfer:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -az dir user@remote:</span><br></pre></td></tr></table></figure>
<p>You can also reverse the process:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -a user@remote:dir dest</span><br></pre></td></tr></table></figure>
<p>The rest of this chapter talks <code>samba</code> for file sharing, I skip it.</p>
<h2 id="Chapter-13-User-Environments">Chapter 13. User Environments</h2>
<p>Startup files play an important role at this point, because they set defaults for the shell and other interactive programs. They determine how the system behaves when a user logs in.</p>
<p>I see vi theme config in <code>~/.bashrc</code> file.</p>
<h3 id="The-Command-Path">The Command Path</h3>
<p>The most important part of any shell startup file is the command path. The path should cover the directories that contain every application of interest to a regular user. At the very least, the path should contain these components, in order:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin</span><br><span class="line">/usr/bin</span><br><span class="line">/bin</span><br></pre></td></tr></table></figure>
<p>If the application is on another directory, use symbolic link to <code>/usr/local/bin</code> or you defined <code>bin</code> folder.</p>
<h3 id="The-prompt">The prompt</h3>
<p>I never use this so far, usually prompt shows hostname, username, current directory and sign (<code>$</code> or <code>#</code>). you can change the color and more.</p>
<h3 id="Alias">Alias</h3>
<p>This is common use, sometimes I use shell functions too.</p>
<h3 id="Permission-mask">Permission mask</h3>
<p>It depends on your needs:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umask 022/077</span><br></pre></td></tr></table></figure>
<h3 id="Startup-file-order">Startup file order</h3>
<p>These startup files are used to create <strong>environment</strong>. Each script has a specific use and affects the login environment differently. Every subsequent script executed can override the values assigned by previous scripts.</p>
<p>The two main shell <code>instance types</code> are <code>interactive</code> and <code>noninteractive</code>, but of those, only interactive shells are of interest because noninteractive shells (such as those that run shell scripts) usually don’t read any startup files.</p>
<p>Interactive shells are the ones that you use to <strong>run commands from a terminal</strong>, they can be classified as <code>login</code> or <code>non-login</code>.</p>
<p>I know there are lots of startup files under each user’s home directory or in other system folder, how do they take effect? In what order:
<strong>Reference Doc</strong>
<a href="http://howtolamp.com/articles/difference-between-login-and-non-login-shell/" target="_blank" rel="noopener">Difference between Login shell and Non login shell</a></p>
<p>Logging in remotely with <code>SSH</code> also gives you a login shell.</p>
<p>You can tell if a shell is a login shell by running <code>echo $0</code>; if the first character is a <code>-</code>, the shell’s a login shell.</p>
<p>When Bash is invoked as a <code>Login</code> shell:</p>
<ol>
<li>Login process calls <code>/etc/profile</code></li>
<li><code>/etc/profile</code> calls the scripts in <code>/etc/profile.d/</code></li>
<li>Login process calls <code>~/.bash_profile</code>, <code>~/.bash_login</code> and <code>~/.profile</code>. running only the first one that it sees.</li>
</ol>
<p>Login Shells created by explicitly telling to login.
examples: <code># su - | # su -l | # su --login | # su USERNAME - | # su -l USERNAME | # su --login USERNAME | # sudo -i</code></p>
<p>When bash is invoked as a <code>Non-login</code> shell;</p>
<ol>
<li>Non-login process(shell) calls <code>/etc/bashrc</code></li>
<li>then calls <code>~/.bashrc</code></li>
</ol>
<p><code>Non-Login</code> shells created using the below command syntax:
examples: <code># su | # su USERNAME</code></p>
<p>Note that I can run <code>bash</code> or <code>sh</code> or <code>csh</code> in terminal, it will give me a new simple prompt without user profile or setting…</p>
<p>It seems if you use non-login like <code>su dsadm</code>, the export env vars are still there in <code>env</code> scope, I think the reason is it’s not login! still use current environment. But if you run <code>su - dsadm</code>, it is gone.</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/book/" rel="tag"># book</a>
          
            <a href="/tags/linux/" rel="tag"># linux</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/13/linux-soft-link/" rel="next" title="Symbolic Link Operations">
                <i class="fa fa-chevron-left"></i> Symbolic Link Operations
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/30/career-growth/" rel="prev" title="Career Growth">
                Career Growth <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">295</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">48</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">159</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter1-The-Big-picture"><span class="nav-number">1.</span> <span class="nav-text">Chapter1. The Big picture</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hardware"><span class="nav-number">1.1.</span> <span class="nav-text">Hardware</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kernel"><span class="nav-number">1.2.</span> <span class="nav-text">Kernel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#User-Space"><span class="nav-number">1.3.</span> <span class="nav-text">User Space</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Users"><span class="nav-number">1.4.</span> <span class="nav-text">Users</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-2-Basic-Commands-and-Directory-Hierarchy"><span class="nav-number">2.</span> <span class="nav-text">Chapter 2. Basic Commands and Directory Hierarchy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux-Directory-Hierarchy-Essentials"><span class="nav-number">2.1.</span> <span class="nav-text">Linux Directory Hierarchy Essentials</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kernel-Location"><span class="nav-number">2.2.</span> <span class="nav-text">Kernel Location</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-3-Devices"><span class="nav-number">3.</span> <span class="nav-text">Chapter 3. Devices</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Device-Files"><span class="nav-number">3.1.</span> <span class="nav-text">Device Files</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Block-device"><span class="nav-number">3.1.1.</span> <span class="nav-text">Block device</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Character-device"><span class="nav-number">3.1.2.</span> <span class="nav-text">Character device</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pipe-device"><span class="nav-number">3.1.3.</span> <span class="nav-text">Pipe device</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Socket-device"><span class="nav-number">3.2.</span> <span class="nav-text">Socket device</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-sysfs-Device-Path"><span class="nav-number">3.3.</span> <span class="nav-text">The sysfs Device Path</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dd-and-Devices"><span class="nav-number">3.4.</span> <span class="nav-text">dd and Devices</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Device-Name-Summary"><span class="nav-number">3.5.</span> <span class="nav-text">Device Name Summary</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-4-Disks-and-Filesystems"><span class="nav-number">4.</span> <span class="nav-text">Chapter 4. Disks and Filesystems</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Partitioning-Disk-Devices"><span class="nav-number">4.1.</span> <span class="nav-text">Partitioning Disk Devices</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Changing-Partition-Tables"><span class="nav-number">4.2.</span> <span class="nav-text">Changing Partition Tables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Filesystems"><span class="nav-number">4.3.</span> <span class="nav-text">Filesystems</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Filesystem-Types"><span class="nav-number">4.3.1.</span> <span class="nav-text">Filesystem Types</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Create-a-Filesystems"><span class="nav-number">4.3.2.</span> <span class="nav-text">Create a Filesystems</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mounting-a-Filesystem"><span class="nav-number">4.3.3.</span> <span class="nav-text">Mounting a Filesystem</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Filesystem-UUID"><span class="nav-number">4.3.4.</span> <span class="nav-text">Filesystem UUID</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Disk-Buffering-Caching-and-Filesystems"><span class="nav-number">4.3.5.</span> <span class="nav-text">Disk Buffering, Caching, and Filesystems</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#The-etc-fstab-Filesystem-Table"><span class="nav-number">4.3.6.</span> <span class="nav-text">The /etc/fstab Filesystem Table</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Filesystem-Capacity"><span class="nav-number">4.3.7.</span> <span class="nav-text">Filesystem Capacity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Checking-and-Repairing-Filesystems"><span class="nav-number">4.3.8.</span> <span class="nav-text">Checking and Repairing Filesystems</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Special-Purpose-Filesystems"><span class="nav-number">4.3.9.</span> <span class="nav-text">Special-Purpose Filesystems</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Swap-Space"><span class="nav-number">4.4.</span> <span class="nav-text">Swap Space</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Looking-Forward-Disks-and-User-Space"><span class="nav-number">4.5.</span> <span class="nav-text">Looking Forward: Disks and User Space</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-5-How-the-Linux-Kernel-Boots"><span class="nav-number">5.</span> <span class="nav-text">Chapter 5. How the Linux Kernel Boots</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Startup-Messages"><span class="nav-number">5.1.</span> <span class="nav-text">Startup Messages</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kernel-Initialization-and-Boot-Options"><span class="nav-number">5.2.</span> <span class="nav-text">Kernel Initialization and Boot Options</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kernel-Parameters"><span class="nav-number">5.3.</span> <span class="nav-text">Kernel Parameters</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Boot-Loader"><span class="nav-number">5.4.</span> <span class="nav-text">Boot Loader</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Boot-loader-tasks"><span class="nav-number">5.4.1.</span> <span class="nav-text">Boot loader tasks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Boot-loader-typres"><span class="nav-number">5.4.2.</span> <span class="nav-text">Boot loader typres</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GRUB-Introduction"><span class="nav-number">5.5.</span> <span class="nav-text">GRUB Introduction</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-6-How-User-Space-Starts"><span class="nav-number">6.</span> <span class="nav-text">Chapter 6. How User Space Starts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Introduction-to-init"><span class="nav-number">6.1.</span> <span class="nav-text">Introduction to init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#System-V-Runlevels"><span class="nav-number">6.2.</span> <span class="nav-text">System V Runlevels</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Identifying-Your-init"><span class="nav-number">6.3.</span> <span class="nav-text">Identifying Your init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#systemd"><span class="nav-number">6.4.</span> <span class="nav-text">systemd</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Units-and-Unit-Types"><span class="nav-number">6.4.1.</span> <span class="nav-text">Units and Unit Types</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#systemd-Dependencies"><span class="nav-number">6.4.2.</span> <span class="nav-text">systemd Dependencies</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#systemd-Configuration"><span class="nav-number">6.4.3.</span> <span class="nav-text">systemd Configuration</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#systemd-Operation"><span class="nav-number">6.5.</span> <span class="nav-text">systemd Operation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#systemd-Process-Tracking-and-Synchronization"><span class="nav-number">6.5.1.</span> <span class="nav-text">systemd Process Tracking and Synchronization</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#systemd-On-Demand-and-Resource-Parallelized-Startup"><span class="nav-number">6.5.2.</span> <span class="nav-text">systemd On-Demand and Resource-Parallelized Startup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#systemd-Auxiliary-Programs"><span class="nav-number">6.5.3.</span> <span class="nav-text">systemd Auxiliary Programs</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shutting-Down-Your-System"><span class="nav-number">6.6.</span> <span class="nav-text">Shutting Down Your System</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Initial-RAM-Filesystem"><span class="nav-number">6.7.</span> <span class="nav-text">The Initial RAM Filesystem</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-7-System-Configuration"><span class="nav-number">7.</span> <span class="nav-text">Chapter 7. System Configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Structure-of-etc"><span class="nav-number">7.1.</span> <span class="nav-text">The Structure of /etc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#System-Logging"><span class="nav-number">7.2.</span> <span class="nav-text">System Logging</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#The-System-Logger"><span class="nav-number">7.2.1.</span> <span class="nav-text">The System Logger</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Configuration-Files"><span class="nav-number">7.2.2.</span> <span class="nav-text">Configuration Files</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#User-Management-Files"><span class="nav-number">7.3.</span> <span class="nav-text">User Management Files</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#The-etc-passwd-File"><span class="nav-number">7.3.1.</span> <span class="nav-text">The /etc/passwd File</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Special-Users"><span class="nav-number">7.3.2.</span> <span class="nav-text">Special Users</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#The-etc-shadow-File"><span class="nav-number">7.3.3.</span> <span class="nav-text">The /etc/shadow File</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Working-with-Groups"><span class="nav-number">7.3.4.</span> <span class="nav-text">Working with Groups</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Setting-the-Time"><span class="nav-number">7.4.</span> <span class="nav-text">Setting the Time</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Network-Time"><span class="nav-number">7.4.1.</span> <span class="nav-text">Network Time</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Scheduling-Recurring-Tasks-with-cron"><span class="nav-number">7.5.</span> <span class="nav-text">Scheduling Recurring Tasks with cron</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Installing-Crontab-Files"><span class="nav-number">7.5.1.</span> <span class="nav-text">Installing Crontab Files</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#System-Crontab-Files"><span class="nav-number">7.5.2.</span> <span class="nav-text">System Crontab Files</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Understanding-User-IDs-and-User-Switching"><span class="nav-number">7.6.</span> <span class="nav-text">Understanding User IDs and User Switching</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PAM"><span class="nav-number">7.7.</span> <span class="nav-text">PAM</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PAM-Configuration"><span class="nav-number">7.7.1.</span> <span class="nav-text">PAM Configuration</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-8-A-Closer-Look-at-Processes-and-Resource-Utilization"><span class="nav-number">8.</span> <span class="nav-text">Chapter 8. A Closer Look at Processes and Resource Utilization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tracking-Processes"><span class="nav-number">8.1.</span> <span class="nav-text">Tracking Processes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Finding-Open-Files-by-lsof"><span class="nav-number">8.2.</span> <span class="nav-text">Finding Open Files by lsof</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tracing-Program-Execution-and-System-Calls"><span class="nav-number">8.3.</span> <span class="nav-text">Tracing Program Execution and System Calls</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Threads"><span class="nav-number">8.4.</span> <span class="nav-text">Threads</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Introduction-to-Resource-Monitoring"><span class="nav-number">8.5.</span> <span class="nav-text">Introduction to Resource Monitoring</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Adjusting-Process-Priorities"><span class="nav-number">8.5.1.</span> <span class="nav-text">Adjusting Process Priorities</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Load-Averages"><span class="nav-number">8.5.2.</span> <span class="nav-text">Load Averages</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory"><span class="nav-number">8.6.</span> <span class="nav-text">Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Page-Faults"><span class="nav-number">8.6.1.</span> <span class="nav-text">Page Faults</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Monitoring-CPU-and-Memory-Performance"><span class="nav-number">8.7.</span> <span class="nav-text">Monitoring CPU and Memory Performance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#I-O-Monitoring"><span class="nav-number">8.8.</span> <span class="nav-text">I/O Monitoring</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Per-Process-Monitoring"><span class="nav-number">8.9.</span> <span class="nav-text">Per-Process Monitoring</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-9-Network-and-Configuration"><span class="nav-number">9.</span> <span class="nav-text">Chapter 9. Network and Configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Routes-and-the-Kernel-Routing-Table"><span class="nav-number">9.1.</span> <span class="nav-text">Routes and the Kernel Routing Table</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Basic-ICMP-and-DNS-Tools"><span class="nav-number">9.2.</span> <span class="nav-text">Basic ICMP and DNS Tools</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ping"><span class="nav-number">9.2.1.</span> <span class="nav-text">ping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#traceroute"><span class="nav-number">9.2.2.</span> <span class="nav-text">traceroute</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DNS-and-host"><span class="nav-number">9.2.3.</span> <span class="nav-text">DNS and host</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kernel-Network-Interfaces"><span class="nav-number">9.3.</span> <span class="nav-text">Kernel Network Interfaces</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Resolving-Hostnames"><span class="nav-number">9.4.</span> <span class="nav-text">Resolving Hostnames</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#netstat-command"><span class="nav-number">9.5.</span> <span class="nav-text">netstat command</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-10-Network-Applications-and-Services"><span class="nav-number">10.</span> <span class="nav-text">Chapter 10. Network Applications and Services</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#curl-command"><span class="nav-number">10.1.</span> <span class="nav-text">curl command</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Diagnostic-Tools"><span class="nav-number">10.2.</span> <span class="nav-text">Diagnostic Tools</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-11-Introduction-to-Shell-Scripts"><span class="nav-number">11.</span> <span class="nav-text">Chapter 11. Introduction to Shell Scripts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#if-condition"><span class="nav-number">11.1.</span> <span class="nav-text">if condition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#test-command"><span class="nav-number">11.2.</span> <span class="nav-text">test command</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#file-filter"><span class="nav-number">11.2.1.</span> <span class="nav-text">file filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#string-test"><span class="nav-number">11.2.2.</span> <span class="nav-text">string test</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#arithmetic-test"><span class="nav-number">11.2.3.</span> <span class="nav-text">arithmetic test</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case-condition"><span class="nav-number">11.3.</span> <span class="nav-text">case condition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loop"><span class="nav-number">11.4.</span> <span class="nav-text">loop</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Command-Substitution"><span class="nav-number">11.5.</span> <span class="nav-text">Command Substitution</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Temporary-File-Management"><span class="nav-number">11.6.</span> <span class="nav-text">Temporary File Management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Important-Shell-Script-Utilities"><span class="nav-number">11.7.</span> <span class="nav-text">Important Shell Script Utilities</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#basename"><span class="nav-number">11.7.1.</span> <span class="nav-text">basename</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#awk"><span class="nav-number">11.7.2.</span> <span class="nav-text">awk</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sed"><span class="nav-number">11.7.3.</span> <span class="nav-text">sed</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#expr"><span class="nav-number">11.7.4.</span> <span class="nav-text">expr</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Subshells"><span class="nav-number">11.8.</span> <span class="nav-text">Subshells</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-12-Moving-Files-Across-the-Network"><span class="nav-number">12.</span> <span class="nav-text">Chapter 12. Moving Files Across the Network</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Quick-copy-browser"><span class="nav-number">12.1.</span> <span class="nav-text">Quick copy browser</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rsync"><span class="nav-number">12.2.</span> <span class="nav-text">rsync</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-13-User-Environments"><span class="nav-number">13.</span> <span class="nav-text">Chapter 13. User Environments</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Command-Path"><span class="nav-number">13.1.</span> <span class="nav-text">The Command Path</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-prompt"><span class="nav-number">13.2.</span> <span class="nav-text">The prompt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Alias"><span class="nav-number">13.3.</span> <span class="nav-text">Alias</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Permission-mask"><span class="nav-number">13.4.</span> <span class="nav-text">Permission mask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Startup-file-order"><span class="nav-number">13.5.</span> <span class="nav-text">Startup file order</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>





  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
