<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="中文|English">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="More information please see man bash, it has comprehensive information. This blog collects the commonly used code snippets based on my daily work, also do summary from related stackoverflow topics. se">
<meta name="keywords" content="shell">
<meta property="og:type" content="article">
<meta property="og:title" content="Common Code Snippets">
<meta property="og:url" content="http://yoursite.com/2019/02/24/shell-common-code/index.html">
<meta property="og:site_name" content="海胆阶段&#39;s Blog">
<meta property="og:description" content="More information please see man bash, it has comprehensive information. This blog collects the commonly used code snippets based on my daily work, also do summary from related stackoverflow topics. se">
<meta property="og:locale" content="中文|English">
<meta property="og:updated_time" content="2021-05-31T19:37:48.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Common Code Snippets">
<meta name="twitter:description" content="More information please see man bash, it has comprehensive information. This blog collects the commonly used code snippets based on my daily work, also do summary from related stackoverflow topics. se">






  <link rel="canonical" href="http://yoursite.com/2019/02/24/shell-common-code/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Common Code Snippets | 海胆阶段's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="中文|English">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海胆阶段's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">159</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">48</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">296</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/24/shell-common-code/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="海胆阶段">
      <meta itemprop="description" content="骐骥一跃，不能十步；驽马十驾，功在不舍">
      <meta itemprop="image" content="/images/cuishao.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海胆阶段's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Common Code Snippets

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-02-24 17:19:39" itemprop="dateCreated datePublished" datetime="2019-02-24T17:19:39-08:00">2019-02-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-05-31 12:37:48" itemprop="dateModified" datetime="2021-05-31T12:37:48-07:00">2021-05-31</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>More information please see <code>man bash</code>, it has comprehensive information.</p>
<p>This blog collects the commonly used code snippets based on my daily work, also do summary from related <em>stackoverflow</em> topics.</p>
<h1>set builtin</h1>
<p>Usually I use <code>set -x</code> for debugging purpose, today I see a new statement <code>set -ex</code>. What is this and what is set in Bash? 后来又知道了很多，见awesome list中的bash tutoral.</p>
<p><a href="https://www.gnu.org/software/bash//manual/html_node/The-Set-Builtin.html" target="_blank" rel="noopener">The Set Builtin</a>, in short, <code>set</code> allows you to change the values of shell options and set the positional parameters, or to display the names and values of shell variables.</p>
<p><code>set -e</code>, causes the shell to exit if any subcommand or pipeline returns a non-zero status. This tells bash that it should exit the script if any statement returns a non-true return value. The benefit of using <code>-e</code> is that it prevents errors snowballing into serious issues when they could have been caught earlier.</p>
<p>But sometimes <code>set -e</code> may not be good, see these two posts:
<a href="https://serverfault.com/questions/143445/what-does-set-e-do-and-why-might-it-be-considered-dangerous" target="_blank" rel="noopener">What does ‘set -e’ do, and why might it be considered dangerous?</a>
这个回答很有启发，用哪种方法还得看具体场景。一定要考虑清楚。</p>
<p><a href="https://www.cnblogs.com/YatHo/p/7682344.html" target="_blank" rel="noopener">“set -e” usage</a></p>
<h1>get path of running script</h1>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curpath=$(dirname $(readlink -f $0))</span><br></pre></td></tr></table></figure>
<p><code>readlink -f $0</code> will follow every symlink in every component of the given name recursively and get the <code>canonical</code> path. A single file existing on a system can have <strong>many</strong> different paths that refer to it, but only one <code>canonical</code> path, <code>canonical</code> gives a unique <strong>absolute</strong> path for a given file. That means even though you call a script in it’s current directory, <code>readlink -f $0</code> will give you the absolute path!</p>
<p><code>dirname $0</code> cut the script name to get the calling path, the path is relative not absolute.</p>
<h1>run script in it’s driectory</h1>
<p>Sometimes we want to run script in it’s folder by <code>./xxx.sh</code>. we can check that:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SCRIPT_PATH=$(dirname <span class="variable">$0</span>)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"X"</span><span class="string">"<span class="variable">$&#123;SCRIPT_PATH&#125;</span>"</span> != <span class="string">"X."</span> ]]; <span class="keyword">then</span></span><br><span class="line">  LogMsg <span class="string">"###### ERROR: Please run this script in it's directory!"</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<h1>create tmp file to store log</h1>
<p>Create a temporary file or directory, this temp file is owned and grouped by the current user. Aside from the obvious step of setting proper permissions for files exposed to all users of the system, it is important to give temporary files nonpredictable filenames, for example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $$: current PID</span></span><br><span class="line">OUT_FILE=/tmp/$(basename <span class="variable">$0</span>).$$.<span class="variable">$RANDOM</span><span class="variable">$RANDOM</span></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">OUT_FILE=$(mktemp /tmp/<span class="built_in">log</span>.$$.XXXXXXXXX)</span><br></pre></td></tr></table></figure>
<p>For regular use, it may be more wise to avoid /tmp and create a /tmp under its home.</p>
<p>it will randomly generate 6 characters to replace <code>XXXXXX</code>. You may need to delete the tmp file when script exits, for example, use <code>trap</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> exitHook &#123;</span><br><span class="line">  rm -f <span class="variable">$OUT_FILE</span></span><br><span class="line">  rm -f <span class="variable">$&#123;OUT_FILE&#125;</span>.yml</span><br><span class="line">  rm -f <span class="variable">$&#123;OUT_FILE&#125;</span>.out</span><br><span class="line">  rm -f <span class="variable">$&#123;OUT_FILE&#125;</span>.err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">## must put at beginning of script</span></span><br><span class="line"><span class="built_in">trap</span> exitHook EXIT</span><br></pre></td></tr></table></figure>
<p>Actually, you can get random number from</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="variable">$RANDOM</span></span><br></pre></td></tr></table></figure>
<p>you can also seed it to generate reproducible sequence:
<a href="https://stackoverflow.com/questions/42004870/seed-for-random-environment-variable-in-bash" target="_blank" rel="noopener">https://stackoverflow.com/questions/42004870/seed-for-random-environment-variable-in-bash</a></p>
<h1>if condition</h1>
<p>List of <a href="http://tldp.org/LDP/Bash-Beginners-Guide/html/sect_07_01.html" target="_blank" rel="noopener">test command condition</a> Or check manual <code>man test</code>.</p>
<p>The test command, it can be written as<code>[]</code> or <code>test expression</code>, <code>[[ ]]</code> is modern format, it supports regular expression <code>=~</code> for string. which one if preferred: <code>test</code> is traditional (and part of the POSIX specification for standard shells, which are often used for system startup scripts), whereas [[ ]] is specific to bash (and a few other modern shells). It’s important to know how to use test since it is widely used, but [[ ]] is clearly more useful and is easier to code, so it is preferred for modern scripts.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## don't double quote regexp</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$name</span>"</span> =~ colou?r ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"..."</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>其他test 的变量operands 一般用double quote括起来，防止值为空的时候出错.</p>
<p>对于file system, 主要检测<code>-e</code>, <code>-f</code>, <code>-d</code>, <code>-L</code>, <code>-r -w -x</code>, etc. 还有更多的检测选择，参考man.</p>
<p>对于string 则主要就是检测<code>-n</code>, <code>-z</code>, <code>=</code>, <code>==</code>, <code>!=</code>, <code>=~</code>, <code>&gt;</code>, <code>&lt;</code>.</p>
<p>For comparing integers, <code>-eq</code>, <code>-ne</code>, <code>-ge</code>, <code>-gt</code>, <code>-le</code>, <code>-lt</code>. Or use <code>(( xxx ))</code>, this is a compound command designed for integers:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">INT=-3</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$INT</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"INT is empty."</span> &gt;&amp;2</span><br><span class="line">  <span class="built_in">exit</span> 1 </span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$INT</span>"</span> -lt 0 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"INT is negative."</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"INT is positive."</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ $((INT % 2)) -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"INT is even."</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"INT is odd."</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or using (())</span></span><br><span class="line"><span class="keyword">if</span> ((1)); <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">"It is true."</span>; <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> ((0)); <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">"It is true."</span>; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要注意(()) 中的变量不再需要expansion symbol $了，直接用变量名</span></span><br><span class="line"><span class="built_in">declare</span> -i day=30</span><br><span class="line"><span class="keyword">if</span> (( day &gt; 0 || day &lt; 31 )); <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"day is good"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里结合read command，判断输入是否是有一个item</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">"input one item -&gt; "</span></span><br><span class="line">(( <span class="string">"<span class="variable">$(echo \"$REPLY\" | wc -w)</span>"</span> &gt; 1 )) &amp;&amp; <span class="built_in">echo</span> <span class="string">"invalid input"</span></span><br></pre></td></tr></table></figure>
<p><code>==</code> or <code>=</code>, <code>!=</code> and <code>=~</code> are used for string comparision:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sth does not exist? or using -z</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;sth&#125;</span>"</span><span class="string">"X"</span> == <span class="string">"X"</span> ]]; <span class="keyword">then</span></span><br><span class="line">  LogMsg <span class="string">"###### INFO: ..."</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># True if the length of "STRING" is zero.</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="string">"<span class="variable">$&#123;sth&#125;</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">  LogMsg <span class="string">"###### INFO: ..."</span> &gt;&amp;2</span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># directory does not exist?</span></span><br><span class="line"><span class="keyword">if</span> [[ ! -d <span class="string">"<span class="variable">$&#123;folder_path&#125;</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">   LogMsg <span class="string">"###### ERROR: <span class="variable">$&#123;folder_path&#125;</span> directory doesn't exist!"</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>对于logial operators, 有2种模式，一种是在command内部使用，比如: <code>test</code>(<code>-a</code>, <code>-o</code>, <code>!</code>), <code>[[ ]]</code>, <code>(())</code>(<code>&amp;&amp;</code> <code>||</code> <code>!</code>):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$INT</span>"</span> -ge <span class="string">"<span class="variable">$MIN_VAL</span>"</span> &amp;&amp; <span class="string">"<span class="variable">$INT</span>"</span> -le <span class="string">"<span class="variable">$MAX_VAL</span>"</span> ]]</span><br><span class="line"><span class="comment"># same as test</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$INT</span>"</span> -ge <span class="string">"<span class="variable">$MIN_VAL</span>"</span> -a <span class="string">"<span class="variable">$INT</span>"</span> -le <span class="string">"<span class="variable">$MAX_VAL</span>"</span> ]</span><br><span class="line"><span class="comment"># note in test need escape</span></span><br><span class="line"><span class="keyword">if</span> [[ ! (<span class="string">"<span class="variable">$INT</span>"</span> -ge <span class="string">"<span class="variable">$MIN_VAL</span>"</span> &amp;&amp; <span class="string">"<span class="variable">$INT</span>"</span> -le <span class="string">"<span class="variable">$MAX_VAL</span>"</span>) ]]</span><br><span class="line"><span class="keyword">if</span> [ ! \( <span class="string">"<span class="variable">$INT</span>"</span> -ge <span class="string">"<span class="variable">$MIN_VAL</span>"</span> -a <span class="string">"<span class="variable">$INT</span>"</span> -le <span class="string">"<span class="variable">$MAX_VAL</span>"</span> \) ]</span><br></pre></td></tr></table></figure>
<p>Since all expressions and operators used by test are treated as command arguments by the shell (unlike <code>[[ ]]</code> and <code>(( ))</code> ), characters that have special meaning to bash, such as &lt;, &gt;, (, and ), must be quoted or escaped.</p>
<p>一种是外部使用的, provided by bash, for example: <code>[[ ]] &amp;&amp; [[ ]] || [[ ]]</code>, <code>[[ ! xxx ]]</code>. They obey short circuit rule.</p>
<p>Tips: 对于简单的if-condition, 可以替换为形如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chaining commands</span></span><br><span class="line">[ -r ~/.profile ] &amp;&amp; . ~/.profile</span><br><span class="line">cat ~/.profile &amp;&amp; <span class="built_in">echo</span> <span class="string">"this is profile"</span> || <span class="built_in">echo</span> <span class="string">"failed to read profile"</span></span><br><span class="line"><span class="built_in">test</span> -f <span class="string">"<span class="variable">$FILE</span>"</span> &amp;&amp; <span class="built_in">source</span> <span class="string">"<span class="variable">$_</span>"</span> || <span class="built_in">echo</span> <span class="string">"<span class="variable">$_</span> does not exist"</span> &gt;&amp; 2</span><br><span class="line">[ ! -r <span class="string">"<span class="variable">$FILE</span>"</span> ] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">"<span class="variable">$FILE</span> is not readable"</span> ; <span class="built_in">exit</span> 1 &#125;</span><br><span class="line"><span class="comment"># parameters expansion 甚至都不需要if-condition</span></span><br><span class="line"><span class="variable">$&#123;var:="hello"&#125;</span></span><br></pre></td></tr></table></figure>
<h1>select loop</h1>
<p>The select loop provides an easy way to create a numbered menu from which users can select options. It is useful when you need to ask the user to choose one or more items from a list of choices.</p>
<blockquote>
<p>Note that this loop was introduced in ksh and has been adapted into bash. It is not available in sh.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PS3 is designed for select command</span></span><br><span class="line">PS3=<span class="string">"Enter your choice (must be a number): "</span></span><br><span class="line">select DRINK <span class="keyword">in</span> tea cofee water juice appe all none</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="comment"># After a match is found, no further matches are attempted.</span></span><br><span class="line">   <span class="comment"># don't need the double quote</span></span><br><span class="line">   <span class="comment"># the pattern match is the same as pathname expansion</span></span><br><span class="line">   <span class="comment"># for example: ???) [[:alpha:]]) *.txt)</span></span><br><span class="line">   <span class="keyword">case</span> <span class="variable">$DRINK</span> <span class="keyword">in</span></span><br><span class="line">      tea | cofee | water | all) </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Go to canteen"</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">        ;;</span><br><span class="line">      juice|appe)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Available at home"</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">        ;;</span><br><span class="line">      none) </span><br><span class="line">        <span class="built_in">break</span> </span><br><span class="line">        ;;</span><br><span class="line">      <span class="comment"># match anything at last</span></span><br><span class="line">      *) </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ERROR: Invalid selection"</span> </span><br><span class="line">        ;;</span><br><span class="line">   <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>When select you can use index number or literal, if no <code>break</code>, it will loop forever.
If want case to match more than one terms, use <code>;;&amp;</code> instead of <code>;;</code> at end of each case. The addition of the <code>;;&amp;</code> syntax allows case to continue to the next test rather than simply terminating.</p>
<h1>input password and confirm</h1>
<p>Must not show password user input:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"****************************************************************"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Please input the password:"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"****************************************************************"</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">read</span> -s -p <span class="string">"PASSWORD: "</span> PASSWORD</span><br><span class="line">  <span class="built_in">echo</span></span><br><span class="line">  <span class="built_in">read</span> -s -p <span class="string">"CONFIRM:  "</span> PASSWORD_CONFIRM</span><br><span class="line">  <span class="built_in">echo</span></span><br><span class="line">  [ <span class="variable">$&#123;#PASSWORD&#125;</span> -lt 6 ] &amp;&amp; <span class="built_in">echo</span> <span class="string">"The length of password at least 6, please try again"</span> &amp;&amp; <span class="built_in">continue</span></span><br><span class="line">  [ <span class="string">"<span class="variable">$&#123;PASSWORD&#125;</span>"</span> = <span class="string">"<span class="variable">$&#123;PASSWORD_CONFIRM&#125;</span>"</span> ] &amp;&amp; <span class="built_in">break</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Passwords do not match please try again..."</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h1>script input parameters</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"No command-line arguments were specified..."</span></span><br><span class="line">  <span class="comment"># call Usage function here</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## case和C语言中有一样的性质，如果没有break，会继续对比接下来的选项</span></span><br><span class="line"><span class="comment">## 这里并不需要，因为shift 且没有相同的flags</span></span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$#</span> -gt 0 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    -p1)</span><br><span class="line">       <span class="built_in">shift</span></span><br><span class="line">       P1=<span class="variable">$&#123;1&#125;</span></span><br><span class="line">       <span class="built_in">shift</span>;;</span><br><span class="line"></span><br><span class="line">    -p2)</span><br><span class="line">       <span class="built_in">shift</span></span><br><span class="line">       P2=<span class="variable">$&#123;1&#125;</span></span><br><span class="line">       <span class="built_in">shift</span>;;</span><br><span class="line"></span><br><span class="line">    -h|--<span class="built_in">help</span>)</span><br><span class="line">       <span class="comment"># Usage</span></span><br><span class="line">       <span class="built_in">exit</span> 0;;</span><br><span class="line">       </span><br><span class="line">    *) <span class="comment"># Usage</span></span><br><span class="line">       <span class="built_in">exit</span> 1;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[[ <span class="string">"X<span class="variable">$P1</span>"</span> = <span class="string">"X"</span> ]] &amp;&amp;  <span class="built_in">exit</span> 1</span><br><span class="line">[[ <span class="string">"X<span class="variable">$P2</span>"</span> = <span class="string">"X"</span> ]] &amp;&amp;  <span class="built_in">exit</span> 1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note there are 2 shift in one case, after each <code>shift</code>, <code>$#</code> minus 1.</p>
</blockquote>
<h1>function</h1>
<p>The function refers to passed arguments by their position (not by name), that is <code>$1</code>, <code>$2</code>, and so forth. <code>$0</code> is the name of the script itself.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> example()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">## local var prevent var leaking to shell</span></span><br><span class="line">  <span class="built_in">local</span> first=<span class="variable">$1</span></span><br><span class="line">  <span class="built_in">local</span> second=<span class="variable">$2</span></span><br><span class="line">  <span class="comment">## return code is similar to exit code but this is return</span></span><br><span class="line">  <span class="comment">## will break the rest execution</span></span><br><span class="line">  <span class="built_in">return</span> &lt;<span class="built_in">return</span> code&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Need to call your function after it is declared.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">example <span class="string">"p1"</span> <span class="string">"p2"</span></span><br><span class="line"></span><br><span class="line">args <span class="comment">#0 is &lt;absolute path to script itself&gt;</span></span><br><span class="line">args <span class="comment">#1 is p1</span></span><br><span class="line">args <span class="comment">#2 is p2</span></span><br></pre></td></tr></table></figure>
<p>Show functions:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## list all function names</span></span><br><span class="line"><span class="built_in">declare</span> -F</span><br><span class="line"><span class="comment">## show definition</span></span><br><span class="line"><span class="built_in">declare</span> -f [<span class="keyword">function</span> name]</span><br><span class="line"><span class="comment">## clear a function</span></span><br><span class="line"><span class="built_in">unset</span> -f &lt;<span class="keyword">function</span> name&gt;</span><br></pre></td></tr></table></figure>
<p>Export functions, to make it available to subshells, similarly to export variables:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## -xf: export a function</span></span><br><span class="line"><span class="built_in">declare</span> -xf &lt;<span class="keyword">function</span> name&gt;</span><br></pre></td></tr></table></figure>
<h1>log message</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LogMsg()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment"># parse input and reformat</span></span><br><span class="line">  logMsg=<span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"["</span>`date +<span class="string">"%Y/%m/%d %r"</span>`<span class="string">"] "</span> <span class="variable">$&#123;logMsg&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LogMsg <span class="string">"[INFO] ..."</span></span><br><span class="line">LogMsg <span class="string">"[WARNING] ..."</span></span><br><span class="line">LogMsg <span class="string">"[ERROR]..."</span></span><br></pre></td></tr></table></figure>
<p>Actually, this style <code>[INFO] [2019-10-11 15:59:26-0081] ...</code> it better.</p>
<h1>check last command result</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">echo_success_failure</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span> </span><br><span class="line">    LogMsg <span class="string">"###### INFO: Success..."</span></span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">    LogMsg <span class="string">"###### INFO: Failure..."</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>run as root</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">effective_uid=`id -u` 2&gt;/dev/null</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$effective_uid</span> -ne 0 ]; <span class="keyword">then</span></span><br><span class="line"> LogMsg <span class="string">"###### ERROR: Please run this script as root or sudo"</span>  </span><br><span class="line"> <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<h1>IFS and read array</h1>
<p>The default value of IFS contains a space, a tab, and a newline character.
Convert string to array with specific delimiter, for example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">string=<span class="string">"item1:item2:item3"</span></span><br><span class="line"><span class="comment"># &lt;&lt;&lt;: is here string, the same as here doc but shorter single string</span></span><br><span class="line">OLD_IFS=<span class="variable">$IFS</span></span><br><span class="line">IFS=<span class="string">':'</span> <span class="built_in">read</span> -a array &lt;&lt;&lt; <span class="string">"<span class="variable">$&#123;string&#125;</span>"</span></span><br><span class="line"><span class="comment"># or using process substitution</span></span><br><span class="line">IFS=<span class="string">':'</span> <span class="built_in">read</span> -a array &lt; &lt;(<span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;string&#125;</span>"</span>)</span><br><span class="line">IFS=<span class="variable">$OLD_IFS</span></span><br></pre></td></tr></table></figure>
<p>This version has no globbing problem, the delimiter is set in <code>$IFS</code> (here is space), variables quoted. Don’t forget to do sanity check after converting.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;array[0]&#125;</span>  ===&gt; item1</span><br><span class="line"><span class="variable">$&#123;array[1]&#125;</span>  ===&gt; item2</span><br><span class="line"><span class="variable">$&#123;array[2]&#125;</span>  ===&gt; item3</span><br></pre></td></tr></table></figure>
<p>Why we use here string rather than pipeline, for example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;string&#125;</span>"</span> | <span class="built_in">read</span></span><br></pre></td></tr></table></figure>
<p>这是不行的，因为pipeline 的本质是subshell, 但是read 需要更改当前parent shell的内容的。这里read 实际上在更改了subshell中$REPLY的内容，一旦command 结束，subshell就没了, parent shell 并没有变化.</p>
<p>此外，验证输入的正确性也很重要，一般用<code>[[ =~ ]]</code> regular expression 去检测了.</p>
<p>Actually if the string use spaces as delimiter, we can loop items directly:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">string=<span class="string">"item1 item2 item3"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;string&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$&#123;i&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h1>loop array</h1>
<p><code>break</code> and <code>continue</code> can be used on loop. 还要注意当<code>do</code> 写在下一行的时候，<code>do</code>前面不需要<code>;</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">declare</span> -a array=(<span class="string">"element1"</span> <span class="string">"element2"</span> <span class="string">"element3"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;array[@]&#125;</span>"</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;i&#125;</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p><code>declare</code> or <code>typeset</code> are an explicit way of declaring variable in shell scripts.</p>
<p>In BASH it is safer to quote the variable using <code>&quot;&quot;</code> for the cases when <code>$i</code> may contain white spaces or shell expandable characters.</p>
<p>If you want to use index of array element</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get length of an array</span></span><br><span class="line">arraylength=<span class="variable">$&#123;#array[@]&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># use for loop to read all values and indexes</span></span><br><span class="line"><span class="keyword">for</span> (( i=0; i&lt;<span class="variable">$&#123;arraylength&#125;</span>; i++ ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="comment">## $&#123;array[$i]&#125; 这里注意，先解析的$i</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$i</span> <span class="string">" / "</span> <span class="variable">$&#123;arraylength&#125;</span> <span class="string">" : "</span> <span class="variable">$&#123;array[$i]&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>If we use <code>declare</code> to define a integer variable:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">declare</span> -i x=10</span><br><span class="line"><span class="keyword">while</span> (( x &gt; 0 ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$x</span></span><br><span class="line">  <span class="comment">## no need to use 'let x=x-1'</span></span><br><span class="line">  <span class="comment">## because x is type integer</span></span><br><span class="line">  x=x-1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># true loop 3 种写法</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> | <span class="keyword">while</span> ((1)) | <span class="keyword">while</span> :</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"> <span class="comment">## pass</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>Until loop continues until it receives a zero exit status.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">count = 1</span><br><span class="line"></span><br><span class="line">until [[ <span class="string">"<span class="variable">$count</span>"</span> -gt 5 ]]; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$count</span>"</span></span><br><span class="line">  count=$((count + 1))</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>In ZSH shell, you can use foreach loop:</p>
<figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## () is a must</span></span><br><span class="line">foreach item (`ls /tmp`)</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$item</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>Another index loop using <code>seq</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq 1 10)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$i</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h1>read file</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># read 3 fields a line, line by line from distros.txt file</span></span><br><span class="line"><span class="comment"># note that &lt; is placed after done, it is the input for loop</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> distro version release; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">printf</span> <span class="string">"Distro: %s\tVersion: %s\tReleased: %s\n"</span> \</span><br><span class="line">    <span class="string">"<span class="variable">$distro</span>"</span> \</span><br><span class="line">    <span class="string">"<span class="variable">$version</span>"</span> \</span><br><span class="line">    <span class="string">"<span class="variable">$release</span>"</span></span><br><span class="line"><span class="comment"># no need cat here</span></span><br><span class="line"><span class="keyword">done</span> &lt; distros.txt</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="keyword">done</span> &lt; &lt;(cat distros.txt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># can also pipeline input to a loop</span></span><br><span class="line"><span class="comment"># while and read is running on subshell</span></span><br><span class="line">sort -k 1,1 -k 2n distros.txt | <span class="keyword">while</span> <span class="built_in">read</span> distro version release; <span class="keyword">do</span> </span><br><span class="line">  <span class="built_in">printf</span> <span class="string">"Distro: %s\tVersion: %s\tReleased: %s\n"</span> \</span><br><span class="line">    <span class="string">"<span class="variable">$distro</span>"</span> \</span><br><span class="line">    <span class="string">"<span class="variable">$version</span>"</span> \</span><br><span class="line">    <span class="string">"<span class="variable">$release</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># using process substitution</span></span><br><span class="line"><span class="comment"># list last 3 lines of dir</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> attr links owner group size date time filename; <span class="keyword">do</span></span><br><span class="line">  cat &lt;&lt; EOF</span><br><span class="line">    Filename: <span class="variable">$filename</span></span><br><span class="line">    Size:     <span class="variable">$size</span></span><br><span class="line">EOF</span><br><span class="line"><span class="keyword">done</span> &lt; &lt;(ls -ltrh | tail -n +2)</span><br></pre></td></tr></table></figure>
<h1>chmod</h1>
<p><code>chmod</code> recursively for directory and it’s content</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 0755 &lt;target directory&gt;</span><br></pre></td></tr></table></figure>
<p>Or only add executable for file</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">'&lt;file name&gt;'</span> -<span class="built_in">type</span> f | xargs chmod +x</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rwxr-xr-x ...</span><br></pre></td></tr></table></figure>
<h1>pass parameters to script for read</h1>
<p>Read can read from keyboard input or file or pipeline: <code>read [-options] [variables...]</code>. If no variable name is supplied, the shell variable <code>$REPLY</code> contains the line of data. If read receives fewer than the expected number, the extra variables are empty, while an excessive amount of input results in the final variable containing all of the extra input.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pass parameters to read command</span></span><br><span class="line"><span class="comment"># must stick to this format</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"admin</span></span><br><span class="line"><span class="string">123456"</span> | ./script.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># receive code snippet in script.sh</span></span><br><span class="line"><span class="comment"># $&#123;username&#125;  ===&gt; admin</span></span><br><span class="line"><span class="comment"># $&#123;password&#125;  ===&gt; 123456</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"Please enter username -&gt; "</span></span><br><span class="line"><span class="built_in">read</span> username</span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"Please enter an password -&gt; "</span></span><br><span class="line"><span class="comment"># -s: silent</span></span><br><span class="line"><span class="built_in">read</span> -s password</span><br></pre></td></tr></table></figure>
<p>Other options:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -p: prompt</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">"Enter one or more values &gt; "</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"REPLY = '<span class="variable">$REPLY</span>'"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -t: timeout</span></span><br><span class="line"><span class="comment"># -s: silent</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">read</span> -t 10 -sp <span class="string">"Enter secret passphrase &gt; "</span> secret_pass; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\nSecret passphrase = '<span class="variable">$secret_pass</span>'"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">"\nInput timed out"</span> &gt;&amp;2</span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -e: pair with -i</span></span><br><span class="line"><span class="comment"># -i: default valut passed to read</span></span><br><span class="line"><span class="built_in">read</span> -e -p <span class="string">"What is your user name? "</span> -i <span class="variable">$USER</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"REPLY = '<span class="variable">$REPLY</span>'"</span></span><br></pre></td></tr></table></figure>
<h1>setup ssh password-less</h1>
<p>Idempotence：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh-keyscan -H <span class="variable">$&#123;remote&#125;</span> &gt;&gt; ~/.ssh/known_hosts</span><br><span class="line">sshpass -p <span class="string">"&lt;password&gt;"</span> ssh-copy-id -i ~/.ssh/id_rsa.pub root@<span class="variable">$&#123;remote&#125;</span></span><br><span class="line"><span class="keyword">if</span> [[ $? -ne 0 ]]; <span class="keyword">then</span></span><br><span class="line">  LogMsg <span class="string">"######ERROR: Something went wrong with ssh-copy-id. Check for incorrect credentials ... "</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<h1>recursive call</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">example()</span><br><span class="line">&#123;</span><br><span class="line">  &lt;execute sth&gt;</span><br><span class="line">  <span class="keyword">if</span> [[ $? -ne 0 ]]; <span class="keyword">then</span></span><br><span class="line">       LogMsg <span class="string">"######ERROR: Something went wrong… "</span></span><br><span class="line">       example</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>tee command</h1>
<p><code>tee</code> command reads the standard input and writes it to <code>both</code> the standard output and one or more files, <code>-a</code> flag used to append output to existing file, if no <code>-a</code>, tee will create the file if not exist.</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LogMsg()</span><br><span class="line">&#123;</span><br><span class="line">  logMsg=<span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"["</span>`date +<span class="string">"%Y/%m/%d %r"</span>`<span class="string">"]"</span> <span class="variable">$&#123;logMsg&#125;</span> | tee -a logs/ds_<span class="variable">$&#123;stage&#125;</span>_<span class="variable">$&#123;timeStamp&#125;</span>.<span class="built_in">log</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意这里tee 有2个方向的输出，可以用来检查pipeline的中间输出是什么</span></span><br><span class="line">+-------------+     +-------+    +--------------+</span><br><span class="line">|  <span class="built_in">command</span>    |     | tee   |    |   stdout     |</span><br><span class="line">|   output    +----&gt;+       +---&gt;+              |</span><br><span class="line">+-------------+     +---+---+    +--------------+</span><br><span class="line">                        |</span><br><span class="line">                    +---v---+</span><br><span class="line">                    |  file |</span><br><span class="line">                    |       |</span><br><span class="line">                    +-------+</span><br></pre></td></tr></table></figure>
<h1>statement block</h1>
<p>这个很有意思，之前都没见过: <code>{}</code>
<a href="https://unix.stackexchange.com/questions/390329/statement-blocks-mechanism-in-shell-scripting" target="_blank" rel="noopener">Statement block in shell script</a></p>
<h1>do something after reboot</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># this script will do sth after reboot </span></span><br><span class="line"><span class="comment"># in /root/completeme.sh</span></span><br><span class="line"><span class="comment"># then restore /etc/profile</span></span><br><span class="line"><span class="comment">#################################################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Warning! This script is going to reboot now to complate the procedure"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"After reboot, login as root to perform the final steps"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Press Ctrl-C now to stop this script in case you don\'t want to reboot"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## heredoc</span></span><br><span class="line">cat &lt;&lt; REBOOT &gt;&gt; /root/completeme.sh</span><br><span class="line"><span class="comment">## do sth after reboot</span></span><br><span class="line"></span><br><span class="line">touch /tmp/after-reboot                            </span><br><span class="line">rm -f /etc/profile</span><br><span class="line">mv /etc/profile.bak /etc/profile</span><br><span class="line"><span class="built_in">echo</span> DONE</span><br><span class="line">REBOOT</span><br><span class="line"></span><br><span class="line">chmod +x /root/completeme.sh</span><br><span class="line">cp /etc/profile /etc/profile.bak</span><br><span class="line"><span class="comment">## after reboot /etc/profile will be executed so /root/completeme.sh</span></span><br><span class="line"><span class="built_in">echo</span> /root/completeme.sh &gt;&gt; /etc/profile</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h1>monitor CPU load</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## to increase CPU load</span></span><br><span class="line"><span class="comment">## dd if=/dev/zero of=/dev/null</span></span><br><span class="line"><span class="comment">## or use stress command!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> sleep 60</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="comment">## to remove header of ps output, append `=` or user --no-headers flag</span></span><br><span class="line">  <span class="comment">## CPU$ 0.0 will be in part if CPU$ &gt; 0.0</span></span><br><span class="line">  REC=`ps -eo pcpu= -o pid= -o comm= | sort -k1 -n -r | head -1`</span><br><span class="line">  USAGE=`<span class="built_in">echo</span> <span class="variable">$REC</span> | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">  <span class="comment">## truncate decimal part</span></span><br><span class="line">  USAGE=<span class="variable">$&#123;USAGE%.*&#125;</span></span><br><span class="line">  PID=`<span class="built_in">echo</span> <span class="variable">$REC</span> | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">  PNAME=`<span class="built_in">echo</span> <span class="variable">$REC</span> | awk <span class="string">'&#123;print $3&#125;'</span>`</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Only if we have a high CPU load on one process, run a check within 7 seconds</span></span><br><span class="line">  <span class="comment"># In this check, we should monitor if the process is still that active</span></span><br><span class="line">  <span class="comment"># If that's the case, root gets a message</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">## man test</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="variable">$USAGE</span> -gt 80 ] </span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">    USAGE1=<span class="variable">$USAGE</span></span><br><span class="line">    PID1=<span class="variable">$PID</span></span><br><span class="line">    PNAME1=<span class="variable">$PNAME</span></span><br><span class="line">    sleep 7</span><br><span class="line">    REC=`ps --no-headers -eo pcpu,pid -o comm= | sort -k1 -n -r | head -1`</span><br><span class="line">    USAGE2=`<span class="built_in">echo</span> <span class="variable">$REC</span> | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">    USAGE2=<span class="variable">$&#123;USAGE2%.*&#125;</span></span><br><span class="line">    PID2=`<span class="built_in">echo</span> <span class="variable">$REC</span> | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">    PNAME2=`<span class="built_in">echo</span> <span class="variable">$REC</span> | awk <span class="string">'&#123;print $3&#125;'</span>`</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Now we have variables with the old process information and with the</span></span><br><span class="line">    <span class="comment"># new information</span></span><br><span class="line"></span><br><span class="line">    [ <span class="variable">$USAGE2</span> -gt 80 ] &amp;&amp; [ <span class="variable">$PID1</span> = <span class="variable">$PID2</span> ] &amp;&amp; mail -s <span class="string">"CPU load of <span class="variable">$PNAME</span> is above 80%"</span> root@blah.com &lt; .</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/shell/" rel="tag"># shell</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/02/24/git-lfs/" rel="next" title="Versioning Large File in Git">
                <i class="fa fa-chevron-left"></i> Versioning Large File in Git
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/02/24/shell-pipeline/" rel="prev" title="BASH Pipeline Demo">
                BASH Pipeline Demo <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/cuishao.png" alt="海胆阶段">
            
              <p class="site-author-name" itemprop="name">海胆阶段</p>
              <p class="site-description motion-element" itemprop="description">骐骥一跃，不能十步；驽马十驾，功在不舍</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">296</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">48</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">159</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">set builtin</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">get path of running script</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">run script in it’s driectory</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">create tmp file to store log</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">if condition</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">select loop</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">7.</span> <span class="nav-text">input password and confirm</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">8.</span> <span class="nav-text">script input parameters</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">9.</span> <span class="nav-text">function</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">10.</span> <span class="nav-text">log message</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">11.</span> <span class="nav-text">check last command result</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">12.</span> <span class="nav-text">run as root</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">13.</span> <span class="nav-text">IFS and read array</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">14.</span> <span class="nav-text">loop array</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">15.</span> <span class="nav-text">read file</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">16.</span> <span class="nav-text">chmod</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">17.</span> <span class="nav-text">pass parameters to script for read</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">18.</span> <span class="nav-text">setup ssh password-less</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">19.</span> <span class="nav-text">recursive call</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">20.</span> <span class="nav-text">tee command</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">21.</span> <span class="nav-text">statement block</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">22.</span> <span class="nav-text">do something after reboot</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">23.</span> <span class="nav-text">monitor CPU load</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chengdong Liao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>





  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>

        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  



  











  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function () {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
